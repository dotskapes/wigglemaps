function vect(h,p,q){this.x=h;this.y=p;this.z=q?q:0;this.add=function(m){this.x+=m.x;this.y+=m.y;this.z+=m.z};this.sub=function(m){this.x-=m.x;this.y-=m.y;this.z-=m.z};this.scale=function(m){this.x*=m;this.y*=m;this.z*=m};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var m=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);0!=m&&(this.x/=m,this.y/=m,this.z/=m)};this.div=function(m){this.x/=m.x;this.y/=m.y;this.z/=m.z};this.floor=function(){this.x=
Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return 0==this.x+this.y+this.z};this.dot=function(m){return this.x*m.x+this.y*m.y+this.z*m.z};this.cross=function(){throw"Need to reimplement";};this.rotate=function(m){var h=Math.cos(m);m=Math.sin(m);xp=h*this.x-m*this.y;yp=m*this.x+h*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}vect.scale=function(h,p){return new vect(h.x*p,h.y*p,h.z*p)};
vect.add=function(h,p){return new vect(h.x+p.x,h.y+p.y,h.z+p.z)};vect.sub=function(h,p){if(!h||!p)throw"Bad Vector";return new vect(h.x-p.x,h.y-p.y,h.z-p.z)};vect.dist=function(h,p){var q=p.x-h.x,m=p.y-h.y,u=p.z-h.z;return Math.sqrt(q*q+m*m+u*u)};vect.dir=function(h,p){var q=vect.sub(h,p);q.normalize();return q};vect.dot2d=function(h,p){return h.x*p.x+h.y*p.y};vect.cross=function(h,p){return h.x*p.y-h.y*p.x};
vect.left=function(h,p,q,m){m||(m=0);p=vect.sub(p,h);h=vect.sub(q,h);return vect.cross(p,h)>=-m};vect.intersects=function(h,p,q,m,u){u||(u=0);return vect.left(h,p,q,u)!=vect.left(h,p,m,u)&&vect.left(q,m,p,u)!=vect.left(q,m,h,u)};vect.intersect2dt=function(h,p,q,m){m=h.x*(m.y-q.y)+p.x*(q.y-m.y)+m.x*(p.y-h.y)+q.x*(h.y-p.y);return 0==m?Infinity:-(h.x*(q.y-p.y)+p.x*(h.y-q.y)+q.x*(p.y-h.y))/m};
vect.intersect2dpos=function(h,p,q,m){var u=h.x*(m.y-q.y)+p.x*(q.y-m.y)+m.x*(p.y-h.y)+q.x*(h.y-p.y);if(0==u)return Infinity;q=(h.x*(m.y-q.y)+q.x*(h.y-m.y)+m.x*(q.y-h.y))/u;p=vect.sub(p,h);p.scale(q);return vect.add(h,p)};vect.rotate=function(h,p){var q=Math.cos(p),m=Math.sin(p);xp=q*h.x-m*h.y;yp=m*h.x+q*h.y;return h=new vect(xp,yp,h.z)};
(function(){function h(a,e){for(var d in e)d in a||(a[d]=e[d])}function p(a){var e={};for(key in a)e[key]=a[key];return e}function q(a,e){for(key in e)a[key]=e[key]}function m(a,e,d){return Math.min(Math.max(a,e),d)}function u(a,e,d,b){1>=a&&1>=e&&1>=d&&1>=b?(this.r=a,this.g=e,this.b=d,this.a=b):(this.r=a/255,this.g=e/255,this.b=d/255,this.a=b/255);this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(255*this.r)+","+parseInt(255*
this.g)+","+parseInt(255*this.b)+")"}}function wa(a,e,d,b){return new u(m(a,0,1),m(e,0,1),m(d,0,1),m(b,0,1))}function X(a){var e=parseInt(a.slice(1,3),16),d=parseInt(a.slice(3,5),16);a=parseInt(a.slice(5,7),16);return new u(e,d,a,255)}function ka(a,e){return((a.charCodeAt(e)&255)<<24)+((a.charCodeAt(e+1)&255)<<16)+((a.charCodeAt(e+2)&255)<<8)+(a.charCodeAt(e+3)&255)}function H(a,e){return((a.charCodeAt(e+3)&255)<<24)+((a.charCodeAt(e+2)&255)<<16)+((a.charCodeAt(e+1)&255)<<8)+(a.charCodeAt(e)&255)}
function fa(a,e){var d=a.charCodeAt(e)&255,b=a.charCodeAt(e+1)&255,c=a.charCodeAt(e+2)&255,f=a.charCodeAt(e+3)&255,k=a.charCodeAt(e+4)&255,j=a.charCodeAt(e+5)&255,g=a.charCodeAt(e+6)&255,l=a.charCodeAt(e+7)&255,n=1-2*(l>>7),l=((l&127)<<4)+((g&240)>>4)-1023,d=(g&15)*Math.pow(2,48)+j*Math.pow(2,40)+k*Math.pow(2,32)+f*Math.pow(2,24)+c*Math.pow(2,16)+b*Math.pow(2,8)+d;return n*(1+d*Math.pow(2,-52))*Math.pow(2,l)}function ga(a,e){var d=a.charCodeAt(e)&255,b=a.charCodeAt(e+1)&255,c=a.charCodeAt(e+2)&255,
f=a.charCodeAt(e+3)&255,k=1-2*(f>>7),f=((f&127)<<1)+((c&254)>>7)-127,d=(c&127)*Math.pow(2,16)+b*Math.pow(2,8)+d;return k*(1+d*Math.pow(2,-23))*Math.pow(2,f)}function xa(a,e,d,b){return[a-d,e+b,a-d,e-b,a+d,e+b,a-d,e-b,a+d,e-b,a+d,e+b]}function x(a,e,d){return 2==arguments.length?[a.x,e.y,a.x,a.y,e.x,e.y,a.x,a.y,e.x,a.y,e.x,e.y]:[a.x,e.y,d,a.x,a.y,d,e.x,e.y,d,a.x,a.y,d,e.x,a.y,d,e.x,e.y,d]}function z(a,e){if(!a)return null;var d=a.createProgram(),b=ya(a,a.VERTEX_SHADER,e+"/vert.glsl"),c=ya(a,a.FRAGMENT_SHADER,
e+"/frag.glsl");a.attachShader(d,b);a.attachShader(d,c);a.linkProgram(d);var f={},b=(b.source+c.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg),c=0;a.useProgram(d);if(b){for(var k=0;k<b.length;k++){var j=b[k].split(" ");f[j[2]]={u:j[0],type:j[1],loc:null};if("uniform"==j[0])f[j[2]].loc=a.getUniformLocation(d,j[2]);else{var g=a.getAttribLocation(d,j[2]);f[j[2]].loc=g}"sampler2D"==j[1]&&(f[j[2]].tex=c,c++)}d.get=function(a){return f[a].loc};d.data=function(b,c){var d=f[b];if(!d)throw"Could not find shader variable "+
b;if("uniform"==d.u)if("float"==d.type)a.uniform1f(d.loc,c);else if("vec2"==d.type)a.uniform2fv(d.loc,c);else if("ivec2"==d.type)a.uniform2iv(d.loc,c);else if("vec3"==d.type)a.uniform3fv(d.loc,c);else if("ivec3"==d.type)a.uniform3iv(d.loc,c);else if("vec4"==d.type)a.uniform4fv(d.loc,c);else if("ivec4"==d.type)a.uniform4iv(d.loc,c);else if("bool"==d.type)a.uniform1i(d.loc,c);else if("mat4"==d.type)a.uniformMatrix4fv(d.loc,!1,c);else if("mat3"==d.type)a.uniformMatrix3fv(d.loc,!1,c);else if("sampler2D"==
d.type)"texture"in c&&(c=c.texture()),a.activeTexture(a["TEXTURE"+d.tex]),a.bindTexture(a.TEXTURE_2D,c),a.uniform1i(d.loc,d.tex);else if("int"==d.type)a.uniform1i(d.loc,c);else throw"Unsupported Type for Shader Helper: "+d.type;else if("attribute"==d.u)a.enableVertexAttribArray(d.loc),a.bindBuffer(a.ARRAY_BUFFER,c),a.vertexAttribPointer(d.loc,c.itemSize,a.FLOAT,!1,0,0);else throw"Type: "+d.u+" Recieved";}}return d}function ya(a,e,d){var b=a.createShader(e);$.ajax({async:!1,url:d,dataType:"text",success:function(c){a.shaderSource(b,
c);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS))throw a.getShaderInfoLog(b);b.source=c},error:function(){console.log("Could not load "+d)}});return b}function I(a,e,d){var b=a.createBuffer(),c=new Float32Array(e);a.bindBuffer(a.ARRAY_BUFFER,b);b.itemSize=d;b.numItems=e.length/d;a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return b}function la(a,e,d){if(!a)return null;var b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);var c=new Float32Array(e*
d);b.itemSize=d;b.numItems=e;b.update=function(c,d){var e=new Float32Array(c);a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferSubData(a.ARRAY_BUFFER,4*d,e);a.bindBuffer(a.ARRAY_BUFFER,null)};a.bufferData(a.ARRAY_BUFFER,c,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return b}function Y(a,e,d){var b=a.createTexture();b.id=za;za++;var c=new Image;c.onload=function(){a.bindTexture(a.TEXTURE_2D,b);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,c);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,
a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);d&&d()};c.src=e;return b}function ma(a,e){var d=p(e);h(d,{mag_filter:a.LINEAR,min_filter:a.LINEAR,wrap_s:a.CLAMP_TO_EDGE,wrap_t:a.CLAMP_TO_EDGE,mipmap:!1});var b=a.createTexture(),c=null;this.image=function(e){c=e;a.bindTexture(a.TEXTURE_2D,b);a.texImage2D(a.TEXTURE_2D,0,
a.RGBA,a.RGBA,a.UNSIGNED_BYTE,c);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,d.mag_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,d.min_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,d.wrap_s);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,d.wrap_t);d.mipmap&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)};this.texture=function(){return c?b:null}}function Aa(a,e,d){a=a.style(d);null===a&&(a=e.style(d),null===a&&(a=Qa[d]));return a}function Ra(a,e){e||(e={});
"center"in e||(e.center=new vect(0,0));"extents"in e||(e.extents=180);this.mat3=new Float32Array(9);var d=a.width()/a.height();this.mat3[0]=2/e.extents;this.mat3[4]=2*d/e.extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(b){b=new vect(2*(b.x-a.offset().left)/a.width()-1,-(2*(b.y-a.offset().top)/a.height()-1));b.x=b.x/this.mat3[0]-this.mat3[6]/this.mat3[0];b.y=b.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return b};this.screen=function(b){b=new vect(b.x*this.mat3[0]+
this.mat3[6],b.y*this.mat3[4]+this.mat3[7]);b.x=a.offset().left+a.width()*(b.x+1)/2;b.y=a.offset().top+a.height()*(-b.y+1)/2;return b};this.percent=function(b){return new vect(2*((b.x-a.offset().left)/a.width())-1,-(2*((b.y-a.offset().top)/a.height())-1))};this.pixel=function(b){return new vect(a.offset().left+(b.x+1)/2*a.width(),a.offset().top+(-b.y+1)/2*a.height())};this.move=function(a){this.mat3[6]-=a.x*this.mat3[0];this.mat3[7]-=a.y*this.mat3[4]};this.position=function(a){if(!a)return new vect(-this.mat3[6]/
this.mat3[0],-this.mat3[7]/this.mat3[4]);this.mat3[6]=-a.x*this.mat3[0];this.mat3[7]=-a.y*this.mat3[4]};this.position(e.center);this.extents=function(a){e.extents=a;a=this.position();this.level=1;this.mat3[0]=2/e.extents;this.mat3[4]=2*d/e.extents;this.position(a)};this.zoom=function(a){var c=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=a;this.mat3[4]*=a;this.mat3[6]=c.x*this.mat3[0];this.mat3[7]=c.y*this.mat3[4];this.level*=a};this.reset=function(){this.zoom(1/this.level)};
this.reconfigure=function(){var b=this.position();this.mat3[4]/=d;d=a.width()/a.height();this.mat3[4]*=d;this.position(b)}}function Sa(a){var e=!1,d=new vect(0,0),b=new vect(0,0),c=null,f=0;a.canvas.mousedown(function(a){d=new vect(a.clientX,a.clientY);e=!0});$(window).bind("mouseup",function(){e=!1});$(document).bind("keypress","+",function(){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(){a.camera.reset()});a.canvas.bind("mousewheel",
function(c,b){b*=0.5;0>b?(b=-1*b+1,b=1/b):b+=1;a.camera.zoom(b);c.preventDefault()});var k=!0;this.disable=function(){k=!1};this.enable=function(){k=!0};this.update=function(j){b=new vect(R.x,R.y);if(e&&k){var g=vect.sub(a.camera.project(d),a.camera.project(b));a.camera.move(g);d=b;f=g.length()/j;c=g;c.normalize()}else 0.01<f&&c&&(a.camera.move(vect.scale(c,f*j)),f-=3*j*f)}}function Ta(a,e,d){d||(d={});h(d,{base:"default",background:new u(0,0,0,1),antialias:!0});var b=this;this.canvas=$("<canvas></canvas>").attr("id",
"viewer");a?($(a).append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height())):(a=window,$("body").append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height()),$(window).resize(function(){b.resize()}));this.resize=function(){b.canvas.attr("width",$(a).width());b.canvas.attr("height",$(a).height());c.viewport(0,0,b.canvas.width(),b.canvas.height());b.camera.reconfigure();for(var d=0;d<n.length;d++)n[d].resize()};var c;e=
this.canvas;this.gl=c=gl=Ua?WebGLDebugUtils.makeDebugContext(e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),function(a,c){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+c;}):e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});c.viewport(0,0,b.canvas.width(),b.canvas.height());c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);c.enable(c.BLEND);v||(v=z(c,w+"shaders/blur"));Ba||(Ba=z(c,w+"shaders/light"));var f=
new J(c,6);f.create("vert",2);f.create("tex",2);e=f.alloc(6);f.write("vert",x(new vect(-1,-1),new vect(1,1)),e,6);f.write("tex",x(new vect(0,0),new vect(1,1)),e,6);f.update();this.scene=[];this.camera=new Ra(this.canvas,d);this.scroller=new Sa(this);this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.sel=new Va(this);this.select=function(a){a?(this.scroller.disable(),this.sel.enable()):(this.scroller.enable(),this.sel.disable())};var k=(new Date).getTime(),j=[];this.attr=
function(a,c){"base"==a&&(d.base=c,l())};var g=null,l=function(){if("default"==d.base||"nasa"==d.base){var a=p(d);q(a,{source:"file",url:na+"/tiles/nasa_topo_bathy",levels:8,size:256});g=new ha(a)}else"ne"==d.base?(a=p(d),q(a,{source:"file",url:na+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),g=new ha(a)):"ne1"==d.base?(a=p(d),q(a,{source:"file",url:na+"/tiles/NE1_HR_LC",levels:6,size:256}),g=new ha(a)):g=null;g&&g.initialize(b)};l();this.enable_z=function(){c.depthFunc(c.LEQUAL);c.enable(c.DEPTH_TEST)};
this.disable_z=function(){c.disable(c.DEPTH_TEST)};var n=[],r=[null];this.framebuffer=function(){var a=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,a);a.width=b.canvas.width();a.height=b.canvas.height();var d=c.createTexture();c.bindTexture(c.TEXTURE_2D,d);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);
c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a.width,a.height,0,c.RGBA,c.UNSIGNED_BYTE,null);var e=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,e);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,a.width,a.height);c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,d,0);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,e);c.bindTexture(c.TEXTURE_2D,null);c.bindRenderbuffer(c.RENDERBUFFER,null);c.bindFramebuffer(c.FRAMEBUFFER,null);var f={framebuffer:a,
renderbuffer:e,tex:d,resize:function(){a.width=b.canvas.width();a.height=b.canvas.height();c.bindTexture(c.TEXTURE_2D,d);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a.width,a.height,0,c.RGBA,c.UNSIGNED_BYTE,null);c.bindRenderbuffer(c.RENDERBUFFER,e);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,a.width,a.height);c.bindTexture(c.TEXTURE_2D,null);c.bindRenderbuffer(c.RENDERBUFFER,null)},activate:function(d){d||(d={});h(d,{blend:!0,clear:!0});r.push(a);d.blend||c.disable(c.BLEND);c.bindFramebuffer(c.FRAMEBUFFER,
a);c.viewport(0,0,b.canvas.width(),b.canvas.height());d.clear&&(c.clearColor(0,0,0,0),c.clear(c.COLOR_BUFFER_BIT),c.clearDepth(0))},deactivate:function(){var b=r.pop(),d=r[r.length-1];if(b!=a)throw"Non-nested use of framebuffers";c.bindFramebuffer(c.FRAMEBUFFER,d);c.enable(c.BLEND)}};n.push(f);return f};var m=this.framebuffer(),oa=this.framebuffer();this.draw_blur=function(a){c.useProgram(v);oa.activate({blend:!1});v.data("pos",f.get("vert"));v.data("tex_in",f.get("tex"));v.data("sampler",a);v.data("width",
b.canvas.width());v.data("height",b.canvas.height());v.data("hor",!0);c.drawArrays(c.TRIANGLES,0,f.count());oa.deactivate();v.data("pos",f.get("vert"));v.data("tex_in",f.get("tex"));v.data("sampler",oa.tex);v.data("width",b.canvas.width());v.data("height",b.canvas.height());v.data("hor",!1);c.drawArrays(c.TRIANGLES,0,f.count())};this.dirty=!0;var Ca=function(){var a=(new Date).getTime(),e=(a-k)/1E3;b.scroller.update(e);60<=j.length&&j.splice(0,1);j.push(e);for(var f=0,l=0;l<j.length;l++)f+=j[l];f/=
j.length;$("#fps").text(Math.floor(1/f));k=a;c.clearColor(d.background.r,d.background.g,d.background.b,d.background.a);c.clear(c.COLOR_BUFFER_BIT);c.clearDepth(0);a=!1;b.shade&&(a=b.shade.ready());a&&m.activate();g&&g.draw(b,e);for(l=0;l<b.scene.length;l++)b.scene[l].draw(b,e,!1);b.sel.draw(b,e);requestAnimationFrame(Ca)};this.read_pixel=function(a,d){c.bindFramebuffer(c.FRAMEBUFFER,b.framebuffer);var e=new Uint8Array(4),f=(a-b.canvas.position().left)/b.canvas.width(),l=(b.canvas.position().top+b.canvas.height()-
d)/b.canvas.height();c.readPixels(parseInt(f*b.framebuffer.width),parseInt(l*b.framebuffer.height),1,1,c.RGBA,c.UNSIGNED_BYTE,e);c.bindFramebuffer(c.FRAMEBUFFER,null);return e};$(document).mousemove(function(a){R.x=a.clientX;R.y=a.clientY});this.canvas.click(function(){});this.canvas.dblclick(function(){});var C=!1;this.canvas.mousedown(function(){C=!0});this.canvas.mouseup(function(){C=!1});this.canvas.mousemove(function(){if(!C){var a=b.camera.project(new vect(R.x,R.y));$.each(b.scene,function(c,
d){d.update_move&&d.update_move(b,a)})}});this.canvas.mouseout(function(){$.each(b.scene,function(a,c){c.force_out&&c.force_out(b)})});requestAnimationFrame(Ca)}function J(a,e){var d={},b;b=e?e:256;var c=0,f=function(a,c,b,d){a||console.log("ack");b||(b=0);d||(d=c.length);for(var e=0;e<d;e++)a[b+e]=c[e]};this.create=function(c,e){if(!e)throw"Length of buffer must be a positive integer";var f=new Float32Array(b*e),l=la(a,b,e);d[c]={array:f,buffer:l,len:e,dirty:!1}};this.alloc=function(e){if(c+e>=b){for(var j=
b;j<c+e;)j*=2;b=j;for(name in d){var g=new Float32Array(j*d[name].len),l=d[name].array,n=la(a,b,d[name].len);f(g,l);d[name].array=g;d[name].buffer=n;d[name].dirty=!0}}j=c;c+=e;return j};this.get=function(a){return d[a].buffer};this.write=function(a,c,b,e){f(d[a].array,c,b*d[a].len,e*d[a].len);d[a].dirty=!0};this.repeat=function(a,c,b,e){for(var n=0;n<e;n++)f(d[a].array,c,(b+n)*d[a].len,d[a].len);d[a].dirty=!0};this.count=function(){return c};this.data=function(a){return d[a].array};this.update=function(){for(name in d)d[name].dirty&&
(d[name].buffer&&d[name].buffer.update(d[name].array,0),d[name].dirty=!1)}}function Va(a){ba||(ba=z(a.gl,w+"shaders/selbox"));var e=!1,d=!1,b=null,c=null,f=la(a.gl,6,2),k=I(a.gl,xa(0,0,1,1),2);a.canvas.bind("mousedown",function(g){e&&(show=d=!0,c=b=a.camera.percent(new vect(g.clientX,g.clientY)),f.update(x(b,c),0))});var j=function(){};this.select=function(a){j=a};$(document).bind("mouseup",function(){if(e&&d){var f=a.camera.project(a.camera.pixel(b)),l=a.camera.project(a.camera.pixel(c));if(f.x>
l.x){var k=f.x;f.x=l.x;l.x=k}f.y>l.y&&(k=f.y,f.y=l.y,l.y=k);d=!1;j(new S(f,l))}});$(document).bind("click",function(){e&&(show=!1)});$(document).bind("mousemove",function(k){e&&d&&(c=a.camera.percent(new vect(k.clientX,k.clientY)),f.update(x(b,c),0))});this.enable=function(){e=!0};this.disable=function(){e=!1};this.draw=function(){d&&(gl.useProgram(ba),ba.data("pos",f),ba.data("edge_in",k),gl.drawArrays(gl.TRIANGLES,0,f.numItems))}}function Da(a,e){for(;a>=e;)a-=e;for(;0>a;)a+=e;return a}function Wa(a,
e,d,b){this.current=a;this.upper=e;this.lower=d;this.index=b}function Ea(a,e){for(var d=0;d<a.length;d++)if(a[d]==e)return!0;return!1}function ja(a,e,d){if(void 0==e)throw"whoa";return 0==a[e+1].y-a[e].y?Math.min(a[e].x,a[e+1].x):a[e].x+(a[e+1].x-a[e].x)*((d-a[e].y)/(a[e+1].y-a[e].y))}function T(a,e){for(var d=0;d<a.length;d++)if(a[d]==e)return d;return!1}function D(a,e,d){return new vect(ja(e,d,e[a].y),e[a].y)}function K(a,e){if(!e)throw"eek";a.push(e.x);a.push(e.y)}function U(a,e,d){if(!e||!d||
3!=d.length+e.length&&4!=d.length+e.length)throw"ahh";if(3==e.length+d.length){for(var b=0;b<e.length;b++)K(a,e[b]);for(b=0;b<d.length;b++)K(a,d[b])}else e[1].x<e[0].x&&(b=e[0],e[0]=e[1],e[1]=b),d[1].x<d[0].x&&(b=d[0],d[0]=d[1],d[1]=b),K(a,e[0]),K(a,e[1]),K(a,d[1]),K(a,d[0]),K(a,d[1]),K(a,e[0])}function Xa(a){for(var e=[],d=0,b=[],c=0;c<a.length;c++){for(var f=0;f<a[c].length-1;f++){var k=Da(f+1,a[c].length-1),j=Da(f-1,a[c].length-1);e.push(new Wa(f+d,k+d,j+d,c));b.push(a[c][f])}b.push(a[c][0]);d+=
a[c].length}e.sort(function(a,c){return b[a.current].y-b[c.current].y});a=[];c=[];new vect(-200,0);new vect(200,0);d=0;d=[];j=[];for(f=0;f<e.length;f++){var g=e[f],k=Ea(a,g.lower),l=Ea(a,g.current),n,r;if(k&&!l)r=n=T(a,g.lower);else if(l&&!k)n=r=T(a,g.current);else if(k&&l)n=T(a,g.lower),r=T(a,g.current);else if(!k&&!l){a:{n=a;r=b;for(var m=b[g.current].x,h=b[g.current].y,p=0;p<n.length;p++){var C=ja(r,n[p],h);if(C>m||0==C-m&&r[n[p]].y>r[index].y){r=p;break a}}r=n.length}n=r}if(1<Math.abs(n-r)){for(k=
0;k<a.length;k++);throw"Bad";}m=vect.left(b[g.lower],b[g.current],b[g.upper]);h=Math.floor(Math.min(n,r)/2);!m&&!k&&!l?(U(j,c[h],[D(g.current,b,a[r-1]),D(g.current,b,a[r])]),c.splice(h,1,[D(g.current,b,a[r-1]),b[g.current]],[b[g.current],D(g.current,b,a[n])])):m&&!k&&!l?c.splice(h,0,[b[g.current]]):k&&!l?(U(j,c[h],[D(g.current,b,a[Math.max(n,r)-1]),b[g.current]]),c[h]=[D(g.current,b,a[Math.min(n,r)-1]),b[g.current]]):!k&&l?(U(j,c[h],[b[g.current],D(g.current,b,a[Math.min(r,n)+1])]),c[h]=[b[g.current],
D(g.current,b,a[Math.max(r,n)+1])]):!m&&k&&l?(U(j,c[h],[D(g.current,b,a[Math.min(n,r)-1]),b[g.current]]),U(j,c[h+1],[D(g.current,b,a[Math.max(n,r)+1]),b[g.current]]),c.splice(h,2,[D(g.current,b,a[Math.min(n,r)-1]),D(g.current,b,a[Math.max(n,r)+1])])):m&&(k&&l)&&(U(j,c[h],[b[g.current]]),c.splice(h,1));k&&!l?a[n]=g.current:l&&!k?a[r]=g.lower:k&&l?(a.splice(T(a,g.lower),1),a.splice(T(a,g.current),1)):!k&&!l&&(m?a.splice(n,0,g.lower,g.current):a.splice(n,0,g.current,g.lower));for(k=0;k<a.length-1;k++)if(ja(b,
a[k],b[g.current].y)>ja(b,a[k+1],b[g.current].y))throw console.log("Misplaced Sweep"),"Misplace!";}if(0<a.length)throw console.log(a),"Bad "+a.length;if(0<d.length)throw console.log(d),"Wrong";return j}function S(a,e){this.min=a.clone();this.max=e.clone();this.contains=function(d){return a.x<=d.x&&e.x>=d.x&&a.y<=d.y&&e.y>=d.y};this.x_in=function(d){return a.x<=d.x&&e.x>=d.x};this.x_left=function(d){return a.x>=d.x};this.x_right=function(a){return e.x<=a.x};this.y_in=function(d){return a.y<=d.y&&e.y>=
d.y};this.y_left=function(d){return a.y>=d.y};this.y_right=function(a){return e.y<=a.y};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(a){switch(a){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);default:throw"Index out of bounds: "+a;}};this.intersects=
function(a){for(var b=0;4>b;b++)for(var c=0;4>c;c++)if(vect.intersects(this.vertex(b),this.vertex((b+1)%4),a.vertex(c),a.vertex((c+1)%4)))return!0;return this.contains(a.min)&&this.contains(a.max)&&this.contains(new vect(a.min.x,a.max.y))&&this.contains(new vect(a.max.x,a.min.y))||a.contains(this.min)&&a.contains(this.max)&&a.contains(new vect(this.min.x,this.max.y))&&a.contains(new vect(this.max.x,this.min.y))?!0:!1};this.union=function(a){this.min.x=Math.min(this.min.x,a.min.x);this.min.y=Math.min(this.min.y,
a.min.y);this.max.x=Math.max(this.max.x,a.max.x);this.max.y=Math.max(this.max.y,a.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new S(a,e)}}function pa(a,e,d,b){this.data=a[b];this.right=this.left=null;e!=b&&(this.left=new pa(a,e,b-1,parseInt((e+(b-1))/2)));d!=b&&(this.right=new pa(a,b+1,d,parseInt((d+(b+1))/2)));this.subtree=[];for(b=e;b<=d;b++)this.subtree.push(a[b]);this.subtree.sort(function(a,b){return a.y-
b.y});this.yrange=function(a,b,d){return a.y_in(this.subtree[b])&&a.y_in(this.subtree[d])};this.subquery=function(a,b,d,e,g){if(this.yrange(b,d,e))for(b=d;b<=e;b++)a.push(this.subtree[b]);else b.y_in(this.subtree[g])&&a.push(this.subtree[g]),b.y_left(this.subtree[g])?g!=e&&this.subquery(a,b,g+1,e,parseInt((e+(g+1))/2)):(b.x_right(this.subtree[g])||g!=e&&this.subquery(a,b,g+1,e,parseInt((e+(g+1))/2)),g!=d&&this.subquery(a,b,d,g-1,parseInt((d+(g-1))/2)))};this.search=function(b,f){f.x_in(a[e])&&f.x_in(a[d])?
this.subquery(b,f,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2)):(f.contains(this.data)&&b.push(this.data),f.x_left(this.data)?this.right&&this.right.search(b,f):f.x_right(this.data)?this.left&&this.left.search(b,f):(this.left&&this.left.search(b,f),this.right&&this.right.search(b,f)))}}function qa(a){a.sort(function(a,d){return a.x-d.x});this.root=new pa(a,0,a.length-1,parseInt((a.length-1)/2));this.search=function(a){a=a.clone();var d=[];this.root.search(d,a);return d}}function Fa(a){s||
(s=z(w+"shaders/point"),Ga=Y(w+"images/circle.png"));this.id=L();var e=new J(a);e.create("vert",2);e.create("unit",2);e.create("color",3);e.create("alpha",1);var d=this,b=function(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=L();var b=new vect(a.geom[0][0],a.geom[0][1]);this.bounds=new S(b.clone(),b.clone());var c,f,b=0,k={};G(k,a.style,"fill",X);G(k,a.style,"opacity",parseFloat);var g=function(){var a=k.fill;a||(a=d.style("fill"));
a||(a=Ya);e.repeat("color",a.array,c,f)},j=function(){var a=k.opacity;a||(a=d.style("opacity"));a||(a=Za);e.repeat("alpha",[a],c,f)};this.style=function(a,b){if(1==arguments.length)return k[a];k[a]=b;"fill"==a&&g();"opacity"==a&&j()};b=this.geom.length;f=6*b;c=e.alloc(f);$.each(this.geom,function(a,b){e.repeat("vert",b,c+6*a,6);e.write("unit",Ha,c+6*a,6)});g();j()},c=null,f=0,k=!1,j={},g={};this.bounds=null;this.append=function(a){a=new b(a);for(key in a.attr)j[key]=!0;g[a.id]=a;f++;k=!0;c=null;this.bounds?
this.bounds.union(a.bounds):this.bounds=a.bounds.clone();return a};this.features=function(){var a=[];for(key in g)a.push(g[key]);return new y(a)};this.attr=function(){var a=[];for(key in j)a.push(key);return a};this.search=function(a){a=c.search(a.min,a.max);var b=[];$.each(a,function(a,c){b.push(g[c.key])});return new y(b)};this.mouseover=function(){};this.mouseout=function(){};this.click=function(){};this.style=function(a,b){if(1<arguments.length)throw"Not Implemented";return null};this.update_move=
function(){};this.draw=function(a,b,d){e.update(b);if(0<f){if(k){if(!c){var j=[],h;for(h in g)$.each(g[h].geom,function(a,b){j.push({key:h,x:b[0],y:b[1]})});c=new qa(j)}k=!1}gl.useProgram(s);s.data("screen",a.camera.mat3);s.data("pos",e.get("vert"));s.data("circle_in",e.get("unit"));d||(s.data("color_in",e.get("color")),s.data("alpha_in",e.get("alpha")),s.data("select",d),s.data("aspect",a.canvas.width()/a.canvas.height()),s.data("pix_w",2/a.canvas.width()),s.data("rad",5),s.data("glyph",Ga),s.data("zoom",
1/a.camera.level),gl.drawArrays(gl.TRIANGLES,0,e.count()))}}}function $a(){var a={},e={},d=!1,b={},c={},f=!1;this.style=function(c,e){if(2>arguments.length)return void 0!==b[c]?b[c]:null;b[c]=e;if(d)for(var f in a)a[f].update(c)};this.bounds=null;this.features=function(){var a=[],b;for(b in c)a.push(c[b]);return new y(a)};this.search=function(a){f&&this.update();var b=new y([]),c;for(c in e)var d=e[c].search(a),b=b.join(d);return b};this.map_contains=function(a,b){f&&this.update();var c=new y([]),
d;for(d in e)var k=e[d].map_contains(a,b),c=c.join(k);return c};this.append=function(b){b=new ca[b.type].geometry(b,this);c[b.id]=b;this.bounds?this.bounds.union(b.bounds):this.bounds=b.bounds.clone();d&&b.initialize(a[b.type]);f=!0};var k=null,j=null;this.mouseover=function(a){k=a};this.mouseout=function(a){j=a};var g={};this.update_move=function(a,b){if(k||j){var c=this.map_contains(a,b),d={};c&&c.each(function(a,b){d[b.id]=b});for(var e in g)!(e in d)&&j&&j(g[e]);for(e in d)!(e in g)&&k&&k(d[e]);
g=d}};this.force_out=function(){for(var a in g)j&&j(g[a]);g={}};this.initialize=function(b){for(var e in ca)a[e]=new ca[e].renderer(b,this);d=!0;for(var f in c)c[f].initialize(a[c[f].type])};this.update=function(){var a=this.features(),b;for(b in ca)e[b]=new ca[b].collection(a.type(b).items());f=!1};this.draw=function(){f&&this.update();if(!d)throw"Layer has not yet been initialized";for(var b in a)a[b].draw()}}function Ia(a){function e(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||
(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=L();var b,c,d,e=0,f=function(){var a;a="fill"in h?h.fill:l.style("fill");j.repeat("color",a.array,b,c);a="stroke"in h?h.stroke:l.style("stroke");g.repeat("color",a.array,d,e)},k=function(){var a;a="fill-opacity"in h?h["fill-opacity"]:l.style("fill-opacity");j.repeat("alpha",[a],b,c);a="stroke-opacity"in h?h["stroke-opacity"]:l.style("stroke-opacity");g.repeat("alpha",[a],d,e)},n=new vect(Infinity,Infinity),r=new vect(-Infinity,-Infinity);$.each(this.geom,
function(a,b){$.each(b,function(a,b){$.each(b,function(a,b){b[0]<n.x&&(n.x=b[0]);b[0]>r.x&&(r.x=b[0]);b[1]<n.y&&(n.y=b[1]);b[1]>r.y&&(r.y=b[1])})})});this.bounds=new S(n,r);this.initialize=function(){var a=[];c=0;$.each(this.geom,function(b,d){for(var e,f=0;100>f;)try{for(var k=d,g=[],j=0;j<k.length;j++){for(var l=[],n=1;n<k[j].length;n++)l.push(Ja(k[j][n][0],k[j][n][1]));l.push(g[0]);g.push(l)}e=Xa(g);break}catch(Z){f++}if(100==f)throw"Rendering Polygon Failed";c+=e.length/2;a.push(e)});var l=b=
j.alloc(c);$.each(a,function(a,b){var c=b.length/2;j.write("vert",b,l,c);l+=c});d=g.count();$.each(this.geom,function(a,b){for(a=0;a<b.length;a++)e+=6*b[a].length,Ka(g,b[a])});f();k()};var h={};G(h,a.style,"fill",X);G(h,a.style,"stroke",X);G(h,a.style,"fill-opacity",parseFloat);G(h,a.style,"stroke-opacity",parseFloat);this.style=function(a,b){if(1==arguments.length)return h[a];h[a]=b;"fill"==a&&f();"stroke"==a&&f();"fill-opacity"==a&&k();"stroke-opacity"==a&&k()}}a||(a={});a.style||(a.style={});var d,
b,c,f;d="fill"in a.style?a.style.fill:new u(0.02,0.44,0.69,1);b="stroke"in a.style?a.style.stroke:new u(0.02,0.44,0.69,1);c="fill-opacity"in a.style?a.style["fill-opacity"]:0.5;f="stroke-opacity"in a.style?a.style["stroke-opacity"]:1;var k=!1;this.id=L();var j,g,l=this,n={},r=0,h=null;this.features=function(){var a=[];for(key in n)a.push(n[key]);return new y(a)};this.search=function(a){a=h.search(a.min,a.max);var b={};$.each(a,function(a,c){b[c.key]=!0});a=[];for(var c in b)a.push(n[c]);return new y(a)};
this.contains=function(a){var b=0,c=[],d;for(d in n){var e=n[d];if(e.bounds.contains(a)){b++;for(var f=0;f<e.geom.length;f++){var k=0;$.each(e.geom[f],function(b,c){for(var d=0;d<c.length;d++){var e=(d+1)%c.length;if(0>(a.y-c[d][1])/(a.y-c[e][1])){var f=new vect(720,a.y),g=new vect(c[d][0],c[d][1]),e=new vect(c[e][0],c[e][1]);vect.intersects(a,f,g,e)&&k++}}});1==k%2&&c.push(e)}}}return new y(c)};this.aggregate=function(a,b){a.features().each(function(a,c){$.each(c.geom,function(a,d){var e=l.contains(new vect(d[0],
d[1]));e&&b(e,c)})})};this.bounds=null;var m=!1;this.append=function(a){a=new e(a);this.bounds?this.bounds.union(a.bounds):this.bounds=a.bounds.clone();n[a.id]=a;r++;m=!0;h=null;k&&a.initialize()};this.style=function(a,e){if(1<arguments.length)throw"Not Implemented";return"fill"==a?d:"stroke"==a?b:"fill-opacity"==a?c:"stroke-opacity"==a?f:null};var p=null,C=null;this.mouseover=function(a){p=a};this.mouseout=function(a){C=a};var F={};this.update_move=function(a,b){if(p||C){var c=this.contains(b),d=
{};c&&c.each(function(a,b){d[b.id]=b});for(var e in F)!(e in d)&&C&&C(F[e]);for(e in d)!(e in F)&&p&&p(d[e]);F=d}};this.force_out=function(){for(var a in F)C&&C(F[a]);F={}};this.initialize=function(a){N||(N=z(a.gl,w+"shaders/poly"));t||(t=z(a.gl,w+"shaders/line"));j=new J(a.gl,1024);j.create("vert",2);j.create("color",3);j.create("alpha",1);g=new J(a.gl,1024);g.create("vert",2);g.create("norm",2);g.create("color",3);g.create("alpha",1);for(var b in n)n[b].initialize();k=!0};this.draw=function(a,b,
c){if(!c){c=a.gl;j.update(b);g.update(b);if(m){var d=[],e;for(e in n)$.each(n[e].geom,function(a,b){$.each(b,function(a,b){$.each(b,function(a,b){d.push({key:e,x:b[0],y:b[1]})})})});h=new qa(d);m=!1}c.useProgram(N);N.data("screen",a.camera.mat3);N.data("pos",j.get("vert"));N.data("color_in",j.get("color"));N.data("alpha_in",j.get("alpha"));c.drawArrays(c.TRIANGLES,0,j.count());c.useProgram(t);t.data("screen",a.camera.mat3);t.data("pos",g.get("vert"));t.data("norm",g.get("norm"));t.data("color_in",
g.get("color"));t.data("alpha_in",g.get("alpha"));t.data("px_w",2/a.canvas.width());t.data("px_h",2/a.canvas.height());c.drawArrays(c.TRIANGLES,0,g.count())}}}function Ka(a,e){for(var d=a.alloc(6*e.length),b=0,c=function(){if(e[b]){var a=new vect(e[b][0],e[b][1]);b++;return a}return null},f=[],k=[],j=function(a,b,c,d){d?(a[c]=-b.x,a[c+1]=-b.y):(a[c]=b.x,a[c+1]=b.y)},g=function(a,b,c,d){j(a,b,0,!1);j(a,c,2,!1);j(a,b,4,d);j(a,c,6,d);j(a,b,8,d);j(a,c,10,!1)},l=c(),n=c(),h=c(),m=vect.dir(n,l).rotate(ra/
2),p,q=d;n;)p=h?vect.dir(h,l).rotate(ra/2):vect.dir(n,l).rotate(ra/2),g(f,l,n,!1),g(k,m,p,!0),a.write("vert",f,q,6),a.write("norm",k,q,6),q+=6,l=n,n=h,h=c(),m=p;return d}function sa(a){E||(E=z(w+"shaders/grid"));a||(a={});a.style||(a.style={});var e=a.lower,d=a.upper,b=a.rows,c=a.cols,f=(d.x-e.x)/c,k=(d.y-e.y)/b,j=new Float32Array(b*c),g=new Uint8Array(4*c*b),l=!1,n=new J(6);n.create("vert",2);n.create("screen",2);n.create("tex",2);var h=new vect(e.x,e.y),m=new vect(d.x,d.y),p=new vect(0,0),q=new vect(1,
1),s=n.alloc(6);n.write("vert",x(h,m),s,6);n.write("screen",x(new vect(-1,-1),new vect(1,1)),s,6);n.write("tex",x(p,q),s,6);var F=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,F);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);this.lower=function(){return e.clone()};
this.upper=function(){return d.clone()};this.rows=function(){return b};this.cols=function(){return c};this.centroid=function(a,b){return new vect(e.x+f*b+f/2,e.y+k*a+k/2)};this.get=function(a,b){return j[c*a+b]};var Z=-Infinity,ia=Infinity;this.qunatiles=function(a,b){b||(b=function(a,b){return a-b});for(var c=[],d=0;d<j.length;d++)c.push(j[d]);c.sort(b);for(var e=[-Infinity],d=1;d<a;d++){var f=parseInt(inc*d);e.push(c[f])}e.push(Infinity);return e};this.set=function(a,d,e){if(a>=b||d>=c)throw"Index Out of Bounds";
j[c*a+d]=e;l=!0};this.raw_set=function(a,d){if(a>=b*c)throw"Index Out of Bounds: "+a;j[a]=d;l=!0};this.clear=function(a){for(var d=0;d<b*c;d++)j[d]=a};var aa=null;this.draw=function(d){aa||(aa=d.framebuffer());n.update();if(l){Z=-Infinity;ia=Infinity;for(var e=0;e<b*c;e++){var f=j[e];f>Z&&(Z=f);f<ia&&(ia=f)}for(e=0;e<b*c;e++){var f=e,k=a.map(ia,Z,j[e]);g[4*f]=parseInt(255*k.r);g[4*f+1]=parseInt(255*k.g);g[4*f+2]=parseInt(255*k.b);g[4*f+3]=parseInt(255*k.a)}gl.bindTexture(gl.TEXTURE_2D,F);gl.texImage2D(gl.TEXTURE_2D,
0,gl.RGBA,c,b,0,gl.RGBA,gl.UNSIGNED_BYTE,g);gl.bindTexture(gl.TEXTURE_2D,null);l=!1}a.style.antialias&&aa.activate({blend:!1});gl.useProgram(E);E.data("screen",d.camera.mat3);E.data("pos",n.get("vert"));E.data("tex_in",n.get("tex"));E.data("sampler",F);e=vect.sub(d.camera.screen(m),d.camera.screen(h));E.data("width",e.x);E.data("height",-e.y);E.data("rows",b);E.data("cols",c);E.data("blur",a.blur);gl.drawArrays(gl.TRIANGLES,0,n.count());a.style.antialias&&(aa.deactivate(),d.draw_blur(aa.tex))}}function ab(a,
e,d){O||(O=z(w+"shaders/raster"));this.image=Y(a);var b=I(x(new vect(0,1),new vect(1,0)),2),c=I(x(e,d),2);this.draw=function(a,d,e){e||(gl.useProgram(O),O.data("screen",a.camera.mat3),O.data("pos",c),O.data("tex_in",b),O.data("sampler",this.image),gl.drawArrays(gl.TRIANGLES,0,c.numItems))}}function ta(a){A||(A=z(w+"shaders/hillshade"));var e=$(a).find("LatLonBox"),d=new vect(parseFloat(e.find("west").text()),parseFloat(e.find("south").text())),b=new vect(parseFloat(e.find("east").text()),parseFloat(e.find("north").text()));
a=$(a).find("GroundOverlay Icon href").text();var c=!1,f=Y(a,function(){c=!0});this.ready=function(){return c};var k=I(x(new vect(0,1),new vect(1,0)),2),j=I(x(d,b),2),g=315;this.draw=function(a){if(c){for(gl.useProgram(altitude_shader);1<=g;)g-=1;altitude_shader.data("azimuth",g);altitude_shader.data("altitude",Math.PI/4/(2*Math.PI));altitude_shader.data("screen",a.camera.mat3);altitude_shader.data("pos",j);altitude_shader.data("tex_in",k);altitude_shader.data("elevation",f);a=vect.sub(a.camera.screen(b),
a.camera.screen(d));altitude_shader.data("pix_w",1/a.x);altitude_shader.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,j.numItems);return g}}}function ta(a){A||(A=z(w+"shaders/hillshade"));var e=$(a).find("LatLonBox"),d=new vect(parseFloat(e.find("west").text()),parseFloat(e.find("south").text())),b=new vect(parseFloat(e.find("east").text()),parseFloat(e.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var c=!1,f=Y(a,function(){c=!0});this.ready=function(){return c};var k=I(x(new vect(0,
1),new vect(1,0)),2),j=I(x(d,b),2),g=315;this.draw=function(a){if(c){for(gl.useProgram(A);1<=g;)g-=1;A.data("azimuth",g);A.data("altitude",Math.PI/4/(2*Math.PI));A.data("screen",a.camera.mat3);A.data("pos",j);A.data("tex_in",k);A.data("elevation",f);a=vect.sub(a.camera.screen(b),a.camera.screen(d));A.data("pix_w",1/a.x);A.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,j.numItems);return g}}}function ha(a){for(var e=[],d=[],b=0;b<a.levels;b++){var c=p(a);"file"==c.source&&(c.url+="/"+a.size*Math.pow(2,
b+1));c.min=new vect(-180,-90);c.rows=Math.pow(2,b);c.cols=2*c.rows;c.cellsize=180/c.rows;c.z_index=1-ua-b/1E3;c.available=d;c=new bb(c);e.push(c)}ua+=(a.levels+2)/1E3;var f=null;this.initialize=function(a){B||(B=z(a.gl,w+"shaders/tile"));f=new J(a.gl,6*da);f.create("vert",3);f.create("tex",2);f.create("lookup",1);f.alloc(6*da);for(var b=0;25>b;b++)d.push(new ma(a.gl));for(b=0;b<e.length;b++)e[b].initialize(a);e[0].fetch_all();e[0].noexpire(!0)};this.draw=function(b,c){gl.useProgram(B);B.data("screen",
b.camera.mat3);La=Ma=0;for(var d=Infinity,l=e[0],n,h=0;h<e.length;h++){var m=a.size*e[h].cols/e[h].size(b).x;1>m&&(m=1/m);m<d&&(d=m,l=e[h],n=h)}for(h=n;0<=h;h--)e[h].fetch();if(l.ready())l.draw(b,c,f,0,!0);else{b.enable_z();d=0;for(h=n;0<=h;h--)d=e[h].draw(b,c,f,d,0==h);b.disable_z()}$.each(e,function(a,b){b.cull()})}}function bb(a){a||(a={});a.desaturate||(a.desaturate=0);a.darken||(a.darken=0);a.hue||(a.hue=0);a.hue_color||(a.hue_color=wa(0,0,0,1));if(!a.available){a.available=[];for(var e=0;8>
e;e++)a.available.push(new ma(d))}var d=null,b=a.url,c=a.min,f=a.rows,k=a.cols,j=a.cellsize;this.rows=f;this.cols=k;for(var g={},l={},n=function(b,d){var e=new vect(c.x+b*j,c.y+d*j),f=new vect(c.x+(b+1)*j,c.y+(d+1)*j),e={vert:x(e,f,a.z_index),tex:null,i:b,j:d,id:b+k*d,ready:!1,min:e,max:f};l[b][d]=e;g[e.id]=e},e=0;e<k;e++)l[e]={};this.size=function(a){var b=a.camera.screen(c);a=a.camera.screen(vect.add(c,new vect(j*k,j*f)));b=vect.sub(a,b);b.y=Math.abs(b.y);return b};var h=!1;this.noexpire=function(a){h=
a};this.cull=function(){if(!h){var b=(new Date).getTime(),c;for(c in p)if(b-p[c]>cb){var d=g[c];delete g[c];delete l[d.i][d.j];a.available.push(d.tex);d.tex=null;d.ready=!1;delete p[c]}}};var m=function(){var a=engine.camera.project(new vect(engine.canvas.offset().left,engine.canvas.offset().top+engine.canvas.height())),b=engine.camera.project(new vect(engine.canvas.offset().left+engine.canvas.width(),engine.canvas.offset().top)),d=Math.floor((a.x-c.x)/j),e=Math.ceil((b.x-c.x)/j),a=Math.floor((a.y-
c.y)/j),b=Math.ceil((b.y-c.y)/j);return{min_col:d,max_col:e,min_row:a,max_row:b}},p={};this.ready=function(){for(var a=m(),b=Math.max(0,a.min_col);b<Math.min(k,a.max_col);b++)for(var c=Math.max(0,a.min_row);c<Math.min(f,a.max_row);c++)if(!l[b][c]||!l[b][c].ready)return!1;return!0};var q=function(c,e){if(!l[c][e].tex){var f;if("file"==a.source)f=b+"/"+l[c][e].id+".png";else if("wms"==a.source){f={service:"wms",version:"1.1.0",request:"GetMap",layers:a.layer,bbox:[l[c][e].min.x,l[c][e].min.y,l[c][e].max.x,
l[c][e].max.y].join(),width:a.size,height:a.size,srs:"EPSG:4326",format:"image/png",transparent:"true"};var k=[],g;for(g in f)k.push(g+"="+f[g]);f=b+"?"+k.join("&")}l[c][e].tex=a.available.pop();l[c][e].tex||(l[c][e].tex=new ma(d));g=f;var j=l[c][e],n=new Image;n.crossOrigin="";n.onload=function(){j.tex&&(j.tex.image(n),j.ready=!0)};n.src=g}};this.fetch_all=function(){for(var a=(new Date).getTime(),b=0;b<k;b++)for(var c=0;c<f;c++)l[b][c]||n(b,c),l[b][c].tex||q(b,c),p[l[b][c].id]=a};this.fetch=function(){for(var a=
m(),b=(new Date).getTime(),c=Math.max(0,a.min_col-1);c<Math.min(k,a.max_col+1);c++)for(var d=Math.max(0,a.min_row-1);d<Math.min(f,a.max_row+1);d++)l[c][d]||n(c,d),l[c][d].tex||q(c,d),p[l[c][d].id]=b};var s=!1;this.initialize=function(a){if(s)throw"Not Implemented: Migrating Tile Layers to New Map";B||(B=z(a.gl,w+"shaders/tile"));d=a.gl;s=!0};this.draw=function(b,c,e,g,j){s||this.initialize(b);b=function(){La++;e.update();B.data("pos",e.get("vert"));B.data("tex_in",e.get("tex"));B.data("lookup_in",
e.get("lookup"));B.data("desaturate",a.desaturate);B.data("darken",a.darken);B.data("hue",a.hue);B.data("hue_color",a.hue_color.array);d.drawArrays(d.TRIANGLES,0,6*g)};c=m();for(var n=(new Date).getTime(),h=Math.max(0,c.min_col);h<Math.min(k,c.max_col);h++)for(var r=Math.max(0,c.min_row);r<Math.min(f,c.max_row);r++)if(l[h][r]&&l[h][r].ready&&l[h][r].tex){e.write("vert",l[h][r].vert,6*g,6);e.write("tex",x(new vect(0,0),new vect(1,1)),6*g,6);e.repeat("lookup",[g/da+1/(2*da)],6*g,6);p[l[h][r].id]=n;
B.data("sampler"+g,l[h][r].tex);if(null==l[h][r].tex)throw"badness";g++;Ma++;g>=da&&(b(),g=0)}j&&b();return g}}var w="",V=jQuery,db=function(a){if("string"===typeof a.data){var e=a.handler,d=a.data.toLowerCase().split(" ");a.handler=function(a){if(!(this!==a.target&&(/textarea|select/i.test(a.target.nodeName)||"text"===a.target.type))){var c="keypress"!==a.type&&V.hotkeys.specialKeys[a.which],f=String.fromCharCode(a.which).toLowerCase(),k="",j={};a.altKey&&"alt"!==c&&(k+="alt+");a.ctrlKey&&"ctrl"!==
c&&(k+="ctrl+");a.metaKey&&(!a.ctrlKey&&"meta"!==c)&&(k+="meta+");a.shiftKey&&"shift"!==c&&(k+="shift+");c?j[k+c]=!0:(j[k+f]=!0,j[k+V.hotkeys.shiftNums[f]]=!0,"shift+"===k&&(j[V.hotkeys.shiftNums[f]]=!0));c=0;for(f=d.length;c<f;c++)if(j[d[c]])return e.apply(this,arguments)}}}};V.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",
45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">",
"/":"?","\\":"|","[":"{","]":"}"}};V.each(["keydown","keyup","keypress"],function(){V.event.special[this]={add:db}});var M=jQuery,va=function(a){var e=a||window.event,d=[].slice.call(arguments,1),b=0,c=0,f=0;a=M.event.fix(e);a.type="mousewheel";e.wheelDelta&&(b=e.wheelDelta/120);e.detail&&(b=-e.detail/3);f=b;void 0!==e.axis&&e.axis===e.HORIZONTAL_AXIS&&(f=0,c=-1*b);void 0!==e.wheelDeltaY&&(f=e.wheelDeltaY/120);void 0!==e.wheelDeltaX&&(c=-1*e.wheelDeltaX/120);d.unshift(a,b,c,f);return(M.event.dispatch||
M.event.handle).apply(this,d)},W=["DOMMouseScroll","mousewheel"];if(M.event.fixHooks)for(var P=W.length;P;)M.event.fixHooks[W[--P]]=M.event.mouseHooks;M.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=W.length;a;)this.addEventListener(W[--a],va,!1);else this.onmousewheel=va},teardown:function(){if(this.removeEventListener)for(var a=W.length;a;)this.removeEventListener(W[--a],va,!1);else this.onmousewheel=null}};M.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",
a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}});for(var Na=0,P=["ms","moz","webkit","o"],ea=0;ea<P.length&&!window.requestAnimationFrame;++ea)window.requestAnimationFrame=window[P[ea]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[P[ea]+"CancelAnimationFrame"]||window[P[ea]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var e=(new Date).getTime(),d=Math.max(0,16-(e-Na)),b=window.setTimeout(function(){a(e+
d)},d);Na=e+d;return b});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});var ra=3.14159265,G=function(a,e,d,b){d in e&&(a[d]=b?b(e[d]):e[d])},Ua=!1,za=0,Qa={fill:new u(0.02,0.44,0.69,1),opacity:1,radius:5},na="http://eland.ecohealthalliance.org/wigglemaps",R={x:0,y:0},v=null,Ba=null,ba=null,s=null,Ga,Ha=xa(0,0,1,1),Ya=new u(0.02,0.44,0.69,1),Za=1,s=null,ca={Point:{geometry:function(a,e){var d={},b=null;this.id=L();this.type=a.type;this.attr=function(){};this.geom=
a.geom;this.geometry=function(){};this.initialize=function(a){b=a.create(this);b.update_all()};this.compute=function(a){return Aa(this,e,a)};this.style=function(a,c,e){if(2>arguments.length)return void 0!==d[a]?d[a]:null;d[a]=c;b&&b.update(a)};this.bounds=null;for(var c=0;c<this.geom.length;c++){var f=new vect(this.geom[c][0],this.geom[c][1]),f=new S(f.clone(),f.clone());this.bounds?this.bounds.union(f):this.bounds=f}this.map_contains=function(a,b){for(var c=a.camera.screen(b),d=this.compute("radius");0<
this.geom.length;){var e=a.camera.screen(new vect(this.geom[0][0],this.geom[0][1]));return vect.dist(e,c)<d}}},renderer:function(a,e){s||(s=z(a.gl,w+"shaders/point"));var d=new J(a.gl,1024);d.create("vert",2);d.create("unit",2);d.create("color",3);d.create("alpha",1);var b=[],c=function(a){var b,c,g={fill:function(a){d.repeat("color",a.array,b,c)},opacity:function(a){d.repeat("alpha",[a],b,c)}};this.update=function(b){var c=Aa(a,e,b);if(!c)throw"Style property does not exist";g[b](c)};this.update_all=
function(){for(var a in g)this.update(a)};var l=a.geom;c=6*l.length;b=d.alloc(c);$.each(l,function(a,c){d.repeat("vert",c,b+6*a,6);d.write("unit",Ha,b+6*a,6)});this.update_all()};this.create=function(a,d){var e=new c(a,d);b.push(e);return e};this.update=function(a){for(var c=0;c<b.length;c++)b[c].update(a)};this.draw=function(){d.update();gl.useProgram(s);s.data("screen",a.camera.mat3);s.data("pos",d.get("vert"));s.data("circle_in",d.get("unit"));s.data("color_in",d.get("color"));s.data("alpha_in",
d.get("alpha"));s.data("aspect",a.canvas.width()/a.canvas.height());s.data("pix_w",2/a.canvas.width());s.data("rad",5);s.data("zoom",1/a.camera.level);gl.drawArrays(gl.TRIANGLES,0,d.count())}},collection:function(a){var e=[],d=0;$.each(a,function(a,b){var k=b.compute("radius");k>d&&(d=k);$.each(b.geom,function(a,c){e.push({x:c[0],y:c[1],ref:b})})});var b=new qa(e);this.search=function(a){a=b.search(a);var d=[];$.each(a,function(a,b){d.push(b.ref)});return new y(d)};this.map_contains=function(a,e){var k=
a.camera.screen(e),j=vect.add(k,new vect(-d,d)),k=vect.add(k,new vect(d,-d)),j=new S(a.camera.project(j),a.camera.project(k)),j=b.search(j),g=[];$.each(j,function(b,d){d.ref.map_contains(a,e)&&g.push(d.ref)});return new y(g)}}}},L,Oa=1;L=function(){var a=Oa;Oa++;return a};var Ja;Ja=function(a,e){return new vect(a+1E-6*Math.random()-5E-7,e+1E-6*Math.random()-5E-7)};var N=null,t,E=null,y=function(a){var e=null;this.length=a.length;this.count=function(){return a.length};this.items=function(){return a};
this.type=function(b){for(var c=[],d=0;d<a.length;d++)a[d].type==b&&c.push(a[d]);return new y(c)};this.join=function(b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]);for(d=0;d<b.count();d++){var e=b.get(d);this.id(e.id)||c.push(e)}return new y(c)};this.attr=function(b){return a.length?a[0].attr[b]:null};this.get=function(b){return a[b]};this.subset=function(b){for(var c=[],d=0;d<b.length;d++)c.push(a[b[d]]);return new y(c)};this.id=function(b){if(!e){e={};for(var c=0;c<a.length;c++)e[a[c].id]=a[c]}return b in
e?e[b]:null};this.each=function(b){for(var c=0;c<a.length;c++)b(c,a[c]);return this};var d={">":function(a,c){return a>c},"<":function(a,c){return a<c},"==":function(a,c){return a==c},">=":function(a,c){return a>=c},"<=":function(a,c){return a<=c}};this.select=function(b){if(b.match(/^\s*\*\s*$/))return new y(a);var c=b.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!c)throw"Bad Selector";b=c[1];var e=c[2],k=null,j=null;isNaN(c[3])?j=c[3]:k=parseFloat(c[3]);new_elem=[];if(j)for(c=0;c<a.length;c++)d[e](a[c].attr[b],
a[c].attr[j])&&new_elem.push(a[c]);else for(c=0;c<a.length;c++)d[e](a[c].attr[b],k)&&new_elem.push(a[c]);return new y(new_elem)};this.filter=function(b){for(var c=[],d=0;d<a.length;d++)b(a[d])&&c.push(a[d]);return new y(c)};this.quantile=function(b,c,d){a.sort(function(a,c){return a.attr[b]-c.attr[b]});var e=Math.round(c*this.length/d);c=Math.round((c-1)*this.length/d);return new y(a.slice(c,e))};this.range=function(b){for(var c=Infinity,d=-Infinity,e=0;e<a.length;e++)c>a[e].attr[b]&&(c=a[e].attr[b]),
d<a[e].attr[b]&&(d=a[e].attr[b]);return{min:c,max:d}};this.style=function(b,c){if(1==arguments.length){var d=[];$.each(a,function(a,c){d.push(c.style(b))});return d}if("function"==typeof c)$.each(a,function(a,d){d.style(b,c(d))});else{var e;a:if(null==c||void 0==c.length)e=!1;else{for(e=0;e<c.length;e++)if(!(e in c)){e=!1;break a}e=!0}e?$.each(a,function(a,d){d.style(b,c[a])}):$.each(a,function(a,d){d.style(b,c)})}return this}},O=null,A=null,Q=null,A=null,cb=1E3,ua=0,da=8,Ma=0,La=0,B=null,Pa=[];window.wiggle=
{Map:function(a,e){this.center=function(a,c){engine.camera.position(new vect(a,c))};this.vcenter=function(a){this.center(a.x,a.y)};this.extents=function(a){engine.camera.extents(a)};this.append=function(a){a.initialize(engine);engine.scene.push(a)};this.remove=function(a){for(var c=0;c<engine.scene.length;c++)if(engine.scene[c]==a)return engine.scene.splice(c,1),!0;return!1};this.shade=function(a){a=new ta(a);engine.shade=a};this.select=function(a){a?(engine.sel.select(a),engine.select(!0)):engine.select(!1)};
this.resize=function(){engine.resize()};this.attr=function(a,c){engine.attr(a,c)};this.png=function(){var a=engine.canvas.get(0).toDataURL();$.ajax({url:"../server/export.png",type:"POST",data:a})};this.width=function(){return engine.canvas.innerWidth()};this.height=function(){return engine.canvas.innerHeight()};var d=null;this.click=function(a){d=a};engine=new Ta(a,this,e);engine.canvas.click(function(a){d&&(a=new vect(a.pageX,a.pageY),a=engine.camera.project(a),d(a))})},layer:{PointLayer:Fa,LineLayer:function(){function a(a){a||
(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=L();var c,e=0,g=function(){var a;a="stroke"in h?h.stroke:b.style("stroke");d.repeat("color",a.array,c,e)},l=function(){var a;a="stroke-opacity"in h?h["stroke-opacity"]:b.style("stroke-opacity");d.repeat("alpha",[a],c,e)};c=d.count();Ka(d,this.geom);var e=6*this.geom.length,h={};G(h,a.style,"fill",X);G(h,a.style,"stroke",X);G(h,a.style,"fill-opacity",parseFloat);G(h,a.style,"stroke-opacity",
parseFloat);this.style=function(a,b){if(1==arguments.length)return h[a];h[a]=b;"fill"==a&&g();"stroke"==a&&g();"fill-opacity"==a&&l();"stroke-opacity"==a&&l()};g();l()}var e=new u(0.02,0.44,0.69,1);t||(t=z(w+"shaders/line"));this.id=L();var d=new J(1024);d.create("vert",2);d.create("norm",2);d.create("unit",2);d.create("color",3);d.create("alpha",1);var b=this,c=0;this.append=function(b){b=new a(b);for(key in b.attr);c++;return b};this.style=function(a,b){if(1<arguments.length)throw"Not Implemented";
return"stroke"==a?e:"stroke-opacity"==a?1:null};this.draw=function(a,b){d.update(b);0<c&&(gl.useProgram(t),t.data("screen",a.camera.mat3),t.data("pos",d.get("vert")),t.data("norm",d.get("norm")),t.data("color_in",d.get("color")),t.data("alpha_in",d.get("alpha")),t.data("px_w",2/a.canvas.width()),t.data("px_h",2/a.canvas.height()),gl.drawArrays(gl.TRIANGLES,0,d.count()))}},PolygonLayer:Ia,Grid:sa,Hillshade:ta,Elevation:function(a){Q||(Q=z(w+"shaders/elevation"));var e=$(a).find("LatLonBox"),d=new vect(parseFloat(e.find("west").text()),
parseFloat(e.find("south").text())),b=new vect(parseFloat(e.find("east").text()),parseFloat(e.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var c=Y(a),f=I(x(new vect(0,1),new vect(1,0)),2),k=I(x(d,b),2);this.draw=function(a,e,h){h||(gl.useProgram(Q),Q.data("screen",a.camera.mat3),Q.data("pos",k),Q.data("tex_in",f),Q.data("elevation",c),vect.sub(a.camera.screen(b),a.camera.screen(d)),gl.drawArrays(gl.TRIANGLES,0,k.numItems))}}},io:{Shapefile:function(a){var e=a.path;$.ajax({url:e+
".shx",mimeType:"text/plain; charset=x-user-defined",success:function(d){for(var b=[],c=100;c<d.length;)b.push(2*ka(d,c)),c+=8;$.ajax({url:e+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(c){for(var d=[],e=[],g=0;g<b.length;g++){var h=b[g];ka(c,h);ka(c,h+4);var n=h+8,m=H(c,n);if(0==m)console.log("NULL Shape");else if(1==m)m=fa(c,n+4),n=fa(c,n+12),d.push({attr:{},geom:[[m,n]]});else if(5==m){for(var m=H(c,n+36),n=H(c,n+40),p=h+52,h=h+52+4*m,q=[],s=0;s<m;s++){var u=H(c,p+4*s),
t;t=s+1<m?H(c,p+4*(s+1)):n;var w=h,x=[];for(t-=1;t>=u;t--){var y=fa(c,w+16*t),z=fa(c,w+16*t+8);x.push([y,z])}q.push(x)}e.push({attr:{},geom:[q]})}else throw"Not Implemented: "+m;}if(0<d.length){var v=new Fa(d.length);$.each(d,function(a,b){v.append(b)});c=v}else 0<e.length?(v=new Ia(a),$.each(e,function(a,b){for(var c=0;100>c;)try{v.append(b),c=101}catch(d){c++}100==c&&console.log("rendering polygon failed")}),c=v):c=void 0;a.success(c)}})}})},GeoJSON:function(a){for(var e=new $a,d=0;d<a.features.length;d++){var b=
a.features[d];if("Feature"==b.type){"Point"==b.geometry.type&&e.append({type:"Point",geom:[b.geometry.coordinates],attr:b.properties});"MultiPoint"==b.geometry.type&&e.append({type:"Point",geom:b.geometry.coordinates,attr:b.properties});if("Polygon"==b.geometry.type){for(var c=b.geometry.coordinates,f=[],h=0;h<=c.length-1;h++){for(var j=[],g=c[h].length-1;0<=g;g--)j.push(c[h][g]);f.push(j)}e.append({type:"Polygon",geom:[f],attr:b.properties})}if("MultiPolygon"==b.geometry.type){var l=[];$.each(b.geometry.coordinates,
function(a,b){for(var c=[],d=0;d<=b.length-1;d++){for(var e=[],f=b[d].length-1;0<=f;f--)e.push(b[d][f]);c.push(e)}l.push(c)});e.append({type:"Polygon",geom:l,attr:b.properties})}"MultiLineString"==b.geometry.type&&$.each(b.geometry.coordinates,function(a,c){e.append({type:"Line",geom:c,attr:b.properties})})}}return e},KML:function(a){var e=$(a).find("LatLonBox"),d=new vect(parseFloat(e.find("west").text()),parseFloat(e.find("south").text())),e=new vect(parseFloat(e.find("east").text()),parseFloat(e.find("north").text()));
a=$(a).find("GroundOverlay Icon href").text();return new ab(w+a,d,e)},SparseGrid:function(a,e){var d=ga(a,0),b=ga(a,4),c=H(a,8),f=H(a,12),h=ga(a,16),j={};for(key in e)j[key]=e[key];j.lower=new vect(d,b);j.upper=new vect(d+h*c,b+h*f);j.rows=f;j.cols=c;d=new sa(j);for(b=20;b<a.length;){for(var h=H(a,b),c=H(a,b+4),f=b+4,j=c,g=0;g<j;g++){var l=ga(a,f+4*g);d.raw_set(h+g,l)}b+=8+4*c}return d},AsciiGrid:function(a,e){var d=a.split("\n"),b=d.splice(0,6),c=parseInt(b[0].slice(14)),f=parseInt(b[1].slice(14)),
h=parseFloat(b[2].slice(14)),j=parseFloat(b[3].slice(14)),g=parseFloat(b[4].slice(14)),b=b[5].slice(14),l={};for(key in e)l[key]=e[key];l.lower=new vect(h,j);l.upper=new vect(h+g*c,j+g*f);l.rows=f;l.cols=c;h=new sa(l);for(j=0;j<f;j++){g=d[j].split(" ");for(l=0;l<c;l++)g[l]==b?h.set(f-1-j,l,NaN):h.set(f-1-j,l,parseFloat(g[l]))}return h},WMS:function(a){a=p(a);for(var e=["url","layer"],d=0;d<e.length;d++){var b=e[d];if(!(b in a))throw"Key "+b+" not found";}h(a,{levels:16,size:256});var e={source:"wms"},
c;for(c in e)a[c]=e[c];return new ha(a)}},util:{fcolor:wa,icolor:function(a,e,d,b){return new u(m(a/255,0,1),m(e/255,0,1),m(d/255,0,1),m(b/255,0,1))}},widget:{Slider:function(a,e,d){var b=function(a){if(a>=d)throw"Slider index out of bounds";return e.x/(d-1)*a},c=function(b){return b<=a.x?0:b>=a.x+e.x?d-1:Math.round((b-a.x)/e.x*(d-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",a.x).css("top",a.y).css("width",e.x).css("height",e.y);var f=!1,h=0,j=
$("<div></div>").addClass("slider-box").css("position","relative").css("left",-10).css("height",e.y).css("width",20).mousedown(function(){f=!0});this.tick=function(){return h};this.count=function(){return d};var g=function(){};this.change=function(a){g=a};var l=function(){};this.release=function(a){l=a};this.dragging=function(){return f};this.dom.append(j);this.set=function(a){a!=h&&g(a);h=a;var c=b(a);j.css("left",c-10);l(a)};$(document).bind("mouseup",function(){if(f){f=!1;var a=c(event.clientX);
l(a)}});$(document).bind("mousemove",function(a){f&&(a=c(a.clientX),a!=h&&g(a),h=a,a=b(a),j.css("left",a-10))})}},ready:function(a){Pa.push(a)}};$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(a,e){var d=/wigglemaps(\.min)?\.js/;$(e).attr("src").match(d)&&(w=$(e).attr("src").replace(d,""))});$.each(Pa,function(a,e){e()})})})();
