function vect(h,l,n){this.x=h;this.y=l;this.z=n?n:0;this.add=function(h){this.x+=h.x;this.y+=h.y;this.z+=h.z};this.sub=function(h){this.x-=h.x;this.y-=h.y;this.z-=h.z};this.scale=function(h){this.x*=h;this.y*=h;this.z*=h;return this};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var h=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(0==h)return this;this.x/=h;this.y/=h;this.z/=h;return this};this.div=function(h){this.x/=h.x;this.y/=
h.y;this.z/=h.z};this.floor=function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return 0==this.x+this.y+this.z};this.dot=function(h){return this.x*h.x+this.y*h.y+this.z*h.z};this.cross=function(){throw"Need to reimplement";};this.rotate=function(h){var l=Math.cos(h);h=Math.sin(h);xp=l*this.x-h*this.y;yp=h*this.x+l*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}
vect.scale=function(h,l){return new vect(h.x*l,h.y*l,h.z*l)};vect.add=function(h,l){return new vect(h.x+l.x,h.y+l.y,h.z+l.z)};vect.sub=function(h,l){if(!h||!l)throw"Bad Vector";return new vect(h.x-l.x,h.y-l.y,h.z-l.z)};vect.dist=function(h,l){var n=l.x-h.x,p=l.y-h.y,r=l.z-h.z;return Math.sqrt(n*n+p*p+r*r)};vect.dir=function(h,l){var n=vect.sub(h,l);n.normalize();return n};vect.dot2d=function(h,l){return h.x*l.x+h.y*l.y};vect.cross=function(h,l){return h.x*l.y-h.y*l.x};
vect.left=function(h,l,n,p){p||(p=0);l=vect.sub(l,h);h=vect.sub(n,h);return vect.cross(l,h)>=-p};vect.intersects=function(h,l,n,p,r){r||(r=0);return vect.left(h,l,n,r)!=vect.left(h,l,p,r)&&vect.left(n,p,l,r)!=vect.left(n,p,h,r)};vect.intersect2dt=function(h,l,n,p){p=h.x*(p.y-n.y)+l.x*(n.y-p.y)+p.x*(l.y-h.y)+n.x*(h.y-l.y);return 0==p?Infinity:-(h.x*(n.y-l.y)+l.x*(h.y-n.y)+n.x*(l.y-h.y))/p};
vect.intersect2dpos=function(h,l,n,p){var r=h.x*(p.y-n.y)+l.x*(n.y-p.y)+p.x*(l.y-h.y)+n.x*(h.y-l.y);if(0==r)return Infinity;n=(h.x*(p.y-n.y)+n.x*(h.y-p.y)+p.x*(n.y-h.y))/r;l=vect.sub(l,h);l.scale(n);return vect.add(h,l)};vect.rotate=function(h,l){var n=Math.cos(l),p=Math.sin(l);xp=n*h.x-p*h.y;yp=p*h.x+n*h.y;return h=new vect(xp,yp,h.z)};vect.normalize=function(h){h=h.clone();var l=Math.sqrt(h.x*h.x+h.y*h.y+h.z*h.z);if(0==l)return h;h.x/=l;h.y/=l;h.z/=l;return h};
(function(){function h(a,c){for(var b in c)b in a||(a[b]=c[b])}function l(a){var c={};for(key in a)c[key]=a[key];return c}function n(a,c){for(key in c)a[key]=c[key]}function p(a,c,b){return Math.min(Math.max(a,c),b)}function r(a,c,b,e){1>=a&&1>=c&&1>=b&&1>=e?(this.r=a,this.g=c,this.b=b,this.a=e):(this.r=a/255,this.g=c/255,this.b=b/255,this.a=e/255);this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(255*this.r)+","+parseInt(255*
this.g)+","+parseInt(255*this.b)+")"}}function ta(a,c,b,e){return new r(p(a,0,1),p(c,0,1),p(b,0,1),p(e,0,1))}function Ia(a){if(null==a||void 0==a.length)return!1;for(var c=0;c<a.length;c++)if(!(c in a))return!1;return!0}function ha(a,c){return((a.charCodeAt(c)&255)<<24)+((a.charCodeAt(c+1)&255)<<16)+((a.charCodeAt(c+2)&255)<<8)+(a.charCodeAt(c+3)&255)}function D(a,c){return((a.charCodeAt(c+3)&255)<<24)+((a.charCodeAt(c+2)&255)<<16)+((a.charCodeAt(c+1)&255)<<8)+(a.charCodeAt(c)&255)}function X(a,c){var b=
a.charCodeAt(c)&255,e=a.charCodeAt(c+1)&255,d=a.charCodeAt(c+2)&255,g=a.charCodeAt(c+3)&255,k=a.charCodeAt(c+4)&255,j=a.charCodeAt(c+5)&255,f=a.charCodeAt(c+6)&255,q=a.charCodeAt(c+7)&255,m=1-2*(q>>7),q=((q&127)<<4)+((f&240)>>4)-1023,b=(f&15)*Math.pow(2,48)+j*Math.pow(2,40)+k*Math.pow(2,32)+g*Math.pow(2,24)+d*Math.pow(2,16)+e*Math.pow(2,8)+b;return m*(1+b*Math.pow(2,-52))*Math.pow(2,q)}function Y(a,c){var b=a.charCodeAt(c)&255,e=a.charCodeAt(c+1)&255,d=a.charCodeAt(c+2)&255,g=a.charCodeAt(c+3)&255,
k=1-2*(g>>7),g=((g&127)<<1)+((d&254)>>7)-127,b=(d&127)*Math.pow(2,16)+e*Math.pow(2,8)+b;return k*(1+b*Math.pow(2,-23))*Math.pow(2,g)}function ua(a,c,b,e){return[a-b,c+e,a-b,c-e,a+b,c+e,a-b,c-e,a+b,c-e,a+b,c+e]}function t(a,c,b){return 2==arguments.length?[a.x,c.y,a.x,a.y,c.x,c.y,a.x,a.y,c.x,a.y,c.x,c.y]:[a.x,c.y,b,a.x,a.y,b,c.x,c.y,b,a.x,a.y,b,c.x,a.y,b,c.x,c.y,b]}function B(a,c){if(!a)return null;var b=a.createProgram(),e=va(a,a.VERTEX_SHADER,c+"/vert.glsl"),d=va(a,a.FRAGMENT_SHADER,c+"/frag.glsl");
a.attachShader(b,e);a.attachShader(b,d);a.linkProgram(b);var g={},e=(e.source+d.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg),d=0;a.useProgram(b);if(e){for(var k=0;k<e.length;k++){var j=e[k].split(" ");g[j[2]]={u:j[0],type:j[1],loc:null};if("uniform"==j[0])g[j[2]].loc=a.getUniformLocation(b,j[2]);else{var f=a.getAttribLocation(b,j[2]);g[j[2]].loc=f}"sampler2D"==j[1]&&(g[j[2]].tex=d,d++)}b.get=function(a){return g[a].loc};b.data=function(e,b){var d=g[e];if(!d)throw"Could not find shader variable "+
e;if("uniform"==d.u)if("float"==d.type)a.uniform1f(d.loc,b);else if("vec2"==d.type)a.uniform2fv(d.loc,b);else if("ivec2"==d.type)a.uniform2iv(d.loc,b);else if("vec3"==d.type)a.uniform3fv(d.loc,b);else if("ivec3"==d.type)a.uniform3iv(d.loc,b);else if("vec4"==d.type)a.uniform4fv(d.loc,b);else if("ivec4"==d.type)a.uniform4iv(d.loc,b);else if("bool"==d.type)a.uniform1i(d.loc,b);else if("mat4"==d.type)a.uniformMatrix4fv(d.loc,!1,b);else if("mat3"==d.type)a.uniformMatrix3fv(d.loc,!1,b);else if("sampler2D"==
d.type)"texture"in b&&(b=b.texture()),a.activeTexture(a["TEXTURE"+d.tex]),a.bindTexture(a.TEXTURE_2D,b),a.uniform1i(d.loc,d.tex);else if("int"==d.type)a.uniform1i(d.loc,b);else throw"Unsupported Type for Shader Helper: "+d.type;else if("attribute"==d.u)a.enableVertexAttribArray(d.loc),a.bindBuffer(a.ARRAY_BUFFER,b),a.vertexAttribPointer(d.loc,b.itemSize,a.FLOAT,!1,0,0);else throw"Type: "+d.u+" Recieved";}}return b}function va(a,c,b){var e=a.createShader(c);$.ajax({async:!1,url:b,dataType:"text",success:function(b){a.shaderSource(e,
b);a.compileShader(e);if(!a.getShaderParameter(e,a.COMPILE_STATUS))throw a.getShaderInfoLog(e);e.source=b},error:function(){console.log("Could not load "+b)}});return e}function E(a,c,b){var e=a.createBuffer(),d=new Float32Array(c);a.bindBuffer(a.ARRAY_BUFFER,e);e.itemSize=b;e.numItems=c.length/b;a.bufferData(a.ARRAY_BUFFER,d,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return e}function ia(a,c,b){if(!a)return null;var e=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,e);var d=new Float32Array(c*
b);e.itemSize=b;e.numItems=c;e.update=function(b,d){var c=new Float32Array(b);a.bindBuffer(a.ARRAY_BUFFER,e);a.bufferSubData(a.ARRAY_BUFFER,4*d,c);a.bindBuffer(a.ARRAY_BUFFER,null)};a.bufferData(a.ARRAY_BUFFER,d,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return e}function Z(a,c,b){var e=a.createTexture();e.id=wa;wa++;var d=new Image;d.onload=function(){a.bindTexture(a.TEXTURE_2D,e);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,
a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);b&&b()};d.src=c;return e}function ja(a,c){var b=l(c);h(b,{mag_filter:a.LINEAR,min_filter:a.LINEAR,wrap_s:a.CLAMP_TO_EDGE,wrap_t:a.CLAMP_TO_EDGE,mipmap:!1});var e=a.createTexture(),d=null;this.image=function(c){d=c;a.bindTexture(a.TEXTURE_2D,e);a.texImage2D(a.TEXTURE_2D,0,
a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,b.mag_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,b.min_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,b.wrap_s);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,b.wrap_t);b.mipmap&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)};this.texture=function(){return d?e:null}}function Ja(a,c){c||(c={});var b=a.width()/a.height();"center"in c||(c.center=new vect(0,0));"extents"in c||(c.extents=
180);"v_extents"in c||(c.v_extents=c.extents/b);this.mat3=new Float32Array(9);this.mat3[0]=2/c.extents;this.mat3[4]=2/c.v_extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(b){b=new vect(2*(b.x-a.offset().left)/a.width()-1,-(2*(b.y-a.offset().top)/a.height()-1));b.x=b.x/this.mat3[0]-this.mat3[6]/this.mat3[0];b.y=b.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return b};this.screen=function(b){b=new vect(b.x*this.mat3[0]+this.mat3[6],b.y*this.mat3[4]+this.mat3[7]);b.x=
a.offset().left+a.width()*(b.x+1)/2;b.y=a.offset().top+a.height()*(-b.y+1)/2;return b};this.percent=function(b){return new vect(2*((b.x-a.offset().left)/a.width())-1,-(2*((b.y-a.offset().top)/a.height())-1))};this.pixel=function(b){return new vect(a.offset().left+(b.x+1)/2*a.width(),a.offset().top+(-b.y+1)/2*a.height())};this.move=function(a){this.mat3[6]-=a.x*this.mat3[0];this.mat3[7]-=a.y*this.mat3[4]};this.position=function(a){if(!a)return new vect(-this.mat3[6]/this.mat3[0],-this.mat3[7]/this.mat3[4]);
this.mat3[6]=-a.x*this.mat3[0];this.mat3[7]=-a.y*this.mat3[4]};this.position(c.center);this.extents=function(a,d){c.extents=a;c.v_extents=d?d:c.extents/b;var g=this.position();this.level=1;this.mat3[0]=2/c.extents;this.mat3[4]=2/c.v_extents;this.position(g)};this.zoom=function(a){var b=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=a;this.mat3[4]*=a;this.mat3[6]=b.x*this.mat3[0];this.mat3[7]=b.y*this.mat3[4];this.level*=a};this.reset=function(){this.zoom(1/this.level)};
this.reconfigure=function(){var e=this.position();this.mat3[4]/=b;b=a.width()/a.height();this.mat3[4]*=b;this.position(e)}}function Ka(a){var c=!1,b=new vect(0,0),e=new vect(0,0),d=null,g=0;a.canvas.mousedown(function(a){b=new vect(a.clientX,a.clientY);c=!0});$(window).bind("mouseup",function(){c=!1});$(document).bind("keypress","+",function(){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(){a.camera.reset()});a.canvas.bind("mousewheel",
function(b,d){d*=0.5;0>d?(d=-1*d+1,d=1/d):d+=1;a.camera.zoom(d);b.preventDefault()});var k=!0;this.disable=function(){k=!1};this.enable=function(){k=!0};this.update=function(j){e=new vect(aa.x,aa.y);if(c&&k){var f=vect.sub(a.camera.project(b),a.camera.project(e));a.camera.move(f);b=e;g=f.length()/j;d=f;d.normalize()}else 0.01<g&&d&&(a.camera.move(vect.scale(d,g*j)),g-=3*j*g)}}function ba(a){this.engine=a;this.views=[];this.update=function(a){for(var b=0;b<views.length;b++)this.views[b].update(a)};
this.view_factory=function(){throw"Not Implemented";};this.create=function(c,b){var e=this.view_factory(c,b,a);e.update_all();this.views.push(e);return e}}function ka(a,c,b){this.style_map={};this.update=function(e){var d=C.derivedStyle(a,c,b,e);if(null===d)throw"Style property does not exist";this.style_map[e](d)};this.update_all=function(){for(var a in this.style_map)this.update(a)}}function La(a,c){ba.call(this,a,c);a.shaders.point||(a.shaders.point=B(a.gl,y+"shaders/point"));var b=a.shaders.point,
e=10,d=new S(a.gl,Ma);d.create("vert",2);d.create("unit",2);d.create("stroke_width",1);d.create("rad",1);d.create("fill_color",3);d.create("fill",1);d.create("stroke_color",3);d.create("stroke",1);d.create("alpha",1);var g=function(b){ka.call(this,b,c,a);var g,f;this.style_map={fill:function(a){"none"==a?d.repeat("fill",[-0.75],g,f):(d.repeat("fill",[0.75],g,f),d.repeat("fill_color",a.array,g,f))},opacity:function(a){d.repeat("alpha",[a],g,f)},radius:function(a){a>e&&(e=a);d.repeat("rad",[a],g,f)},
stroke:function(a){"none"==a?d.repeat("stroke",[-0.75],g,f):(d.repeat("stroke",[0.75],g,f),d.repeat("stroke_color",a.array,g,f))},"stroke-width":function(a){d.repeat("stroke_width",[a],g,f)}};b=b.geom;f=6*b.length;g=d.alloc(f);$.each(b,function(a,b){d.repeat("vert",b,g+6*a,6);d.write("unit",Na,g+6*a,6)});this.update_all()};this.view_factory=function(a){return new g(a)};this.draw=function(){var c=a.gl;d.update();c.useProgram(b);b.data("screen",a.camera.mat3);b.data("pos",d.get("vert"));b.data("circle_in",
d.get("unit"));b.data("color_in",d.get("fill_color"));b.data("stroke_color_in",d.get("stroke_color"));b.data("alpha_in",d.get("alpha"));b.data("fill_in",d.get("fill"));b.data("stroke_in",d.get("stroke"));b.data("aspect",a.canvas.width()/a.canvas.height());b.data("pix_w",2/a.canvas.width());b.data("rad",d.get("rad"));b.data("stroke_width_in",d.get("stroke_width"));b.data("max_rad",e);c.drawArrays(c.TRIANGLES,0,d.count())}}function la(a,c){ba.call(this,a,c);a.shaders.line||(a.shaders.line=B(a.gl,y+
"shaders/line"));var b=a.shaders.line,e=new S(a.gl,1024);e.create("vert",2);e.create("norm",2);e.create("width",2);e.create("color",3);e.create("unit",2);e.create("alpha",1);var d=function(b,d){ka.call(this,b,c,a);var j=e.count(),f=0;this.style_map={stroke:function(a){e.repeat("color",a.array,j,f)},"stroke-opacity":function(a){e.repeat("alpha",[a],j,f)},"stroke-width":function(a){e.repeat("width",[a],j,f)}};d||(d=b.geom);$.each(d,function(a,b){for(a=0;a<b.length;a++)f+=6*b[a].length,Oa(e,b[a])});
this.update_all()};this.view_factory=function(a,b,e){return new d(a,b,e)};this.draw=function(){var d=a.gl;e.update();d.useProgram(b);b.data("screen",a.camera.mat3);b.data("pos",e.get("vert"));b.data("norm",e.get("norm"));b.data("color_in",e.get("color"));b.data("alpha_in",e.get("alpha"));b.data("circle_in",e.get("unit"));b.data("width_in",e.get("width"));b.data("px_w",2/a.canvas.width());b.data("px_h",2/a.canvas.height());d.drawArrays(d.TRIANGLES,0,e.count())}}function Pa(a,c){ba.call(this,a,c);a.shaders.polygon||
(a.shaders.polygon=B(a.gl,y+"shaders/poly"));var b=a.shaders.polygon,e=new la(a,c),d=new S(a.gl,Qa);d.create("vert",2);d.create("color",3);d.create("alpha",1);var g=function(b){ka.call(this,b,c,a);e.create(b);var g,f;this.style_map={fill:function(a){d.repeat("color",a.array,g,f)},"fill-opacity":function(a){d.repeat("alpha",[a],g,f)}};b=b.geom;var q=[];f=0;$.each(b,function(a,b){for(var d,e=0;100>e;)try{for(var c=b,g=[],k=0;k<c.length;k++){for(var j=[],m=1;m<c[k].length;m++)j.push(xa(c[k][m][0],c[k][m][1]));
j.push(g[0]);g.push(j)}d=Ra(g);break}catch(h){e++}if(100==e)throw"Rendering Polygon Failed";f+=d.length/2;q.push(d)});var m=g=d.alloc(f);$.each(q,function(a,b){var e=b.length/2;d.write("vert",b,m,e);m+=e});this.update_all()};this.view_factory=function(a){return new g(a)};this.draw=function(){var c=a.gl;d.update();c.useProgram(b);b.data("screen",a.camera.mat3);b.data("pos",d.get("vert"));b.data("color_in",d.get("color"));b.data("alpha_in",d.get("alpha"));c.drawArrays(c.TRIANGLES,0,d.count());e.draw()}}
function Sa(a,c,b){ba.call(this,a,c,b);var e=new la(a,c);this.view_factory=function(a){for(var g=[],k=[],j=c.attr("order"),f=0;f<j.length;f++){var q=a.attr(j[f]);isNaN(q)?0<k.length&&(g.push(k),k=[]):k.push([(f-b.range.min.x)/b.range.width(),(q-b.range.min.y)/b.range.height()])}0<k.length&&g.push(k);return e.create(a,[g])};this.draw=function(){e.draw()}}function ya(a,c){var b=this;h(c,{background:new r(0,0,0,1)});this.type="Engine";this.id=da();this.canvas=$("<canvas></canvas>").attr("id","viewer");
var e=null;a?($(a).append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height())):(a=window,$("body").append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height()),$(window).resize(function(){b.resize()}));this.resize=function(){this.canvas.attr("width",$(a).width());this.canvas.attr("height",$(a).height());e.viewport(0,0,this.canvas.width(),this.canvas.height());this.camera.reconfigure();for(var b=0;b<framebuffers.length;b++)framebuffers[b].resize()};
var d=this.canvas;this.gl=e=gl=Ta?WebGLDebugUtils.makeDebugContext(d.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),function(a,b){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+b;}):d.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});e.viewport(0,0,this.canvas.width(),this.canvas.height());e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);e.enable(e.BLEND);this.camera=new Ja(this.canvas,c);this.scroller=new Ka(this);
this.extents=function(a,b){this.camera.extents(a,b)};this.center=function(a,b){this.camera.position(new vect(a,b))};this.vcenter=function(a){this.center(a.x,a.y)};this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.Renderers={};this.renderers={};this.views={};this.styles={};this.defaultStyle=function(a,b){var d;a in this.styles&&(d=this.styles[a][b]);if(null===d||void 0===d)d=this.styles["default"][b];return null===d||void 0===d?null:d};var g=function(a,d){b.views[a.id].update(d)};
this.append=function(a){if("draw"in a)this.scene[a.id]=a;else{if(a.id in this.renderers)throw"Added layer to Engine twice";this.renderers[a.id]={};a.features().each(function(d,e){var f;f=e.type in b.Renderers?e.type:"default";f in b.renderers[a.id]||(b.renderers[a.id][f]=new b.Renderers[f](b,a,c));f=b.renderers[a.id][f].create(e);f.update_all();if(void 0!==b.views[e.id])throw"Cannot add a feature twice to the same Engine";b.views[e.id]=f;C.registerCallback(b,e,g)});this.layers[a.id]=a}};this.style=
function(a,b,d){void 0===this.styles[a.id]&&(this.styles[a.id]={});if(void 0===d)return void 0!==this.styles[a.id][b]?this.styles[a.id][b]:null;this.styles[a.id][b]=d;a.id in this.views?this.views[a.id].update(b):a.id in this.renderers&&$.each(this.renderers[a.id],function(a,b){b.update()})};this.sel=new Ua(this);var k=(new Date).getTime(),j=[],f,q=this;f=function(){q.draw()};this.shaders={};this.scene={};this.layers={};this.draw=function(){var a=(new Date).getTime(),d=(a-k)/1E3;this.scroller.update(d);
60<=j.length&&j.splice(0,1);j.push(d);for(var g=0,q=0;q<j.length;q++)g+=j[q];g/=j.length;$("#fps").text(Math.floor(1/g));k=a;e.clearColor(c.background.r,c.background.g,c.background.b,c.background.a);e.clear(e.COLOR_BUFFER_BIT);e.clearDepth(0);$.each(this.layers,function(a,b){b.update()});$.each(this.scene,function(a,e){e.draw(b,d)});$.each(this.renderers,function(a,b){$.each(b,function(a,b){b.draw(d)})});requestAnimationFrame(f);this.sel.draw(this,d)};this.enableZ=function(){e.depthFunc(e.LEQUAL);
e.enable(e.DEPTH_TEST)};this.disableZ=function(){e.disable(e.DEPTH_TEST)};requestAnimationFrame(f)}function S(a,c){var b={},e;e=c?c:256;var d=0,g=function(a,b,d,e){a||console.log("ack");d||(d=0);e||(e=b.length);for(var c=0;c<e;c++)a[d+c]=b[c]};this.create=function(d,c){if(!c)throw"Length of buffer must be a positive integer";var g=new Float32Array(e*c),q=ia(a,e,c);b[d]={array:g,buffer:q,len:c,dirty:!1}};this.alloc=function(c){if(d+c>=e){for(var j=e;j<d+c;)j*=2;e=j;for(name in b){var f=new Float32Array(j*
b[name].len),q=b[name].array,m=ia(a,e,b[name].len);g(f,q);b[name].array=f;b[name].buffer=m;b[name].dirty=!0}}j=d;d+=c;return j};this.get=function(a){return b[a].buffer};this.write=function(a,d,e,c){g(b[a].array,d,e*b[a].len,c*b[a].len);b[a].dirty=!0};this.repeat=function(a,d,e,c){for(var m=0;m<c;m++)g(b[a].array,d,(e+m)*b[a].len,b[a].len);b[a].dirty=!0};this.count=function(){return d};this.data=function(a){return b[a].array};this.update=function(){for(name in b)b[name].dirty&&(b[name].buffer&&b[name].buffer.update(b[name].array,
0),b[name].dirty=!1)}}function Ua(a){U||(U=B(a.gl,y+"shaders/selbox"));var c=!1,b=!1,e=null,d=null,g=ia(a.gl,6,2),k=E(a.gl,ua(0,0,1,1),2);a.canvas.bind("mousedown",function(f){c&&(show=b=!0,d=e=a.camera.percent(new vect(f.clientX,f.clientY)),g.update(t(e,d),0))});var j=function(){};this.select=function(a){j=a};$(document).bind("mouseup",function(){if(c&&b){var g=a.camera.project(a.camera.pixel(e)),k=a.camera.project(a.camera.pixel(d));if(g.x>k.x){var m=g.x;g.x=k.x;k.x=m}g.y>k.y&&(m=g.y,g.y=k.y,k.y=
m);b=!1;j(new M(g,k))}});$(document).bind("click",function(){c&&(show=!1)});$(document).bind("mousemove",function(f){c&&b&&(d=a.camera.percent(new vect(f.clientX,f.clientY)),g.update(t(e,d),0))});this.enable=function(){c=!0};this.disable=function(){c=!1};this.draw=function(){b&&(gl.useProgram(U),U.data("pos",g),U.data("edge_in",k),gl.drawArrays(gl.TRIANGLES,0,g.numItems))}}function za(a,c){for(;a>=c;)a-=c;for(;0>a;)a+=c;return a}function Va(a,c,b,e){this.current=a;this.upper=c;this.lower=b;this.index=
e}function Aa(a,c){for(var b=0;b<a.length;b++)if(a[b]==c)return!0;return!1}function ea(a,c,b){if(void 0==c)throw"whoa";return 0==a[c+1].y-a[c].y?Math.min(a[c].x,a[c+1].x):a[c].x+(a[c+1].x-a[c].x)*((b-a[c].y)/(a[c+1].y-a[c].y))}function N(a,c){for(var b=0;b<a.length;b++)if(a[b]==c)return b;return!1}function v(a,c,b){return new vect(ea(c,b,c[a].y),c[a].y)}function F(a,c){if(!c)throw"eek";a.push(c.x);a.push(c.y)}function O(a,c,b){if(!c||!b||3!=b.length+c.length&&4!=b.length+c.length)throw"ahh";if(3==
c.length+b.length){for(var e=0;e<c.length;e++)F(a,c[e]);for(e=0;e<b.length;e++)F(a,b[e])}else c[1].x<c[0].x&&(e=c[0],c[0]=c[1],c[1]=e),b[1].x<b[0].x&&(e=b[0],b[0]=b[1],b[1]=e),F(a,c[0]),F(a,c[1]),F(a,b[1]),F(a,b[0]),F(a,b[1]),F(a,c[0])}function Ra(a){for(var c=[],b=0,e=[],d=0;d<a.length;d++){for(var g=0;g<a[d].length-1;g++){var k=za(g+1,a[d].length-1),j=za(g-1,a[d].length-1);c.push(new Va(g+b,k+b,j+b,d));e.push(a[d][g])}e.push(a[d][0]);b+=a[d].length}c.sort(function(a,b){return e[a.current].y-e[b.current].y});
a=[];d=[];new vect(-200,0);new vect(200,0);b=0;b=[];j=[];for(g=0;g<c.length;g++){var f=c[g],k=Aa(a,f.lower),q=Aa(a,f.current),m,h;if(k&&!q)h=m=N(a,f.lower);else if(q&&!k)m=h=N(a,f.current);else if(k&&q)m=N(a,f.lower),h=N(a,f.current);else if(!k&&!q){a:{m=a;h=e;for(var l=e[f.current].x,z=e[f.current].y,n=0;n<m.length;n++){var p=ea(h,m[n],z);if(p>l||0==p-l&&h[m[n]].y>h[index].y){h=n;break a}}h=m.length}m=h}if(1<Math.abs(m-h)){for(k=0;k<a.length;k++);throw"Bad";}l=vect.left(e[f.lower],e[f.current],e[f.upper]);
z=Math.floor(Math.min(m,h)/2);!l&&!k&&!q?(O(j,d[z],[v(f.current,e,a[h-1]),v(f.current,e,a[h])]),d.splice(z,1,[v(f.current,e,a[h-1]),e[f.current]],[e[f.current],v(f.current,e,a[m])])):l&&!k&&!q?d.splice(z,0,[e[f.current]]):k&&!q?(O(j,d[z],[v(f.current,e,a[Math.max(m,h)-1]),e[f.current]]),d[z]=[v(f.current,e,a[Math.min(m,h)-1]),e[f.current]]):!k&&q?(O(j,d[z],[e[f.current],v(f.current,e,a[Math.min(h,m)+1])]),d[z]=[e[f.current],v(f.current,e,a[Math.max(h,m)+1])]):!l&&k&&q?(O(j,d[z],[v(f.current,e,a[Math.min(m,
h)-1]),e[f.current]]),O(j,d[z+1],[v(f.current,e,a[Math.max(m,h)+1]),e[f.current]]),d.splice(z,2,[v(f.current,e,a[Math.min(m,h)-1]),v(f.current,e,a[Math.max(m,h)+1])])):l&&(k&&q)&&(O(j,d[z],[e[f.current]]),d.splice(z,1));k&&!q?a[m]=f.current:q&&!k?a[h]=f.lower:k&&q?(a.splice(N(a,f.lower),1),a.splice(N(a,f.current),1)):!k&&!q&&(l?a.splice(m,0,f.lower,f.current):a.splice(m,0,f.current,f.lower));for(k=0;k<a.length-1;k++)if(ea(e,a[k],e[f.current].y)>ea(e,a[k+1],e[f.current].y))throw console.log("Misplaced Sweep"),
"Misplace!";}if(0<a.length)throw console.log(a),"Bad "+a.length;if(0<b.length)throw console.log(b),"Wrong";return j}function M(a,c){this.min=a.clone();this.max=c.clone();this.contains=function(b){return a.x<=b.x&&c.x>=b.x&&a.y<=b.y&&c.y>=b.y};this.x_in=function(b){return a.x<=b.x&&c.x>=b.x};this.x_left=function(b){return a.x>=b.x};this.x_right=function(a){return c.x<=a.x};this.y_in=function(b){return a.y<=b.y&&c.y>=b.y};this.y_left=function(b){return a.y>=b.y};this.y_right=function(a){return c.y<=
a.y};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(a){switch(a){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);default:throw"Index out of bounds: "+a;}};this.intersects=function(a){for(var e=0;4>e;e++)for(var d=0;4>d;d++)if(vect.intersects(this.vertex(e),
this.vertex((e+1)%4),a.vertex(d),a.vertex((d+1)%4)))return!0;return this.contains(a.min)&&this.contains(a.max)&&this.contains(new vect(a.min.x,a.max.y))&&this.contains(new vect(a.max.x,a.min.y))||a.contains(this.min)&&a.contains(this.max)&&a.contains(new vect(this.min.x,this.max.y))&&a.contains(new vect(this.max.x,this.min.y))?!0:!1};this.union=function(a){this.min.x=Math.min(this.min.x,a.min.x);this.min.y=Math.min(this.min.y,a.min.y);this.max.x=Math.max(this.max.x,a.max.x);this.max.y=Math.max(this.max.y,
a.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new M(a,c)}}function ma(a,c,b,e){this.data=a[e];this.right=this.left=null;c!=e&&(this.left=new ma(a,c,e-1,parseInt((c+(e-1))/2)));b!=e&&(this.right=new ma(a,e+1,b,parseInt((b+(e+1))/2)));this.subtree=[];for(e=c;e<=b;e++)this.subtree.push(a[e]);this.subtree.sort(function(a,b){return a.y-b.y});this.yrange=function(a,b,e){return a.y_in(this.subtree[b])&&a.y_in(this.subtree[e])};
this.subquery=function(a,b,e,c,f){if(this.yrange(b,e,c))for(b=e;b<=c;b++)a.push(this.subtree[b]);else b.y_in(this.subtree[f])&&a.push(this.subtree[f]),b.y_left(this.subtree[f])?f!=c&&this.subquery(a,b,f+1,c,parseInt((c+(f+1))/2)):(b.x_right(this.subtree[f])||f!=c&&this.subquery(a,b,f+1,c,parseInt((c+(f+1))/2)),f!=e&&this.subquery(a,b,e,f-1,parseInt((e+(f-1))/2)))};this.search=function(d,e){e.x_in(a[c])&&e.x_in(a[b])?this.subquery(d,e,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2)):(e.contains(this.data)&&
d.push(this.data),e.x_left(this.data)?this.right&&this.right.search(d,e):e.x_right(this.data)?this.left&&this.left.search(d,e):(this.left&&this.left.search(d,e),this.right&&this.right.search(d,e)))}}function na(a){a.sort(function(a,b){return a.x-b.x});0<a.length?this.root=new ma(a,0,a.length-1,parseInt((a.length-1)/2)):null==this.root;this.search=function(a){if(!this.root)return[];a=a.clone();var b=[];this.root.search(b,a);return b}}function fa(a){a||(a={});this.id=da();this.type="Layer";var c={},
b={},e=!1;if(a.style)throw"Not Implemeneted";this.style=function(){throw"Not Implemented";};this.bounds=null;this.features=function(){var a=[],d;for(d in b)a.push(b[d]);return new s(a)};var d={};this.properties=function(a){var b=[],e;for(e in d)(!a||a&&d[e])&&b.push(e);return b};this.search=function(a){e&&this.update();var b=new s([]),d;for(d in c)var g=c[d].search(a),b=b.join(g);return b};this.map_contains=function(a,b){e&&this.update();var d=new s([]),g;for(g in c)var f=c[g].map_contains(a,b),d=
d.join(f);return d};var g={};this.attr=function(a,b){if(2>arguments.length)return void 0!==g[a]?g[a]:null;g[a]=b};this.append=function(a){var c=new oa[a.type].geometry(a,this);b[c.id]=c;this.bounds?this.bounds.union(c.bounds):this.bounds=c.bounds.clone();for(var g in a.attr)d[g]=void 0===d[g]?isNaN(a.attr[g])?!1:!0:!isNaN(a.attr[g])&&d[g]?!0:!1;e=!0};var k=null,j=null;this.mouseover=function(a){k=a};this.mouseout=function(a){j=a};var f={};this.update_move=function(a,b){if(k||j){var d=this.map_contains(a,
b),e={};d&&d.each(function(a,b){e[b.id]=b});for(var c in f)!(c in e)&&j&&j(f[c]);for(c in e)!(c in f)&&k&&k(e[c]);f=e}};this.force_out=function(){for(var a in f)j&&j(f[a]);f={}};this.update=function(){if(e){var a=this.features(),b;for(b in oa)c[b]=new oa[b].collection(a.type(b).items())}e=!1}}function Ba(a){var c=new vect(Infinity,Infinity),b=new vect(-Infinity,-Infinity);$.each(a,function(a,d){$.each(d,function(a,d){$.each(d,function(a,d){d[0]<c.x&&(c.x=d[0]);d[0]>b.x&&(b.x=d[0]);d[1]<c.y&&(c.y=
d[1]);d[1]>b.y&&(b.y=d[1])})})});return new M(c,b)}function Oa(a,c){for(var b=6*c.length,e=a.alloc(b),d=[new vect(1,1),new vect(1,-1),new vect(-1,-1),new vect(-1,1)],g=0,k=function(){if(c[g]){var a=new vect(c[g][0],c[g][1]);g++;return a}return null},j=k(),f=k(),h=k(),m=function(a,b,d){var e=vect.dir(a,b).rotate(P/2),c=vect.dir(b,d).rotate(P/2);a=vect.add(a,e);var g=vect.add(b,e),f=vect.add(b,c);d=vect.add(d,c);d=vect.intersect2dpos(a,g,f,d);return Infinity==d?vect.add(b,e):d},l=vect.dir(j,f).rotate(-P/
2),n=vect.dir(j,f).rotate(P/2),p,ca,r=function(a,b,d,e,c){a.push(b.x);a.push(b.y);a.push(d.x);a.push(d.y);a.push(e.x);a.push(e.y);a.push(b.x);a.push(b.y);a.push(e.x);a.push(e.y);a.push(c.x);a.push(c.y)},u=[],H=[],I=[];f;)h?(p=vect.sub(m(j,f,h),f),ca=vect.sub(m(h,f,j),f)):(p=vect.dir(j,f).rotate(P/2),ca=vect.dir(j,f).rotate(-P/2)),r(u,j,j,f,f),r(H,l,n,p,ca),r(I,d[0],d[1],d[2],d[3]),l=ca,n=p,j=f,f=h,h=k();a.write("vert",u,e,b);a.write("norm",H,e,b);a.write("unit",I,e,b);return e}function pa(a){A||(A=
B(engine.gl,y+"shaders/grid"));a||(a={});a.style||(a.style={});var c=a.lower,b=a.upper,e=a.rows,d=a.cols,g=(b.x-c.x)/d,k=(b.y-c.y)/e,j=new Float32Array(e*d),f=new Uint8Array(4*d*e),h=!1,m=new S(engine.gl,6);m.create("vert",2);m.create("screen",2);m.create("tex",2);var l=new vect(c.x,c.y),n=new vect(b.x,b.y),p=new vect(0,0),r=new vect(1,1),s=m.alloc(6);m.write("vert",t(l,n),s,6);m.write("screen",t(new vect(-1,-1),new vect(1,1)),s,6);m.write("tex",t(p,r),s,6);var u=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,
u);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);this.lower=function(){return c.clone()};this.upper=function(){return b.clone()};this.rows=function(){return e};this.cols=function(){return d};this.centroid=function(a,b){return new vect(c.x+g*b+g/2,c.y+
k*a+k/2)};this.get=function(a,b){return j[d*a+b]};var H=-Infinity,I=Infinity;this.qunatiles=function(a,b){b||(b=function(a,b){return a-b});for(var d=[],e=0;e<j.length;e++)d.push(j[e]);d.sort(b);for(var c=[-Infinity],e=1;e<a;e++){var g=parseInt(inc*e);c.push(d[g])}c.push(Infinity);return c};this.set=function(a,b,c){if(a>=e||b>=d)throw"Index Out of Bounds";j[d*a+b]=c;h=!0};this.raw_set=function(a,b){if(a>=e*d)throw"Index Out of Bounds: "+a;j[a]=b;h=!0};this.clear=function(a){for(var b=0;b<e*d;b++)j[b]=
a};this.initialize=function(){};var T=null;this.draw=function(b){T||(T=b.framebuffer());m.update();if(h){H=-Infinity;I=Infinity;for(var c=0;c<e*d;c++){var g=j[c];g>H&&(H=g);g<I&&(I=g)}for(c=0;c<e*d;c++){var g=c,k=a.map(I,H,j[c]);f[4*g]=parseInt(255*k.r);f[4*g+1]=parseInt(255*k.g);f[4*g+2]=parseInt(255*k.b);f[4*g+3]=parseInt(255*k.a)}gl.bindTexture(gl.TEXTURE_2D,u);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,d,e,0,gl.RGBA,gl.UNSIGNED_BYTE,f);gl.bindTexture(gl.TEXTURE_2D,null);h=!1}a.style.antialias&&T.activate({blend:!1});
gl.useProgram(A);A.data("screen",b.camera.mat3);A.data("pos",m.get("vert"));A.data("tex_in",m.get("tex"));A.data("sampler",u);c=vect.sub(b.camera.screen(n),b.camera.screen(l));A.data("width",c.x);A.data("height",-c.y);A.data("rows",e);A.data("cols",d);A.data("blur",a.blur);gl.drawArrays(gl.TRIANGLES,0,m.count());a.style.antialias&&(T.deactivate(),b.draw_blur(T.tex))}}function Wa(a,c,b){J||(J=B(y+"shaders/raster"));this.image=Z(a);var e=E(t(new vect(0,1),new vect(1,0)),2),d=E(t(c,b),2);this.draw=function(a,
b,c){c||(gl.useProgram(J),J.data("screen",a.camera.mat3),J.data("pos",d),J.data("tex_in",e),J.data("sampler",this.image),gl.drawArrays(gl.TRIANGLES,0,d.numItems))}}function Ca(a){w||(w=B(y+"shaders/hillshade"));var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),e=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var d=!1,g=Z(a,function(){d=!0});this.ready=function(){return d};
var k=E(t(new vect(0,1),new vect(1,0)),2),j=E(t(b,e),2),f=315;this.draw=function(a){if(d){for(gl.useProgram(altitude_shader);1<=f;)f-=1;altitude_shader.data("azimuth",f);altitude_shader.data("altitude",Math.PI/4/(2*Math.PI));altitude_shader.data("screen",a.camera.mat3);altitude_shader.data("pos",j);altitude_shader.data("tex_in",k);altitude_shader.data("elevation",g);a=vect.sub(a.camera.screen(e),a.camera.screen(b));altitude_shader.data("pix_w",1/a.x);altitude_shader.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,
0,j.numItems);return f}}}function Ca(a){w||(w=B(engine.gl,y+"shaders/hillshade"));var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),e=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var d=!1,g=Z(engine.gl,a,function(){d=!0});this.ready=function(){return d};var k=E(engine.gl,t(new vect(0,1),new vect(1,0)),2),j=E(engine.gl,t(b,e),2),f=315;this.initialize=function(){};
this.draw=function(a){if(d){for(gl.useProgram(w);1<=f;)f-=1;w.data("azimuth",f);w.data("altitude",Math.PI/4/(2*Math.PI));w.data("screen",a.camera.mat3);w.data("pos",j);w.data("tex_in",k);w.data("elevation",g);a=vect.sub(a.camera.screen(e),a.camera.screen(b));w.data("pix_w",1/a.x);w.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,j.numItems);return f}}}function ga(a){for(var c=[],b=[],e=0;e<a.levels;e++){var d=l(a);"file"==d.source&&(d.url+="/"+a.size*Math.pow(2,e+1));d.min=new vect(-180,-90);d.rows=
Math.pow(2,e);d.cols=2*d.rows;d.cellsize=180/d.rows;d.z_index=1-qa-e/1E3;d.available=b;d=new Xa(d);c.push(d)}qa+=(a.levels+2)/1E3;var g=null;this.initialize=function(a){x||(x=B(a.gl,y+"shaders/tile"));g=new S(a.gl,6*V);g.create("vert",3);g.create("tex",2);g.create("lookup",1);g.alloc(6*V);for(var d=0;25>d;d++)b.push(new ja(a.gl));for(d=0;d<c.length;d++)c[d].initialize(a);c[0].fetch_all();c[0].noexpire(!0)};this.draw=function(b,d){gl.useProgram(x);x.data("screen",b.camera.mat3);Da=Ea=0;for(var e=Infinity,
h=c[0],m,l=0;l<c.length;l++){var n=a.size*c[l].cols/c[l].size(b).x;1>n&&(n=1/n);n<e&&(e=n,h=c[l],m=l)}for(l=m;0<=l;l--)c[l].fetch();if(h.ready())h.draw(b,d,g,0,!0);else{b.enableZ();e=0;for(l=m;0<=l;l--)e=c[l].draw(b,d,g,e,0==l);b.disableZ()}$.each(c,function(a,b){b.cull()})}}function Xa(a){a||(a={});a.desaturate||(a.desaturate=0);a.darken||(a.darken=0);a.hue||(a.hue=0);a.hue_color||(a.hue_color=ta(0,0,0,1));if(!a.available){a.available=[];for(var c=0;8>c;c++)a.available.push(new ja(e))}var b,e=null,
d=a.url,g=a.min,k=a.rows,j=a.cols,f=a.cellsize;this.rows=k;this.cols=j;for(var h={},m={},l=function(b,d){var e=new vect(g.x+b*f,g.y+d*f),c=new vect(g.x+(b+1)*f,g.y+(d+1)*f),e={vert:t(e,c,a.z_index),tex:null,i:b,j:d,id:b+j*d,ready:!1,min:e,max:c};m[b][d]=e;h[e.id]=e},c=0;c<j;c++)m[c]={};this.size=function(a){var b=a.camera.screen(g);a=a.camera.screen(vect.add(g,new vect(f*j,f*k)));b=vect.sub(a,b);b.y=Math.abs(b.y);return b};var n=!1;this.noexpire=function(a){n=a};this.cull=function(){if(!n){var b=
(new Date).getTime(),d;for(d in r)if(b-r[d]>Ya){var e=h[d];delete h[d];delete m[e.i][e.j];a.available.push(e.tex);e.tex=null;e.ready=!1;delete r[d]}}};var p=function(){var a=b.camera.project(new vect(b.canvas.offset().left,b.canvas.offset().top+b.canvas.height())),d=b.camera.project(new vect(b.canvas.offset().left+b.canvas.width(),b.canvas.offset().top)),e=Math.floor((a.x-g.x)/f),c=Math.ceil((d.x-g.x)/f),a=Math.floor((a.y-g.y)/f),d=Math.ceil((d.y-g.y)/f);return{min_col:e,max_col:c,min_row:a,max_row:d}},
r={};this.ready=function(){for(var a=p(),b=Math.max(0,a.min_col);b<Math.min(j,a.max_col);b++)for(var d=Math.max(0,a.min_row);d<Math.min(k,a.max_row);d++)if(!m[b][d]||!m[b][d].ready)return!1;return!0};var s=function(b,c){if(!m[b][c].tex){var g;if("file"==a.source)g=d+"/"+m[b][c].id+".png";else if("wms"==a.source){g={service:"wms",version:"1.1.0",request:"GetMap",layers:a.layer,bbox:[m[b][c].min.x,m[b][c].min.y,m[b][c].max.x,m[b][c].max.y].join(),width:a.size,height:a.size,srs:"EPSG:4326",format:"image/png",
transparent:"true"};var f=[],k;for(k in g)f.push(k+"="+g[k]);g=d+"?"+f.join("&")}m[b][c].tex=a.available.pop();m[b][c].tex||(m[b][c].tex=new ja(e));k=g;var j=m[b][c],h=new Image;h.crossOrigin="";h.onload=function(){j.tex&&(j.tex.image(h),j.ready=!0)};h.src=k}};this.fetch_all=function(){for(var a=(new Date).getTime(),b=0;b<j;b++)for(var d=0;d<k;d++)m[b][d]||l(b,d),m[b][d].tex||s(b,d),r[m[b][d].id]=a};this.fetch=function(){for(var a=p(),b=(new Date).getTime(),d=Math.max(0,a.min_col-1);d<Math.min(j,
a.max_col+1);d++)for(var e=Math.max(0,a.min_row-1);e<Math.min(k,a.max_row+1);e++)m[d][e]||l(d,e),m[d][e].tex||s(d,e),r[m[d][e].id]=b};var u=!1;this.initialize=function(a){if(u)throw"Not Implemented: Migrating Tile Layers to New Map";x||(x=B(a.gl,y+"shaders/tile"));b=a;e=b.gl;u=!0};this.draw=function(b,d,c,g,f){u||this.initialize(b);b=function(){Da++;c.update();x.data("pos",c.get("vert"));x.data("tex_in",c.get("tex"));x.data("lookup_in",c.get("lookup"));x.data("desaturate",a.desaturate);x.data("darken",
a.darken);x.data("hue",a.hue);x.data("hue_color",a.hue_color.array);e.drawArrays(e.TRIANGLES,0,6*g)};d=p();for(var h=(new Date).getTime(),l=Math.max(0,d.min_col);l<Math.min(j,d.max_col);l++)for(var q=Math.max(0,d.min_row);q<Math.min(k,d.max_row);q++)if(m[l][q]&&m[l][q].ready&&m[l][q].tex){c.write("vert",m[l][q].vert,6*g,6);c.write("tex",t(new vect(0,0),new vect(1,1)),6*g,6);c.repeat("lookup",[g/V+1/(2*V)],6*g,6);r[m[l][q].id]=h;x.data("sampler"+g,m[l][q].tex);if(null==m[l][q].tex)throw"badness";g++;
Ea++;g>=V&&(b(),g=0)}f&&b();return g}}var y="",Q=jQuery,Za=function(a){if("string"===typeof a.data){var c=a.handler,b=a.data.toLowerCase().split(" ");a.handler=function(a){if(!(this!==a.target&&(/textarea|select/i.test(a.target.nodeName)||"text"===a.target.type))){var d="keypress"!==a.type&&Q.hotkeys.specialKeys[a.which],g=String.fromCharCode(a.which).toLowerCase(),k="",j={};a.altKey&&"alt"!==d&&(k+="alt+");a.ctrlKey&&"ctrl"!==d&&(k+="ctrl+");a.metaKey&&(!a.ctrlKey&&"meta"!==d)&&(k+="meta+");a.shiftKey&&
"shift"!==d&&(k+="shift+");d?j[k+d]=!0:(j[k+g]=!0,j[k+Q.hotkeys.shiftNums[g]]=!0,"shift+"===k&&(j[Q.hotkeys.shiftNums[g]]=!0));d=0;for(g=b.length;d<g;d++)if(j[b[d]])return c.apply(this,arguments)}}}};Q.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",
102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}};Q.each(["keydown","keyup","keypress"],
function(){Q.event.special[this]={add:Za}});var G=jQuery,ra=function(a){var c=a||window.event,b=[].slice.call(arguments,1),e=0,d=0,g=0;a=G.event.fix(c);a.type="mousewheel";c.wheelDelta&&(e=c.wheelDelta/120);c.detail&&(e=-c.detail/3);g=e;void 0!==c.axis&&c.axis===c.HORIZONTAL_AXIS&&(g=0,d=-1*e);void 0!==c.wheelDeltaY&&(g=c.wheelDeltaY/120);void 0!==c.wheelDeltaX&&(d=-1*c.wheelDeltaX/120);b.unshift(a,e,d,g);return(G.event.dispatch||G.event.handle).apply(this,b)},R=["DOMMouseScroll","mousewheel"];if(G.event.fixHooks)for(var K=
R.length;K;)G.event.fixHooks[R[--K]]=G.event.mouseHooks;G.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=R.length;a;)this.addEventListener(R[--a],ra,!1);else this.onmousewheel=ra},teardown:function(){if(this.removeEventListener)for(var a=R.length;a;)this.removeEventListener(R[--a],ra,!1);else this.onmousewheel=null}};G.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",
a)}});for(var Fa=0,K=["ms","moz","webkit","o"],W=0;W<K.length&&!window.requestAnimationFrame;++W)window.requestAnimationFrame=window[K[W]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[K[W]+"CancelAnimationFrame"]||window[K[W]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var c=(new Date).getTime(),b=Math.max(0,16-(c-Fa)),e=window.setTimeout(function(){a(c+b)},b);Fa=c+b;return e});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)});var P=3.14159265,aa={x:0,y:0};$(document).mousemove(function(a){aa.x=a.clientX;aa.y=a.clientY});var Ta=!1,wa=0,C=new function(){this.styles={};this.derivedStyle=function(a,e,d,c){if(!d)throw"Undefined operation";var k;k=this.getStyle(a,d,c);null===k&&(k=this.getStyle(a,null,c),null===k&&(k=this.getStyle(e,d,c),null===k&&(k=this.getStyle(e,d,c),null===k&&(k=d.defaultStyle(a.type,c)))));return k};var a={};this.registerCallback=function(b,e,d){a[b.id]||(a[b.id]={});a[b.id][e.id]=
d};var c=function(a,e){var d=e?e.id:"default";d in C.styles||(C.styles[d]={});a.id in C.styles[d]||(C.styles[d][a.id]={})};this.getStyle=function(a,e,d){c(a,e);a=this.styles[e?e.id:"default"][a.id][d];return void 0===a?null:a};this.setStyle=function(b,e,d,g){c(b,e);this.styles[e?e.id:"default"][b.id][d]=g;if(e){if(a[e.id]&&a[e.id][b.id])a[e.id][b.id](b,d)}else $.each(a,function(a,e){if(e[b.id])e[b.id](b,d)})}},Ma=1024,Na=ua(0,0,1,1),Qa=1024,U=null,oa={Point:{geometry:function(a,c){sa.call(this,a,
c);this.bounds=null;for(var b=0;b<this.geom.length;b++){var e=new vect(this.geom[b][0],this.geom[b][1]),e=new M(e.clone(),e.clone());this.bounds?this.bounds.union(e):this.bounds=e}this.map_contains=function(a,b){for(var e=C.derivedStyle(this,c,a,"radius"),j=0;j<this.geom.length;j++){var f=a.camera.screen(new vect(this.geom[j][0],this.geom[j][1]));if(vect.dist(f,b)<e)return!0}return!1}},collection:function(a){var c=[],b=0;$.each(a,function(a,e){var k=C.derivedStyle(this,layer,engine,"radius");k>b&&
(b=k);$.each(e.geom,function(a,b){c.push({x:b[0],y:b[1],ref:e})})});var e=new na(c);this.search=function(a){a=e.search(a);var b=[];$.each(a,function(a,d){b.push(d.ref)});return new s(b)};this.map_contains=function(a,c){for(var k=vect.add(c,new vect(-b,b)),j=vect.add(c,new vect(b,-b)),k=new M(a.camera.project(k),a.camera.project(j)),k=e.search(k),j=0;j<k.length;j++){var f=k[j];if(f.ref.map_contains(a,c))return new s([f.ref])}return new s([])}}},Polygon:{geometry:function(a,c){sa.call(this,a,c);this.bounds=
Ba(this.geom);this.map_contains=function(a,e){return this.contains(a.camera.project(e))};this.contains=function(a){var e=0;if(this.bounds.contains(a)){e++;for(e=0;e<this.geom.length;e++){var d=0;$.each(this.geom[e],function(e,c){for(var j=0;j<c.length;j++){var f=(j+1)%c.length;if(0>(a.y-c[j][1])/(a.y-c[f][1])){var h=new vect(720,a.y),m=new vect(c[j][0],c[j][1]),f=new vect(c[f][0],c[f][1]);vect.intersects(a,h,m,f)&&d++}}});if(1==d%2)return!0}}return!1}},collection:function(a){for(var c=[],b=0;b<a.length;b++)$.each(a[b].geom,
function(e,d){$.each(d,function(d,e){$.each(e,function(d,e){c.push({ref:a[b],x:e[0],y:e[1]})})})});tree=new na(c);this.search=function(b){var d=tree.search(b),c={};$.each(d,function(a,b){c[b.ref.id]=b.ref});for(d=0;d<a.length;d++)for(var k=0;4>k;k++)a[d].contains(b.vertex(k))&&(c[a[d].id]=a[d]);b=[];for(var j in c)b.push(c[j]);return new s(b)};this.map_contains=function(a,b){return this.contains(a.camera.project(b))};this.contains=function(b){for(var d=[],c=0;c<a.length;c++)a[c].contains(b)&&d.push(a[c]);
return new s(d)}}},Line:{geometry:function(a,c){sa.call(this,a,c);this.bounds=Ba(this.geom);this.map_contains=function(){return!1}},collection:function(){this.search=function(){return new s([])};this.map_contains=function(){return new s([])};this.contains=function(){return new s([])}}}},sa=function(a){this.id=da();this.type="Feature";this.type=a.type;var c=a.attr;this.attr=function(a,e){if(2>arguments.length)return c[a];throw"Not Implemented";};this.geom=a.geom;this.geometry=function(){};this.style=
function(a,c,d){var g;!a||"Engine"==a.type?(g=a,a=c,c=d):g=null;if(void 0===c)return C.getStyle(this,g,a);C.setStyle(this,g,a,c);return this}},da,Ga=1;da=function(){var a=Ga;Ga++;return a};var xa;xa=function(a,c){return new vect(a+1E-6*Math.random()-5E-7,c+1E-6*Math.random()-5E-7)};var A=null,s=function(a){var c=null;this.length=a.length;this.count=function(){return a.length};this.items=function(){return a};this.type=function(b){for(var d=[],c=0;c<a.length;c++)a[c].type==b&&d.push(a[c]);return new s(d)};
this.join=function(b){for(var d=[],c=0;c<a.length;c++)d.push(a[c]);for(c=0;c<b.count();c++){var k=b.get(c);this.id(k.id)||d.push(k)}return new s(d)};this.attr=function(){throw"Not Implemented";};this.get=function(b){return a[b]};this.subset=function(b){for(var d=[],c=0;c<b.length;c++)d.push(a[b[c]]);return new s(d)};this.id=function(b){if(!c){c={};for(var d=0;d<a.length;d++)c[a[d].id]=a[d]}return b in c?c[b]:null};this.each=function(b){for(var d=0;d<a.length;d++)b(d,a[d]);return this};var b={">":function(a,
b){return a>b},"<":function(a,b){return a<b},"==":function(a,b){return a==b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b}};this.select=function(c){if(c.match(/^\s*\*\s*$/))return new s(a);var d=c.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!d)throw"Bad Selector";c=d[1];var g=d[2],k=null,j=null;isNaN(d[3])?j=d[3]:k=parseFloat(d[3]);new_elem=[];if(j)for(d=0;d<a.length;d++)b[g](a[d].attr(c),a[d].attr(j))&&new_elem.push(a[d]);else for(d=0;d<a.length;d++)b[g](a[d].attr(c),k)&&
new_elem.push(a[d]);return new s(new_elem)};this.filter=function(b){for(var c=[],g=0;g<a.length;g++)b(a[g])&&c.push(a[g]);return new s(c)};this.quantile=function(b,c,g){a.sort(function(a,c){return a.attr(b)-c.attr(b)});var k=Math.round(c*this.length/g);c=Math.round((c-1)*this.length/g);return new s(a.slice(c,k))};this.range=function(b){for(var c=Infinity,g=-Infinity,k=!1,j=0;j<a.length;j++){var f=a[j].attr(b);isNaN(f)||(k=!0,c>f&&(c=f),g<f&&(g=f))}return!k?null:{min:c,max:g}};this.style=function(b,
c,g){var k,j,f;"Engine"==b.type?(k=b,j=c,f=g):(k=null,j=b,f=c);if(void 0===f){if(a[0])return a[0].style(k,j)}else return $.each(a,function(a,b){b.style(k,j,"function"==typeof f?f(b):Ia(f)?f[a]:f)}),this}},J=null,w=null,L=null,w=null,Ya=1E3,qa=0,V=8,Ea=0,Da=0,x=null,Ha=[];window.wiggle={Map:function(a,c){void 0===c&&(c={});ya.call(this,a,c);h(c,{base:"default","tile-server":"http://eland.ecohealthalliance.org/wigglemaps"});this.Renderers={Point:La,Polygon:Pa,Line:la};this.styles={Point:{fill:new r(0.02,
0.44,0.69,1),opacity:1,radius:5,stroke:"none","stroke-width":2},Polygon:{fill:new r(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new r(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":0.75},Line:{stroke:new r(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":2},"default":{fill:new r(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new r(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":1}};var b=null;"default"==c.base||"nasa"==c.base?(b=l(c),n(b,{source:"file",url:c["tile-server"]+"/tiles/nasa_topo_bathy",
levels:8,size:256}),b=new ga(b)):"ne"==c.base?(b=l(c),n(b,{source:"file",url:c["tile-server"]+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),b=new ga(b)):"ne1"==c.base?(b=l(c),n(b,{source:"file",url:TILE_SERVER+"/tiles/NE1_HR_LC",levels:6,size:256}),b=new ga(b)):b=null;b&&(b.initialize(this),this.scene[b.id]=b)},TimeSeries:function(a,c){void 0===c&&(c={});ya.call(this,a,c);this.styles={"default":{fill:new r(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new r(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":2}};
this.extents(1,1);this.center(0.5,0.5);this.Renderers={"default":Sa}},layer:{Layer:fa,Grid:pa,Hillshade:Ca,Elevation:function(a){L||(L=B(y+"shaders/elevation"));var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),e=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var d=Z(a),g=E(t(new vect(0,1),new vect(1,0)),2),k=E(t(b,e),2);this.draw=function(a,c,h){h||(gl.useProgram(L),
L.data("screen",a.camera.mat3),L.data("pos",k),L.data("tex_in",g),L.data("elevation",d),vect.sub(a.camera.screen(e),a.camera.screen(b)),gl.drawArrays(gl.TRIANGLES,0,k.numItems))}}},io:{Shapefile:function(a){var c=a.path;$.ajax({url:c+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(b){for(var e=[],d=100;d<b.length;)e.push(2*ha(b,d)),d+=8;$.ajax({url:c+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(b){for(var c=[],d=[],f=0;f<e.length;f++){var h=e[f];ha(b,
h);ha(b,h+4);var m=h+8,l=D(b,m);if(0==l)console.log("NULL Shape");else if(1==l)l=X(b,m+4),m=X(b,m+12),c.push({type:"Point",attr:{},geom:[[l,m]]});else if(5==l){for(var l=D(b,m+36),m=D(b,m+40),n=h+52,h=h+52+4*l,p=[],r=0;r<l;r++){var s=D(b,n+4*r),u;u=r+1<l?D(b,n+4*(r+1)):m;var t=h,w=[];for(u-=1;u>=s;u--){var x=X(b,t+16*u),y=X(b,t+16*u+8);w.push([x,y])}p.push(w)}d.push({type:"Polygon",attr:{},geom:[p]})}else throw"Not Implemented: "+l;}if(0<c.length){var v=new fa(a);$.each(c,function(a,b){v.append(b)});
b=v}else 0<d.length?(v=new fa(a),$.each(d,function(a,b){v.append(b)}),b=v):b=void 0;a.success(b)}})}})},GeoJSON:function(a,c){void 0===c&&(c={});for(var b=new fa(c),e=0;e<a.features.length;e++){var d=a.features[e];if("Feature"==d.type){"Point"==d.geometry.type&&b.append({type:"Point",geom:[d.geometry.coordinates],attr:d.properties});"MultiPoint"==d.geometry.type&&b.append({type:"Point",geom:d.geometry.coordinates,attr:d.properties});if("Polygon"==d.geometry.type){for(var g=d.geometry.coordinates,
h=[],j=0;j<=g.length-1;j++){for(var f=[],l=g[j].length-1;0<=l;l--)f.push(g[j][l]);h.push(f)}b.append({type:"Polygon",geom:[h],attr:d.properties})}if("MultiPolygon"==d.geometry.type){var m=[];$.each(d.geometry.coordinates,function(a,b){for(var c=[],d=0;d<=b.length-1;d++){for(var e=[],f=b[d].length-1;0<=f;f--)e.push(b[d][f]);c.push(e)}m.push(c)});b.append({type:"Polygon",geom:m,attr:d.properties})}"MultiLineString"==d.geometry.type&&$.each(d.geometry.coordinates,function(a,c){b.append({type:"Line",
geom:[[c]],attr:d.properties})})}}return b},KML:function(a){var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),c=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();return new Wa(y+a,b,c)},SparseGrid:function(a,c){var b=Y(a,0),e=Y(a,4),d=D(a,8),g=D(a,12),h=Y(a,16),j={};for(key in c)j[key]=c[key];j.lower=new vect(b,e);j.upper=new vect(b+h*d,e+h*g);j.rows=g;j.cols=d;b=
new pa(j);for(e=20;e<a.length;){for(var h=D(a,e),d=D(a,e+4),g=e+4,j=d,f=0;f<j;f++){var l=Y(a,g+4*f);b.raw_set(h+f,l)}e+=8+4*d}return b},AsciiGrid:function(a,c){var b=a.split("\n"),e=b.splice(0,6),d=parseInt(e[0].slice(14)),g=parseInt(e[1].slice(14)),h=parseFloat(e[2].slice(14)),j=parseFloat(e[3].slice(14)),f=parseFloat(e[4].slice(14)),e=e[5].slice(14),l={};for(key in c)l[key]=c[key];l.lower=new vect(h,j);l.upper=new vect(h+f*d,j+f*g);l.rows=g;l.cols=d;h=new pa(l);for(j=0;j<g;j++){f=b[j].split(" ");
for(l=0;l<d;l++)f[l]==e?h.set(g-1-j,l,NaN):h.set(g-1-j,l,parseFloat(f[l]))}return h},WMS:function(a){a=l(a);for(var c=["url","layer"],b=0;b<c.length;b++){var e=c[b];if(!(e in a))throw"Key "+e+" not found";}h(a,{levels:16,size:256});var c={source:"wms"},d;for(d in c)a[d]=c[d];return new ga(a)}},util:{fcolor:ta,icolor:function(a,c,b,e){return new r(p(a/255,0,1),p(c/255,0,1),p(b/255,0,1),p(e/255,0,1))},Box:M,RangeTree:na},widget:{Slider:function(a,c,b){var e=function(a){if(a>=b)throw"Slider index out of bounds";
return c.x/(b-1)*a},d=function(d){return d<=a.x?0:d>=a.x+c.x?b-1:Math.round((d-a.x)/c.x*(b-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",a.x).css("top",a.y).css("width",c.x).css("height",c.y);var g=!1,h=0,j=$("<div></div>").addClass("slider-box").css("position","relative").css("left",-10).css("height",c.y).css("width",20).mousedown(function(){g=!0});this.tick=function(){return h};this.count=function(){return b};var f=function(){};this.change=function(a){f=
a};var l=function(){};this.release=function(a){l=a};this.dragging=function(){return g};this.dom.append(j);this.set=function(a){a!=h&&f(a);h=a;var b=e(a);j.css("left",b-10);l(a)};$(document).bind("mouseup",function(){if(g){g=!1;var a=d(event.clientX);l(a)}});$(document).bind("mousemove",function(a){g&&(a=d(a.clientX),a!=h&&f(a),h=a,a=e(a),j.css("left",a-10))})}},ready:function(a){Ha.push(a)}};$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(a,c){var b=/wigglemaps(\.min)?\.js/;
$(c).attr("src").match(b)&&(y=$(c).attr("src").replace(b,""))});$.each(Ha,function(a,c){c()})})})();
