// A basic vector type. Supports standard 2D vector operations
function vect(e,t){return new Vector2D(e,t)}var Vector2D=function(e,t){this.x=e,this.y=t,this.add=function(e){return this.x+=e.x,this.y+=e.y,this},this.sub=function(e){return this.x-=e.x,this.y-=e.y,this},this.scale=function(e){return this.x*=e,this.y*=e,this},this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.normalize=function(){var e=this.length();return e===0?this:(this.x/=e,this.y/=e,this)},this.div=function(e){return this.x/=e.x,this.y/=e.y,this},this.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},this.zero=function(){return this.x+this.y===0},this.dot=function(e){return this.x*e.x+this.y*e.y},this.cross=function(e){return this.x*e.y-this.y*e.x},this.rotate=function(e){var t=Math.cos(e),n=Math.sin(e);return xp=t*this.x-n*this.y,yp=n*this.x+t*this.y,this.x=xp,this.y=yp,this},this.clone=function(){return new Vector2D(this.x,this.y)},this.array=function(){return[this.x,this.y]}};vect.scale=function(e,t){return e.clone().scale(t)},vect.add=function(e,t){return e.clone().add(t)},vect.sub=function(e,t){return e.clone().sub(t)},vect.dist=function(e,t){return e.clone().sub(t).length()},vect.dir=function(e,t){return e.clone().sub(t).normalize()},vect.dot=function(e,t){return e.x*t.x+e.y*t.y},vect.cross=function(e,t){return e.x*t.y-e.y*t.x},vect.left=function(e,t,n,r){r||(r=0);var i=vect.sub(t,e),s=vect.sub(n,e);return vect.cross(i,s)>=-r},vect.intersects=function(e,t,n,r,i){return i||(i=0),vect.left(e,t,n,i)!=vect.left(e,t,r,i)&&vect.left(n,r,t,i)!=vect.left(n,r,e,i)},vect.intersect2dt=function(e,t,n,r){var i=e.x*(r.y-n.y)+t.x*(n.y-r.y)+r.x*(t.y-e.y)+n.x*(e.y-t.y);if(i===0)return Infinity;var s=e.x*(r.y-n.y)+n.x*(e.y-r.y)+r.x*(n.y-e.y),o=s/i,u=-(e.x*(n.y-t.y)+t.x*(e.y-n.y)+n.x*(t.y-e.y)),a=u/i;return a},vect.intersect2dpos=function(e,t,n,r){var i=e.x*(r.y-n.y)+t.x*(n.y-r.y)+r.x*(t.y-e.y)+n.x*(e.y-t.y);if(i===0)return Infinity;var s=e.x*(r.y-n.y)+n.x*(e.y-r.y)+r.x*(n.y-e.y),o=s/i,u=vect.sub(t,e);return u.scale(o),vect.add(e,u)},vect.rotate=function(e,t){var n=Math.cos(t),r=Math.sin(t);xp=n*e.x-r*e.y,yp=r*e.x+n*e.y;var i=new vect(xp,yp);return i},vect.normalize=function(e){return e.clone().normalize()},function(){"use strict";var e="";(function(e){function t(t){if(typeof t.data!="string")return;var n=t.handler,r=t.data.toLowerCase().split(" ");t.handler=function(t){if(!(this===t.target||!/textarea|select/i.test(t.target.nodeName)&&t.target.type!=="text"))return;var i=t.type!=="keypress"&&e.hotkeys.specialKeys[t.which],s=String.fromCharCode(t.which).toLowerCase(),o,u="",a={};t.altKey&&i!=="alt"&&(u+="alt+"),t.ctrlKey&&i!=="ctrl"&&(u+="ctrl+"),t.metaKey&&!t.ctrlKey&&i!=="meta"&&(u+="meta+"),t.shiftKey&&i!=="shift"&&(u+="shift+"),i?a[u+i]=!0:(a[u+s]=!0,a[u+e.hotkeys.shiftNums[s]]=!0,u==="shift+"&&(a[e.hotkeys.shiftNums[s]]=!0));for(var f=0,l=r.length;f<l;f++)if(a[r[f]])return n.apply(this,arguments)}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}},e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})})(jQuery),function(e){function r(t){var n=t||window.event,r=[].slice.call(arguments,1),i=0,s=!0,o=0,u=0;return t=e.event.fix(n),t.type="mousewheel",n.wheelDelta&&(i=n.wheelDelta/120),n.detail&&(i=-n.detail/3),u=i,n.axis!==undefined&&n.axis===n.HORIZONTAL_AXIS&&(u=0,o=-1*i),n.wheelDeltaY!==undefined&&(u=n.wheelDeltaY/120),n.wheelDeltaX!==undefined&&(o=-1*n.wheelDeltaX/120),r.unshift(t,i,o,u),(e.event.dispatch||e.event.handle).apply(this,r)}var t=["DOMMouseScroll","mousewheel"];if(e.event.fixHooks)for(var n=t.length;n;)e.event.fixHooks[t[--n]]=e.event.mouseHooks;e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=t.length;e;)this.addEventListener(t[--e],r,!1);else this.onmousewheel=r},teardown:function(){if(this.removeEventListener)for(var e=t.length;e;)this.removeEventListener(t[--e],r,!1);else this.onmousewheel=null}},e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var t=3.14159265,n=function(e,t){var n=[];for(var r in t)n.push(r+"="+t[r]);return e+"?"+n.join("&")},r=function(e,t){for(var n in t)n in e||(e[n]=t[n])},i=function(e,t){for(var n in t)e[n]=t[n]},s=function(e){var t={};for(var n in e)t[n]=e[n];return t},o=function(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(!(r in e))throw"Key "+r+" not found"}},u=function(e,t){for(var n in t)e[n]=t[n]},a=function(e,t,n,r,i){n in t?i?e[n]=i(t[n]):e[n]=t[n]:e[n]=r},f=function(e,t,n,r){n in t&&(r?e[n]=r(t[n]):e[n]=t[n])},l=function(e){if(e===null)return!1;if(e.length===undefined)return!1;for(var t=0;t<e.length;t++)if(!(t in e))return!1;return!0},c=function(e){var t=e[0];if(t=='"'||t=="'")if(e[e.length-1]==t)return!0;return!1},h=function(e){return e.match(/^rgb\(\d+,\d+,\d+\)$/)?!0:!1},p=function(e){return e.match(/^(\+|\-)?\d*\.\d*$/)&&e.length>1?!0:e.match(/^(\+|\-)?\d*\.\d*e(\+|\-)?\d+$/)&&e.length>1?!0:!1},d=function(e){return e.length==1?e.match(/^\d$/):e.match(/^(\+|\-)?\d+$/)},v=function(e,t){return e.indexOf(t)!=-1},m=function(e,t,n){return Math.min(Math.max(e,t),n)},g=function(e,t,n,r){e<=1&&t<=1&&n<=1&&r<=1?(this.r=e,this.g=t,this.b=n,this.a=r):(console.warn("Specifying colors as ints is deprecated"),this.r=e/255,this.g=t/255,this.b=n/255,this.a=r/255),this.array=[this.r,this.g,this.b,this.a],this.vect=function(){return this.array},this.rgb=function(){return"rgb("+parseInt(this.r*255,10)+","+parseInt(this.g*255,10)+","+parseInt(this.b*255,10)+")"}},y=function(e,t,n,r){return new g(m(e/255,0,1),m(t/255,0,1),m(n/255,0,1),m(r/255,0,1))},b=function(e,t,n,r){return new g(m(e,0,1),m(t,0,1),m(n,0,1),m(r,0,1))},w=function(e){return conosole.warn("Deprecated: use parseRGB instead"),"rgb("+Math.round(e[0]*255,10)+","+Math.round(e[1]*255,10)+","+Math.round(e[2]*255,10)+")"},E=function(e){var t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return y(t,n,r,255)},S=function(e){var t=e.match(/^rgb\((\d+),(\d+),(\d+)\)$/);return t?y(t[1],t[2],t[3],255):null},x={x:0,y:0};$(document).mousemove(function(e){x.x=e.clientX,x.y=e.clientY,x.lastMove=(new Date).getTime()});var T=function(e,t){return e.charCodeAt(t)},N=function(e,t){return((e.charCodeAt(t)&255)<<24)+((e.charCodeAt(t+1)&255)<<16)+((e.charCodeAt(t+2)&255)<<8)+(e.charCodeAt(t+3)&255)},C=function(e,t){return((e.charCodeAt(t+3)&255)<<24)+((e.charCodeAt(t+2)&255)<<16)+((e.charCodeAt(t+1)&255)<<8)+(e.charCodeAt(t)&255)},k=function(e,t){return((e.charCodeAt(t)&255)<<8)+(e.charCodeAt(t+1)&255)},L=function(e,t){return((e.charCodeAt(t+1)&255)<<8)+(e.charCodeAt(t)&255)},A=function(e,t){var n=e.charCodeAt(t)&255,r=e.charCodeAt(t+1)&255,i=e.charCodeAt(t+2)&255,s=e.charCodeAt(t+3)&255,o=e.charCodeAt(t+4)&255,u=e.charCodeAt(t+5)&255,a=e.charCodeAt(t+6)&255,f=e.charCodeAt(t+7)&255,l=1-2*(f>>7),c=((f&127)<<4)+((a&240)>>4)-1023,h=(a&15)*Math.pow(2,48)+u*Math.pow(2,40)+o*Math.pow(2,32)+s*Math.pow(2,24)+i*Math.pow(2,16)+r*Math.pow(2,8)+n;return l*(1+h*Math.pow(2,-52))*Math.pow(2,c)},O=function(e,t){var n=e.charCodeAt(t)&255,r=e.charCodeAt(t+1)&255,i=e.charCodeAt(t+2)&255,s=e.charCodeAt(t+3)&255,o=1-2*(s>>7),u=((s&127)<<1)+((i&254)>>7)-127,a=(i&127)*Math.pow(2,16)+r*Math.pow(2,8)+n;return o*(1+a*Math.pow(2,-23))*Math.pow(2,u)},M=function(e,t,n){var r=[],i=t;while(i<t+n){var s=e[i];if(s.charCodeAt(0)===0)break;r.push(s),i++}return r.join("")},_=!1,D=function(e){var t;if(!_)t=e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});else{var n=function(e,t,n){throw WebGLDebugUtils.glEnumToString(e)+" was caused by call to "+t};t=WebGLDebugUtils.makeDebugContext(e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),n)}return t},P=function(e,t,n,r){var i=[e-n,t+r,e-n,t-r,e+n,t+r,e-n,t-r,e+n,t-r,e+n,t+r];return i},H=function(e,t,n){var r;return arguments.length==2?r=[e.x,t.y,e.x,e.y,t.x,t.y,e.x,e.y,t.x,e.y,t.x,t.y]:r=[e.x,t.y,n,e.x,e.y,n,t.x,t.y,n,e.x,e.y,n,t.x,e.y,n,t.x,t.y,n],r},B=function(e,t){if(!e)return null;var n=e.createProgram(),r=j(e,e.VERTEX_SHADER,t+"/vert.glsl"),i=j(e,e.FRAGMENT_SHADER,t+"/frag.glsl");return e.attachShader(n,r),e.attachShader(n,i),e.linkProgram(n),F(e,n,r,i),n},j=function(e,t,n){var r=e.createShader(t);return $.ajax({async:!1,url:n,dataType:"text",success:function(t){e.shaderSource(r,t),e.compileShader(r);if(!e.getShaderParameter(r,e.COMPILE_STATUS))throw e.getShaderInfoLog(r);r.source=t},error:function(e){console.log("Could not load "+n)}}),r},F=function(e,t,n,r){var i={},s={},o=(n.source+r.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg),u=0;e.useProgram(t);if(o){for(var a=0;a<o.length;a++){var f=o[a].split(" ");i[f[2]]={u:f[0],type:f[1],loc:null};if(f[0]=="uniform")i[f[2]].loc=e.getUniformLocation(t,f[2]);else{var l=e.getAttribLocation(t,f[2]);i[f[2]].loc=l}f[1]=="sampler2D"&&(i[f[2]].tex=u,u++)}t.get=function(e){return i[e].loc},t.data=function(t,n){var r=i[t];if(!r)throw"Could not find shader variable "+t;if(r.u=="uniform")if(r.type=="float")e.uniform1f(r.loc,n);else if(r.type=="vec2")e.uniform2fv(r.loc,n);else if(r.type=="ivec2")e.uniform2iv(r.loc,n);else if(r.type=="vec3")e.uniform3fv(r.loc,n);else if(r.type=="ivec3")e.uniform3iv(r.loc,n);else if(r.type=="vec4")e.uniform4fv(r.loc,n);else if(r.type=="ivec4")e.uniform4iv(r.loc,n);else if(r.type=="bool")e.uniform1i(r.loc,n);else if(r.type=="mat4")e.uniformMatrix4fv(r.loc,!1,n);else if(r.type=="mat3")e.uniformMatrix3fv(r.loc,!1,n);else if(r.type=="sampler2D")"texture"in n&&(n=n.texture()),e.activeTexture(e["TEXTURE"+r.tex]),e.bindTexture(e.TEXTURE_2D,n),e.uniform1i(r.loc,r.tex);else{if(r.type!="int")throw"Unsupported Type for Shader Helper: "+r.type;e.uniform1i(r.loc,n)}else{if(r.u!="attribute")throw"Type: "+r.u+" Recieved";e.enableVertexAttribArray(r.loc),e.bindBuffer(e.ARRAY_BUFFER,n),e.vertexAttribPointer(r.loc,n.itemSize,e.FLOAT,!1,0,0)}}}},I=function(e,t,n,r){var i=e.createBuffer();i.itemSize=n,i.numItems=r;var s=new Float32Array(t.length*r*n);for(var o=0;o<r;o++)for(var u=0;u<t.length;u++)s[o*t.length+u]=t[u];return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),i},q=function(e,t,n){var r=e.createBuffer(),i=new Float32Array(t);return e.bindBuffer(e.ARRAY_BUFFER,r),r.itemSize=n,r.numItems=t.length/n,e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),r},R=function(e,t,n){var r=e.createBuffer(),i=0;for(var s=0;s<t.length;s++)i+=t[s].length;var o=new Float32Array(i),u=0;for(var s=0;s<t.length;s++)for(var a=0;a<t[s].length;a++)o[u]=t[s][a],u++;return e.bindBuffer(e.ARRAY_BUFFER,r),r.itemSize=n,r.numItems=i/n,e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),r},U=function(e,t,n){if(!e)return null;var r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r);var i=new Float32Array(t*n);return r.itemSize=n,r.numItems=t,r.update=function(t,n){var i=new Float32Array(t);e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferSubData(e.ARRAY_BUFFER,4*n,i),e.bindBuffer(e.ARRAY_BUFFER,null)},e.bufferData(e.ARRAY_BUFFER,i,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),r},z=function(e,t,n){var r=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r);var i=new Uint16Array(t);return r.itemSize=n,r.numItems=t/n,r.update=function(t,n){var i=new Uint16Array(t);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,2*n,i),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)},e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),r},W=0,X=function(e,t,n){var r=e.createTexture();r.id=W,W++;var i=new Image;return i.onload=function(){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),n&&n()},i.src=t,r},V=function(e,t){var n=e.gl,r={},i;t?i=t:i=256;var s=0,o=function(e,t,n,r){e||console.log("ack"),n||(n=0),r||(r=t.length);for(var i=0;i<r;i++)e[n+i]=t[i]},u=function(e){var t=i;while(t<e)t*=2;i=t;for(var s in r){var u=new Float32Array(t*r[s].len),a=r[s].array,f=U(n,i,r[s].len);o(u,a),r[s].array=u,r[s].buffer=f,r[s].dirty=!0}};this.create=function(e,t){if(!t)throw"Length of buffer must be a positive integer";var s=new Float32Array(i*t),o=U(n,i,t);r[e]={array:s,buffer:o,len:t,dirty:!1}},this.alloc=function(e){s+e>=i&&u(s+e);var t=s;return s+=e,t},this.get=function(e){return r[e].buffer},this.write=function(e,t,n,i){o(r[e].array,t,n*r[e].len,i*r[e].len),r[e].dirty=!0},this.repeat=function(e,t,n,i){for(var s=0;s<i;s++)o(r[e].array,t,(n+s)*r[e].len,r[e].len);r[e].dirty=!0},this.count=function(){return s},this.data=function(e){return r[e].array},this.update=function(){for(var t in r)r[t].dirty&&(r[t].buffer&&r[t].buffer.update(r[t].array,0),r[t].dirty=!1,e.dirty=!0)}},J=function(e,t){var n=e.gl,i=s(t);r(i,{mag_filter:n.LINEAR,min_filter:n.LINEAR,wrap_s:n.CLAMP_TO_EDGE,wrap_t:n.CLAMP_TO_EDGE,mipmap:!1});var o=n.createTexture(),u=null;this.image=function(t){u=t,n.bindTexture(n.TEXTURE_2D,o),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,u),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,i.mag_filter),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,i.min_filter),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,i.wrap_s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i.wrap_t),i.mipmap&&n.generateMipmap(n.TEXTURE_2D),n.bindTexture(n.TEXTURE_2D,null),e.dirty=!0},this.texture=function(){return u?o:null}},K=function(e,t){var n=new Image;n.crossOrigin="",n.onload=function(){t(n)},n.src=e},Q=function(e,t){this.min=e.clone(),this.max=t.clone(),this.contains=function(n){return e.x<=n.x&&t.x>=n.x&&e.y<=n.y&&t.y>=n.y},this.x_in=function(n){return e.x<=n.x&&t.x>=n.x},this.x_left=function(t){return e.x>=t.x},this.x_right=function(e){return t.x<=e.x},this.y_in=function(n){return e.y<=n.y&&t.y>=n.y},this.y_left=function(t){return e.y>=t.y},this.y_right=function(e){return t.y<=e.y},this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)},this.height=function(){return this.max.y-this.min.y},this.width=function(){return this.max.x-this.min.x},this.vertex=function(e){switch(e){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);default:throw"Index out of bounds: "+e}},this.intersects=function(e){for(var t=0;t<4;t++)for(var n=0;n<4;n++)if(vect.intersects(this.vertex(t),this.vertex((t+1)%4),e.vertex(n),e.vertex((n+1)%4)))return!0;return this.contains(e.min)&&this.contains(e.max)&&this.contains(new vect(e.min.x,e.max.y))&&this.contains(new vect(e.max.x,e.min.y))?!0:e.contains(this.min)&&e.contains(this.max)&&e.contains(new vect(this.min.x,this.max.y))&&e.contains(new vect(this.max.x,this.min.y))?!0:!1},this.union=function(e){this.min.x=Math.min(this.min.x,e.min.x),this.min.y=Math.min(this.min.y,e.min.y),this.max.x=Math.max(this.max.x,e.max.x),this.max.y=Math.max(this.max.y,e.max.y)},this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)},this.clone=function(){return new Q(e,t)}},G=function(e){var t=[],n=[];for(var r=0;r<e.length;r++){var i=[];if(e[r].length<=3)n.push(e[r]);else for(var s=1;s<e[r].length;s++)i.push(Vt(e[r][s][0],e[r][s][1]));i.push(t[0]),t.push(i)}var o=at(t);for(var s=0;s<n.length;s++)o.push(n[s][0][0]),o.push(n[s][0][1]),o.push(n[s][1][0]),o.push(n[s][1][1]),o.push(n[s][2][0]),o.push(n[s][2][1]);return o},Y=function(e,t){while(e>=t)e-=t;while(e<0)e+=t;return e},Z=function(e,t,n,r){this.current=e,this.upper=t,this.lower=n,this.index=r},et=function(e,t,n){var r=e.length-1,i=0,s=parseInt((e.length-1)/2,10);if(e.length===0)return 0;for(;;){if(r<0||i>=e.length)throw console.log(r,i,s,e.length),"Index Out of Bounds";if(e[s]==n)return s;if(r==i)return t[e[s]].x>t[n].x?s:s+1;if(t[e[s]].x>t[n].x)r=s;else if(t[e[s]].x<t[n].x)i=s+1;else if(t[e[s]].y>t[n].y){if(i==s)return i;r=s-1}else{if(r==s)return s;i=s+1}s=parseInt((r+i)/2,10)}},tt=function(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return!0;return!1},nt=function(e,t,n){if(t===undefined)throw"whoa";if(e[t+1].y-e[t].y===0)return Math.min(e[t].x,e[t+1].x);var r=(n-e[t].y)/(e[t+1].y-e[t].y);return e[t].x+(e[t+1].x-e[t].x)*r},rt=function(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return n;return!1},it=function(e,t,n,r){for(var i=0;i<e.length;i++){var s=nt(t,e[i],r);if(s>n)return i;if(s-n===0&&t[e[i]].y>t[index].y)return i}return e.length},st=function(e,t,n){return new vect(nt(t,n,t[e].y),t[e].y)},ot=function(e,t){if(!t)throw"eek";e.push(t.x),e.push(t.y)},ut=function(e,t,n){if(!t||!n||n.length+t.length!=3&&n.length+t.length!=4)throw"ahh";if(t.length+n.length==3){for(var r=0;r<t.length;r++)ot(e,t[r]);for(var r=0;r<n.length;r++)ot(e,n[r])}else{if(t[1].x<t[0].x){var i=t[0];t[0]=t[1],t[1]=i}if(n[1].x<n[0].x){var i=n[0];n[0]=n[1],n[1]=i}ot(e,t[0]),ot(e,t[1]),ot(e,n[1]),ot(e,n[0]),ot(e,n[1]),ot(e,t[0])}},at=function(e){var t=[],n=0,r=[];for(var i=0;i<e.length;i++){for(var s=0;s<e[i].length-1;s++){var o=Y(s+1,e[i].length-1),u=Y(s-1,e[i].length-1);t.push(new Z(s+n,o+n,u+n,i)),r.push(e[i][s])}r.push(e[i][0]),n+=e[i].length}t.sort(function(e,t){return r[e.current].y-r[t.current].y});var a=[],f=[],l=new vect(-200,0),c=new vect(200,0),n=0,h=[],p=0,d=[];for(var s=0;s<t.length;s++){var v=t[s],m=tt(a,v.lower),g=tt(a,v.current),y,b;m&&!g?(y=rt(a,v.lower),b=y):g&&!m?(b=rt(a,v.current),y=b):m&&g?(y=rt(a,v.lower),b=rt(a,v.current)):!m&&!g&&(b=it(a,r,r[v.current].x,r[v.current].y),y=b);if(Math.abs(y-b)>1){for(var o=0;o<a.length;o++);throw"Bad"}var w=vect.left(r[v.lower],r[v.current],r[v.upper]),E=Math.floor(Math.min(y,b)/2);!w&&!m&&!g?(ut(d,f[E],[st(v.current,r,a[b-1]),st(v.current,r,a[b])]),f.splice(E,1,[st(v.current,r,a[b-1]),r[v.current]],[r[v.current],st(v.current,r,a[y])])):w&&!m&&!g?f.splice(E,0,[r[v.current]]):m&&!g?(ut(d,f[E],[st(v.current,r,a[Math.max(y,b)-1]),r[v.current]]),f[E]=[st(v.current,r,a[Math.min(y,b)-1]),r[v.current]]):!m&&g?(ut(d,f[E],[r[v.current],st(v.current,r,a[Math.min(b,y)+1])]),f[E]=[r[v.current],st(v.current,r,a[Math.max(b,y)+1])]):!w&&m&&g?(ut(d,f[E],[st(v.current,r,a[Math.min(y,b)-1]),r[v.current]]),ut(d,f[E+1],[st(v.current,r,a[Math.max(y,b)+1]),r[v.current]]),f.splice(E,2,[st(v.current,r,a[Math.min(y,b)-1]),st(v.current,r,a[Math.max(y,b)+1])])):w&&m&&g&&(ut(d,f[E],[r[v.current]]),f.splice(E,1)),m&&!g?a[y]=v.current:g&&!m?a[b]=v.lower:m&&g?(a.splice(rt(a,v.lower),1),a.splice(rt(a,v.current),1)):!m&&!g&&(w?a.splice(y,0,v.lower,v.current):a.splice(y,0,v.current,v.lower));for(var o=0;o<a.length-1;o++)if(nt(r,a[o],r[v.current].y)>nt(r,a[o+1],r[v.current].y))throw console.log("Misplaced Sweep"),"Misplace!"}if(a.length>0)throw console.log(a),"Bad "+a.length;if(h.length>0)throw console.log(h),"Wrong";return d},ft=new function(){this.styles={},this.derivedStyle=function(e,t,n,r){if(!n)throw"Undefined operation";var i;return i=this.getStyle(e,n,r),i===null&&(i=this.getStyle(e,null,r),i===null&&(i=this.getStyle(t,n,r),i===null&&(i=this.getStyle(t,null,r),i===null&&(i=n.defaultStyle(e.type,r))))),i};var e=function(e){return e?e.id:"default"},t=function(t,n){var r=e(n);r in ft.styles||(ft.styles[r]={}),t.id in ft.styles[r]||(ft.styles[r][t.id]={})};this.getStyle=function(n,r,i){t(n,r);var s,o=e(r);return s=this.styles[o][n.id][i],s===undefined?null:s},this.setStyle=function(n,r,i,s){t(n,r);var o=e(r);this.styles[o][n.id][i]=s,ht.trigger(n,"style",[n,i])}},lt=function(e,t){var n=e.canvas,r=this;t||(t={}),t.width&&!t.height?t.height=t.width:!t.width&&t.height&&(t.width=t.height);var i=t.preserveAspectRatio?n.height()/n.width():1;t.min?t.center=vect.add(t.min,(new vect(t.width,t.height*i)).scale(.5)):t.center||(t.center=new vect(0,0));var s=t.width,o=t.height,u=t.height/t.width,a=t.center.clone(),f=1;this.worldToPx=new Float32Array(9),this.pxToScreen=new Float32Array(9),this.worldToScreen=new Float32Array(9),this.mat3=this.worldToScreen,this.reconfigure=function(){var i=t.preserveAspectRatio?n.height()/n.width():1,u=o/s,l=t.xlock?1:f,c=t.ylock?1:f,h=(new vect(s/l,s*u*i/c)).scale(.5),p=vect.add(a,h),d=vect.sub(a,h),v=n.width(),m=n.height(),g=vect.sub(p,d),y=function(){r.worldToPx[0]=v/g.x,r.worldToPx[1]=0,r.worldToPx[2]=0,r.worldToPx[3]=0,r.worldToPx[4]=m/g.y,r.worldToPx[5]=0,r.worldToPx[6]=-(d.x*v)/g.x,r.worldToPx[7]=-(d.y*m)/g.y,r.worldToPx[8]=1},b=function(){r.pxToScreen[0]=2/v,r.pxToScreen[1]=0,r.pxToScreen[2]=0,r.pxToScreen[3]=0,r.pxToScreen[4]=2/m,r.pxToScreen[5]=0,r.pxToScreen[6]=-1,r.pxToScreen[7]=-1,r.pxToScreen[8]=1},w=function(){r.worldToScreen[0]=2/g.x,r.worldToScreen[1]=0,r.worldToScreen[2]=0,r.worldToScreen[3]=0,r.worldToScreen[4]=2/g.y,r.worldToScreen[5]=0,r.worldToScreen[6]=-2*d.x/g.x-1,r.worldToScreen[7]=-2*d.y/g.y-1,r.worldToScreen[8]=1};y(),b(),w(),e.dirty=!0},this.reconfigure(),this.project=function(e){var t=new vect(2*(e.x-n.offset().left)/n.width()-1,-(2*(e.y-n.offset().top)/n.height()-1));return t.x=t.x/this.mat3[0]-this.mat3[6]/this.mat3[0],t.y=t.y/this.mat3[4]-this.mat3[7]/this.mat3[4],t},this.screen=function(e){var t=new vect(e.x*this.mat3[0]+this.mat3[6],e.y*this.mat3[4]+this.mat3[7]);return t.x=n.offset().left+n.width()*(t.x+1)/2,t.y=n.offset().top+n.height()*(-t.y+1)/2,t},this.percent=function(e){return new vect(2*((e.x-n.offset().left)/n.width())-1,-(2*((e.y-n.offset().top)/n.height())-1))},this.pixel=function(e){return new vect(n.offset().left+(e.x+1)/2*n.width(),n.offset().top+(-e.y+1)/2*n.height())},this.move=function(e){a.add(e),this.reconfigure()},this.zoom=function(e){if(e===undefined)return f;f=e,this.reconfigure()},this.position=function(e,t){if(e===undefined)return a.clone();t===undefined?a=e.clone():a=new vect(e,t),this.reconfigure()},this.reset=function(){f=1,this.reconfigure()},n.resize(function(e){r.reconfigure()}),this.extents=function(e){s=e,o=e*u,f=1,this.reconfigure()},this.size=function(){var e=t.preserveAspectRatio?n.height()/n.width():1,r=o/s,i=t.xlock?1:f,u=t.ylock?1:f;return new vect(s/i,s*r*e/u)}},ct=function(e,t){var n=!1,r=new vect(0,0),i=new vect(0,0),s=null,o=0;e.canvas.mousedown(function(e){r=new vect(e.clientX,e.clientY),n=!0}),$(window).bind("mouseup",function(){n=!1}),$(document).bind("keypress","+",function(t){e.camera.zoom(1.1)}),$(document).bind("keypress","-",function(t){e.camera.zoom(10/11)}),$(document).bind("keypress","0",function(t){e.camera.reset()}),e.canvas.bind("mousewheel",function(t,n){n*=.5,n<0?(n*=-1,n+=1,n=1/n):n+=1;var r=e.camera.zoom();e.camera.zoom(r*n),a(),t.preventDefault()});var u=!0;this.disable=function(){u=!1},this.enable=function(){u=!0},this.update=function(t){i=new vect(x.x,x.y);var f=!1,l;if(n&&u){var c=vect.sub(e.camera.project(r),e.camera.project(i)),h=e.camera.position();l=vect.add(h,c),e.camera.position(l),r=i,o=c.length()/t,s=c,s.normalize(),f=!0}else if(o>.01&&s){var c=vect.scale(s,o*t),h=e.camera.position();l=vect.add(h,c),e.camera.position(l),o-=3*t*o,f=!0}f&&a()};var a=function(){if(t.worldMin&&t.worldMax){var n=e.camera.position(),r=e.camera.size(),i=t.worldMax.x-t.worldMin.x;if(r.x>i){var s=r.x*e.camera.zoom();e.camera.zoom(i/s)}n=e.camera.position(),r=e.camera.size();var o=t.worldMax.y-t.worldMin.y;if(r.y>o){var u=r.y*e.camera.zoom();e.camera.zoom(o/u)}}var n=e.camera.position(),a=e.camera.size().scale(.5),f=!1;t.worldMin&&(n.x-a.x<t.worldMin.x&&(n.x=t.worldMin.x+a.x),n.y-a.y<t.worldMin.y&&(n.y=t.worldMin.y+a.y),f=!0),t.worldMax&&(n.x+a.x>t.worldMax.x&&(n.x=t.worldMax.x-a.x),n.y+a.y>t.worldMax.y&&(n.y=t.worldMax.y-a.y),f=!0),f&&e.camera.position(n)}},ht=new function(){this.listeners={},this.manage=function(e){e.id in this.listeners||(this.listeners[e.id]={parents:[],callbacks:{}})},this.linkParent=function(e,t){this.manage(e),this.manage(t),this.listeners[t.id].parents.push(e)},this.addEventHandler=function(e,t,n){this.manage(e),this.listeners[e.id].callbacks[t]||(this.listeners[e.id].callbacks[t]=[]),this.listeners[e.id].callbacks[t].push(n)};var e=null;this.moveMouse=function(e){},this.clickMouse=function(e){},this.mouseDown=function(e){},this.mouseOver=function(t){e!==null&&t!=e&&this.trigger(e,"mouseout",[e]),t!==null&&t!=e&&this.trigger(t,"mouseover",[t]),e=t},this.trigger=function(e,t,n){e.id in this.listeners&&(t in this.listeners[e.id].callbacks&&$.each(this.listeners[e.id].callbacks[t],function(t,r){r.apply(e,n)}),$.each(this.listeners[e.id].parents,function(e,r){ht.trigger(r,t,n)}))}},pt=function(e,t){this.style_map={},this.geom=e;var n={};this.updateMany=function(e){for(var t in e)this.updateOne(t,e[value])},this.updateOne=function(e,t){if(t===undefined)throw"No value for style defined";if(n[e]==t)return;n[e]=t,e in this.style_map&&this.style_map[e](t)},this.updateDefault=function(e){var n=t(e);this.updateOne(e,n)},this.update=function(e,t){typeof e=="string"?t===undefined?this.updateDefault(e):this.updateOne(e,t):this.updateMany(e)},this.keys=function(){var e={};for(var t in this.style_map)e[t]=!0;return e},this.updateAll=function(){for(var e in this.style_map)this.updateDefault(e)}},dt=function(e){var t=this;this.engine=e,this.views=[],this.update=function(e){for(var t=0;t<views.length;t++)this.views[t].update(e)},this.View=function(){throw"Attempt to call abstract function"},this.create=function(e,t){var n=new this.View(e,t);return this.views.push(n),n.updateAll(),n},this.draw=function(){throw"Attempt to call abstract function"}},vt=1024,mt=P(0,0,1,1),gt=function(t,n){dt.call(this,t,n),t.shaders.point||(t.shaders.point=B(t.gl,e+"shaders/point"));var r=t.shaders.point,i=10,s=new V(t,vt);s.create("vert",2),s.create("unit",2),s.create("stroke_width",1),s.create("rad",1),s.create("fill_color",3),s.create("fill",1),s.create("stroke_color",3),s.create("stroke",1),s.create("alpha",1);var o=function(e,t){pt.call(this,e,t);var n,r;this.style_map={fill:function(e){e=="none"?s.repeat("fill",[-0.75],n,r):(s.repeat("fill",[.75],n,r),s.repeat("fill_color",e.array,n,r))},opacity:function(e){s.repeat("alpha",[e],n,r)},radius:function(e){e>i&&(i=e),s.repeat("rad",[e],n,r)},stroke:function(e){e=="none"?s.repeat("stroke",[-0.75],n,r):(s.repeat("stroke",[.75],n,r),s.repeat("stroke_color",e.array,n,r))},"stroke-width":function(e){s.repeat("stroke_width",[e],n,r)}};var o=e.length;r=6*o,n=s.alloc(r),$.each(e,function(e,t){s.repeat("vert",t,n+e*6,6),s.write("unit",mt,n+e*6,6)})};this.View=o,this.update=function(){s.update()},this.draw=function(){var e=t.gl;e.useProgram(r),r.data("screen",t.camera.mat3),r.data("pos",s.get("vert")),r.data("circle_in",s.get("unit")),r.data("color_in",s.get("fill_color")),r.data("stroke_color_in",s.get("stroke_color")),r.data("alpha_in",s.get("alpha")),r.data("fill_in",s.get("fill")),r.data("stroke_in",s.get("stroke")),r.data("aspect",t.canvas.width()/t.canvas.height()),r.data("pix_w",2/t.canvas.width()),r.data("rad",s.get("rad")),r.data("stroke_width_in",s.get("stroke_width")),r.data("max_rad",i),e.drawArrays(e.TRIANGLES,0,s.count())}},yt=1024,bt=function(e,t){var n=6*t.length,r=e.alloc(n),i=[-1,1,-1,-1,1,-1,-1,1,1,-1,1,1],s=0,o=function(){if(t[s]){var e=new vect(t[s][0],t[s][1]);return s++,e}return null},u=null,a=o(),f=o(),l=[],c=[],h=[];while(a)l.push(u||vect.add(a,vect.sub(a,f))),c.push(a),h.push(f||vect.add(a,vect.sub(a,u))),u=a,a=f,f=o();var p=[],d=[],v=[],m=r,g=function(t,n,r){e.write("prev",t.array(),m,1),e.write("current",n.array(),m,1),e.write("next",r.array(),m,1),m++};for(var y=1;y<t.length;y++)e.write("unit",i,m,6),g(l[y-1],c[y-1],h[y-1]),g(h[y-1],c[y-1],l[y-1]),g(h[y],c[y],l[y]),g(l[y-1],c[y-1],h[y-1]),g(h[y],c[y],l[y]),g(l[y],c[y],h[y]);return n},wt=function(t){dt.call(this,t),t.shaders.line||(t.shaders.line=B(t.gl,e+"shaders/line"));var n=t.shaders.line,r=new V(t,1024);r.create("prev",2),r.create("current",2),r.create("next",2),r.create("unit",2),r.create("width",1),r.create("color",3),r.create("alpha",1);var i=function(e,t){pt.call(this,e,t);var n=r.count(),i=0;this.style_map={stroke:function(e){r.repeat("color",e.array,n,i)},"stroke-opacity":function(e){r.repeat("alpha",[e],n,i)},"stroke-width":function(e){r.repeat("width",[e],n,i)}};var s=function(e,t){return e[0]==t[0]&&e[1]==t[1]};$.each(e,function(e,t){for(var e=0;e<t.length;e++)i+=bt(r,t[e])})};this.View=i,this.update=function(){r.update()},this.draw=function(){var e=t.gl;r.update(),e.useProgram(n),n.data("world",t.camera.worldToPx),n.data("screen",t.camera.pxToScreen),n.data("prev",r.get("prev")),n.data("current",r.get("current")),n.data("next",r.get("next")),n.data("color_in",r.get("color")),n.data("alpha_in",r.get("alpha")),n.data("circle_in",r.get("unit")),n.data("width",r.get("width")),n.data("px_w",2/t.canvas.width()),n.data("px_h",2/t.canvas.height()),e.drawArrays(e.TRIANGLES,0,r.count())}},Et=1024,St=function(t){dt.call(this,t),t.shaders.polygon||(t.shaders.polygon=B(t.gl,e+"shaders/poly"));var n=t.shaders.polygon,r=new V(t,Et);r.create("vert",2),r.create("color",3),r.create("alpha",1);var i=function(e,t){pt.call(this,e,t);var n,i;this.style_map={fill:function(e){r.repeat("color",e.array,n,i)},"fill-opacity":function(e){r.repeat("alpha",[e],n,i)}};var s=[];i=0,$.each(e,function(e,t){var n,r=0;while(r<100)try{n=G(t);break}catch(o){r++}r==100&&(console.log("Rendering Polygon Failed: Skipping Interior"),n=[]),i+=n.length/2,s.push(n)}),n=r.alloc(i);var o=n;$.each(s,function(e,t){var n=t.length/2;r.write("vert",t,o,n),o+=n})};this.View=i,this.update=function(e){r.update()},this.draw=function(){var e=t.gl;r.update(),e.useProgram(n),n.data("screen",t.camera.mat3),n.data("pos",r.get("vert")),n.data("color_in",r.get("color")),n.data("alpha_in",r.get("alpha")),e.drawArrays(e.TRIANGLES,0,r.count())}},xt=function(e,t,n){wt.call(this,e,t,n);var r=n.order;this.View=function(e){var t=[],n=[];for(var i=0;i<r.length;i++){var s=e.attr(r[i]);isNaN(s)?n.length>0&&(t.push(n),n=[]):n.push([i,s])}n.length>0&&t.push(n);var o=[t];return o}},Tt=function(e){return function(t,n,r){var i=[],s=function(e){this.update=function(t,n){$.each(e,function(e,r){r.update(t,n)})},this.keys=function(){var t={};return $.each(e,function(e,n){for(var r in n.style_map)t[r]=!0}),t}};$.each(e,function(e,s){i.push(new s(t,n,r))}),this.views=[],this.create=function(e,t){var n=[];return $.each(i,function(r,i){n.push(i.create(e,t))}),new s(n)},this.update=function(){$.each(i,function(e,t){t.update()})},this.draw=function(){$.each(i,function(e,t){t.draw()})}}},Nt={},Ct=function(t,n,i){i||(i={}),i.style||(i.style={}),r(i,{mode:"lonlat",pos:vect(0,0),height:8,padding:vect(5,3)}),this.priority=i.priority,t.text_shader||(t.text_shader=B(t.gl,e+"shaders/text")),"OpenSans"in Nt||$.ajax({url:e+"/fonts/OpenSans.svg",async:!1,dataType:"xml",success:function(e){Nt.OpenSans={};var t=e.getElementsByTagName("glyph");for(var n=0;n<t.length;n++){var r=t[n].getAttribute("unicode");Nt.OpenSans[r]={path:t[n].getAttribute("d"),hor:parseFloat(t[n].getAttribute("horiz-adv-x"))}}}});var s=new V(t);s.create("pos",2),s.create("tex",2),s.create("mode",1);var o=function(e){var t=0;for(var n=0;n<e.length-2;n++)t+=(e[n+1][0]-e[n][0])*(e[n+1][1]+e[n][1]);return t>0},u=function(e,t,n){if(!e)return;var r=[0+t,0],i=[0+t,0],o=/([A-Za-z])([^A-Za-z]*)/g,u=null,a=[],f=[];while(u=o.exec(e)){var l=u[2].split(" "),c;if(u[1].match("[Zz]"))c=[r[0],r[1]],f.push(f[0]),f&&a.push(f),f=[];else if(u[1].match(/[M]/)
)c=[parseFloat(l[0])+t,parseFloat(l[1])],f.push(c),r=c;else if(u[1].match(/[Ll]/))u[1]=="L"?c=[parseFloat(l[0])+t,parseFloat(l[1])]:u[1]=="l"&&(c=[r[0]+parseFloat(l[0]),r[1]+parseFloat(l[1])]),f.push(c),r=c;else if(u[1].match(/[Hh]/))u[1]=="H"?c=[parseFloat(l[0])+t,r[1]]:u[1]=="h"&&(c=[r[0]+parseFloat(l[0]),r[1]]),f.push(c),r=c;else if(u[1].match(/[Vv]/))u[1]=="V"?c=[r[0],parseFloat(l[0])]:u[1]=="v"&&(c=[r[0],r[1]+parseFloat(l[0])]),f.push(c),r=c;else{if(!u[1].match(/[QqTt]/))throw"Path error: "+u[1];u[1]=="Q"?(i=[parseFloat(l[0])+t,parseFloat(l[1])],c=[parseFloat(l[2])+t,parseFloat(l[3])]):u[1]=="q"?(i=[r[0]+parseFloat(l[0]),r[1]+parseFloat(l[1])],c=[r[0]+parseFloat(l[2]),r[1]+parseFloat(l[3])]):u[1]=="T"?(i=[-(i[0]-r[0])+r[0],-(i[1]-r[1])+r[1]],c=[parseFloat(l[0])+t,parseFloat(l[1])]):u[1]=="t"&&(i=[-(i[0]-r[0])+r[0],-(i[1]-r[1])+r[1]],c=[r[0]+parseFloat(l[0]),r[1]+parseFloat(l[1])]);var h,p=new vect(c[0],c[1]),d=new vect(r[0],r[1]),v=new vect(i[0],i[1]);vect.left(p,d,v)?(h=1,f.push(i),f.push(c)):(h=0,f.push(c));var m=s.alloc(3);s.write("pos",[r[0],r[1],c[0],c[1],i[0],i[1]],m,3),s.write("tex",[0,0,1,1,.5,0],m,3),s.repeat("mode",[h],m,3),r=c}}var g=0;for(var y=0;y<a.length;y++)a[y].reverse();var b;while(g<100)try{b=G(a),g=101}catch(w){g++}g==100&&console.log("rendering polygon failed on",n);var E=b.length/2,S=s.alloc(E);s.write("pos",b,S,E),s.repeat("tex",[0,0],S,E),s.repeat("mode",[.5],S,E);var x=Infinity,T=-Infinity;for(var y=0;y<a.length;y++)for(var N=0;N<a[y].length;N++)a[y][N][0]<x&&(x=a[y][N][0]),a[y][N][0]>T&&(T=a[y][N][0])},a=0,f=Nt.OpenSans;for(var l=0;l<n.length;l++)n[l]!="P"&&u(f[n[l]].path,a,n[l]),a+=f[n[l]].hor;var c=i.height*a/1e3;this.bbox=function(){var e=t.camera.screen(i.pos),n=vect(c,i.height),r=new Q(vect(e.x-i.padding.x,e.y-n.y-i.padding.y),vect(e.x+n.x+i.padding.x,e.y+i.padding.y));return r},this.draw=function(e,t){var n=e.gl;s.update();var r=e.text_shader;n.useProgram(r),r.data("screen",e.camera.mat3),r.data("pos",s.get("pos")),r.data("tex_in",s.get("tex")),r.data("mode_in",s.get("mode")),r.data("px",2/e.canvas.width()),r.data("py",2/e.canvas.height()),r.data("translate",[i.pos.x,i.pos.y]),r.data("height",i.height),r.data("aspect",e.canvas.height()/e.canvas.width()),r.data("one_px",2/e.canvas.height()),n.drawArrays(n.TRIANGLES,0,s.count())}},kt=function(e,t,n){var r={};$.each(e.Queriers,function(i,s){r[i]=new s(e,t,n)}),this.boxSearch=function(e){var t=new Mt([]);for(var n in r){var i=r[n].boxSearch(e);t=t.join(i)}return t},this.pointSearch=function(e){for(var t in r){var n=r[t].pointSearch(e);if(n)return n}return null}},Lt=function(e,t,n){var r=t.features().type("Point"),i=[],s=0;r.each(function(n,r){var o=ft.derivedStyle(r,t,e,"radius");o>s&&(s=o),$.each(r.geom,function(e,t){i.push({x:t[0],y:t[1],ref:r})})});var o=new It(i);this.boxSearch=function(e){var t=o.search(e),n=[];return $.each(t,function(e,t){n.push(t.ref)}),new Mt(n)};var u=function(e){return new vect(e[0],e[1])};this.pointSearch=function(n){var r=vect.add(n,new vect(-s,s)),i=vect.add(n,new vect(s,-s)),a=new Q(e.camera.project(r),e.camera.project(i)),f=o.search(a);for(var l=0;l<f.length;l++){var c=f[l].ref,h=ft.derivedStyle(c,t,e,"radius");for(var p=0;p<c.geom.length;p++){var d=e.camera.screen(u(c.geom[p]));if(vect.dist(d,n)<h)return c}}return null}},At=function(e,t,n){var r=t.features().type("Polygon"),i=[];r.each(function(e,t){$.each(t.geom,function(e,n){$.each(n,function(e,n){$.each(n,function(e,n){i.push({ref:t,x:n[0],y:n[1]})})})})});var s=new It(i);this.boxSearch=function(e){var t=s.search(e),n={};$.each(t,function(e,t){n[t.ref.id]=t.ref}),r.each(function(t,r){for(var i=0;i<4;i++)r.contains(e.vertex(i))&&(n[r.id]=r)});var i=[];for(var o in n)i.push(n[o]);return new Mt(i)},this.pointSearch=function(t){var n=e.camera.project(t);for(var i=0;i<r.count();i++){var s=r.get(i);if(s.contains(n))return s}return null}},Ot=function(e,t,n){var r=t.features(),i=[];t.features().each(function(e,t){$.each(n.geomFunc(t),function(e,n){$.each(n,function(e,n){$.each(n,function(e,n){i.push({ref:t,x:n[0],y:n[1]})})})})});var s=new It(i);this.boxSearch=function(e){var t=s.search(e),n={};$.each(t,function(e,t){n[t.ref.id]=t.ref});var r=[];for(var i in n)r.push(n[i]);return new Mt(r)},this.pointSearch=function(i){var s=e.camera.project(i),o=Math.floor(s.x);if(o<0||o>=n.order.length)return null;for(var u=0;u<r.count();u++){var a=r.get(u),f=a.attr(n.order[o]),l=a.attr(n.order[o+1]);if(isNaN(f)||isNaN(l))continue;var c=vect(o,f),h=vect(o+1,l),p=e.camera.screen(c),d=e.camera.screen(h),v=vect.dir(d,p),m=vect.sub(i,p),g=vect.dot(m,v),y=m.length(),b=Math.sqrt(Math.pow(y,2)-Math.pow(g,2));if(b<ft.derivedStyle(a,t,e,"stroke-width"))return a}return null}},Mt=function(e){var t=null;this.length=e.length,this.count=function(){return e.length},this.items=function(){return e},this.type=function(t){var n=[];for(var r=0;r<e.length;r++)(t=="*"||e[r].type==t)&&n.push(e[r]);return new Mt(n)},this.join=function(t){var n=[];for(var r=0;r<e.length;r++)n.push(e[r]);for(var r=0;r<t.count();r++){var i=t.get(r);this.id(i.id)||n.push(i)}return new Mt(n)},this.not=function(t){var n=[];for(var r=0;r<e.length;r++)t.id(e[r].id)===null&&n.push(e[r]);return new Mt(n)},this.both=function(t){var n=[];for(var r=0;r<e.length;r++)t.id(e[r].id)!==null&&n.push(e[r]);return new Mt(n)},this.attr=function(e){throw"Not Implemented"},this.get=function(t){return e[t]},this.subset=function(t){var n=[];for(var r=0;r<t.length;r++)n.push(e[t[r]]);return new Mt(n)},this.id=function(n){if(!t){t={};for(var r=0;r<e.length;r++)t[e[r].id]=e[r]}return n in t?t[n]:null},this.each=function(t){for(var n=0;n<e.length;n++)t(n,e[n]);return this};var n={">":function(e,t){return e>t},"<":function(e,t){return e<t},"==":function(e,t){return e==t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t}};this.select=function(t){if(t.match(/^\s*\*\s*$/))return new Mt(e);var r=t.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!r)throw"Bad Selector";var i=r[1],s=r[2],o=null,u=null;isNaN(r[3])?u=r[3]:o=parseFloat(r[3]);var a=[];if(u)for(var f=0;f<e.length;f++)n[s](e[f].attr(i),e[f].attr(u))&&a.push(e[f]);else for(var f=0;f<e.length;f++)n[s](e[f].attr(i),o)&&a.push(e[f]);return new Mt(a)},this.filter=function(t){var n=[];for(var r=0;r<e.length;r++)t(e[r])&&n.push(e[r]);return new Mt(n)},this.quantile=function(t,n,r){var i=e.filter(function(e){return e.attr(t)!==undefined});i.sort(function(e,n){return e.attr(t)-n.attr(t)});var s=Math.round(n*i.length/r),o=Math.round((n-1)*i.length/r);return new Mt(i.slice(o,s))},this.range=function(t){var n=Infinity,r=-Infinity,i=!1;for(var s=0;s<e.length;s++){var o=e[s].attr(t);isNaN(o)||(i=!0,n>o&&(n=o),r<o&&(r=o))}return i?{min:n,max:r}:null},this.style=function(t,n,r){var i=function(e,t,n){return typeof e=="function"?e(n):l(e)?e[t]:e},s,o,u;t.type=="Engine"?(s=t,o=n,u=r):(s=null,o=t,u=n);if(u!==undefined)return $.each(e,function(e,t){t.style(s,o,i(u,e,t))}),this;if(e[0])return e[0].style(s,o)}},_t=function(e,t,n){var r=this;ht.manage(t),ht.linkParent(e,t),this.renderers={},this.views={};var i=function(n,i){var s=ft.derivedStyle(n,t,e,i);r.views[n.id].update(i,s)};t.features().each(function(s,o){var u;o.type in e.Renderers?u=o.type:u="default",u in r.renderers||(r.renderers[u]=new e.Renderers[u](e,t,n));var a=r.renderers[u].create(n.geomFunc(o),function(n){return function(r){return ft.derivedStyle(n,t,e,r)}}(o));r.views[o.id]=a,ht.linkParent(t,o),ht.addEventHandler(o,"style",i)}),this.update=function(e,t){for(var n in this.renderers)this.renderers[n].update(t)},this.draw=function(e,t){for(var n in this.renderers)this.renderers[n].draw(t)}},Dt=function(e,t){var n=[];this.append=function(t,i){r(i,{priority:0});var s=new Ct(e,t,i);n.push(s),n.sort(function(e,t){return t.priority-e.priority})},this.draw=function(e,t){var r=[];$.each(n,function(n,i){var s=i.bbox();for(var n=0;n<r.length;n++)if(r[n].bbox().intersects(s))return!1;i.draw(e,t),r.push(i)})}},Pt=function(e,t){var n=this;r(t,{background:new g(0,0,0,1)}),this.type="Engine",this.id=Xt(),this.canvas=$("<canvas></canvas>").attr("id","viewer");var i=null;e?$(e).append(this.canvas):(e=window,$("body").append(this.canvas)),this.canvas.attr("width",$(e).width()),this.canvas.attr("height",$(e).height()),$(window).resize(function(e){n.resize()});var s=[],o=[];this.framebuffer=function(){var e=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,e),e.width=n.canvas.width(),e.height=n.canvas.height();var t=i.createTexture();i.bindTexture(i.TEXTURE_2D,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,i.RGBA,i.UNSIGNED_BYTE,null);var u=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,u),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e.width,e.height),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,u),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null);var a={framebuffer:e,renderbuffer:u,tex:t,resize:function(){e.width=n.canvas.width(),e.height=n.canvas.height(),i.bindTexture(i.TEXTURE_2D,t),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e.width,e.height,0,i.RGBA,i.UNSIGNED_BYTE,null),i.bindRenderbuffer(i.RENDERBUFFER,u),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e.width,e.height),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null)},activate:function(t){t||(t={}),r(t,{blend:!0,clear:!0}),o.push(e),t.blend||i.disable(i.BLEND),i.bindFramebuffer(i.FRAMEBUFFER,e),i.viewport(0,0,n.canvas.width(),n.canvas.height()),t.clear&&(i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.clearDepth(0))},deactivate:function(){var t=o.pop(),n=o[o.length-1];if(t!=e)throw"Non-nested use of framebuffers";i.bindFramebuffer(i.FRAMEBUFFER,n),i.enable(i.BLEND)}};return s.push(a),a},this.resize=function(){this.canvas.attr("width",$(e).width()),this.canvas.attr("height",$(e).height()),i.viewport(0,0,this.canvas.width(),this.canvas.height()),this.camera.reconfigure();for(var t=0;t<s.length;t++)s[t].resize()},i=D(this.canvas,_),this.gl=i,i.viewport(0,0,this.canvas.width(),this.canvas.height()),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.enable(i.BLEND),this.camera=new lt(n,t),this.scroller=new ct(this,t),this.extents=function(e){this.camera.extents(e)},this.center=function(e,t){t===undefined?this.camera.position(e):this.camera.position(new vect(e,t))},this.pxW=1/this.canvas.attr("width"),this.pxH=1/this.canvas.attr("height"),this.Renderers={},this.Queriers={},this.renderers={},this.views={},this.styles={},this.dirty=!0,this.defaultStyle=function(e,t){var n;e in this.styles&&(n=this.styles[e][t]);if(n===null||n===undefined)n=this.styles["default"][t];return n===null||n===undefined?null:n},ht.manage(this),this.search=function(e,t){return this.queriers[e.id].boxSearch(t)},this.style=function(e,t,n){this.styles[e.id]===undefined&&(this.styles[e.id]={});if(n===undefined)return this.styles[e.id][t]!==undefined?this.styles[e.id][t]:null;this.styles[e.id][t]=n,e.id in this.views?this.views[e.id].update(t):e.id in this.renderers&&$.each(this.renderers[e.id],function(e,t){t.update()})};var u=new jt(this);this.select=function(e){u.select(e)};var a=!1;this.enableSelect=function(){this.scroller.disable(),u.enable(),a=!0},this.disableSelect=function(){this.scroller.enable(),u.disable(),a=!1};var f=(new Date).getTime(),l=[],c=function(e){return function(){e.draw()}}(this);this.shaders={},this.scene=[],this.queriers={};var h=0,p=0;this.update=function(){var e=(new Date).getTime(),t=(e-f)/1e3;l.length>=60&&l.splice(0,1),l.push(t);var r=0;for(var i=0;i<l.length;i++)r+=l[i];r/=l.length,$("#fps").text(Math.floor(1/r)),f=e,this.scroller.update(t);if(x.lastMove>p){var s=vect(x.x,x.y),o=!1;$.each(this.queriers,function(e,t){var n=t.pointSearch(s);if(n)return ht.mouseOver(n),o=!0,!1}),o||ht.mouseOver(null)}p=x.lastMove,$.each(this.scene,function(e,r){r.update&&r.update(n,t)})};var d=new Dt(this,t);this.label=function(e,t){d.append(e,t)},this.draw=function(){this.update(),this.dirty&&(i.clearColor(t.background.r,t.background.g,t.background.b,t.background.a),i.clear(i.COLOR_BUFFER_BIT),i.clearDepth(0),$.each(this.scene,function(e,t){t.draw(n)}),d.draw(n),a&&u.draw(this)),this.dirty=!1,requestAnimationFrame(c)},this.enableZ=function(){i.depthFunc(i.LEQUAL),i.enable(i.DEPTH_TEST)},this.disableZ=function(){i.disable(i.DEPTH_TEST)},this.canvas.mouseout(function(){ht.mouseOver(null)}),requestAnimationFrame(c)},Ht=function(e,t){var n=this;t===undefined&&(t={}),t.geomFunc=function(e){return e.geom},r(t,{width:360,center:new vect(0,0),base:"default","tile-server":"http://eland.ecohealthalliance.org",preserveAspectRatio:!0}),Pt.call(this,e,t),this.Renderers={Point:gt,Polygon:Tt([St,wt]),Line:wt},this.Queriers={Point:Lt,Polygon:At},this.styles={Point:{fill:new g(.02,.44,.69,1),opacity:1,radius:5,stroke:"none","stroke-width":2},Polygon:{fill:new g(.02,.44,.69,1),"fill-opacity":.5,stroke:new g(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":.75},Line:{stroke:new g(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":2},"default":{fill:new g(.02,.44,.69,1),"fill-opacity":.5,stroke:new g(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":1}};var i=null,o=function(){i;var e;t.base=="default"||t.base=="nasa"?(e=s(t),u(e,{source:"file",url:t["tile-server"]+"/tiles/nasa_topo_bathy",levels:8,size:256}),i=new gn(e)):t.base=="ne"?(e=s(t),u(e,{source:"file",url:t["tile-server"]+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),i=new gn(e)):t.base=="ne1"?(e=s(t),u(e,{source:"file",url:t["tile-server"]+"/tiles/NE1_HR_LC",levels:6,size:256}),i=new gn(e)):i=null,i&&(i.initialize(n),n.scene.push(i))};o(),this.settings=function(e,n){t[e]=n,e=="base"&&o()},this.append=function(e){if("draw"in e){this.scene.push(e),this.dirty=!0;return}this.scene.push(new _t(n,e,t)),this.queriers[e.id]=new kt(this,e,t),this.dirty=!0}},Bt=function(e,t,n){var i=this;n===undefined&&(n={}),n.order||(n.order=t.numeric(),n.order.sort());var s=function(e,t){var n,r;return e.min<t.min?n=e.min:n=t.min,e.max>t.max?r=e.max:r=t.max,{min:n,max:r}},o=t.features(),u=null;$.each(n.order,function(e,t){var n=o.range(t);u?u=s(u,n):u=n}),r(n,{range:{min:u.min,max:u.max},domain:{min:0,max:n.order.length-1},min:new vect(0,u.min),width:n.order.length-1,height:u.max-u.min,worldMin:new vect(0,u.min),worldMax:new vect(n.order.length-1,u.max),xlock:!1,ylock:!1});var a=n.order;n.geomFunc=function(e){var t=[],n=[];for(var r=0;r<a.length;r++){var i=e.attr(a[r]);isNaN(i)?n.length>0&&(t.push(n),n=[]):n.push([r,i])}n.length>0&&t.push(n);var s=[t];return s},Pt.call(this,e,n),this.styles={"default":{fill:new g(.02,.44,.69,1),"fill-opacity":.5,stroke:new g(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":2}},this.Renderers={"default":wt},this.Queriers={"*":Ot};var f={stroke:new g(.25,.25,.25,1),"stroke-width":.75,"stroke-opacity":1},l=function(e){return f[e]},c=function(){var e=new wt(i);$.each(n.order,function(t,r){var i=[[[[t,n.range.min],[t,n.range.max]]]];e.create(i,l)});var t=[[[[n.domain.min,n.range.min],[n.domain.max,n.range.min],[n.domain.max,n.range.max],[n.domain.min,n.range.max],[n.domain.min,n.range.min]]]];e.create(t,l),i.scene.push(e);if(n.ticks){var r=0;while(r>n.range.min)r-=n.ticks;while(r<n.range.max){var s=[[[[n.domain.min,r],[n.domain.max,r]]]];e.create(s,l),r+=n.ticks}}};c(),this.scene.push(new _t(i,t,n)),this.queriers[t.id]=new kt(this,t,n)},jt=function(t){var n=B(t.gl,e+"shaders/selbox"),r=!1,i=!1,s=null,o=null,u=U(t.gl,6,2),a=q(t.gl,P(0,0,1,1),2),f=function(){u.update(H(s,o),0),t.dirty=!0};t.canvas.bind("mousedown",function(e){if(!r)return;i=!0,s=t.camera.percent(new vect(e.clientX,e.clientY)),o=s,f()});var l=function(){};this.select=function(e){l=e},$(document).bind("mouseup",function(e){if(!r)return;if(!i)return;var n=t.camera.project(t.camera.pixel(s)),u=t.camera.project(t.camera.pixel(o));if(n.x>u.x){var a=n.x;n.x=u.x,u.x=a}if(n.y>u.y){var a=n.y;n.y=u.y,u.y=a}i=!1,l(new Q(n,u)),t.dirty=!0}),$(document).bind("click",function(e){if(!r)return}),$(document).bind("mousemove",function(e){if(!r)return;i&&(o=t.camera.percent(new vect(e.clientX,e.clientY)),f())}),this.enable=function(){r=!0},this.disable=function(){r=!1},this.draw=function(e,t){var r=e.gl;i&&(r.useProgram(n),n.data("pos",u),n.data("edge_in",a),r.drawArrays(r.TRIANGLES,0,u.numItems))}},Ft=function(e,t,n,r){this.data=e[r],this.left=null,this.right=null,t!=r&&(this.left=new Ft(e,t,r-1,parseInt((t+(r-1))/2,10))),n!=r&&(this.right=new Ft(e,r+1,n,parseInt((n+(r+1))/2,10))),this.subtree=[];for(var i=t;i<=n;i++)this.subtree.push(e[i]);this.subtree.sort(function(e,t){return e.y-t.y});var s=function(r){return r.x_in(e[t])&&r.x_in(e[n])};this.yrange=function(e,t,n){return e.y_in(this.subtree[t])&&e.y_in(this.subtree[n])},this.subquery=function(e,t,n,r,i){if(this.yrange(t,n,r)){for(var s=n;s<=r;s++)e.push(this.subtree[s]);return}t.y_in(this.subtree[i])&&e.push(this.subtree[i]),t.y_left(this.subtree[i])?i!=r&&this.subquery(e,t,i+1,r,parseInt((r+(i+1))/2,10)):t.x_right(this.subtree[i])?i!=n&&this.subquery(e,t,n,i-1,parseInt((n+(i-1))/2,10)):(i!=r&&this.subquery(e,t,i+1,r,parseInt((r+(i+1))/2,10)),i!=n&&this.subquery(e,t,n,i-1,parseInt((n+(i-1))/2,10)))},this.search=function(e,t){if(s(t)){this.subquery(e,t,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2,10));return}t.contains(this.data)&&e.push(this.data),t.x_left(this.data)?this.right&&this.right.search(e,t):t.x_right(this.data)?this.left&&this.left.search(e,t):(this.left&&this.left.search(e,t),this.right&&this.right.search(e,t))}},It=function(e){e.sort(function(e,t){return e.x-t.x}),e.length>0?this.root=new Ft(e,0,e.length-1,parseInt((e.length-1)/2,10)):this.root=null,this.search=function(e){if(!this.root)return[];var t=e.clone(),n=[];return this.root.search(n,t),n}},qt=1,Rt=2,Ut=3,zt=function(e,t){var n=this;this.id=Xt(),this.type="Feature",this.type=e.type;var r=e.attr;this.attr=function(e,t){if(t===undefined)return r[e];throw"Not Implemented"},this.geom=e.geom,this.geometry=function(){},this.style=function(e,t,n){var r,i,s;return!e||e.type=="Engine"?(r=e,i=t,s=n):(r=null,i=e,s=t),s===undefined?ft.getStyle(this,r,i):(ft.setStyle(this,r,i,s),this)}},Wt=6378.1,Xt=function(){var e=1;return function(){var t=e;return e++,t}}(),Vt=function(){var e=1e-6,t={},n={};return function(t,n){return new vect(t+Math.random()*e-e/2,n+Math.random()*e-e/2)}}(),$t=function(e,t){zt.call(this,e,t);var n=function(e){return new vect(e[0],e[1])};this.bounds=null;for(var r=0;r<this.geom.length;r++){var i=n(this.geom[r]),s=new Q(i.clone(),i.clone());this.bounds?this.bounds.union(s):this.bounds=s}this.map_contains=function(e,r){var i=r,s=ft.derivedStyle(this,t,e,"radius");for(var o=0;o<this.geom.length;o++){var u=e.camera.screen(n(this.geom[o]));if(vect.dist(u,i)<s)return!0}return!1}},Jt=function(e){var t=[],n=0;$.each(e,function(e,r){var i=ft.derivedStyle(this,layer,engine,"radius");i>n&&(n=i),$.each(r.geom,function(e,n){t.push({x:n[0],y:n[1],ref:r})})});var r=new It(t);this.search=function(e){var t=r.search(e),n=[];return $.each(t,function(e,t){n.push(t.ref)}),new Mt(n)},this.map_contains=function(e,t){var i=t,s=vect.add(i,new vect(-n,n)),o=vect.add(i,new vect(n,-n)),u=new Q(e.camera.project(s),e.camera.project(o)),a=r.search(u);for(var f=0;f<a.length;f++){var l=a[f];if(l.ref.map_contains(e,t))return new Mt([l.ref])}return new Mt([])}},Kt=function(e,t){zt.call(this,e,t),this.bounds=Gt(this.geom),this.map_contains=function(e,t){return this.contains(e.camera.project(t))},this.contains=function(e){var t=0,n=[],r=this;if(r.bounds.contains(e)){t++;for(var i=0;i<r.geom.length;i++){var s=r.geom[i],o=0;$.each(s,function(t,n){for(var r=0;r<n.length;r++){var i=(r+1)%n.length;if((e.y-n[r][1])/(e.y-n[i][1])<0){var s=new vect(720,e.y),u=new vect(n[r][0],n[r][1]),a=new vect(n[i][0],n[i][1]);vect.intersects(e,s,u,a)&&o++}}});if(o%2==1)return!0}}return!1}},Qt=function(e){var t=[];for(var n=0;n<e.length;n++)$.each(e[n].geom,function(r,i){$.each(i,function(r,i){$.each(i,function(r,i){t.push({ref:e[n],x:i[0],y:i[1]})})})});tree=new It(t),this.search=function(t){var n=tree.search(t),r={};$.each(n,function(e,t){r[t.ref.id]=t.ref});for(var i=0;i<e.length;i++)for(var s=0;s<4;s++)e[i].contains(t.vertex(s))&&(r[e[i].id]=e[i]);var o=[];for(var u in r)o.push(r[u]);return new Mt(o)},this.map_contains=function(e,t){return this.contains(e.camera.project(t))},this.contains=function(t){var n=[];for(var r=0;r<e.length;r++)e[r].contains(t)&&n.push(e[r]);return new Mt(n)}},Gt=function(e){var t=new vect(Infinity,Infinity),n=new vect(-Infinity,-Infinity);return $.each(e,function(e,r){$.each(r,function(e,r){$.each(r,function(e,r){r[0]<t.x&&(t.x=r[0]),r[0]>n.x&&(n.x=r[0]),r[1]<t.y&&(t.y=r[1]),r[1]>n.y&&(n.y=r[1])})})}),new Q(t,n)},Yt=function(e,t){zt.call(this,e,t),this.bounds=Gt(this.geom),this.map_contains=function(e,t){return!1}},Zt=function(e){this.search=function(e){return new Mt([])},this.map_contains=function(e,t){return new Mt([])},this.contains=function(e){return new Mt([])}},en={Point:$t,Polygon:Kt,Line:Yt},tn=function(e){e||(e={}),this.id=Xt(),this.type="Layer";var t={},n={};if(e.style)for(var r in e.style)ft.setStyle(this,null,r,e.style[r]);this.style=function(e,t,n){var r,i,s;return!e||e.type=="Engine"?(r=e,i=t,s=n):(r=null,i=e,s=t),s===undefined?ft.getStyle(this,r,i):(ft.setStyle(this,r,i,s),this)},this.bounds=null,this.features=function(){var e=[];for(var t in n)e.push(n[t]);return new Mt(e)};var i={};this.properties=function(){var e=[];for(var t in i)e.push(t);return e},this.numeric=function(){var e=[];for(var t in i)i[t]&&e.push(t);return e};var s={};this.attr=function(e,t){if(arguments.length<2)return s[e]!==undefined?s[e]:null;s[e]=t},this.fixed=!1,this.append=function(e){if(this.fixed)throw"Layers are currently immutable once added to a map";var t=new en[e.type](e,this);n[t.id]=t,this.bounds?this.bounds.union(t.bounds):this.bounds=t.bounds.clone();for(var r in e.attr)i[r]===undefined?isNaN(e.attr[r])?i[r]=!1:i[r]=!0:!isNaN(e.attr[r])&&i[r]?i[r]=!0:i[r]=!1;return t},this.mouseover=function(e){ht.addEventHandler(this,"mouseover",e)},this.mouseout=function(e){ht.addEventHandler(this,"mouseout",e)}},nn=null,rn=function(t){var n;t||(t={}),t.style||(t.style={});var r=t.lower,i=t.upper,s=t.rows,o=t.cols,u=(i.x-r.x)/o,a=(i.y-r.y)/s,f=new Float32Array(s*o),l=new Uint8Array(o*s*4),c,h,p=new vect(r.x,r.y),d=new vect(i.x,i.y),v=new vect(0,0),m=new vect(1,1),g=!1,y=function(e,t){l[e*4]=parseInt(t.r*255,10),l[e*4+1]=parseInt(t.g*255,10),l[e*4+2]=parseInt(t.b*255,10),l[e*4+3]=parseInt(t.a*255,10)},b=function(e,t){return o*e+t};this.lower=function(){return r.clone()},this.upper=function(){return i.clone()},this.rows=function(){return s},this.cols=function(){return o},this.centroid=function(e,t){return new vect(r.x+u*t+u/2,r.y+a*e+a/2)},this.get=function(e,t){return f[b(e,t)]};var w=-Infinity,E=Infinity,S={};this.qunatiles=function(e,t){t||(t=function(e,t){return e-t});var n=[];for(var r=0;r<f.length;r++)n.push(f[r]);n.sort(t);var i=[-Infinity];for(var r=1;r<e;r++){var s=parseInt(inc*r,10);i.push(n[s])}return i.push(Infinity),i},this.set=function(e,t,r){if(e>=s||t>=o)throw"Index Out of Bounds";var i=b(e,t);f[i]=r,g=!0,n&&(n.dirty=!0)},this.raw_set=function(e,t){if(e>=s*o)throw"Index Out of Bounds: "+e;f[e]=t,g=!0,n&&(n.dirty=!0)},this.clear=function(e){for(var t=0;t<s*o;t++)f[t]=e};var x=!1;this.initialize=function(t){n=t;var r=n.gl;nn||(nn=B(n.gl,e+"shaders/grid")),c=new V(n,6),c.create("vert",2),c.create("screen",2),c.create("tex",2);var i=c.alloc(6);c.write("vert",H(p,d),i,6),c.write("screen",H(new vect(-1,-1),new vect(1,1)),i,6),c.write("tex",H(v,m),i,6),h=r.createTexture(),r.bindTexture(r.TEXTURE_2D,h),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),x=!0};var T=null;this.draw=function(e,n){var r=e.gl;x||this.initialize(e),T||(T=e.framebuffer()),c.update();if(g){w=-Infinity,E=Infinity;for(var i=0;i<s*o;i++){var u=f[i];u>w&&(w=u),u<E&&(E=u)}for(var i=0;i<s*o;i++)y(i,t.map(E,w,f[i]));r.bindTexture(r.TEXTURE_2D,h),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,o,s,0,r.RGBA,r.UNSIGNED_BYTE,l),r.bindTexture(r.TEXTURE_2D,null),g=!1}t.style.antialias&&T.activate({blend:!1}),r.useProgram(nn),nn.data("screen",e.camera.mat3),nn.data("pos",c.get("vert")),nn.data("tex_in",c.get("tex")),nn.data("sampler",h);var a=vect.sub(e.camera.screen(d),e.camera.screen(p));nn.data("width",a.x),nn.data("height",-a.y),nn.data("rows",s),nn.data("cols",o),nn.data("blur",t.blur),r.drawArrays(r.TRIANGLES,0,c.count()),t.style.antialias&&(T.deactivate(),e.draw_blur(T.tex))}},sn=null,on=function(t,n,r){var i,s,o,u=!1;this.id=Xt();var a=!1;this.initialize=function(f){i||(i=B(f.gl,e+"shaders/raster")),this.image=X(f.gl,t,function(){a=!0}),s=q(f.gl,H(new vect(0,1),new vect(1,0)),2),o=q(f.gl,H(n,r),2),u=!0},this.draw=function(e,t,n){var r=e.gl;u||this.initialize(e);if(!a)return;r.useProgram(i),i.data("screen",e.camera.mat3),i.data("pos",o),i.data("tex_in",s),i.data("sampler",this.image),r.drawArrays(r.TRIANGLES,0,o.numItems)}},un=Math.PI/4,an=null,fn=function(t){var n=$(t).find("LatLonBox"),r=new vect(parseFloat(n.find("west").text()),parseFloat(n.find("south").text())),i=new vect(parseFloat(n.find("east").text()),parseFloat(n.find("north").text())),s=$(t).find("GroundOverlay Icon href").text(),o=!1,u;this.ready=function(){return o};var a,f,l=315,c=!1;this.initialize=function(t){an||(an=B(t.gl,e+"shaders/hillshade")),a=q(t.gl,H(new vect(0,1),new vect(1,0)),2),f=q(t.gl,H(r,i),2),u=X(t.gl,s,function(){o=!0}),c=!0},this.draw=function(e,t){var n=e.gl;c||this.initialize(e);if(!o)return;n.useProgram(an);while(l>=1)l-=1;an.data("azimuth",l),an.data("altitude",Math.PI/4/(2*Math.PI)),an.data("screen",e.camera.mat3),an.data("pos",f),an.data("tex_in",a),an.data("elevation",u);var s=vect.sub(e.camera.screen(i),e.camera.screen(r));return an.data("pix_w",1/s.x),an.data("pix_h",1/s.y),n.drawArrays(n.TRIANGLES,0,f.numItems),l}},ln=null,cn=function(t){ln||(ln=B(e+"shaders/elevation"));var n=$(t).find("LatLonBox"),r=new vect(parseFloat(n.find("west").text()),parseFloat(n.find("south").text())),i=new vect(parseFloat(n.find("east").text()),parseFloat(n.find("north").text())),s=$(t).find("GroundOverlay Icon href").text(),o=X(s),u=q(H(new vect(0,1),new vect(1,0)),2),a=q(H(r,i),2);this.draw=function(e,t,n){if(n)return;gl.useProgram(ln),ln.data("screen",e.camera.mat3),ln.data("pos",a),ln.data("tex_in",u),ln.data("elevation",o);var s=vect.sub(e.camera.screen(i),e.camera.screen(r));gl.drawArrays(gl.TRIANGLES,0,a.numItems)}},hn=1e3,pn=0,dn=8,vn=0,mn=0,gn=function(t){var r=null,i=[],o=[],u=null,a=null;this.id=Xt();var f=function(t){t||(t={}),t.desaturate||(t.desaturate=0),t.darken||(t.darken=0),t.hue||(t.hue=0),t.hue_color||(t.hue_color=b(0,0,0,1));var i=t.url,s=t.min,o=t.rows,f=t.cols,l=t.cellsize;this.rows=o,this.cols=f;var c={},h={},p=function(e,n){var r=new vect(s.x+e*l,s.y+n*l),i=new vect(s.x+(e+1)*l,s.y+(n+1)*l),o={vert:H(r,i,t.z_index),tex:null,i:e,j:n,id:e+f*n,ready:!1,min:r,max:i};h[e][n]=o,c[o.id]=o};for(var d=0;d<f;d++)h[d]={};this.size=function(e){var t=e.camera.screen(s),n=e.camera.screen(vect.add(s,new vect(l*f,l*o))),r=vect.sub(n,t);return r.y=Math.abs(r.y),r};var v=!1;this.noexpire=function(e){v=e},this.cull=function(){if(!v){var e=(new Date).getTime();for(var n in g)if(e-g[n]>hn){var r=c[n];delete c[n],delete h[r.i][r.j],t.available.push(r.tex),r.tex=null,r.ready=!1,delete g[n]}}};var m=function(){var e=u.camera.project(new vect(u.canvas.offset().left,u.canvas.offset().top+u.canvas.height())),t=u.camera.project(new vect(u.canvas.offset().left+u.canvas.width(),u.canvas.offset().top)),n=Math.floor((e.x-s.x)/l),r=Math.ceil((t.x-s.x)/l),i=Math.floor((e.y-s.y)/l),o=Math.ceil((t.y-s.y)/l);return{min_col:n,max_col:r,min_row:i,max_row:o}},g={};this.ready=function(){var e=m();for(var t=Math.max(0,e.min_col);t<Math.min(f,e.max_col);t++)for(var n=Math.max(0,e.min_row);n<Math.min(o,e.max_row);n++){if(!h[t][n])return!1;if(!h[t][n].ready)return!1}return!0};var y=function(e,r){if(!h[e][r].tex){var s;if(t.source=="file"){var o=h[e][r].id;s=i+"/"+o+".png"}else t.source=="wms"&&(s=n(i,{service:"wms",version:"1.1.0",request:"GetMap",layers:t.layer,bbox:[h[e][r].min.x,h[e][r].min.y,h[e][r].max.x,h[e][r].max.y].join(","),width:t.size,height:t.size,srs:"EPSG:4326",format:"image/png",transparent:"true"}));h[e][r].tex=t.available.pop(),h[e][r].tex||(h[e][r].tex=new J(u)),K(s,function(e){return function(t){e.tex&&(e.tex.image(t),e.ready=!0)}}(h[e][r]))}};this.fetch_all=function(){var e=(new Date).getTime();for(var t=0;t<f;t++)for(var n=0;n<o;n++)h[t][n]||p(t,n),h[t][n].tex||y(t,n),g[h[t][n].id]=e},this.fetch=function(){var e=m(),t=(new Date).getTime();for(var n=Math.max(0,e.min_col-1);n<Math.min(f,e.max_col+1);n++)for(var r=Math.max(0,e.min_row-1);r<Math.min(o,e.max_row+1);r++)h[n][r]||p(n,r),h[n][r].tex||y(n,r),g[h[n][r].id]=t};var w=!1;this.initialize=function(t){if(w)throw"Not Implemented: Migrating Tile Layers to New Map";r||(r=B(t.gl,e+"shaders/tile")),w=!0},this.draw=function(e,n,i,s,u){w||this.initialize(e);var l=function(){mn++,i.update(),r.data("pos",i.get("vert")),r.data("tex_in",i.get("tex")),r.data("lookup_in",i.get("lookup")),r.data("desaturate",t.desaturate),r.data("darken",t.darken),r.data("hue",t.hue),r.data("hue_color",t.hue_color.array),a.drawArrays(a.TRIANGLES,0,s*6)},c=m(),p=(new Date).getTime();for(var d=Math.max(0,c.min_col);d<Math.min(f,c.max_col);d++)for(var v=Math.max(0,c.min_row);v<Math.min(o,c.max_row);v++)if(h[d][v]&&h[d][v].ready&&h[d][v].tex){i.write("vert",h[d][v].vert,s*6,6),i.write("tex",H(new vect(0,0),new vect(1,1)),s*6,6),i.repeat("lookup",[s/dn+1/(dn*2)],s*6,6),g[h[d][v].id]=p,r.data("sampler"+s,h[d][v].tex);if(h[d][v].tex===null)throw"badness";s++,vn++,s>=dn&&(l(),s=0)}return u&&l(),s}};for(var l=0;l<t.levels;l++){var c=s(t);c.source=="file"&&(c.url+="/"+t.size*Math.pow(2,l+1)),c.min=new vect(-180,-90),c.rows=Math.pow(2,l),c.cols=c.rows*2,c.cellsize=180/c.rows,c.z_index=1-pn-l/1e3,c.available=o;var h=new f(c);i.push(h)}var p=1-pn-t.levels/1e3;pn+=(t.levels+2)/1e3;var d=null,v=!1;this.initialize=function(t){u=t,r||(r=B(u.gl,e+"shaders/tile")),a=u.gl,d=new V(u,dn*6),d.create("vert",3),d.create("tex",2),d.create("lookup",1),d.alloc(dn*6);for(var n=0;n<25;n++)o.push(new J(u));for(var n=0;n<i.length;n++)i[n].initialize(u);i[0].fetch_all(),i[0].noexpire(!0),v=!0},this.draw=function(e,n){v||this.initialize(e),a.useProgram(r),r.data("screen",e.camera.mat3),vn=0,mn=0;var s=Infinity,o=i[0],u,f;for(var l=0;l<i.length;l++){var c=t.size*i[l].cols/i[l].size(e).x;c<1&&(c=1/c),c<s&&(s=c,o=i[l],u=l)}for(var l=u;l>=0;l--)i[l].fetch();if(o.ready())o.draw(e,n,d,0,!0);else{e.enableZ();var h=0;for(var l=u;l>=0;l--)h=i[l].draw(e,n,d,h,l===0);e.disableZ()}$.each(i,function(e,t){t.cull()})}},yn=function(e){var t=s(e);o(t,["url","layer"]),r(t,{levels:16,size:256}),i(t,{source:"wms"});var n=new gn(t);return n},bn=function(e,t){t===undefined&&(t={});var n=new tn(t);for(var r=0;r<e.features.length;r++){var i=e.features[r];if(i.type=="Feature"){i.geometry.type=="Point"&&n.append({type:"Point",geom:[i.geometry.coordinates],attr:i.properties}),i.geometry.type=="MultiPoint"&&n.append({type:"Point",geom:i.geometry.coordinates,attr:i.properties});if(i.geometry.type=="Polygon"){var s=i.geometry.coordinates,o=[];for(var u=0;u<=s.length-1;u++){var a=[];for(var f=s[u].length-1;f>=0;f--)a.push(s[u][f]);o.push(a)}n.append({type:"Polygon",geom:[o],attr:i.properties})}if(i.geometry.type=="MultiPolygon"){var l=[];$.each(i.geometry.coordinates,function(e,t){var n=[];for(var r=0;r<=t.length-1;r++){var i=[];for(var s=t[r].length-1;s>=0;s--)i.push(t[r][s]);n.push(i)}l.push(n)}),n.append({type:"Polygon",geom:l,attr:i.properties})}i.geometry.type=="MultiLineString"&&$.each(i.geometry.coordinates,function(e,t){n.append({type:"Line",geom:[[t]],attr:i.properties})})}}return n},wn=8,En=0,Sn=1,xn=5,Tn=function(e){var t=N(e,0),n=N(e,24),r=C(e,28),i=C(e,32),s=A(e,36),o=A(e,44),u=A(e,52),a=A(e,60);return{code:t,length:n,version:r,shapetype:i,bounds:new Q(vect(s,o),vect(u,a))}},Nn=function(e){var t=[],n=function(n){return t.push(2*N(e,n)),n+8},r=100;while(r<e.length)r=n(r);return t},Cn=function(e){var t=e.path;$.ajax({url:t+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(n){var r=Nn(n);$.ajax({url:t+".shp",mimeType:"text/plain; charset=x-user-defined"
,success:function(n){$.ajax({url:t+".dbf",mimeType:"text/plain; charset=x-user-defined",success:function(t){var i=Ln(n,t,r,e);e.success(i)}})}})}})},kn=function(e){var t=function(t){var n=M(e,t,10),r=M(e,t+11,1),i=T(e,t+16);return{name:n,type:r,length:i}},n=T(e,0);if(n==4)throw"Level 7 dBASE not supported";var r=T(e,1),i=T(e,2),s=T(e,3),o=C(e,4),u=L(e,8),a=L(e,10),f=32,l=32,c=f,h=[];while(c<u-1)h.push(t(c)),c+=l;var p=[],d=u;while(d<u+o*a){var v=M(e,d,1);if(v=="*")d+=a;else{d++;var m={};for(var g=0;g<h.length;g++){var y=h[g],b;y.type=="C"?b=M(e,d,y.length).trim():y.type=="N"&&(b=parseFloat(M(e,d,y.length))),d+=y.length,m[y.name]=b}p.push(m)}}return p},Ln=function(e,t,n,r){var i=[],s=function(t,n,r){var i=[];for(var s=r-1;s>=n;s--){var o=A(e,t+16*s),u=A(e,t+16*s+8);i.push([o,u])}return i},o=function(t){var n=N(e,t),r=N(e,t+4),o=t+8,u=C(e,o);if(u==En)console.log("NULL Shape");else if(u==Sn){var a=A(e,o+4),f=A(e,o+12);i.push({type:"Point",attr:{},geom:[[a,f]]})}else{if(u!=xn)throw"Not Implemented: "+u;var l=C(e,o+36),c=C(e,o+40),h=t+52,p=t+52+4*l,d=[];for(var v=0;v<l;v++){var m=C(e,h+v*4),g;v+1<l?g=C(e,h+(v+1)*4):g=c;var y=s(p,m,g);d.push(y)}i.push({type:"Polygon",attr:{},geom:[d]})}},u=kn(t);for(var a=0;a<n.length;a++){var f=n[a];o(f)}var l=new tn;for(var a=0;a<i.length;a++){var c=i[a];c.attr=u[a],l.append(c)}return l},An=function(e,t){var n=e.split("\n"),r=n.splice(0,6),i=parseInt(r[0].slice(14),10),s=parseInt(r[1].slice(14),10),o=parseFloat(r[2].slice(14)),u=parseFloat(r[3].slice(14)),a=parseFloat(r[4].slice(14)),f=r[5].slice(14),l=-Infinity,c=Infinity,h=function(e,t){return i*e+t},p={};for(var d in t)p[d]=t[d];p.lower=new vect(o,u),p.upper=new vect(o+a*i,u+a*s),p.rows=s,p.cols=i;var v=new rn(p);for(var m=0;m<s;m++){var g=n[m].split(" ");for(var y=0;y<i;y++)g[y]==f?v.set(s-1-m,y,NaN):v.set(s-1-m,y,parseFloat(g[y]))}return v},On=function(e,t){var n=O(e,0),r=O(e,4),i=C(e,8),s=C(e,12),o=O(e,16),u=20,a={};for(var f in t)a[f]=t[f];a.lower=new vect(n,r),a.upper=new vect(n+o*i,r+o*s),a.rows=s,a.cols=i;var l=new rn(a),c=function(t,n,r){for(var i=0;i<r;i++){var s=O(e,t+i*4);l.raw_set(n+i,s)}},h=u;while(h<e.length){var p=C(e,h),d=C(e,h+4);c(h+4,p,d),h+=8+d*4}return l},Mn=function(t){var n=$(t).find("LatLonBox"),r=new vect(parseFloat(n.find("west").text()),parseFloat(n.find("south").text())),i=new vect(parseFloat(n.find("east").text()),parseFloat(n.find("north").text())),s=$(t).find("GroundOverlay Icon href").text();return new on(e+s,r,i)},_n=[];window.wiggle={Map:Ht,TimeSeries:Bt,layer:{Layer:tn,Grid:rn,Hillshade:fn,Elevation:cn,Raster:on},io:{Shapefile:Cn,GeoJSON:bn,KML:Mn,SparseGrid:On,AsciiGrid:An,WMS:yn},util:{fcolor:b,icolor:y,Box:Q,RangeTree:It},ready:function(e){_n.push(e)}},$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(t,n){var r=/wigglemaps(\.min)?\.js/;$(n).attr("src").match(r)&&(e=$(n).attr("src").replace(r,""))}),$.each(_n,function(e,t){t()})})}();