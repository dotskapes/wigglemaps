function vect(j,m,q){this.x=j;this.y=m;this.z=q?q:0;this.add=function(h){this.x+=h.x;this.y+=h.y;this.z+=h.z};this.sub=function(h){this.x-=h.x;this.y-=h.y;this.z-=h.z};this.scale=function(h){this.x*=h;this.y*=h;this.z*=h};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var h=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);0!=h&&(this.x/=h,this.y/=h,this.z/=h)};this.div=function(h){this.x/=h.x;this.y/=h.y;this.z/=h.z};this.floor=function(){this.x=
Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return 0==this.x+this.y+this.z};this.dot=function(h){return this.x*h.x+this.y*h.y+this.z*h.z};this.cross=function(){throw"Need to reimplement";};this.rotate=function(h){var j=Math.cos(h);h=Math.sin(h);xp=j*this.x-h*this.y;yp=h*this.x+j*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}vect.scale=function(j,m){return new vect(j.x*m,j.y*m,j.z*m)};
vect.add=function(j,m){return new vect(j.x+m.x,j.y+m.y,j.z+m.z)};vect.sub=function(j,m){if(!j||!m)throw"Bad Vector";return new vect(j.x-m.x,j.y-m.y,j.z-m.z)};vect.dist=function(j,m){var q=m.x-j.x,h=m.y-j.y,s=m.z-j.z;return Math.sqrt(q*q+h*h+s*s)};vect.dir=function(j,m){var q=vect.sub(j,m);q.normalize();return q};vect.dot2d=function(j,m){return j.x*m.x+j.y*m.y};vect.cross=function(j,m){return j.x*m.y-j.y*m.x};
vect.left=function(j,m,q,h){h||(h=0);m=vect.sub(m,j);j=vect.sub(q,j);return vect.cross(m,j)>=-h};vect.intersects=function(j,m,q,h,s){s||(s=0);return vect.left(j,m,q,s)!=vect.left(j,m,h,s)&&vect.left(q,h,m,s)!=vect.left(q,h,j,s)};vect.intersect2dt=function(j,m,q,h){h=j.x*(h.y-q.y)+m.x*(q.y-h.y)+h.x*(m.y-j.y)+q.x*(j.y-m.y);return 0==h?Infinity:-(j.x*(q.y-m.y)+m.x*(j.y-q.y)+q.x*(m.y-j.y))/h};
vect.intersect2dpos=function(j,m,q,h){var s=j.x*(h.y-q.y)+m.x*(q.y-h.y)+h.x*(m.y-j.y)+q.x*(j.y-m.y);if(0==s)return Infinity;q=(j.x*(h.y-q.y)+q.x*(j.y-h.y)+h.x*(q.y-j.y))/s;m=vect.sub(m,j);m.scale(q);return vect.add(j,m)};vect.rotate=function(j,m){var q=Math.cos(m),h=Math.sin(m);xp=q*j.x-h*j.y;yp=h*j.x+q*j.y;return j=new vect(xp,yp,j.z)};
(function(){function j(a,b){for(var c in b)c in a||(a[c]=b[c])}function m(a){var b={};for(key in a)b[key]=a[key];return b}function q(a,b){for(key in b)a[key]=b[key]}function h(a,b,c){return Math.min(Math.max(a,b),c)}function s(a,b,c,d){1>=a&&1>=b&&1>=c&&1>=d?(this.r=a,this.g=b,this.b=c,this.a=d):(this.r=a/255,this.g=b/255,this.b=c/255,this.a=d/255);this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(255*this.r)+","+parseInt(255*
this.g)+","+parseInt(255*this.b)+")"}}function va(a,b,c,d){return new s(h(a,0,1),h(b,0,1),h(c,0,1),h(d,0,1))}function Z(a){var b=parseInt(a.slice(1,3),16),c=parseInt(a.slice(3,5),16);a=parseInt(a.slice(5,7),16);return new s(b,c,a,255)}function ja(a,b){return((a.charCodeAt(b)&255)<<24)+((a.charCodeAt(b+1)&255)<<16)+((a.charCodeAt(b+2)&255)<<8)+(a.charCodeAt(b+3)&255)}function J(a,b){return((a.charCodeAt(b+3)&255)<<24)+((a.charCodeAt(b+2)&255)<<16)+((a.charCodeAt(b+1)&255)<<8)+(a.charCodeAt(b)&255)}
function fa(a,b){var c=a.charCodeAt(b)&255,d=a.charCodeAt(b+1)&255,e=a.charCodeAt(b+2)&255,f=a.charCodeAt(b+3)&255,g=a.charCodeAt(b+4)&255,l=a.charCodeAt(b+5)&255,n=a.charCodeAt(b+6)&255,k=a.charCodeAt(b+7)&255,F=1-2*(k>>7),k=((k&127)<<4)+((n&240)>>4)-1023,c=(n&15)*Math.pow(2,48)+l*Math.pow(2,40)+g*Math.pow(2,32)+f*Math.pow(2,24)+e*Math.pow(2,16)+d*Math.pow(2,8)+c;return F*(1+c*Math.pow(2,-52))*Math.pow(2,k)}function ga(a,b){var c=a.charCodeAt(b)&255,d=a.charCodeAt(b+1)&255,e=a.charCodeAt(b+2)&255,
f=a.charCodeAt(b+3)&255,g=1-2*(f>>7),f=((f&127)<<1)+((e&254)>>7)-127,c=(e&127)*Math.pow(2,16)+d*Math.pow(2,8)+c;return g*(1+c*Math.pow(2,-23))*Math.pow(2,f)}function wa(a,b,c,d){return[a-c,b+d,a-c,b-d,a+c,b+d,a-c,b-d,a+c,b-d,a+c,b+d]}function w(a,b,c){return 2==arguments.length?[a.x,b.y,a.x,a.y,b.x,b.y,a.x,a.y,b.x,a.y,b.x,b.y]:[a.x,b.y,c,a.x,a.y,c,b.x,b.y,c,a.x,a.y,c,b.x,a.y,c,b.x,b.y,c]}function B(a){if(!gl)return null;var b=gl.createProgram(),c=xa(gl.VERTEX_SHADER,a+"/vert.glsl");a=xa(gl.FRAGMENT_SHADER,
a+"/frag.glsl");gl.attachShader(b,c);gl.attachShader(b,a);gl.linkProgram(b);var d={},c=(c.source+a.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg);a=0;gl.useProgram(b);if(c){for(var e=0;e<c.length;e++){var f=c[e].split(" ");d[f[2]]={u:f[0],type:f[1],loc:null};if("uniform"==f[0])d[f[2]].loc=gl.getUniformLocation(b,f[2]);else{var g=gl.getAttribLocation(b,f[2]);d[f[2]].loc=g}"sampler2D"==f[1]&&(d[f[2]].tex=a,a++)}b.get=function(a){return d[a].loc};b.data=function(a,b){var c=d[a];if(!c)throw"Could not find shader variable "+
a;if("uniform"==c.u)if("float"==c.type)gl.uniform1f(c.loc,b);else if("vec2"==c.type)gl.uniform2fv(c.loc,b);else if("ivec2"==c.type)gl.uniform2iv(c.loc,b);else if("vec3"==c.type)gl.uniform3fv(c.loc,b);else if("ivec3"==c.type)gl.uniform3iv(c.loc,b);else if("vec4"==c.type)gl.uniform4fv(c.loc,b);else if("ivec4"==c.type)gl.uniform4iv(c.loc,b);else if("bool"==c.type)gl.uniform1i(c.loc,b);else if("mat4"==c.type)gl.uniformMatrix4fv(c.loc,!1,b);else if("mat3"==c.type)gl.uniformMatrix3fv(c.loc,!1,b);else if("sampler2D"==
c.type)"texture"in b&&(b=b.texture()),gl.activeTexture(gl["TEXTURE"+c.tex]),gl.bindTexture(gl.TEXTURE_2D,b),gl.uniform1i(c.loc,c.tex);else if("int"==c.type)gl.uniform1i(c.loc,b);else throw"Unsupported Type for Shader Helper: "+c.type;else if("attribute"==c.u)gl.enableVertexAttribArray(c.loc),gl.bindBuffer(gl.ARRAY_BUFFER,b),gl.vertexAttribPointer(c.loc,b.itemSize,gl.FLOAT,!1,0,0);else throw"Type: "+c.u+" Recieved";}}return b}function xa(a,b){var c=gl.createShader(a);$.ajax({async:!1,url:b,dataType:"text",
success:function(a){gl.shaderSource(c,a);gl.compileShader(c);if(!gl.getShaderParameter(c,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(c);c.source=a},error:function(){console.log("Could not load "+b)}});return c}function K(a,b){var c=gl.createBuffer(),d=new Float32Array(a);gl.bindBuffer(gl.ARRAY_BUFFER,c);c.itemSize=b;c.numItems=a.length/b;gl.bufferData(gl.ARRAY_BUFFER,d,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return c}function ka(a,b){if(!gl)return null;var c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,
c);var d=new Float32Array(a*b);c.itemSize=b;c.numItems=a;c.update=function(a,b){var d=new Float32Array(a);gl.bindBuffer(gl.ARRAY_BUFFER,c);gl.bufferSubData(gl.ARRAY_BUFFER,4*b,d);gl.bindBuffer(gl.ARRAY_BUFFER,null)};gl.bufferData(gl.ARRAY_BUFFER,d,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return c}function aa(a,b){var c=gl.createTexture();c.id=ya;ya++;var d=new Image;d.onload=function(){gl.bindTexture(gl.TEXTURE_2D,c);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,d);gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);b&&b()};d.src=a;return c}function la(a){var b=m(a);j(b,{mag_filter:gl.LINEAR,min_filter:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,mipmap:!1});var c=gl.createTexture(),d=null;this.image=function(a){d=a;gl.bindTexture(gl.TEXTURE_2D,
c);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,d);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,b.mag_filter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,b.min_filter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,b.wrap_s);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,b.wrap_t);b.mipmap&&gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null)};this.texture=function(){return d?c:null}}function Oa(a,b){b||(b={});"center"in b||(b.center=new vect(0,
0));"extents"in b||(b.extents=180);this.mat3=new Float32Array(9);var c=a.width()/a.height();this.mat3[0]=2/b.extents;this.mat3[4]=2*c/b.extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(b){b=new vect(2*(b.x-a.offset().left)/a.width()-1,-(2*(b.y-a.offset().top)/a.height()-1));b.x=b.x/this.mat3[0]-this.mat3[6]/this.mat3[0];b.y=b.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return b};this.screen=function(b){b=new vect(b.x*this.mat3[0]+this.mat3[6],b.y*this.mat3[4]+this.mat3[7]);
b.x=a.offset().left+a.width()*(b.x+1)/2;b.y=a.offset().top+a.height()*(-b.y+1)/2;return b};this.percent=function(b){return new vect(2*((b.x-a.offset().left)/a.width())-1,-(2*((b.y-a.offset().top)/a.height())-1))};this.pixel=function(b){return new vect(a.offset().left+(b.x+1)/2*a.width(),a.offset().top+(-b.y+1)/2*a.height())};this.move=function(a){this.mat3[6]-=a.x*this.mat3[0];this.mat3[7]-=a.y*this.mat3[4]};this.position=function(a){if(!a)return new vect(-this.mat3[6]/this.mat3[0],-this.mat3[7]/
this.mat3[4]);this.mat3[6]=-a.x*this.mat3[0];this.mat3[7]=-a.y*this.mat3[4]};this.position(b.center);this.extents=function(a){b.extents=a;a=this.position();this.level=1;this.mat3[0]=2/b.extents;this.mat3[4]=2*c/b.extents;this.position(a)};this.zoom=function(a){var b=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=a;this.mat3[4]*=a;this.mat3[6]=b.x*this.mat3[0];this.mat3[7]=b.y*this.mat3[4];this.level*=a};this.reset=function(){this.zoom(1/this.level)};this.reconfigure=function(){var b=
this.position();this.mat3[4]/=c;c=a.width()/a.height();this.mat3[4]*=c;this.position(b)}}function Pa(a){var b=!1,c=new vect(0,0),d=new vect(0,0),e=null,f=0;a.canvas.mousedown(function(a){c=new vect(a.clientX,a.clientY);b=!0});$(window).bind("mouseup",function(){b=!1});$(document).bind("keypress","+",function(){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(){a.camera.reset()});a.canvas.bind("mousewheel",function(b,c){c*=
0.5;0>c?(c=-1*c+1,c=1/c):c+=1;a.camera.zoom(c);b.preventDefault()});var g=!0;this.disable=function(){g=!1};this.enable=function(){g=!0};this.update=function(l){d=new vect(U.x,U.y);if(b&&g){var n=vect.sub(a.camera.project(c),a.camera.project(d));a.camera.move(n);c=d;f=n.length()/l;e=n;e.normalize()}else 0.01<f&&e&&(a.camera.move(vect.scale(e,f*l)),f-=3*l*f)}}function Qa(a,b){b||(b={});j(b,{base:"default",background:new s(0,0,0,1),antialias:!0});var c=this;this.canvas=$("<canvas></canvas>").attr("id",
"viewer");a?($(a).append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height())):(a=window,$("body").append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height()),$(window).resize(function(){c.resize()}));this.resize=function(){c.canvas.attr("width",$(a).width());c.canvas.attr("height",$(a).height());gl.viewport(0,0,c.canvas.width(),c.canvas.height());c.camera.reconfigure();for(var b=0;b<k.length;b++)k[b].resize()};var d=
this.canvas;gl=Ra?WebGLDebugUtils.makeDebugContext(d.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),function(a,b){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+b;}):d.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});gl.viewport(0,0,c.canvas.width(),c.canvas.height());gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.BLEND);y||(y=B(v+"shaders/blur"));za||(za=B(v+"shaders/light"));var e=new N(6);
e.create("vert",2);e.create("tex",2);d=e.alloc(6);e.write("vert",w(new vect(-1,-1),new vect(1,1)),d,6);e.write("tex",w(new vect(0,0),new vect(1,1)),d,6);e.update();this.scene=[];this.camera=new Oa(this.canvas,b);this.scroller=new Pa(this);this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.sel=new Sa(this);this.select=function(a){a?(this.scroller.disable(),this.sel.enable()):(this.scroller.enable(),this.sel.disable())};var f=(new Date).getTime(),g=[];this.attr=function(a,
c){"base"==a&&(b.base=c,n())};var l=null,n=function(){if("default"==b.base||"nasa"==b.base){var a=m(b);q(a,{source:"file",url:ma+"/tiles/nasa_topo_bathy",levels:8,size:256});l=new ha(a)}else"ne"==b.base?(a=m(b),q(a,{source:"file",url:ma+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),l=new ha(a)):"ne1"==b.base?(a=m(b),q(a,{source:"file",url:ma+"/tiles/NE1_HR_LC",levels:6,size:256}),l=new ha(a)):l=null};n();this.enable_z=function(){gl.depthFunc(gl.LEQUAL);gl.enable(gl.DEPTH_TEST)};this.disable_z=function(){gl.disable(gl.DEPTH_TEST)};
var k=[],F=[null];this.framebuffer=function(){var a=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,a);a.width=c.canvas.width();a.height=c.canvas.height();var b=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,b);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,
0,gl.RGBA,a.width,a.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);var d=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,d);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a.width,a.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,b,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,d);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);var e={framebuffer:a,
renderbuffer:d,tex:b,resize:function(){a.width=c.canvas.width();a.height=c.canvas.height();gl.bindTexture(gl.TEXTURE_2D,b);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a.width,a.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,d);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a.width,a.height);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null)},activate:function(b){b||(b={});j(b,{blend:!0,clear:!0});F.push(a);b.blend||gl.disable(gl.BLEND);
gl.bindFramebuffer(gl.FRAMEBUFFER,a);gl.viewport(0,0,c.canvas.width(),c.canvas.height());b.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.clearDepth(0))},deactivate:function(){var b=F.pop(),c=F[F.length-1];if(b!=a)throw"Non-nested use of framebuffers";gl.bindFramebuffer(gl.FRAMEBUFFER,c);gl.enable(gl.BLEND)}};k.push(e);return e};var Ta=this.framebuffer(),h=this.framebuffer();this.draw_blur=function(a){gl.useProgram(y);h.activate({blend:!1});y.data("pos",e.get("vert"));y.data("tex_in",
e.get("tex"));y.data("sampler",a);y.data("width",c.canvas.width());y.data("height",c.canvas.height());y.data("hor",!0);gl.drawArrays(gl.TRIANGLES,0,e.count());h.deactivate();y.data("pos",e.get("vert"));y.data("tex_in",e.get("tex"));y.data("sampler",h.tex);y.data("width",c.canvas.width());y.data("height",c.canvas.height());y.data("hor",!1);gl.drawArrays(gl.TRIANGLES,0,e.count())};this.dirty=!0;var Aa=function(){var a=(new Date).getTime(),d=(a-f)/1E3;c.scroller.update(d);60<=g.length&&g.splice(0,1);
g.push(d);for(var e=0,k=0;k<g.length;k++)e+=g[k];e/=g.length;$("#fps").text(Math.floor(1/e));f=a;gl.clearColor(b.background.r,b.background.g,b.background.b,b.background.a);gl.clear(gl.COLOR_BUFFER_BIT);gl.clearDepth(0);a=!1;c.shade&&(a=c.shade.ready());a&&Ta.activate();l&&l.draw(c,d);for(k=0;k<c.scene.length;k++)c.scene[k].draw(c,d,!1);c.sel.draw(c,d);requestAnimationFrame(Aa)};this.read_pixel=function(a,b){gl.bindFramebuffer(gl.FRAMEBUFFER,c.framebuffer);var d=new Uint8Array(4),e=(a-c.canvas.position().left)/
c.canvas.width(),f=(c.canvas.position().top+c.canvas.height()-b)/c.canvas.height();gl.readPixels(parseInt(e*c.framebuffer.width),parseInt(f*c.framebuffer.height),1,1,gl.RGBA,gl.UNSIGNED_BYTE,d);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return d};$(document).mousemove(function(a){U.x=a.clientX;U.y=a.clientY});this.canvas.click(function(){});this.canvas.dblclick(function(){});var r=!1;this.canvas.mousedown(function(){r=!0});this.canvas.mouseup(function(){r=!1});this.canvas.mousemove(function(){if(!r){var a=
c.camera.project(new vect(U.x,U.y));$.each(c.scene,function(b,d){d.update_move&&d.update_move(c,a)})}});this.canvas.mouseout(function(){$.each(c.scene,function(a,b){b.force_out&&b.force_out(c)})});requestAnimationFrame(Aa)}function N(a){var b={},c;c=a?a:256;var d=0,e=function(a,b,c,d){a||console.log("ack");c||(c=0);d||(d=b.length);for(var e=0;e<d;e++)a[c+e]=b[e]};this.create=function(a,d){if(!d)throw"Length of buffer must be a positive integer";var e=new Float32Array(c*d),n=ka(c,d);b[a]={array:e,
buffer:n,len:d,dirty:!1}};this.alloc=function(a){if(d+a>=c){for(var g=c;g<d+a;)g*=2;c=g;for(name in b){var l=new Float32Array(g*b[name].len),n=b[name].array,k=ka(c,b[name].len);e(l,n);b[name].array=l;b[name].buffer=k;b[name].dirty=!0}}g=d;d+=a;return g};this.get=function(a){return b[a].buffer};this.write=function(a,c,d,n){e(b[a].array,c,d*b[a].len,n*b[a].len);b[a].dirty=!0};this.repeat=function(a,c,d,n){for(var k=0;k<n;k++)e(b[a].array,c,(d+k)*b[a].len,b[a].len);b[a].dirty=!0};this.count=function(){return d};
this.data=function(a){return b[a].array};this.update=function(){for(name in b)b[name].dirty&&(b[name].buffer&&b[name].buffer.update(b[name].array,0),b[name].dirty=!1)}}function Sa(a){ba||(ba=B(v+"shaders/selbox"));var b=!1,c=!1,d=null,e=null,f=ka(6,2),g=K(wa(0,0,1,1),2);a.canvas.bind("mousedown",function(n){b&&(show=c=!0,e=d=a.camera.percent(new vect(n.clientX,n.clientY)),f.update(w(d,e),0))});var l=function(){};this.select=function(a){l=a};$(document).bind("mouseup",function(){if(b&&c){var f=a.camera.project(a.camera.pixel(d)),
k=a.camera.project(a.camera.pixel(e));if(f.x>k.x){var g=f.x;f.x=k.x;k.x=g}f.y>k.y&&(g=f.y,f.y=k.y,k.y=g);c=!1;l(new ca(f,k))}});$(document).bind("click",function(){b&&(show=!1)});$(document).bind("mousemove",function(g){b&&c&&(e=a.camera.percent(new vect(g.clientX,g.clientY)),f.update(w(d,e),0))});this.enable=function(){b=!0};this.disable=function(){b=!1};this.draw=function(){c&&(gl.useProgram(ba),ba.data("pos",f),ba.data("edge_in",g),gl.drawArrays(gl.TRIANGLES,0,f.numItems))}}function Ba(a,b){for(;a>=
b;)a-=b;for(;0>a;)a+=b;return a}function Ua(a,b,c,d){this.current=a;this.upper=b;this.lower=c;this.index=d}function Ca(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return!0;return!1}function ia(a,b,c){if(void 0==b)throw"whoa";return 0==a[b+1].y-a[b].y?Math.min(a[b].x,a[b+1].x):a[b].x+(a[b+1].x-a[b].x)*((c-a[b].y)/(a[b+1].y-a[b].y))}function V(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return c;return!1}function C(a,b,c){return new vect(ia(b,c,b[a].y),b[a].y)}function L(a,b){if(!b)throw"eek";a.push(b.x);
a.push(b.y)}function W(a,b,c){if(!b||!c||3!=c.length+b.length&&4!=c.length+b.length)throw"ahh";if(3==b.length+c.length){for(var d=0;d<b.length;d++)L(a,b[d]);for(d=0;d<c.length;d++)L(a,c[d])}else b[1].x<b[0].x&&(d=b[0],b[0]=b[1],b[1]=d),c[1].x<c[0].x&&(d=c[0],c[0]=c[1],c[1]=d),L(a,b[0]),L(a,b[1]),L(a,c[1]),L(a,c[0]),L(a,c[1]),L(a,b[0])}function ca(a,b){this.min=a.clone();this.max=b.clone();this.contains=function(c){return a.x<=c.x&&b.x>=c.x&&a.y<=c.y&&b.y>=c.y};this.x_in=function(c){return a.x<=c.x&&
b.x>=c.x};this.x_left=function(b){return a.x>=b.x};this.x_right=function(a){return b.x<=a.x};this.y_in=function(c){return a.y<=c.y&&b.y>=c.y};this.y_left=function(b){return a.y>=b.y};this.y_right=function(a){return b.y<=a.y};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(a){switch(a){case 0:return this.min.clone();case 1:return new vect(this.max.x,
this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);default:throw"Index out of bounds: "+a;}};this.intersects=function(a){for(var b=0;4>b;b++)for(var e=0;4>e;e++)if(vect.intersects(this.vertex(b),this.vertex((b+1)%4),a.vertex(e),a.vertex((e+1)%4)))return!0;return this.contains(a.min)&&this.contains(a.max)&&this.contains(new vect(a.min.x,a.max.y))&&this.contains(new vect(a.max.x,a.min.y))||a.contains(this.min)&&a.contains(this.max)&&a.contains(new vect(this.min.x,
this.max.y))&&a.contains(new vect(this.max.x,this.min.y))?!0:!1};this.union=function(a){this.min.x=Math.min(this.min.x,a.min.x);this.min.y=Math.min(this.min.y,a.min.y);this.max.x=Math.max(this.max.x,a.max.x);this.max.y=Math.max(this.max.y,a.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new ca(a,b)}}function na(a,b,c,d){this.data=a[d];this.right=this.left=null;b!=d&&(this.left=new na(a,b,d-1,parseInt((b+(d-1))/2)));
c!=d&&(this.right=new na(a,d+1,c,parseInt((c+(d+1))/2)));this.subtree=[];for(d=b;d<=c;d++)this.subtree.push(a[d]);this.subtree.sort(function(a,b){return a.y-b.y});this.yrange=function(a,b,c){return a.y_in(this.subtree[b])&&a.y_in(this.subtree[c])};this.subquery=function(a,b,c,d,n){if(this.yrange(b,c,d))for(b=c;b<=d;b++)a.push(this.subtree[b]);else b.y_in(this.subtree[n])&&a.push(this.subtree[n]),b.y_left(this.subtree[n])?n!=d&&this.subquery(a,b,n+1,d,parseInt((d+(n+1))/2)):(b.x_right(this.subtree[n])||
n!=d&&this.subquery(a,b,n+1,d,parseInt((d+(n+1))/2)),n!=c&&this.subquery(a,b,c,n-1,parseInt((c+(n-1))/2)))};this.search=function(d,f){f.x_in(a[b])&&f.x_in(a[c])?this.subquery(d,f,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2)):(f.contains(this.data)&&d.push(this.data),f.x_left(this.data)?this.right&&this.right.search(d,f):f.x_right(this.data)?this.left&&this.left.search(d,f):(this.left&&this.left.search(d,f),this.right&&this.right.search(d,f)))}}function Da(a){a.sort(function(a,c){return a.x-
c.x});this.root=new na(a,0,a.length-1,parseInt((a.length-1)/2));this.search=function(a,c){var d=new ca(a,c),e=[];this.root.search(e,d);return e}}function oa(a){z||(z=B(v+"shaders/point"),Ea=aa(v+"images/circle.png"));this.id=P();var b=new N(a);b.create("vert",2);b.create("unit",2);b.create("color",3);b.create("alpha",1);var c=this,d=function(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=P();var d=new vect(a.geom[0][0],a.geom[0][1]);
this.bounds=new ca(d.clone(),d.clone());var e,f,d=0,g={};H(g,a.style,"fill",Z);H(g,a.style,"opacity",parseFloat);var n=function(){var a=g.fill;a||(a=c.style("fill"));a||(a=Va);b.repeat("color",a.array,e,f)},l=function(){var a=g.opacity;a||(a=c.style("opacity"));a||(a=Wa);b.repeat("alpha",[a],e,f)};this.style=function(a,b){if(1==arguments.length)return g[a];g[a]=b;"fill"==a&&n();"opacity"==a&&l()};d=this.geom.length;f=6*d;e=b.alloc(f);$.each(this.geom,function(a,c){b.repeat("vert",c,e+6*a,6);b.write("unit",
Xa,e+6*a,6)});n();l()},e=null,f=0,g=!1,l={},n={};this.bounds=null;this.append=function(a){a=new d(a);for(key in a.attr)l[key]=!0;n[a.id]=a;f++;g=!0;e=null;this.bounds?this.bounds.union(a.bounds):this.bounds=a.bounds.clone();return a};this.features=function(){var a=[];for(key in n)a.push(n[key]);return new I(a)};this.attr=function(){var a=[];for(key in l)a.push(key);return a};this.search=function(a){a=e.search(a.min,a.max);var b=[];$.each(a,function(a,c){b.push(n[c.key])});return new I(b)};this.mouseover=
function(){};this.mouseout=function(){};this.click=function(){};this.style=function(a,b){if(1<arguments.length)throw"Not Implemented";return null};this.update_move=function(){};this.draw=function(a,c,d){b.update(c);if(0<f){if(g){if(!e){var l=[],h;for(h in n)$.each(n[h].geom,function(a,b){l.push({key:h,x:b[0],y:b[1]})});e=new Da(l)}g=!1}gl.useProgram(z);z.data("screen",a.camera.mat3);z.data("pos",b.get("vert"));z.data("circle_in",b.get("unit"));d||(z.data("color_in",b.get("color")),z.data("alpha_in",
b.get("alpha")),z.data("select",d),z.data("aspect",a.canvas.width()/a.canvas.height()),z.data("pix_w",2/a.canvas.width()),z.data("rad",5),z.data("glyph",Ea),z.data("zoom",1/a.camera.level),gl.drawArrays(gl.TRIANGLES,0,b.count()))}}}function pa(a){function b(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=P();var b,c,d,e=0,f=function(){var a;a="fill"in j?j.fill:n.style("fill");g.repeat("color",a.array,b,c);a="stroke"in j?j.stroke:
n.style("stroke");l.repeat("color",a.array,d,e)},k=function(){var a;a="fill-opacity"in j?j["fill-opacity"]:n.style("fill-opacity");g.repeat("alpha",[a],b,c);a="stroke-opacity"in j?j["stroke-opacity"]:n.style("stroke-opacity");l.repeat("alpha",[a],d,e)},F=[];c=0;$.each(this.geom,function(a,b){for(var d=[],e=0;e<b.length;e++){for(var f=[],g=1;g<b[e].length;g++)f.push(Ga(b[e][g][0],b[e][g][1]));f.push(d[0]);d.push(f)}for(var e=[],n=0,l=[],g=0;g<d.length;g++){for(f=0;f<d[g].length-1;f++){var k=Ba(f+1,
d[g].length-1),t=Ba(f-1,d[g].length-1);e.push(new Ua(f+n,k+n,t+n,g));l.push(d[g][f])}l.push(d[g][0]);n+=d[g].length}e.sort(function(a,b){return l[a.current].y-l[b.current].y});d=[];g=[];new vect(-200,0);new vect(200,0);n=0;n=[];t=[];for(f=0;f<e.length;f++){var p=e[f],k=Ca(d,p.lower),j=Ca(d,p.current),h,r;if(k&&!j)r=h=V(d,p.lower);else if(j&&!k)h=r=V(d,p.current);else if(k&&j)h=V(d,p.lower),r=V(d,p.current);else if(!k&&!j){a:{h=d;r=l;for(var m=l[p.current].x,x=l[p.current].y,G=0;G<h.length;G++){var Fa=
ia(r,h[G],x);if(Fa>m||0==Fa-m&&r[h[G]].y>r[index].y){r=G;break a}}r=h.length}h=r}if(1<Math.abs(h-r)){for(k=0;k<d.length;k++);throw"Bad";}m=vect.left(l[p.lower],l[p.current],l[p.upper]);x=Math.floor(Math.min(h,r)/2);!m&&!k&&!j?(W(t,g[x],[C(p.current,l,d[r-1]),C(p.current,l,d[r])]),g.splice(x,1,[C(p.current,l,d[r-1]),l[p.current]],[l[p.current],C(p.current,l,d[h])])):m&&!k&&!j?g.splice(x,0,[l[p.current]]):k&&!j?(W(t,g[x],[C(p.current,l,d[Math.max(h,r)-1]),l[p.current]]),g[x]=[C(p.current,l,d[Math.min(h,
r)-1]),l[p.current]]):!k&&j?(W(t,g[x],[l[p.current],C(p.current,l,d[Math.min(r,h)+1])]),g[x]=[l[p.current],C(p.current,l,d[Math.max(r,h)+1])]):!m&&k&&j?(W(t,g[x],[C(p.current,l,d[Math.min(h,r)-1]),l[p.current]]),W(t,g[x+1],[C(p.current,l,d[Math.max(h,r)+1]),l[p.current]]),g.splice(x,2,[C(p.current,l,d[Math.min(h,r)-1]),C(p.current,l,d[Math.max(h,r)+1])])):m&&(k&&j)&&(W(t,g[x],[l[p.current]]),g.splice(x,1));k&&!j?d[h]=p.current:j&&!k?d[r]=p.lower:k&&j?(d.splice(V(d,p.lower),1),d.splice(V(d,p.current),
1)):!k&&!j&&(m?d.splice(h,0,p.lower,p.current):d.splice(h,0,p.current,p.lower));for(k=0;k<d.length-1;k++)if(ia(l,d[k],l[p.current].y)>ia(l,d[k+1],l[p.current].y))throw console.log("Misplaced Sweep"),"Misplace!";}if(0<d.length)throw console.log(d),"Bad "+d.length;if(0<n.length)throw console.log(n),"Wrong";c+=t.length/2;F.push(t)});var p=new vect(Infinity,Infinity),h=new vect(-Infinity,-Infinity);$.each(this.geom,function(a,b){$.each(b,function(a,b){$.each(b,function(a,b){b[0]<p.x&&(p.x=b[0]);b[0]>
h.x&&(h.x=b[0]);b[1]<p.y&&(p.y=b[1]);b[1]>h.y&&(h.y=b[1])})})});this.bounds=new ca(p,h);var r=b=g.alloc(c);$.each(F,function(a,b){var d=b.length/2;g.write("vert",b,r,d);r+=d});d=l.count();$.each(this.geom,function(a,b){for(a=0;a<b.length;a++)e+=6*b[a].length,Ha(l,b[a])});var j={};H(j,a.style,"fill",Z);H(j,a.style,"stroke",Z);H(j,a.style,"fill-opacity",parseFloat);H(j,a.style,"stroke-opacity",parseFloat);this.style=function(a,b){if(1==arguments.length)return j[a];j[a]=b;"fill"==a&&f();"stroke"==a&&
f();"fill-opacity"==a&&k();"stroke-opacity"==a&&k()};f();k()}a||(a={});a.style||(a.style={});var c,d,e,f;c="fill"in a.style?a.style.fill:new s(0.02,0.44,0.69,1);d="stroke"in a.style?a.style.stroke:new s(0.02,0.44,0.69,1);e="fill-opacity"in a.style?a.style["fill-opacity"]:0.5;f="stroke-opacity"in a.style?a.style["stroke-opacity"]:1;Q||(Q=B(v+"shaders/poly"));u||(u=B(v+"shaders/line"));this.id=P();var g=new N(1024);g.create("vert",2);g.create("color",3);g.create("alpha",1);var l=new N(1024);l.create("vert",
2);l.create("norm",2);l.create("color",3);l.create("alpha",1);var n=this,k={},F=0,h=null;this.features=function(){var a=[];for(key in k)a.push(k[key]);return new I(a)};this.search=function(a){a=h.search(a.min,a.max);var b={};$.each(a,function(a,d){b[d.key]=!0});a=[];for(var d in b)a.push(k[d]);return new I(a)};this.contains=function(a){var b=0,d=[],c;for(c in k){var e=k[c];if(e.bounds.contains(a)){b++;for(var f=0;f<e.geom.length;f++){var g=0;$.each(e.geom[f],function(b,d){for(var c=0;c<d.length;c++){var e=
(c+1)%d.length;if(0>(a.y-d[c][1])/(a.y-d[e][1])){var f=new vect(720,a.y),l=new vect(d[c][0],d[c][1]),e=new vect(d[e][0],d[e][1]);vect.intersects(a,f,l,e)&&g++}}});1==g%2&&d.push(e)}}}return new I(d)};this.aggregate=function(a,b){a.features().each(function(a,d){$.each(d.geom,function(a,c){var e=n.contains(new vect(c[0],c[1]));e&&b(e,d)})})};this.bounds=null;var j=!1;this.append=function(a){a=new b(a);this.bounds?this.bounds.union(a.bounds):this.bounds=a.bounds.clone();k[a.id]=a;F++;j=!0;h=null};this.style=
function(a,b){if(1<arguments.length)throw"Not Implemented";return"fill"==a?c:"stroke"==a?d:"fill-opacity"==a?e:"stroke-opacity"==a?f:null};var m=null,r=null;this.mouseover=function(a){m=a};this.mouseout=function(a){r=a};var p={};this.update_move=function(a,b){if(m||r){var d=this.contains(b),c={};d&&d.each(function(a,b){c[b.id]=b});for(var e in p)!(e in c)&&r&&r(p[e]);for(e in c)!(e in p)&&m&&m(c[e]);p=c}};this.force_out=function(){for(var a in p)r&&r(p[a]);p={}};this.draw=function(a,b,d){if(!d){g.update(b);
l.update(b);if(j){var c=[],e;for(e in k)$.each(k[e].geom,function(a,b){$.each(b,function(a,b){$.each(b,function(a,b){c.push({key:e,x:b[0],y:b[1]})})})});h=new Da(c);j=!1}gl.useProgram(Q);Q.data("screen",a.camera.mat3);Q.data("pos",g.get("vert"));Q.data("color_in",g.get("color"));Q.data("alpha_in",g.get("alpha"));gl.drawArrays(gl.TRIANGLES,0,g.count());gl.useProgram(u);u.data("screen",a.camera.mat3);u.data("pos",l.get("vert"));u.data("norm",l.get("norm"));u.data("color_in",l.get("color"));u.data("alpha_in",
l.get("alpha"));u.data("px_w",2/a.canvas.width());u.data("px_h",2/a.canvas.height());gl.drawArrays(gl.TRIANGLES,0,l.count())}}}function Ha(a,b){for(var c=a.alloc(6*b.length),d=0,e=function(){if(b[d]){var a=new vect(b[d][0],b[d][1]);d++;return a}return null},f=[],g=[],l=function(a,b,d,c){c?(a[d]=-b.x,a[d+1]=-b.y):(a[d]=b.x,a[d+1]=b.y)},n=function(a,b,d,c){l(a,b,0,!1);l(a,d,2,!1);l(a,b,4,c);l(a,d,6,c);l(a,b,8,c);l(a,d,10,!1)},k=e(),h=e(),j=e(),m=vect.dir(h,k).rotate(qa/2),q,r=c;h;)q=j?vect.dir(j,k).rotate(qa/
2):vect.dir(h,k).rotate(qa/2),n(f,k,h,!1),n(g,m,q,!0),a.write("vert",f,r,6),a.write("norm",g,r,6),r+=6,k=h,h=j,j=e(),m=q;return c}function Ia(){function a(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=P();var b,e=0,n=function(){var a;a="stroke"in h?h.stroke:d.style("stroke");c.repeat("color",a.array,b,e)},k=function(){var a;a="stroke-opacity"in h?h["stroke-opacity"]:d.style("stroke-opacity");c.repeat("alpha",[a],b,e)};b=c.count();
Ha(c,this.geom);var e=6*this.geom.length,h={};H(h,a.style,"fill",Z);H(h,a.style,"stroke",Z);H(h,a.style,"fill-opacity",parseFloat);H(h,a.style,"stroke-opacity",parseFloat);this.style=function(a,b){if(1==arguments.length)return h[a];h[a]=b;"fill"==a&&n();"stroke"==a&&n();"fill-opacity"==a&&k();"stroke-opacity"==a&&k()};n();k()}var b=new s(0.02,0.44,0.69,1);u||(u=B(v+"shaders/line"));this.id=P();var c=new N(1024);c.create("vert",2);c.create("norm",2);c.create("unit",2);c.create("color",3);c.create("alpha",
1);var d=this,e=0;this.append=function(b){b=new a(b);for(key in b.attr);e++;return b};this.style=function(a,d){if(1<arguments.length)throw"Not Implemented";return"stroke"==a?b:"stroke-opacity"==a?1:null};this.draw=function(a,b){c.update(b);0<e&&(gl.useProgram(u),u.data("screen",a.camera.mat3),u.data("pos",c.get("vert")),u.data("norm",c.get("norm")),u.data("color_in",c.get("color")),u.data("alpha_in",c.get("alpha")),u.data("px_w",2/a.canvas.width()),u.data("px_h",2/a.canvas.height()),gl.drawArrays(gl.TRIANGLES,
0,c.count()))}}function ra(a){D||(D=B(v+"shaders/grid"));a||(a={});a.style||(a.style={});var b=a.lower,c=a.upper,d=a.rows,e=a.cols,f=(c.x-b.x)/e,g=(c.y-b.y)/d,l=new Float32Array(d*e),n=new Uint8Array(4*e*d),k=!1,h=new N(6);h.create("vert",2);h.create("screen",2);h.create("tex",2);var j=new vect(b.x,b.y),m=new vect(c.x,c.y),q=new vect(0,0),r=new vect(1,1),p=h.alloc(6);h.write("vert",w(j,m),p,6);h.write("screen",w(new vect(-1,-1),new vect(1,1)),p,6);h.write("tex",w(q,r),p,6);var t=gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D,t);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);this.lower=function(){return b.clone()};this.upper=function(){return c.clone()};this.rows=function(){return d};this.cols=function(){return e};this.centroid=function(a,d){return new vect(b.x+
f*d+f/2,b.y+g*a+g/2)};this.get=function(a,b){return l[e*a+b]};var G=-Infinity,s=Infinity;this.qunatiles=function(a,b){b||(b=function(a,b){return a-b});for(var d=[],c=0;c<l.length;c++)d.push(l[c]);d.sort(b);for(var e=[-Infinity],c=1;c<a;c++){var f=parseInt(inc*c);e.push(d[f])}e.push(Infinity);return e};this.set=function(a,b,c){if(a>=d||b>=e)throw"Index Out of Bounds";l[e*a+b]=c;k=!0};this.raw_set=function(a,b){if(a>=d*e)throw"Index Out of Bounds: "+a;l[a]=b;k=!0};this.clear=function(a){for(var b=0;b<
d*e;b++)l[b]=a};var O=null;this.draw=function(b){O||(O=b.framebuffer());h.update();if(k){G=-Infinity;s=Infinity;for(var c=0;c<d*e;c++){var f=l[c];f>G&&(G=f);f<s&&(s=f)}for(c=0;c<d*e;c++){var f=c,g=a.map(s,G,l[c]);n[4*f]=parseInt(255*g.r);n[4*f+1]=parseInt(255*g.g);n[4*f+2]=parseInt(255*g.b);n[4*f+3]=parseInt(255*g.a)}gl.bindTexture(gl.TEXTURE_2D,t);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,e,d,0,gl.RGBA,gl.UNSIGNED_BYTE,n);gl.bindTexture(gl.TEXTURE_2D,null);k=!1}a.style.antialias&&O.activate({blend:!1});
gl.useProgram(D);D.data("screen",b.camera.mat3);D.data("pos",h.get("vert"));D.data("tex_in",h.get("tex"));D.data("sampler",t);c=vect.sub(b.camera.screen(m),b.camera.screen(j));D.data("width",c.x);D.data("height",-c.y);D.data("rows",d);D.data("cols",e);D.data("blur",a.blur);gl.drawArrays(gl.TRIANGLES,0,h.count());a.style.antialias&&(O.deactivate(),b.draw_blur(O.tex))}}function Ya(a,b,c){R||(R=B(v+"shaders/raster"));this.image=aa(a);var d=K(w(new vect(0,1),new vect(1,0)),2),e=K(w(b,c),2);this.draw=
function(a,b,c){c||(gl.useProgram(R),R.data("screen",a.camera.mat3),R.data("pos",e),R.data("tex_in",d),R.data("sampler",this.image),gl.drawArrays(gl.TRIANGLES,0,e.numItems))}}function sa(a){A||(A=B(v+"shaders/hillshade"));var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),d=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=!1,f=aa(a,function(){e=!0});this.ready=
function(){return e};var g=K(w(new vect(0,1),new vect(1,0)),2),l=K(w(c,d),2),n=315;this.draw=function(a){if(e){for(gl.useProgram(altitude_shader);1<=n;)n-=1;altitude_shader.data("azimuth",n);altitude_shader.data("altitude",Math.PI/4/(2*Math.PI));altitude_shader.data("screen",a.camera.mat3);altitude_shader.data("pos",l);altitude_shader.data("tex_in",g);altitude_shader.data("elevation",f);a=vect.sub(a.camera.screen(d),a.camera.screen(c));altitude_shader.data("pix_w",1/a.x);altitude_shader.data("pix_h",
1/a.y);gl.drawArrays(gl.TRIANGLES,0,l.numItems);return n}}}function sa(a){A||(A=B(v+"shaders/hillshade"));var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),d=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=!1,f=aa(a,function(){e=!0});this.ready=function(){return e};var g=K(w(new vect(0,1),new vect(1,0)),2),l=K(w(c,d),2),n=315;this.draw=function(a){if(e){for(gl.useProgram(A);1<=
n;)n-=1;A.data("azimuth",n);A.data("altitude",Math.PI/4/(2*Math.PI));A.data("screen",a.camera.mat3);A.data("pos",l);A.data("tex_in",g);A.data("elevation",f);a=vect.sub(a.camera.screen(d),a.camera.screen(c));A.data("pix_w",1/a.x);A.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,l.numItems);return n}}}function ha(a){for(var b=[],c=[],d=0;25>d;d++)c.push(new la);for(d=0;d<a.levels;d++){var e=m(a);"file"==e.source&&(e.url+="/"+a.size*Math.pow(2,d+1));e.min=new vect(-180,-90);e.rows=Math.pow(2,d);e.cols=
2*e.rows;e.cellsize=180/e.rows;e.z_index=1-ta-d/1E3;e.available=c;e=new Za(e);b.push(e)}ta+=(a.levels+2)/1E3;b[0].fetch_all();b[0].noexpire(!0);var f=new N(6*da);f.create("vert",3);f.create("tex",2);f.create("lookup",1);f.alloc(6*da);this.draw=function(d,c){Ja=Ka=0;for(var e=Infinity,h=b[0],j,m=0;m<b.length;m++){var q=a.size*b[m].cols/b[m].size(d).x;1>q&&(q=1/q);q<e&&(e=q,h=b[m],j=m)}for(m=j;0<=m;m--)b[m].fetch();gl.useProgram(E);E.data("screen",d.camera.mat3);if(h.ready())h.draw(d,c,f,0,!0);else{d.enable_z();
e=0;for(m=j;0<=m;m--)e=b[m].draw(d,c,f,e,0==m);d.disable_z()}$.each(b,function(a,b){b.cull()})}}function Za(a){a||(a={});a.desaturate||(a.desaturate=0);a.darken||(a.darken=0);a.hue||(a.hue=0);a.hue_color||(a.hue_color=va(0,0,0,1));if(!a.available){a.available=[];for(var b=0;8>b;b++)a.available.push(new la)}E||(E=B(v+"shaders/tile"));var c=a.url,d=a.min,e=a.rows,f=a.cols,g=a.cellsize;this.rows=e;this.cols=f;for(var l={},n={},h=function(b,c){var e=new vect(d.x+b*g,d.y+c*g),h=new vect(d.x+(b+1)*g,d.y+
(c+1)*g),e={vert:w(e,h,a.z_index),tex:null,i:b,j:c,id:b+f*c,ready:!1,min:e,max:h};n[b][c]=e;l[e.id]=e},b=0;b<f;b++)n[b]={};this.size=function(a){var b=a.camera.screen(d);a=a.camera.screen(vect.add(d,new vect(g*f,g*e)));b=vect.sub(a,b);b.y=Math.abs(b.y);return b};var j=!1;this.noexpire=function(a){j=a};this.cull=function(){if(!j){var b=(new Date).getTime(),c;for(c in q)if(b-q[c]>$a){var d=l[c];delete l[c];delete n[d.i][d.j];a.available.push(d.tex);d.tex=null;d.ready=!1;delete q[c]}}};var m=function(){var a=
engine.camera.project(new vect(engine.canvas.offset().left,engine.canvas.offset().top+engine.canvas.height())),b=engine.camera.project(new vect(engine.canvas.offset().left+engine.canvas.width(),engine.canvas.offset().top)),c=Math.floor((a.x-d.x)/g),e=Math.ceil((b.x-d.x)/g),a=Math.floor((a.y-d.y)/g),b=Math.ceil((b.y-d.y)/g);return{min_col:c,max_col:e,min_row:a,max_row:b}},q={};this.ready=function(){for(var a=m(),b=Math.max(0,a.min_col);b<Math.min(f,a.max_col);b++)for(var c=Math.max(0,a.min_row);c<
Math.min(e,a.max_row);c++)if(!n[b][c]||!n[b][c].ready)return!1;return!0};var s=function(b,d){if(!n[b][d].tex){var e;if("file"==a.source)e=c+"/"+n[b][d].id+".png";else if("wms"==a.source){e={service:"wms",version:"1.1.0",request:"GetMap",layers:a.layer,bbox:[n[b][d].min.x,n[b][d].min.y,n[b][d].max.x,n[b][d].max.y].join(),width:a.size,height:a.size,srs:"EPSG:4326",format:"image/png",transparent:"true"};var f=[],g;for(g in e)f.push(g+"="+e[g]);e=c+"?"+f.join("&")}n[b][d].tex=a.available.pop();n[b][d].tex||
(n[b][d].tex=new la);g=e;var l=n[b][d],h=new Image;h.crossOrigin="";h.onload=function(){l.tex&&(l.tex.image(h),l.ready=!0)};h.src=g}};this.fetch_all=function(){for(var a=(new Date).getTime(),b=0;b<f;b++)for(var d=0;d<e;d++)n[b][d]||h(b,d),n[b][d].tex||s(b,d),q[n[b][d].id]=a};this.fetch=function(){for(var a=m(),b=(new Date).getTime(),d=Math.max(0,a.min_col-1);d<Math.min(f,a.max_col+1);d++)for(var c=Math.max(0,a.min_row-1);c<Math.min(e,a.max_row+1);c++)n[d][c]||h(d,c),n[d][c].tex||s(d,c),q[n[d][c].id]=
b};this.draw=function(b,d,c,g,l){b=function(){Ja++;c.update();E.data("pos",c.get("vert"));E.data("tex_in",c.get("tex"));E.data("lookup_in",c.get("lookup"));E.data("desaturate",a.desaturate);E.data("darken",a.darken);E.data("hue",a.hue);E.data("hue_color",a.hue_color.array);gl.drawArrays(gl.TRIANGLES,0,6*g)};d=m();for(var h=(new Date).getTime(),k=Math.max(0,d.min_col);k<Math.min(f,d.max_col);k++)for(var j=Math.max(0,d.min_row);j<Math.min(e,d.max_row);j++)if(n[k][j]&&n[k][j].ready&&n[k][j].tex){c.write("vert",
n[k][j].vert,6*g,6);c.write("tex",w(new vect(0,0),new vect(1,1)),6*g,6);c.repeat("lookup",[g/da+1/(2*da)],6*g,6);q[n[k][j].id]=h;E.data("sampler"+g,n[k][j].tex);if(null==n[k][j].tex)throw"bad";g++;Ka++;g>=da&&(b(),g=0)}l&&b();return g}}var v="",X=jQuery,ab=function(a){if("string"===typeof a.data){var b=a.handler,c=a.data.toLowerCase().split(" ");a.handler=function(a){if(!(this!==a.target&&(/textarea|select/i.test(a.target.nodeName)||"text"===a.target.type))){var e="keypress"!==a.type&&X.hotkeys.specialKeys[a.which],
f=String.fromCharCode(a.which).toLowerCase(),g="",l={};a.altKey&&"alt"!==e&&(g+="alt+");a.ctrlKey&&"ctrl"!==e&&(g+="ctrl+");a.metaKey&&(!a.ctrlKey&&"meta"!==e)&&(g+="meta+");a.shiftKey&&"shift"!==e&&(g+="shift+");e?l[g+e]=!0:(l[g+f]=!0,l[g+X.hotkeys.shiftNums[f]]=!0,"shift+"===g&&(l[X.hotkeys.shiftNums[f]]=!0));e=0;for(f=c.length;e<f;e++)if(l[c[e]])return b.apply(this,arguments)}}}};X.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",
27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",
2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}};X.each(["keydown","keyup","keypress"],function(){X.event.special[this]={add:ab}});var M=jQuery,ua=function(a){var b=a||window.event,c=[].slice.call(arguments,1),d=0,e=0,f=0;a=M.event.fix(b);a.type="mousewheel";b.wheelDelta&&(d=b.wheelDelta/120);b.detail&&(d=-b.detail/3);f=d;void 0!==b.axis&&b.axis===b.HORIZONTAL_AXIS&&(f=0,e=-1*d);void 0!==b.wheelDeltaY&&(f=b.wheelDeltaY/
120);void 0!==b.wheelDeltaX&&(e=-1*b.wheelDeltaX/120);c.unshift(a,d,e,f);return(M.event.dispatch||M.event.handle).apply(this,c)},Y=["DOMMouseScroll","mousewheel"];if(M.event.fixHooks)for(var S=Y.length;S;)M.event.fixHooks[Y[--S]]=M.event.mouseHooks;M.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=Y.length;a;)this.addEventListener(Y[--a],ua,!1);else this.onmousewheel=ua},teardown:function(){if(this.removeEventListener)for(var a=Y.length;a;)this.removeEventListener(Y[--a],
ua,!1);else this.onmousewheel=null}};M.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}});for(var La=0,S=["ms","moz","webkit","o"],ea=0;ea<S.length&&!window.requestAnimationFrame;++ea)window.requestAnimationFrame=window[S[ea]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[S[ea]+"CancelAnimationFrame"]||window[S[ea]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=
function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-La)),d=window.setTimeout(function(){a(b+c)},c);La=b+c;return d});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});var qa=3.14159265,H=function(a,b,c,d){c in b&&(a[c]=d?d(b[c]):b[c])},Ra=!1;gl=null;var ya=0,ma="http://eland.ecohealthalliance.org:8080/wigglemaps",U={x:0,y:0},y=null,za=null,ba=null,P,Ma=1;P=function(){var a=Ma;Ma++;return a};var Ga;Ga=function(a,b){return new vect(a+1E-6*Math.random()-5E-7,
b+1E-6*Math.random()-5E-7)};var z=null,Ea,Xa=wa(0,0,1,1),Va=new s(0.02,0.44,0.69,1),Wa=1,Q=null,u,D=null,I=function(a){var b=null;this.length=a.length;this.count=function(){return a.length};this.attr=function(b){return a.length?a[0].attr[b]:null};this.get=function(b){return a[b]};this.subset=function(b){for(var c=[],f=0;f<b.length;f++)c.push(a[b[f]]);return new I(c)};this.id=function(c){if(!b){b={};for(var e=0;e<a.length;e++)b[a[e].id]=a[e]}return c in b?b[c]:null};this.each=function(b){for(var c=
0;c<a.length;c++)b(c,a[c]);return this};var c={">":function(a,b){return a>b},"<":function(a,b){return a<b},"==":function(a,b){return a==b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b}};this.select=function(b){if(b.match(/^\s*\*\s*$/))return new I(a);var e=b.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!e)throw"Bad Selector";b=e[1];var f=e[2],g=null,l=null;isNaN(e[3])?l=e[3]:g=parseFloat(e[3]);new_elem=[];if(l)for(e=0;e<a.length;e++)c[f](a[e].attr[b],a[e].attr[l])&&new_elem.push(a[e]);
else for(e=0;e<a.length;e++)c[f](a[e].attr[b],g)&&new_elem.push(a[e]);return new I(new_elem)};this.filter=function(b){for(var c=[],f=0;f<a.length;f++)b(a[f])&&c.push(a[f]);return new I(c)};this.quantile=function(b,c,f){a.sort(function(a,c){return a.attr[b]-c.attr[b]});var g=Math.round(c*this.length/f);c=Math.round((c-1)*this.length/f);return new I(a.slice(c,g))};this.range=function(b){for(var c=Infinity,f=-Infinity,g=0;g<a.length;g++)c>a[g].attr[b]&&(c=a[g].attr[b]),f<a[g].attr[b]&&(f=a[g].attr[b]);
return{min:c,max:f}};this.style=function(b,c){if(1==arguments.length){var f=[];$.each(a,function(a,c){f.push(c.style(b))});return f}if("function"==typeof c)$.each(a,function(a,f){f.style(b,c(f))});else{var g;a:if(null==c||void 0==c.length)g=!1;else{for(g=0;g<c.length;g++)if(!(g in c)){g=!1;break a}g=!0}g?$.each(a,function(a,f){f.style(b,c[a])}):$.each(a,function(a,f){f.style(b,c)})}return this}},R=null,A=null,T=null,A=null,$a=1E3,ta=0,da=8,Ka=0,Ja=0,E=null,Na=[];window.wiggle={Map:function(a,b){engine=
new Qa(a,b);this.center=function(a,b){engine.camera.position(new vect(a,b))};this.vcenter=function(a){this.center(a.x,a.y)};this.extents=function(a){engine.camera.extents(a)};this.append=function(a){engine.scene.push(a)};this.remove=function(a){for(var b=0;b<engine.scene.length;b++)if(engine.scene[b]==a)return engine.scene.splice(b,1),!0;return!1};this.shade=function(a){a=new sa(a);engine.shade=a};this.select=function(a){a?(engine.sel.select(a),engine.select(!0)):engine.select(!1)};this.resize=function(){engine.resize()};
this.attr=function(a,b){engine.attr(a,b)};this.png=function(){var a=engine.canvas.get(0).toDataURL();$.ajax({url:"../server/export.png",type:"POST",data:a})};this.width=function(){return engine.canvas.innerWidth()};this.height=function(){return engine.canvas.innerHeight()};var c=null;this.click=function(a){c=a};engine.canvas.click(function(a){c&&(a=new vect(a.pageX,a.pageY),a=engine.camera.project(a),c(a))})},layer:{PointLayer:oa,LineLayer:Ia,PolygonLayer:pa,Grid:ra,Hillshade:sa,Elevation:function(a){T||
(T=B(v+"shaders/elevation"));var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),d=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=aa(a),f=K(w(new vect(0,1),new vect(1,0)),2),g=K(w(c,d),2);this.draw=function(a,b,h){h||(gl.useProgram(T),T.data("screen",a.camera.mat3),T.data("pos",g),T.data("tex_in",f),T.data("elevation",e),vect.sub(a.camera.screen(d),a.camera.screen(c)),
gl.drawArrays(gl.TRIANGLES,0,g.numItems))}}},io:{Shapefile:function(a){var b=a.path;$.ajax({url:b+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(c){for(var d=[],e=100;e<c.length;)d.push(2*ja(c,e)),e+=8;$.ajax({url:b+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(b){for(var c=[],e=[],h=0;h<d.length;h++){var k=d[h];ja(b,k);ja(b,k+4);var j=k+8,m=J(b,j);if(0==m)console.log("NULL Shape");else if(1==m)m=fa(b,j+4),j=fa(b,j+12),c.push({attr:{},geom:[[m,j]]});
else if(5==m){for(var m=J(b,j+36),j=J(b,j+40),q=k+52,k=k+52+4*m,s=[],r=0;r<m;r++){var p=J(b,q+4*r),t;t=r+1<m?J(b,q+4*(r+1)):j;var u=k,w=[];for(t-=1;t>=p;t--){var O=fa(b,u+16*t),x=fa(b,u+16*t+8);w.push([O,x])}s.push(w)}e.push({attr:{},geom:[s]})}else throw"Not Implemented: "+m;}if(0<c.length){var v=new oa(c.length);$.each(c,function(a,b){v.append(b)});b=v}else 0<e.length?(v=new pa(a),$.each(e,function(a,b){for(var c=0;100>c;)try{v.append(b),c=101}catch(d){c++}100==c&&console.log("rendering polygon failed")}),
b=v):b=void 0;a.success(b)}})}})},GeoJSON:function(a,b){for(var c=0,d=0,e=0,f=[],g=[],h=[],j=0;j<a.features.length;j++){var k=a.features[j];if("Feature"==k.type){"Point"==k.geometry.type&&(c++,f.push({geom:[k.geometry.coordinates],attr:k.properties}));"MultiPoint"==k.geometry.type&&(c+=k.geometry.cooordinates.length,f.push({geom:k.geometry.coordinates,attr:k.properties}));if("Polygon"==k.geometry.type){for(var m=k.geometry.coordinates,q=[],s=0;s<=m.length-1;s++){for(var u=[],r=m[s].length-1;0<=r;r--)u.push(m[s][r]);
q.push(u)}d++;g.push({geom:[q],attr:k.properties})}if("MultiPolygon"==k.geometry.type){var p=[];$.each(k.geometry.coordinates,function(a,b){for(var c=[],d=0;d<=b.length-1;d++){for(var e=[],f=b[d].length-1;0<=f;f--)e.push(b[d][f]);c.push(e)}p.push(c)});d++;g.push({geom:p,attr:k.properties})}"MultiLineString"==k.geometry.type&&$.each(k.geometry.coordinates,function(a,b){e++;h.push({geom:b,attr:k.properties})})}}if(0<c){var t=new oa(c);$.each(f,function(a,b){t.append(b)});return t}if(0<d)return t=new pa(b),
$.each(g,function(a,b){for(var c=0;100>c;)try{t.append(b),c=101}catch(d){c++}100==c&&console.log("rendering polygon failed")}),t;if(0<e){var v=new Ia;$.each(h,function(a,b){v.append(b)});return v}},KML:function(a){var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),b=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();return new Ya(v+a,c,b)},SparseGrid:function(a,b){var c=
ga(a,0),d=ga(a,4),e=J(a,8),f=J(a,12),g=ga(a,16),h={};for(key in b)h[key]=b[key];h.lower=new vect(c,d);h.upper=new vect(c+g*e,d+g*f);h.rows=f;h.cols=e;c=new ra(h);for(d=20;d<a.length;){for(var g=J(a,d),e=J(a,d+4),f=d+4,h=e,j=0;j<h;j++){var k=ga(a,f+4*j);c.raw_set(g+j,k)}d+=8+4*e}return c},AsciiGrid:function(a,b){var c=a.split("\n"),d=c.splice(0,6),e=parseInt(d[0].slice(14)),f=parseInt(d[1].slice(14)),g=parseFloat(d[2].slice(14)),h=parseFloat(d[3].slice(14)),j=parseFloat(d[4].slice(14)),d=d[5].slice(14),
k={};for(key in b)k[key]=b[key];k.lower=new vect(g,h);k.upper=new vect(g+j*e,h+j*f);k.rows=f;k.cols=e;g=new ra(k);for(h=0;h<f;h++){j=c[h].split(" ");for(k=0;k<e;k++)j[k]==d?g.set(f-1-h,k,NaN):g.set(f-1-h,k,parseFloat(j[k]))}return g},WMS:function(a){a=m(a);for(var b=["url","layer"],c=0;c<b.length;c++){var d=b[c];if(!(d in a))throw"Key "+d+" not found";}j(a,{levels:16,size:256});var b={source:"wms"},e;for(e in b)a[e]=b[e];return new ha(a)}},util:{fcolor:va,icolor:function(a,b,c,d){return new s(h(a/
255,0,1),h(b/255,0,1),h(c/255,0,1),h(d/255,0,1))}},widget:{Slider:function(a,b,c){var d=function(a){if(a>=c)throw"Slider index out of bounds";return b.x/(c-1)*a},e=function(d){return d<=a.x?0:d>=a.x+b.x?c-1:Math.round((d-a.x)/b.x*(c-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",a.x).css("top",a.y).css("width",b.x).css("height",b.y);var f=!1,g=0,h=$("<div></div>").addClass("slider-box").css("position","relative").css("left",-10).css("height",b.y).css("width",
20).mousedown(function(){f=!0});this.tick=function(){return g};this.count=function(){return c};var j=function(){};this.change=function(a){j=a};var k=function(){};this.release=function(a){k=a};this.dragging=function(){return f};this.dom.append(h);this.set=function(a){a!=g&&j(a);g=a;var b=d(a);h.css("left",b-10);k(a)};$(document).bind("mouseup",function(){if(f){f=!1;var a=e(event.clientX);k(a)}});$(document).bind("mousemove",function(a){f&&(a=e(a.clientX),a!=g&&j(a),g=a,a=d(a),h.css("left",a-10))})}},
ready:function(a){Na.push(a)}};$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(a,b){var c=/wigglemaps(\.min)?\.js/;$(b).attr("src").match(c)&&(v=$(b).attr("src").replace(c,""))});$.each(Na,function(a,b){b()})})})();
