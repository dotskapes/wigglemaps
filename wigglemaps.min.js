function Vector2D(e,t){this.x=e,this.y=t,this.add=function(e){return this.x+=e.x,this.y+=e.y,this},this.sub=function(e){return this.x-=e.x,this.y-=e.y,this},this.scale=function(e){return this.x*=e,this.y*=e,this},this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.normalize=function(){var e=this.length();return e==0?this:(this.x/=e,this.y/=e,this)},this.div=function(e){return this.x/=e.x,this.y/=e.y,this},this.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},this.zero=function(){return this.x+this.y==0},this.dot=function(e){return this.x*e.x+this.y*e.y},this.cross=function(e){return this.x*e.y-this.y*e.x},this.rotate=function(e){var t=Math.cos(e),n=Math.sin(e);return xp=t*this.x-n*this.y,yp=n*this.x+t*this.y,this.x=xp,this.y=yp,this},this.clone=function(){return new Vector2D(this.x,this.y)},this.array=function(){return[this.x,this.y]}}function vect(e,t){return new Vector2D(e,t)}vect.scale=function(e,t){return e.clone().scale(t)},vect.add=function(e,t){return e.clone().add(t)},vect.sub=function(e,t){return e.clone().sub(t)},vect.dist=function(e,t){return e.clone().sub(t).length()},vect.dir=function(e,t){return e.clone().sub(t).normalize()},vect.dot=function(e,t){return e.x*t.x+e.y*t.y},vect.cross=function(e,t){return e.x*t.y-e.y*t.x},vect.left=function(e,t,n,r){r||(r=0);var i=vect.sub(t,e),s=vect.sub(n,e);return vect.cross(i,s)>=-r},vect.intersects=function(e,t,n,r,i){return i||(i=0),vect.left(e,t,n,i)!=vect.left(e,t,r,i)&&vect.left(n,r,t,i)!=vect.left(n,r,e,i)},vect.intersect2dt=function(e,t,n,r){var i=e.x*(r.y-n.y)+t.x*(n.y-r.y)+r.x*(t.y-e.y)+n.x*(e.y-t.y);if(i==0)return Infinity;var s=e.x*(r.y-n.y)+n.x*(e.y-r.y)+r.x*(n.y-e.y),o=s/i,u=-(e.x*(n.y-t.y)+t.x*(e.y-n.y)+n.x*(t.y-e.y)),a=u/i;return a},vect.intersect2dpos=function(e,t,n,r){var i=e.x*(r.y-n.y)+t.x*(n.y-r.y)+r.x*(t.y-e.y)+n.x*(e.y-t.y);if(i==0)return Infinity;var s=e.x*(r.y-n.y)+n.x*(e.y-r.y)+r.x*(n.y-e.y),o=s/i,u=vect.sub(t,e);return u.scale(o),vect.add(e,u)},vect.rotate=function(e,t){var n=Math.cos(t),r=Math.sin(t);xp=n*e.x-r*e.y,yp=r*e.x+n*e.y;var e=new vect(xp,yp);return e},vect.normalize=function(e){return e.clone().normalize()},function(){function n(e,t){var n=[];for(var r in t)n.push(r+"="+t[r]);return e+"?"+n.join("&")}function r(e,t){for(var n in t)n in e||(e[n]=t[n])}function i(e,t){for(var n in t)e[n]=t[n]}function s(e){var t={};for(key in e)t[key]=e[key];return t}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(!(r in e))throw"Key "+r+" not found"}}function u(e,t){for(key in t)e[key]=t[key]}function l(e){return"rgb("+Math.round(e[0]*255)+","+Math.round(e[1]*255)+","+Math.round(e[2]*255)+")"}function c(e,t,n){return Math.min(Math.max(e,t),n)}function h(e,t,n,r){e<=1&&t<=1&&n<=1&&r<=1?(this.r=e,this.g=t,this.b=n,this.a=r):(this.r=e/255,this.g=t/255,this.b=n/255,this.a=r/255),this.array=[this.r,this.g,this.b,this.a],this.vect=function(){return this.array},this.rgb=function(){return"rgb("+parseInt(this.r*255)+","+parseInt(this.g*255)+","+parseInt(this.b*255)+")"}}function p(e,t,n,r){return new h(c(e/255,0,1),c(t/255,0,1),c(n/255,0,1),c(r/255,0,1))}function d(e,t,n,r){return new h(c(e,0,1),c(t,0,1),c(n,0,1),c(r,0,1))}function v(e){var t=parseInt(e.slice(1,3),16),n=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return new h(t,n,r,255)}function m(e){if(e==null)return!1;if(e.length==undefined)return!1;for(var t=0;t<e.length;t++)if(!(t in e))return!1;return!0}function g(e){var t=e[0];if(t=='"'||t=="'")if(e[e.length-1]==t)return!0;return!1}function y(e){return e.match(/^rgb\(\d+,\d+,\d+\)$/)?!0:!1}function b(e){return e.match(/^(\+|\-)?\d*\.\d*$/)&&e.length>1?!0:e.match(/^(\+|\-)?\d*\.\d*e(\+|\-)?\d+$/)&&e.length>1?!0:!1}function w(e){return e.length==1?e.match(/^\d$/):e.match(/^(\+|\-)?\d+$/)}function E(e){var t=e.match(/^rgb\((\d+),(\d+),(\d+)\)$/);return t?new h(t[1],t[2],t[3],255):null}function S(e,t){return e.indexOf(t)!=-1}function x(e,t){return e.charCodeAt(t)}function T(e,t){return((e.charCodeAt(t)&255)<<24)+((e.charCodeAt(t+1)&255)<<16)+((e.charCodeAt(t+2)&255)<<8)+(e.charCodeAt(t+3)&255)}function N(e,t){return((e.charCodeAt(t+3)&255)<<24)+((e.charCodeAt(t+2)&255)<<16)+((e.charCodeAt(t+1)&255)<<8)+(e.charCodeAt(t)&255)}function C(e,t){return((e.charCodeAt(t)&255)<<8)+(e.charCodeAt(t+1)&255)}function k(e,t){return((e.charCodeAt(t+1)&255)<<8)+(e.charCodeAt(t)&255)}function L(e,t){var n=e.charCodeAt(t)&255,r=e.charCodeAt(t+1)&255,i=e.charCodeAt(t+2)&255,s=e.charCodeAt(t+3)&255,o=e.charCodeAt(t+4)&255,u=e.charCodeAt(t+5)&255,a=e.charCodeAt(t+6)&255,f=e.charCodeAt(t+7)&255,l=1-2*(f>>7),c=((f&127)<<4)+((a&240)>>4)-1023,h=(a&15)*Math.pow(2,48)+u*Math.pow(2,40)+o*Math.pow(2,32)+s*Math.pow(2,24)+i*Math.pow(2,16)+r*Math.pow(2,8)+n;return l*(1+h*Math.pow(2,-52))*Math.pow(2,c)}function A(e,t){var n=e.charCodeAt(t)&255,r=e.charCodeAt(t+1)&255,i=e.charCodeAt(t+2)&255,s=e.charCodeAt(t+3)&255,o=1-2*(s>>7),u=((s&127)<<1)+((i&254)>>7)-127,a=(i&127)*Math.pow(2,16)+r*Math.pow(2,8)+n;return o*(1+a*Math.pow(2,-23))*Math.pow(2,u)}function O(e,t,n){var r=[];index=t;while(index<t+n){var i=e[index];if(i.charCodeAt(0)==0)break;r.push(i),index++}return r.join("")}function _(e){var t;if(!M)t=e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});else{function n(e,t,n){throw WebGLDebugUtils.glEnumToString(e)+" was caused by call to "+t}t=WebGLDebugUtils.makeDebugContext(e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),n)}return t}function D(e,t,n,r){var i=[e-n,t+r,e-n,t-r,e+n,t+r,e-n,t-r,e+n,t-r,e+n,t+r];return i}function P(e,t,n){var r;return arguments.length==2?r=[e.x,t.y,e.x,e.y,t.x,t.y,e.x,e.y,t.x,e.y,t.x,t.y]:r=[e.x,t.y,n,e.x,e.y,n,t.x,t.y,n,e.x,e.y,n,t.x,e.y,n,t.x,t.y,n],r}function H(e,t){if(!e)return null;var n=e.createProgram(),r=B(e,e.VERTEX_SHADER,t+"/vert.glsl"),i=B(e,e.FRAGMENT_SHADER,t+"/frag.glsl");return e.attachShader(n,r),e.attachShader(n,i),e.linkProgram(n),j(e,n,r,i),n}function B(e,t,n){var r=e.createShader(t);return $.ajax({async:!1,url:n,dataType:"text",success:function(t){e.shaderSource(r,t),e.compileShader(r);if(!e.getShaderParameter(r,e.COMPILE_STATUS))throw e.getShaderInfoLog(r);r.source=t},error:function(e){console.log("Could not load "+n)}}),r}function j(e,t,n,r){var i={},s={},o=(n.source+r.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg),u=0;e.useProgram(t);if(o){for(var a=0;a<o.length;a++){var f=o[a].split(" ");i[f[2]]={u:f[0],type:f[1],loc:null};if(f[0]=="uniform")i[f[2]].loc=e.getUniformLocation(t,f[2]);else{var l=e.getAttribLocation(t,f[2]);i[f[2]].loc=l}f[1]=="sampler2D"&&(i[f[2]].tex=u,u++)}t.get=function(e){return i[e].loc},t.data=function(t,n){var r=i[t];if(!r)throw"Could not find shader variable "+t;if(r.u=="uniform")if(r.type=="float")e.uniform1f(r.loc,n);else if(r.type=="vec2")e.uniform2fv(r.loc,n);else if(r.type=="ivec2")e.uniform2iv(r.loc,n);else if(r.type=="vec3")e.uniform3fv(r.loc,n);else if(r.type=="ivec3")e.uniform3iv(r.loc,n);else if(r.type=="vec4")e.uniform4fv(r.loc,n);else if(r.type=="ivec4")e.uniform4iv(r.loc,n);else if(r.type=="bool")e.uniform1i(r.loc,n);else if(r.type=="mat4")e.uniformMatrix4fv(r.loc,!1,n);else if(r.type=="mat3")e.uniformMatrix3fv(r.loc,!1,n);else if(r.type=="sampler2D")"texture"in n&&(n=n.texture()),e.activeTexture(e["TEXTURE"+r.tex]),e.bindTexture(e.TEXTURE_2D,n),e.uniform1i(r.loc,r.tex);else{if(r.type!="int")throw"Unsupported Type for Shader Helper: "+r.type;e.uniform1i(r.loc,n)}else{if(r.u!="attribute")throw"Type: "+r.u+" Recieved";e.enableVertexAttribArray(r.loc),e.bindBuffer(e.ARRAY_BUFFER,n),e.vertexAttribPointer(r.loc,n.itemSize,e.FLOAT,!1,0,0)}}}}function F(e,t,n,r){var i=e.createBuffer();i.itemSize=n,i.numItems=r;var s=new Float32Array(t.length*r*n);for(var o=0;o<r;o++)for(var u=0;u<t.length;u++)s[o*t.length+u]=t[u];return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),i}function I(e,t,n){var r=e.createBuffer(),i=new Float32Array(t);return e.bindBuffer(e.ARRAY_BUFFER,r),r.itemSize=n,r.numItems=t.length/n,e.bufferData(e.ARRAY_BUFFER,i,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),r}function q(e,t,n){var r=e.createBuffer(),i=0;for(var s=0;s<t.length;s++)i+=t[s].length;var o=new Float32Array(i),u=0;for(var s=0;s<t.length;s++)for(var a=0;a<t[s].length;a++)o[u]=t[s][a],u++;return e.bindBuffer(e.ARRAY_BUFFER,r),r.itemSize=n,r.numItems=i/n,e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),r}function R(e,t,n){if(!e)return null;var r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r);var i=new Float32Array(t*n);return r.itemSize=n,r.numItems=t,r.update=function(t,n){var i=new Float32Array(t);e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferSubData(e.ARRAY_BUFFER,4*n,i),e.bindBuffer(e.ARRAY_BUFFER,null)},e.bufferData(e.ARRAY_BUFFER,i,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),r}function U(e,t,n){var r=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r);var i=new Uint16Array(t);return r.itemSize=n,r.numItems=t/n,r.update=function(t,n){var i=new Uint16Array(t);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,2*n,i),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)},e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),r}function W(e,t,n){var r=e.createTexture();r.id=z,z++;var i=new Image;return i.onload=function(){e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),n&&n()},i.src=t,r}function X(e,t){var n=e.gl,r={},i;t?i=t:i=256;var s=0,o=function(e,t,n,r){e||console.log("ack"),n||(n=0),r||(r=t.length);for(var i=0;i<r;i++)e[n+i]=t[i]},u=function(e){var t=i;while(t<e)t*=2;i=t;for(name in r){var s=new Float32Array(t*r[name].len),u=r[name].array,a=R(n,i,r[name].len);o(s,u),r[name].array=s,r[name].buffer=a,r[name].dirty=!0}};this.create=function(e,t){if(!t)throw"Length of buffer must be a positive integer";var s=new Float32Array(i*t),o=R(n,i,t);r[e]={array:s,buffer:o,len:t,dirty:!1}},this.alloc=function(e){s+e>=i&&u(s+e);var t=s;return s+=e,t},this.get=function(e){return r[e].buffer},this.write=function(e,t,n,i){o(r[e].array,t,n*r[e].len,i*r[e].len),r[e].dirty=!0},this.repeat=function(e,t,n,i){for(var s=0;s<i;s++)o(r[e].array,t,(n+s)*r[e].len,r[e].len);r[e].dirty=!0},this.count=function(){return s},this.data=function(e){return r[e].array},this.update=function(){for(name in r)r[name].dirty&&(r[name].buffer&&r[name].buffer.update(r[name].array,0),r[name].dirty=!1,e.dirty=!0)}}function V(e,t){var n=e.gl,i=s(t);r(i,{mag_filter:n.LINEAR,min_filter:n.LINEAR,wrap_s:n.CLAMP_TO_EDGE,wrap_t:n.CLAMP_TO_EDGE,mipmap:!1});var o=n.createTexture(),u=null;this.image=function(t){u=t,n.bindTexture(n.TEXTURE_2D,o),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,u),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,i.mag_filter),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,i.min_filter),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,i.wrap_s),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i.wrap_t),i.mipmap&&n.generateMipmap(n.TEXTURE_2D),n.bindTexture(n.TEXTURE_2D,null),e.dirty=!0},this.texture=function(){return u?o:null}}function J(e,t){var n=new Image;n.crossOrigin="",n.onload=function(){t(n)},n.src=e}function Q(e,t){var n=e.canvas,r=this;t||(t={}),t.width&&!t.height?t.height=t.width:!t.width&&t.height&&(t.width=t.height);var i=t.preserveAspectRatio?n.height()/n.width():1;t.min?t.center=vect.add(t.min,(new vect(t.width,t.height*i)).scale(.5)):t.center||(t.center=new vect(0,0));var s=t.width,o=t.height,u=t.height/t.width,a=t.center.clone(),f=1;this.worldToPx=new Float32Array(9),this.pxToScreen=new Float32Array(9),this.worldToScreen=new Float32Array(9),this.mat3=this.worldToScreen,this.reconfigure=function(){var i=t.preserveAspectRatio?n.height()/n.width():1,u=o/s,l=t.xlock?1:f,c=t.ylock?1:f,h=(new vect(s/l,s*u*i/c)).scale(.5),p=vect.add(a,h),d=vect.sub(a,h),v=n.width(),m=n.height(),g=vect.sub(p,d),y=function(){r.worldToPx[0]=v/g.x,r.worldToPx[1]=0,r.worldToPx[2]=0,r.worldToPx[3]=0,r.worldToPx[4]=m/g.y,r.worldToPx[5]=0,r.worldToPx[6]=-(d.x*v)/g.x,r.worldToPx[7]=-(d.y*m)/g.y,r.worldToPx[8]=1},b=function(){r.pxToScreen[0]=2/v,r.pxToScreen[1]=0,r.pxToScreen[2]=0,r.pxToScreen[3]=0,r.pxToScreen[4]=2/m,r.pxToScreen[5]=0,r.pxToScreen[6]=-1,r.pxToScreen[7]=-1,r.pxToScreen[8]=1},w=function(){r.worldToScreen[0]=2/g.x,r.worldToScreen[1]=0,r.worldToScreen[2]=0,r.worldToScreen[3]=0,r.worldToScreen[4]=2/g.y,r.worldToScreen[5]=0,r.worldToScreen[6]=-2*d.x/g.x-1,r.worldToScreen[7]=-2*d.y/g.y-1,r.worldToScreen[8]=1};y(),b(),w(),e.dirty=!0},this.reconfigure(),this.project=function(e){var t=new vect(2*(e.x-n.offset().left)/n.width()-1,-(2*(e.y-n.offset().top)/n.height()-1));return t.x=t.x/this.mat3[0]-this.mat3[6]/this.mat3[0],t.y=t.y/this.mat3[4]-this.mat3[7]/this.mat3[4],t},this.screen=function(e){var t=new vect(e.x*this.mat3[0]+this.mat3[6],e.y*this.mat3[4]+this.mat3[7]);return t.x=n.offset().left+n.width()*(t.x+1)/2,t.y=n.offset().top+n.height()*(-t.y+1)/2,t},this.percent=function(e){return new vect(2*((e.x-n.offset().left)/n.width())-1,-(2*((e.y-n.offset().top)/n.height())-1))},this.pixel=function(e){return new vect(n.offset().left+(e.x+1)/2*n.width(),n.offset().top+(-e.y+1)/2*n.height())},this.move=function(e){a.add(e),this.reconfigure()},this.zoom=function(e){if(e===undefined)return f;f=e,this.reconfigure()},this.position=function(e,t){if(e===undefined)return a.clone();t===undefined?a=e.clone():a=new vect(e,t),this.reconfigure()},this.reset=function(){f=1,this.reconfigure()},n.resize(function(e){r.reconfigure()}),this.extents=function(e){s=e,o=e*u,f=1,this.reconfigure()},this.size=function(){var e=t.preserveAspectRatio?n.height()/n.width():1,r=o/s,i=t.xlock?1:f,u=t.ylock?1:f;return new vect(s/i,s*r*e/u)}}function G(e,n){var r=!1,i=new vect(0,0),s=new vect(0,0),o=null,u=0;e.canvas.mousedown(function(e){i=new vect(e.clientX,e.clientY),r=!0}),$(window).bind("mouseup",function(){r=!1}),$(document).bind("keypress","+",function(t){e.camera.zoom(1.1)}),$(document).bind("keypress","-",function(t){e.camera.zoom(10/11)}),$(document).bind("keypress","0",function(t){e.camera.reset()}),e.canvas.bind("mousewheel",function(t,n){n*=.5,n<0?(n*=-1,n+=1,n=1/n):n+=1;var r=e.camera.zoom();e.camera.zoom(r*n),f(),t.preventDefault()});var a=!0;this.disable=function(){a=!1},this.enable=function(){a=!0},this.update=function(n){s=new vect(t.x,t.y);var l=!1,c;if(r&&a){var h=vect.sub(e.camera.project(i),e.camera.project(s)),p=e.camera.position();c=vect.add(p,h),e.camera.position(c),i=s,u=h.length()/n,o=h,o.normalize(),l=!0}else if(u>.01&&o){var h=vect.scale(o,u*n),p=e.camera.position();c=vect.add(p,h),e.camera.position(c),u-=3*n*u,l=!0}l&&f()};var f=function(){if(n.worldMin&&n.worldMax){var t=e.camera.position(),r=e.camera.size(),i=n.worldMax.x-n.worldMin.x;if(r.x>i){var s=r.x*e.camera.zoom();e.camera.zoom(i/s)}t=e.camera.position(),r=e.camera.size();var o=n.worldMax.y-n.worldMin.y;if(r.y>o){var u=r.y*e.camera.zoom();e.camera.zoom(o/u)}}var t=e.camera.position(),a=e.camera.size().scale(.5),f=!1;n.worldMin&&(t.x-a.x<n.worldMin.x&&(t.x=n.worldMin.x+a.x),t.y-a.y<n.worldMin.y&&(t.y=n.worldMin.y+a.y),f=!0),n.worldMax&&(t.x+a.x>n.worldMax.x&&(t.x=n.worldMax.x-a.x),t.y+a.y>n.worldMax.y&&(t.y=n.worldMax.y-a.y),f=!0),f&&e.camera.position(t)}}function et(e,t,n,r,i){Z||(Z=H(BASE_DIR+"shaders/basic"));var s=[],o=[];if(!i){var u=Math.abs((r.x-n.x)/t.length),a=Math.abs(r.y-n.y);for(var f=0;f<t.length;f++){var l=new vect(n.x+u*f,n.y),c=new vect(n.x+u*(f+1),r.y);o.push.apply(o,P(e.camera.percent(l),e.camera.percent(c)));for(var h=0;h<6;h++)s.push.apply(s,t[f].vect())}}else{var u=Math.abs(r.x-n.x),a=Math.abs((r.y-n.y)/t.length);for(var f=0;f<t.length;f++){var p=t.length-1-f,l=new vect(n.x,n.y+a*(p+1)),c=new vect(r.x,n.y-a*p);console.log("box",l,c),o.push.apply(o,P(e.camera.percent(l),e.camera.percent(c)));for(var h=0;h<6;h++)s.push.apply(s,t[f].vect())}}var d=I(o,2),v=I(s,4);this.update=function(e,t){},this.draw=function(e,t,n){if(n)return;gl.useProgram(Z),Z.data("pos",d),Z.data("color_in",v),gl.drawArrays(gl.TRIANGLES,0,d.numItems)}}function rt(e,t){this.style_map={},this.geom=e;var n={};this.updateMany=function(e){for(var t in e)this.updateOne(t,e[value])},this.updateOne=function(e,t){if(t===undefined)throw"No value for style defined";if(n[e]==t)return;n[e]=t,e in this.style_map&&this.style_map[e](t)},this.updateDefault=function(e){var n=t(e);this.updateOne(e,n)},this.update=function(e,t){typeof e=="string"?t===undefined?this.updateDefault(e):this.updateOne(e,t):this.updateMany(e)},this.keys=function(){var e={};for(key in this.style_map)e[key]=!0;return e},this.updateAll=function(){for(var e in this.style_map)this.updateDefault(e)}}function it(e){var t=this;this.engine=e,this.views=[],this.update=function(e){for(var t=0;t<views.length;t++)this.views[t].update(e)},this.View=function(){throw"Attempt to call abstract function"},this.create=function(e,t){var n=new this.View(e,t);return this.views.push(n),n.updateAll(),n},this.draw=function(){throw"Attempt to call abstract function"}}function ut(e,t){it.call(this,e,t),e.shaders.point||(e.shaders.point=H(e.gl,BASE_DIR+"shaders/point"));var n=e.shaders.point,r=10,i=new X(e,st);i.create("vert",2),i.create("unit",2),i.create("stroke_width",1),i.create("rad",1),i.create("fill_color",3),i.create("fill",1),i.create("stroke_color",3),i.create("stroke",1),i.create("alpha",1);var s=function(e,t){rt.call(this,e,t);var n,s;this.style_map={fill:function(e){e=="none"?i.repeat("fill",[-0.75],n,s):(i.repeat("fill",[.75],n,s),i.repeat("fill_color",e.array,n,s))},opacity:function(e){i.repeat("alpha",[e],n,s)},radius:function(e){e>r&&(r=e),i.repeat("rad",[e],n,s)},stroke:function(e){e=="none"?i.repeat("stroke",[-0.75],n,s):(i.repeat("stroke",[.75],n,s),i.repeat("stroke_color",e.array,n,s))},"stroke-width":function(e){i.repeat("stroke_width",[e],n,s)}};var o=e.length;s=6*o,n=i.alloc(s),$.each(e,function(e,t){i.repeat("vert",t,n+e*6,6),i.write("unit",ot,n+e*6,6)})};this.View=s,this.update=function(){i.update()},this.draw=function(){var t=e.gl;t.useProgram(n),n.data("screen",e.camera.mat3),n.data("pos",i.get("vert")),n.data("circle_in",i.get("unit")),n.data("color_in",i.get("fill_color")),n.data("stroke_color_in",i.get("stroke_color")),n.data("alpha_in",i.get("alpha")),n.data("fill_in",i.get("fill")),n.data("stroke_in",i.get("stroke")),n.data("aspect",e.canvas.width()/e.canvas.height()),n.data("pix_w",2/e.canvas.width()),n.data("rad",i.get("rad")),n.data("stroke_width_in",i.get("stroke_width")),n.data("max_rad",r),t.drawArrays(t.TRIANGLES,0,i.count())}}function ft(e,t){var n=6*t.length,r=e.alloc(n),i=[-1,1,-1,-1,1,-1,-1,1,1,-1,1,1],s=0,o=function(){if(t[s]){var e=new vect(t[s][0],t[s][1]);return s++,e}return null},u=null,a=o(),f=o(),l=[],c=[],h=[];while(a)l.push(u||vect.add(a,vect.sub(a,f))),c.push(a),h.push(f||vect.add(a,vect.sub(a,u))),u=a,a=f,f=o();var p=[],d=[],v=[];currentIndex=r;var m=function(t,n,r){e.write("prev",t.array(),currentIndex,1),e.write("current",n.array(),currentIndex,1),e.write("next",r.array(),currentIndex,1),currentIndex++};for(var g=1;g<t.length;g++)e.write("unit",i,currentIndex,6),m(l[g-1],c[g-1],h[g-1]),m(h[g-1],c[g-1],l[g-1]),m(h[g],c[g],l[g]),m(l[g-1],c[g-1],h[g-1]),m(h[g],c[g],l[g]),m(l[g],c[g],h[g]);return n}function lt(e){it.call(this,e),e.shaders.line||(e.shaders.line=H(e.gl,BASE_DIR+"shaders/line"));var t=e.shaders.line,n=new X(e,1024);n.create("prev",2),n.create("current",2),n.create("next",2),n.create("unit",2),n.create("width",1),n.create("color",3),n.create("alpha",1);var r=function(e,t){rt.call(this,e,t);var r=n.count(),i=0;this.style_map={stroke:function(e){n.repeat("color",e.array,r,i)},"stroke-opacity":function(e){n.repeat("alpha",[e],r,i)},"stroke-width":function(e){n.repeat("width",[e],r,i)}};var s=function(e,t){return e[0]==t[0]&&e[1]==t[1]};$.each(e,function(e,t){for(var e=0;e<t.length;e++)i+=ft(n,t[e])})};this.View=r,this.update=function(){n.update()},this.draw=function(){var r=e.gl;n.update(),r.useProgram(t),t.data("world",e.camera.worldToPx),t.data("screen",e.camera.pxToScreen),t.data("prev",n.get("prev")),t.data("current",n.get("current")),t.data("next",n.get("next")),t.data("color_in",n.get("color")),t.data("alpha_in",n.get("alpha")),t.data("circle_in",n.get("unit")),t.data("width",n.get("width")),t.data("px_w",2/e.canvas.width()),t.data("px_h",2/e.canvas.height()),r.drawArrays(r.TRIANGLES,0,n.count())}}function ht(e){it.call(this,e),e.shaders.polygon||(e.shaders.polygon=H(e.gl,BASE_DIR+"shaders/poly"));var t=e.shaders.polygon,n=new X(e,ct);n.create("vert",2),n.create("color",3),n.create("alpha",1);var r=function(e,t){rt.call(this,e,t);var r,i;this.style_map={fill:function(e){n.repeat("color",e.array,r,i)},"fill-opacity":function(e){n.repeat("alpha",[e],r,i)}};var s=[];i=0,$.each(e,function(e,t){var n,r=0;while(r<100)try{n=Tt(t);break}catch(o){r++}r==100&&(console.log("Rendering Polygon Failed: Skipping Interior"),n=[]),i+=n.length/2,s.push(n)}),r=n.alloc(i);var o=r;$.each(s,function(e,t){var r=t.length/2;n.write("vert",t,o,r),o+=r})};this.View=r,this.update=function(e){n.update()},this.draw=function(){var r=e.gl;n.update(),r.useProgram(t),t.data("screen",e.camera.mat3),t.data("pos",n.get("vert")),t.data("color_in",n.get("color")),t.data("alpha_in",n.get("alpha")),r.drawArrays(r.TRIANGLES,0,n.count())}}function pt(e,t,n){lt.call(this,e,t,n);var r=n.order;this.View=function(e){var t=[],n=[];for(var i=0;i<r.length;i++){var s=e.attr(r[i]);isNaN(s)?n.length>0&&(t.push(n),n=[]):n.push([i,s])}n.length>0&&t.push(n);var o=[t];return o}}function dt(e){return function(t,n,r){var i=[],s=function(e){this.update=function(t,n){$.each(e,function(e,r){r.update(t,n)})},this.keys=function(){var t={};return $.each(e,function(e,n){for(key in n.style_map)t[key]=!0}),t}};$.each(e,function(e,s){i.push(new s(t,n,r))}),this.views=[],this.create=function(e,t){var n=[];return $.each(i,function(r,i){n.push(i.create(e,t))}),new s(n)},this.update=function(){$.each(i,function(e,t){t.update()})},this.draw=function(){$.each(i,function(e,t){t.draw()})}}}function bt(e,t,n){var r=this;Y.manage(t),Y.linkParent(e,t),this.renderers={},this.views={};var i=function(n,i){var s=K.derivedStyle(n,t,e,i);r.views[n.id].update(i,s)};t.features().each(function(s,o){var u;o.type in e.Renderers?u=o.type:u="default",u in r.renderers||(r.renderers[u]=new e.Renderers[u](e,t,n));var a=r.renderers[u].create(n.geomFunc(o),function(n){return function(r){return K.derivedStyle(n,t,e,r)}}(o));r.views[o.id]=a,Y.linkParent(t,o),Y.addEventHandler(o,"style",i)}),this.update=function(e,t){for(var n in this.renderers)this.renderers[n].update(t)},this.draw=function(e,t){for(var n in this.renderers)this.renderers[n].draw(t)}}function wt(e,n){var i=this;r(n,{background:new h(0,0,0,1)}),this.type="Engine",this.id=Vt(),this.canvas=$("<canvas></canvas>").attr("id","viewer");var s=null;e?($(e).append(this.canvas),this.canvas.attr("width",$(e).width()),this.canvas.attr("height",$(e).height())):(e=window,$("body").append(this.canvas),this.canvas.attr("width",$(e).width()),this.canvas.attr("height",$(e).height()),$(window).resize(function(e){i.resize()}));var o=[];this.resize=function(){this.canvas.attr("width",$(e).width()),this.canvas.attr("height",$(e).height()),s.viewport(0,0,this.canvas.width(),this.canvas.height()),this.camera.reconfigure();for(var t=0;t<o.length;t++)o[t].resize()},s=_(this.canvas,M),this.gl=s,s.viewport(0,0,this.canvas.width(),this.canvas.height()),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),s.enable(s.BLEND),this.camera=new Q(i,n),this.scroller=new G(this,n),this.extents=function(e){this.camera.extents(e)},this.center=function(e,t){t===undefined?this.camera.position(e):this.camera.position(new vect(e,t))},this.pxW=1/this.canvas.attr("width"),this.pxH=1/this.canvas.attr("height"),this.Renderers={},this.Queriers={},this.renderers={},this.views={},this.styles={},this.dirty=!0,this.defaultStyle=function(e,t){var n;e in this.styles&&(n=this.styles[e][t]);if(n===null||n===undefined)n=this.styles["default"][t];return n===null||n===undefined?null:n},Y.manage(this),this.search=function(e,t){return this.queriers[e.id].boxSearch(t)},this.style=function(e,t,n){this.styles[e.id]===undefined&&(this.styles[e.id]={});if(n===undefined)return this.styles[e.id][t]!==undefined?this.styles[e.id][t]:null;this.styles[e.id][t]=n,e.id in this.views?this.views[e.id].update(t):e.id in this.renderers&&$.each(this.renderers[e.id],function(e,t){t.update()})};var u=new xt(this);this.select=function(e){u.select(e)};var a=!1;this.enableSelect=function(){this.scroller.disable(),u.enable(),a=!0},this.disableSelect=function(){this.scroller.enable(),u.disable(),a=!1};var f=(new Date).getTime(),l=[],c=function(e){return function(){e.draw()}}(this);this.shaders={},this.scene=[],this.queriers={};var p=0,d=0;this.update=function(){var e=(new Date).getTime(),n=(e-f)/1e3;l.length>=60&&l.splice(0,1),l.push(n);var r=0;for(var s=0;s<l.length;s++)r+=l[s];r/=l.length,$("#fps").text(Math.floor(1/r)),f=e,this.scroller.update(n);if(t.lastMove>d){var o=vect(t.x,t.y),u=!1;$.each(this.queriers,function(e,t){var n=t.pointSearch(o);if(n)return Y.mouseOver(n),u=!0,!1}),u||Y.mouseOver(null)}d=t.lastMove,$.each(this.scene,function(e,t){t.update&&t.update(i,n)})},this.draw=function(){this.update(),this.dirty&&(s.clearColor(n.background.r,n.background.g,n.background.b,n.background.a),s.clear(s.COLOR_BUFFER_BIT),s.clearDepth(0),$.each(this.scene,function(e,t){t.draw(i)}),a&&u.draw(this)),this.dirty=!1,requestAnimationFrame(c)},this.enableZ=function(){s.depthFunc(s.LEQUAL),s.enable(s.DEPTH_TEST)},this.disableZ=function(){s.disable(s.DEPTH_TEST)},this.canvas.mouseout(function(){Y.mouseOver(null)}),requestAnimationFrame(c)}function St(e,t,n){var i=this;n===undefined&&(n={}),n.order||(n.order=t.numeric(),n.order.sort());var s=function(e,t){var n,r;return e.min<t.min?n=e.min:n=t.min,e.max>t.max?r=e.max:r=t.max,{min:n,max:r}},o=t.features(),u=null;$.each(n.order,function(e,t){var n=o.range(t);u?u=s(u,n):u=n}),r(n,{range:{min:u.min,max:u.max},domain:{min:0,max:n.order.length-1},min:new vect(0,u.min),width:n.order.length-1,height:u.max-u.min,worldMin:new vect(0,u.min),worldMax:new vect(n.order.length-1,u.max),xlock:!1,ylock:!1});var a=n.order;n.geomFunc=function(e){var t=[],n=[];for(var r=0;r<a.length;r++){var i=e.attr(a[r]);isNaN(i)?n.length>0&&(t.push(n),n=[]):n.push([r,i])}n.length>0&&t.push(n);var s=[t];return s},wt.call(this,e,n),this.styles={"default":{fill:new h(.02,.44,.69,1),"fill-opacity":.5,stroke:new h(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":2}},this.Renderers={"default":lt},this.Queriers={"*":yt};var f={stroke:new h(.25,.25,.25,1),"stroke-width":.75,"stroke-opacity":1},l=function(e){return f[e]},c=function(){var e=new lt(i);$.each(n.order,function(t,r){var i=[[[[t,n.range.min],[t,n.range.max]]]];e.create(i,l)});var t=[[[[n.domain.min,n.range.min],[n.domain.max,n.range.min],[n.domain.max,n.range.max],[n.domain.min,n.range.max],[n.domain.min,n.range.min]]]];e.create(t,l),i.scene.push(e);if(n.ticks){var r=0;while(r>n.range.min)r-=n.ticks;while(r<n.range.max){var s=[[[[n.domain.min,r],[n.domain.max,r]]]];e.create(s,l),r+=n.ticks}}};c(),this.scene.push(new bt(i,t,n)),this.queriers[t.id]=new vt(this,t,n)}function xt(e){var t=H(e.gl,BASE_DIR+"shaders/selbox"),n=!1,r=!1,i=null,s=null,o=R(e.gl,6,2),u=I(e.gl,D(0,0,1,1),2),a=function(){o.update(P(i,s),0),e.dirty=!0};e.canvas.bind("mousedown",function(t){if(!n)return;r=!0,show=!0,i=e.camera.percent(new vect(t.clientX,t.clientY)),s=i,a()});var f=function(){};this.select=function(e){f=e},$(document).bind("mouseup",function(t){if(!n)return;if(!r)return;var o=e.camera.project(e.camera.pixel(i)),u=e.camera.project(e.camera.pixel(s));if(o.x>u.x){var a=o.x;o.x=u.x,u.x=a}if(o.y>u.y){var a=o.y;o.y=u.y,u.y=a}r=!1,f(new Ft(o,u)),e.dirty=!0}),$(document).bind("click",function(e){if(!n)return;show=!1}),$(document).bind("mousemove",function(t){if(!n)return;r&&(s=e.camera.percent(new vect(t.clientX,t.clientY)),a())}),this.enable=function(){n=!0},this.disable=function(){n=!1},this.draw=function(e,n){var i=e.gl;r&&(i.useProgram(t),t.data("pos",o),t.data("edge_in",u),i.drawArrays(i.TRIANGLES,0,o.numItems))}}function Nt(e,t){while(e>=t)e-=t;while(e<0)e+=t;return e}function Ct(e,t,n,r){this.current=e,this.upper=t,this.lower=n,this.index=r}function kt(e,t,n){var r=e.length-1,i=0,s=parseInt((e.length-1)/2);if(e.length==0)return 0;for(;;){if(r<0||i>=e.length)throw console.log(r,i,s,e.length),"Index Out of Bounds";if(e[s]==n)return s;if(r==i)return t[e[s]].x>t[n].x?s:s+1;if(t[e[s]].x>t[n].x)r=s;else if(t[e[s]].x<t[n].x)i=s+1;else if(t[e[s]].y>t[n].y){if(i==s)return i;r=s-1}else{if(r==s)return s;i=s+1}s=parseInt((r+i)/2)}}function Lt(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return!0;return!1}function At(e,t,n){if(t==undefined)throw"whoa";if(e[t+1].y-e[t].y==0)return Math.min(e[t].x,e[t+1].x);var r=(n-e[t].y)/(e[t+1].y-e[t].y);return e[t].x+(e[t+1].x-e[t].x)*r}function Ot(e,t){for(var n=0;n<e.length;n++)if(e[n]==t)return n;return!1}function Mt(e,t,n,r){for(var i=0;i<e.length;i++){var s=At(t,e[i],r);if(s>n)return i;if(s-n==0&&t[e[i]].y>t[index].y)return i}return e.length}function _t(e,t,n){return new vect(At(t,n,t[e].y),t[e].y)}function Dt(e,t){if(!t)throw"eek";e.push(t.x),e.push(t.y)}function Pt(e,t,n){if(!t||!n||n.length+t.length!=3&&n.length+t.length!=4)throw"ahh";if(t.length+n.length==3){for(var r=0;r<t.length;r++)Dt(e,t[r]);for(var r=0;r<n.length;r++)Dt(e,n[r])}else{if(t[1].x<t[0].x){var i=t[0];t[0]=t[1],t[1]=i}if(n[1].x<n[0].x){var i=n[0];n[0]=n[1],n[1]=i}Dt(e,t[0]),Dt(e,t[1]),Dt(e,n[1]),Dt(e,n[0]),Dt(e,n[1]),Dt(e,t[0])}}function Ht(e){var t=[],n=0,r=[];for(var i=0;i<e.length;i++){for(var s=0;s<e[i].length-1;s++){var o=Nt(s+1,e[i].length-1),u=Nt(s-1,e[i].length-1);t.push(new Ct(s+n,o+n,u+n,i)),r.push(e[i][s])}r.push(e[i][0]),n+=e[i].length}t.sort(function(e,t){return r[e.current].y-r[t.current].y});var a=[],f=[],l=new vect(-200,0),c=new vect(200,0),n=0,h=[],p=0,d=[];for(var s=0;s<t.length;s++){var v=t[s],m=Lt(a,v.lower),g=Lt(a,v.current),y,b;m&&!g?(y=Ot(a,v.lower),b=y):g&&!m?(b=Ot(a,v.current),y=b):m&&g?(y=Ot(a,v.lower),b=Ot(a,v.current)):!m&&!g&&(b=Mt(a,r,r[v.current].x,r[v.current].y),y=b);if(Math.abs(y-b)>1){for(var o=0;o<a.length;o++);throw"Bad"}var w=vect.left(r[v.lower],r[v.current],r[v.upper]),E=Math.floor(Math.min(y,b)/2);!w&&!m&&!g?(Pt(d,f[E],[_t(v.current,r,a[b-1]),_t(v.current,r,a[b])]),f.splice(E,1,[_t(v.current,r,a[b-1]),r[v.current]],[r[v.current],_t(v.current,r,a[y])])):w&&!m&&!g?f.splice(E,0,[r[v.current]]):m&&!g?(Pt(d,f[E],[_t(v.current,r,a[Math.max(y,b)-1]),r[v.current]]),f[E]=[_t(v.current,r,a[Math.min(y,b)-1]),r[v.current]]):!m&&g?(Pt(d,f[E],[r[v.current],_t(v.current,r,a[Math.min(b,y)+1])]),f[E]=[r[v.current],_t(v.current,r,a[Math.max(b,y)+1])]):!w&&m&&g?(Pt(d,f[E],[_t(v.current,r,a[Math.min(y,b)-1]),r[v.current]]),Pt(d,f[E+1],[_t(v.current,r,a[Math.max(y,b)+1]),r[v.current]]),f.splice(E,2,[_t(v.current,r,a[Math.min(y,b)-1]),_t(v.current,r,a[Math.max(y,b)+1])])):w&&m&&g&&(Pt(d,f[E],[r[v.current]]),f.splice(E,1)),m&&!g?a[y]=v.current:g&&!m?a[b]=v.lower:m&&g?(a.splice(Ot(a,v.lower),1),a.splice(Ot(a,v.current),1)):!m&&!g&&(w?a.splice(y,0,v.lower,v.current):a.splice(y,0,v.current,v.lower));for(var o=0;o<a.length-1;o++)if(At(r,a[o],r[v.current].y)>At(r,a[o+1],r[v.current].y))throw console.log("Misplaced Sweep"),"Misplace!"}if(a.length>0)throw console.log(a),"Bad "+a.length;if(h.length>0)throw console.log(h),"Wrong";return d}function Bt(e,t,n,r){this.bounds=t,this.feature=e,this.first=null,this.second=null,this.dist=function(e){return vect.dist(this.bounds.centroid(),e.bounds.centroid())},this.join=function(e){return new Bt(null,this.bounds.union(e.bounds),this,e)}}function jt(e){var t=[];for(var n in e){var r=new Bt(e[n],e[n].bounds,null,null);t.push(r)}var i=function(){var e=Infinity,n=-1,r=-1;for(var i=0;i<t.length;i++)for(var s=0;s<i;s++){var o=t[i].dist(t[s]);o<e&&(e=o,n=i,r=s)}var u=t[n].join(t[r]);t.splice(n,1),t.splice(r,1),t.push(u)};while(t.length>2)i();console.log(t[0])}function Ft(e,t){this.min=e.clone(),this.max=t.clone(),this.contains=function(n){return e.x<=n.x&&t.x>=n.x&&e.y<=n.y&&t.y>=n.y},this.x_in=function(n){return e.x<=n.x&&t.x>=n.x},this.x_left=function(t){return e.x>=t.x},this.x_right=function(e){return t.x<=e.x},this.y_in=function(n){return e.y<=n.y&&t.y>=n.y},this.y_left=function(t){return e.y>=t.y},this.y_right=function(e){return t.y<=e.y},this.area=
function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)},this.height=function(){return this.max.y-this.min.y},this.width=function(){return this.max.x-this.min.x},this.vertex=function(e){switch(e){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);default:throw"Index out of bounds: "+e}},this.intersects=function(e){for(var t=0;t<4;t++)for(var n=0;n<4;n++)if(vect.intersects(this.vertex(t),this.vertex((t+1)%4),e.vertex(n),e.vertex((n+1)%4)))return!0;return this.contains(e.min)&&this.contains(e.max)&&this.contains(new vect(e.min.x,e.max.y))&&this.contains(new vect(e.max.x,e.min.y))?!0:e.contains(this.min)&&e.contains(this.max)&&e.contains(new vect(this.min.x,this.max.y))&&e.contains(new vect(this.max.x,this.min.y))?!0:!1},this.union=function(e){this.min.x=Math.min(this.min.x,e.min.x),this.min.y=Math.min(this.min.y,e.min.y),this.max.x=Math.max(this.max.x,e.max.x),this.max.y=Math.max(this.max.y,e.max.y)},this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)},this.clone=function(){return new Ft(e,t)}}function It(e,t,n,r){this.data=e[r],this.left=null,this.right=null,t!=r&&(this.left=new It(e,t,r-1,parseInt((t+(r-1))/2))),n!=r&&(this.right=new It(e,r+1,n,parseInt((n+(r+1))/2))),this.subtree=[];for(var i=t;i<=n;i++)this.subtree.push(e[i]);this.subtree.sort(function(e,t){return e.y-t.y});var s=function(r){return r.x_in(e[t])&&r.x_in(e[n])};this.yrange=function(e,t,n){return e.y_in(this.subtree[t])&&e.y_in(this.subtree[n])},this.subquery=function(e,t,n,r,i){if(this.yrange(t,n,r)){for(var s=n;s<=r;s++)e.push(this.subtree[s]);return}t.y_in(this.subtree[i])&&e.push(this.subtree[i]),t.y_left(this.subtree[i])?i!=r&&this.subquery(e,t,i+1,r,parseInt((r+(i+1))/2)):t.x_right(this.subtree[i])?i!=n&&this.subquery(e,t,n,i-1,parseInt((n+(i-1))/2)):(i!=r&&this.subquery(e,t,i+1,r,parseInt((r+(i+1))/2)),i!=n&&this.subquery(e,t,n,i-1,parseInt((n+(i-1))/2)))},this.search=function(e,t){if(s(t)){this.subquery(e,t,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2));return}t.contains(this.data)&&e.push(this.data),t.x_left(this.data)?this.right&&this.right.search(e,t):t.x_right(this.data)?this.left&&this.left.search(e,t):(this.left&&this.left.search(e,t),this.right&&this.right.search(e,t))}}function qt(e){e.sort(function(e,t){return e.x-t.x}),e.length>0?this.root=new It(e,0,e.length-1,parseInt((e.length-1)/2)):this.root==null,this.search=function(e){if(!this.root)return[];var t=e.clone(),n=[];return this.root.search(n,t),n}}function Qt(e,t){Wt.call(this,e,t),this.bounds=Yt(this.geom),this.map_contains=function(e,t){return this.contains(e.camera.project(t))},this.contains=function(e){var t=0,n=[],r=this;if(r.bounds.contains(e)){t++;for(var i=0;i<r.geom.length;i++){var s=r.geom[i],o=0;$.each(s,function(t,n){for(var r=0;r<n.length;r++){var i=(r+1)%n.length;if((e.y-n[r][1])/(e.y-n[i][1])<0){var s=new vect(720,e.y),u=new vect(n[r][0],n[r][1]),a=new vect(n[i][0],n[i][1]);vect.intersects(e,s,u,a)&&o++}}});if(o%2==1)return!0}}return!1}}function Gt(e){var t=[];for(var n=0;n<e.length;n++)$.each(e[n].geom,function(r,i){$.each(i,function(r,i){$.each(i,function(r,i){t.push({ref:e[n],x:i[0],y:i[1]})})})});tree=new qt(t),this.search=function(t){var n=tree.search(t),r={};$.each(n,function(e,t){r[t.ref.id]=t.ref});for(var i=0;i<e.length;i++)for(var s=0;s<4;s++)e[i].contains(t.vertex(s))&&(r[e[i].id]=e[i]);var o=[];for(var u in r)o.push(r[u]);return new ln(o)},this.map_contains=function(e,t){return this.contains(e.camera.project(t))},this.contains=function(t){var n=[];for(var r=0;r<e.length;r++)e[r].contains(t)&&n.push(e[r]);return new ln(n)}}function Yt(e){var t=new vect(Infinity,Infinity),n=new vect(-Infinity,-Infinity);return $.each(e,function(e,r){$.each(r,function(e,r){$.each(r,function(e,r){r[0]<t.x&&(t.x=r[0]),r[0]>n.x&&(n.x=r[0]),r[1]<t.y&&(t.y=r[1]),r[1]>n.y&&(n.y=r[1])})})}),new Ft(t,n)}function Zt(t,n){var r=6*n.length,i=t.alloc(r),s=[new vect(1,1),new vect(1,-1),new vect(-1,-1),new vect(-1,1)],o=0,u=function(){if(n[o]){var e=new vect(n[o][0],n[o][1]);return o++,e}return null},a=u(),f=u(),l=u(),c=function(t,n){var r=vect.dir(t,n);return r.rotate(e/2)},h=function(e,t,n){var r=c(e,t),i=c(t,n),s=vect.add(e,r),o=vect.add(t,r),u=vect.add(t,i),a=vect.add(n,i),f=vect.intersect2dpos(s,o,u,a);return f==Infinity?vect.add(t,r):f},p=vect.dir(a,f).rotate(-e/2),d=vect.dir(a,f).rotate(e/2),v,m,g=function(e,t,n,r,i){e.push(t.x),e.push(t.y),e.push(n.x),e.push(n.y),e.push(r.x),e.push(r.y),e.push(t.x),e.push(t.y),e.push(r.x),e.push(r.y),e.push(i.x),e.push(i.y)},y=[],b=[],w=[];while(f)l?(v=vect.sub(h(a,f,l),f),m=vect.sub(h(l,f,a),f)):(v=vect.dir(a,f).rotate(e/2),m=vect.dir(a,f).rotate(-e/2)),g(y,a,a,f,f),g(b,p,d,v,m),g(w,s[0],s[1],s[2],s[3]),p=m,d=v,a=f,f=l,l=u();return t.write("vert",y,i,r),t.write("norm",b,i,r),t.write("unit",w,i,r),i}function en(t,n){var r=6*n.length,i=t.alloc(r),s=0,o=function(){if(n[s]){var e=new vect(n[s][0],n[s][1]);return s++,e}return null},u=[new vect(1,1),new vect(1,-1),new vect(-1,-1),new vect(-1,1)],a=[],f=[],l=[],l=[-1,0,1,0,-1,-1,1,-1,-1,-1,1,0],c=function(e,t,n,r){r?(e[n]=-t.x,e[n+1]=-t.y):(e[n]=t.x,e[n+1]=t.y)},h=function(e,t,n,r){c(e,t,0,!1),c(e,n,2,!1),c(e,t,4,r),c(e,n,6,r),c(e,t,8,r),c(e,n,10,!1)},p=o(),d=o(),v=o(),m=vect.dir(p,d).rotate(e/2),g,y=i;while(d){if(v){var b=vect.dir(v,d),w=vect.dir(d,p);g=vect.sub(b,w).scale(.5).normalize()}else g=vect.dir(p,d).rotate(e/2);h(a,p,d,!1),h(f,m,g,!0),t.write("vert",a,y,6),t.write("norm",f,y,6),t.write("unit",l,y,6),y+=6,p=d,d=v,v=o(),m=g}return i}function tn(e,t){Wt.call(this,e,t),this.bounds=Yt(this.geom),this.map_contains=function(e,t){return!1}}function nn(e){this.search=function(e){return new ln([])},this.map_contains=function(e,t){return new ln([])},this.contains=function(e){return new ln([])}}function sn(e){e||(e={}),this.id=Vt(),this.type="Layer";var t={},n={};if(e.style)throw"Not Implemeneted";this.style=function(e,t,n){var r,i,s;return!e||e.type=="Engine"?(r=e,i=t,s=n):(r=null,i=e,s=t),s===undefined?K.getStyle(this,r,i):(K.setStyle(this,r,i,s),this)},this.bounds=null,this.features=function(){var e=[];for(var t in n)e.push(n[t]);return new ln(e)};var r={};this.properties=function(){var e=[];for(var t in r)e.push(t);return e},this.numeric=function(){var e=[];for(var t in r)r[t]&&e.push(t);return e};var i={};this.attr=function(e,t){if(arguments.length<2)return i[e]!==undefined?i[e]:null;i[e]=t},this.fixed=!1,this.append=function(e){if(this.fixed)throw"Layers are currently immutable once added to a map";var t=new rn[e.type](e,this);n[t.id]=t,this.bounds?this.bounds.union(t.bounds):this.bounds=t.bounds.clone();for(var i in e.attr)r[i]===undefined?isNaN(e.attr[i])?r[i]=!1:r[i]=!0:!isNaN(e.attr[i])&&r[i]?r[i]=!0:r[i]=!1;return dirty=!0,t},this.mouseover=function(e){Y.addEventHandler(this,"mouseover",e)},this.mouseout=function(e){Y.addEventHandler(this,"mouseout",e)}}function un(e){on||(on=H(engine.gl,BASE_DIR+"shaders/grid")),e||(e={}),e.style||(e.style={});var t=e.lower,n=e.upper,r=e.rows,i=e.cols,s=(n.x-t.x)/i,o=(n.y-t.y)/r,u=new Float32Array(r*i),a=new Uint8Array(i*r*4),f=!1,l=function(e,t){a[e*4]=parseInt(t.r*255),a[e*4+1]=parseInt(t.g*255),a[e*4+2]=parseInt(t.b*255),a[e*4+3]=parseInt(t.a*255)},c=new X(engine,6);c.create("vert",2),c.create("screen",2),c.create("tex",2);var h=new vect(t.x,t.y),p=new vect(n.x,n.y),d=new vect(0,0),v=new vect(1,1),m=c.alloc(6);c.write("vert",P(h,p),m,6),c.write("screen",P(new vect(-1,-1),new vect(1,1)),m,6),c.write("tex",P(d,v),m,6);var g=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,g),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var y=function(e,t){return i*e+t};this.lower=function(){return t.clone()},this.upper=function(){return n.clone()},this.rows=function(){return r},this.cols=function(){return i},this.centroid=function(e,n){return new vect(t.x+s*n+s/2,t.y+o*e+o/2)},this.get=function(e,t){return u[y(e,t)]};var b=-Infinity,w=Infinity,E={};this.qunatiles=function(e,t){t||(t=function(e,t){return e-t});var n=[];for(var r=0;r<u.length;r++)n.push(u[r]);n.sort(t);var i=[-Infinity];for(var r=1;r<e;r++){var s=parseInt(inc*r);i.push(n[s])}return i.push(Infinity),i},this.set=function(e,t,n){if(e>=r||t>=i)throw"Index Out of Bounds";var s=y(e,t);u[s]=n,f=!0},this.raw_set=function(e,t){if(e>=r*i)throw"Index Out of Bounds: "+e;u[e]=t,f=!0},this.clear=function(e){for(var t=0;t<r*i;t++)u[t]=e},this.initialize=function(){};var S=null;this.draw=function(t,n){S||(S=t.framebuffer()),c.update();if(f){b=-Infinity,w=Infinity;for(var s=0;s<r*i;s++){var o=u[s];o>b&&(b=o),o<w&&(w=o)}for(var s=0;s<r*i;s++)l(s,e.map(w,b,u[s]));gl.bindTexture(gl.TEXTURE_2D,g),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,i,r,0,gl.RGBA,gl.UNSIGNED_BYTE,a),gl.bindTexture(gl.TEXTURE_2D,null),f=!1}e.style.antialias&&S.activate({blend:!1}),gl.useProgram(on),on.data("screen",t.camera.mat3),on.data("pos",c.get("vert")),on.data("tex_in",c.get("tex")),on.data("sampler",g);var d=vect.sub(t.camera.screen(p),t.camera.screen(h));on.data("width",d.x),on.data("height",-d.y),on.data("rows",r),on.data("cols",i),on.data("blur",e.blur),gl.drawArrays(gl.TRIANGLES,0,c.count()),e.style.antialias&&(S.deactivate(),t.draw_blur(S.tex))}}function an(e,t){var n=e.split("\n"),r=n.splice(0,6),i=parseInt(r[0].slice(14)),s=parseInt(r[1].slice(14)),o=parseFloat(r[2].slice(14)),u=parseFloat(r[3].slice(14)),a=parseFloat(r[4].slice(14)),f=r[5].slice(14),l=-Infinity,c=Infinity,h=function(e,t){return i*e+t},p={};for(key in t)p[key]=t[key];p.lower=new vect(o,u),p.upper=new vect(o+a*i,u+a*s),p.rows=s,p.cols=i;var d=new un(p);for(var v=0;v<s;v++){var m=n[v].split(" ");for(var g=0;g<i;g++)m[g]==f?d.set(s-1-v,g,NaN):d.set(s-1-v,g,parseFloat(m[g]))}return d}function fn(e,t){var n=A(e,0),r=A(e,4),i=N(e,8),s=N(e,12),o=A(e,16),u=20,a={};for(key in t)a[key]=t[key];a.lower=new vect(n,r),a.upper=new vect(n+o*i,r+o*s),a.rows=s,a.cols=i;var f=new un(a),l=function(t,n,r){for(var i=0;i<r;i++){var s=A(e,t+i*4);f.raw_set(n+i,s)}},c=u;while(c<e.length){var h=N(e,c),p=N(e,c+4);l(c+4,h,p),c+=8+p*4}return f}function hn(e){var t=$(e).find("LatLonBox"),n=new vect(parseFloat(t.find("west").text()),parseFloat(t.find("south").text())),r=new vect(parseFloat(t.find("east").text()),parseFloat(t.find("north").text())),i=$(e).find("GroundOverlay Icon href").text();return new pn(BASE_DIR+i,n,r)}function pn(e,t,n){var r,i,s,o=!1;this.id=Vt();var u=!1;this.initialize=function(a){r||(r=H(a.gl,BASE_DIR+"shaders/raster")),this.image=W(a.gl,e,function(){u=!0}),i=I(a.gl,P(new vect(0,1),new vect(1,0)),2),s=I(a.gl,P(t,n),2),o=!0},this.draw=function(e,t,n){var a=e.gl;o||this.initialize(e);if(!u)return;a.useProgram(r),r.data("screen",e.camera.mat3),r.data("pos",s),r.data("tex_in",i),r.data("sampler",this.image),a.drawArrays(a.TRIANGLES,0,s.numItems)}}function mn(e){vn||(vn=H(BASE_DIR+"shaders/hillshade"));var t=$(e).find("LatLonBox"),n=new vect(parseFloat(t.find("west").text()),parseFloat(t.find("south").text())),r=new vect(parseFloat(t.find("east").text()),parseFloat(t.find("north").text())),i=$(e).find("GroundOverlay Icon href").text(),s=!1,o=W(i,function(){s=!0});this.ready=function(){return s};var u=I(P(new vect(0,1),new vect(1,0)),2),a=I(P(n,r),2),f=315;this.draw=function(e,t){if(!s)return;gl.useProgram(altitude_shader);while(f>=1)f-=1;altitude_shader.data("azimuth",f),altitude_shader.data("altitude",Math.PI/4/(2*Math.PI)),altitude_shader.data("screen",e.camera.mat3),altitude_shader.data("pos",a),altitude_shader.data("tex_in",u),altitude_shader.data("elevation",o);var i=vect.sub(e.camera.screen(r),e.camera.screen(n));return altitude_shader.data("pix_w",1/i.x),altitude_shader.data("pix_h",1/i.y),gl.drawArrays(gl.TRIANGLES,0,a.numItems),f}}function yn(e){gn||(gn=H(BASE_DIR+"shaders/elevation"));var t=$(e).find("LatLonBox"),n=new vect(parseFloat(t.find("west").text()),parseFloat(t.find("south").text())),r=new vect(parseFloat(t.find("east").text()),parseFloat(t.find("north").text())),i=$(e).find("GroundOverlay Icon href").text(),s=W(i),o=I(P(new vect(0,1),new vect(1,0)),2),u=I(P(n,r),2);this.draw=function(e,t,i){if(i)return;gl.useProgram(gn),gn.data("screen",e.camera.mat3),gn.data("pos",u),gn.data("tex_in",o),gn.data("elevation",s);var a=vect.sub(e.camera.screen(r),e.camera.screen(n));gl.drawArrays(gl.TRIANGLES,0,u.numItems)}}function mn(e){vn||(vn=H(engine.gl,BASE_DIR+"shaders/hillshade"));var t=$(e).find("LatLonBox"),n=new vect(parseFloat(t.find("west").text()),parseFloat(t.find("south").text())),r=new vect(parseFloat(t.find("east").text()),parseFloat(t.find("north").text())),i=$(e).find("GroundOverlay Icon href").text(),s=!1,o=W(engine.gl,i,function(){s=!0});this.ready=function(){return s};var u=I(engine.gl,P(new vect(0,1),new vect(1,0)),2),a=I(engine.gl,P(n,r),2),f=315;this.initialize=function(e){},this.draw=function(e,t){if(!s)return;gl.useProgram(vn);while(f>=1)f-=1;vn.data("azimuth",f),vn.data("altitude",Math.PI/4/(2*Math.PI)),vn.data("screen",e.camera.mat3),vn.data("pos",a),vn.data("tex_in",u),vn.data("elevation",o);var i=vect.sub(e.camera.screen(r),e.camera.screen(n));return vn.data("pix_w",1/i.x),vn.data("pix_h",1/i.y),gl.drawArrays(gl.TRIANGLES,0,a.numItems),f}}function Tn(e){function v(e){e||(e={}),e.desaturate||(e.desaturate=0),e.darken||(e.darken=0),e.hue||(e.hue=0),e.hue_color||(e.hue_color=d(0,0,0,1));var r=e.url,i=e.min,s=e.rows,a=e.cols,f=e.cellsize;this.rows=s,this.cols=a;var l={},c={},h=function(t,n){var r=new vect(i.x+t*f,i.y+n*f),s=new vect(i.x+(t+1)*f,i.y+(n+1)*f),o={vert:P(r,s,e.z_index),tex:null,i:t,j:n,id:t+a*n,ready:!1,min:r,max:s};c[t][n]=o,l[o.id]=o};for(var p=0;p<a;p++)c[p]={};this.size=function(e){var t=e.camera.screen(i),n=e.camera.screen(vect.add(i,new vect(f*a,f*s))),r=vect.sub(n,t);return r.y=Math.abs(r.y),r};var v=!1;this.noexpire=function(e){v=e},this.cull=function(){if(!v){var t=(new Date).getTime();for(var n in g)if(t-g[n]>bn){var r=l[n];delete l[n],delete c[r.i][r.j],e.available.push(r.tex),r.tex=null,r.ready=!1,delete g[n]}}};var m=function(){var e=o.camera.project(new vect(o.canvas.offset().left,o.canvas.offset().top+o.canvas.height())),t=o.camera.project(new vect(o.canvas.offset().left+o.canvas.width(),o.canvas.offset().top)),n=Math.floor((e.x-i.x)/f),r=Math.ceil((t.x-i.x)/f),s=Math.floor((e.y-i.y)/f),u=Math.ceil((t.y-i.y)/f);return{min_col:n,max_col:r,min_row:s,max_row:u}},g={};this.ready=function(){var e=m();for(var t=Math.max(0,e.min_col);t<Math.min(a,e.max_col);t++)for(var n=Math.max(0,e.min_row);n<Math.min(s,e.max_row);n++){if(!c[t][n])return!1;if(!c[t][n].ready)return!1}return!0};var y=function(t,i){if(!c[t][i].tex){var s;if(e.source=="file"){var u=c[t][i].id;s=r+"/"+u+".png"}else e.source=="wms"&&(s=n(r,{service:"wms",version:"1.1.0",request:"GetMap",layers:e.layer,bbox:[c[t][i].min.x,c[t][i].min.y,c[t][i].max.x,c[t][i].max.y].join(","),width:e.size,height:e.size,srs:"EPSG:4326",format:"image/png",transparent:"true"}));c[t][i].tex=e.available.pop(),c[t][i].tex||(c[t][i].tex=new V(o)),J(s,function(e){return function(t){e.tex&&(e.tex.image(t),e.ready=!0)}}(c[t][i]))}};this.fetch_all=function(){var e=(new Date).getTime();for(var t=0;t<a;t++)for(var n=0;n<s;n++)c[t][n]||h(t,n),c[t][n].tex||y(t,n),g[c[t][n].id]=e},this.fetch=function(){var e=m(),t=(new Date).getTime();for(var n=Math.max(0,e.min_col-1);n<Math.min(a,e.max_col+1);n++)for(var r=Math.max(0,e.min_row-1);r<Math.min(s,e.max_row+1);r++)c[n][r]||h(n,r),c[n][r].tex||y(n,r),g[c[n][r].id]=t};var b=!1;this.initialize=function(e){if(b)throw"Not Implemented: Migrating Tile Layers to New Map";t||(t=H(e.gl,BASE_DIR+"shaders/tile")),b=!0},this.draw=function(n,r,i,o,f){b||this.initialize(n);var l=function(){xn++,i.update(),t.data("pos",i.get("vert")),t.data("tex_in",i.get("tex")),t.data("lookup_in",i.get("lookup")),t.data("desaturate",e.desaturate),t.data("darken",e.darken),t.data("hue",e.hue),t.data("hue_color",e.hue_color.array),u.drawArrays(u.TRIANGLES,0,o*6)},h=m(),p=(new Date).getTime();for(var d=Math.max(0,h.min_col);d<Math.min(a,h.max_col);d++)for(var v=Math.max(0,h.min_row);v<Math.min(s,h.max_row);v++)if(c[d][v]&&c[d][v].ready&&c[d][v].tex){i.write("vert",c[d][v].vert,o*6,6),i.write("tex",P(new vect(0,0),new vect(1,1)),o*6,6),i.repeat("lookup",[o/En+1/(En*2)],o*6,6),g[c[d][v].id]=p,t.data("sampler"+o,c[d][v].tex);if(c[d][v].tex==null)throw"badness";o++,Sn++,o>=En&&(l(),o=0)}return f&&l(),o}}var t=null,r=[],i=[],o=null,u=null;this.id=Vt();for(var a=0;a<e.levels;a++){var f=s(e);f.source=="file"&&(f.url+="/"+e.size*Math.pow(2,a+1)),f.min=new vect(-180,-90),f.rows=Math.pow(2,a),f.cols=f.rows*2,f.cellsize=180/f.rows,f.z_index=1-wn-a/1e3,f.available=i;var l=new v(f);r.push(l)}var c=1-wn-e.levels/1e3;wn+=(e.levels+2)/1e3;var h=null,p=!1;this.initialize=function(e){o=e,t||(t=H(o.gl,BASE_DIR+"shaders/tile")),u=o.gl,h=new X(o,En*6),h.create("vert",3),h.create("tex",2),h.create("lookup",1),h.alloc(En*6);for(var n=0;n<25;n++)i.push(new V(o));for(var n=0;n<r.length;n++)r[n].initialize(o);r[0].fetch_all(),r[0].noexpire(!0),p=!0},this.draw=function(n,i){p||initialize(n),u.useProgram(t),t.data("screen",n.camera.mat3),Sn=0,xn=0;var s=Infinity,o=r[0],a,f;for(var l=0;l<r.length;l++){var c=e.size*r[l].cols/r[l].size(n).x;c<1&&(c=1/c),c<s&&(s=c,o=r[l],a=l)}for(var l=a;l>=0;l--)r[l].fetch();if(o.ready())o.draw(n,i,h,0,!0);else{n.enableZ();var d=0;for(var l=a;l>=0;l--)d=r[l].draw(n,i,h,d,l==0);n.disableZ()}$.each(r,function(e,t){t.cull()})}}function Nn(e){var t=s(e);o(t,["url","layer"]),r(t,{levels:16,size:256}),i(t,{source:"wms"});var n=new Tn(t);return n}(function(e){function t(t){if(typeof t.data!="string")return;var n=t.handler,r=t.data.toLowerCase().split(" ");t.handler=function(t){if(!(this===t.target||!/textarea|select/i.test(t.target.nodeName)&&t.target.type!=="text"))return;var i=t.type!=="keypress"&&e.hotkeys.specialKeys[t.which],s=String.fromCharCode(t.which).toLowerCase(),o,u="",a={};t.altKey&&i!=="alt"&&(u+="alt+"),t.ctrlKey&&i!=="ctrl"&&(u+="ctrl+"),t.metaKey&&!t.ctrlKey&&i!=="meta"&&(u+="meta+"),t.shiftKey&&i!=="shift"&&(u+="shift+"),i?a[u+i]=!0:(a[u+s]=!0,a[u+e.hotkeys.shiftNums[s]]=!0,u==="shift+"&&(a[e.hotkeys.shiftNums[s]]=!0));for(var f=0,l=r.length;f<l;f++)if(a[r[f]])return n.apply(this,arguments)}}e.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}},e.each(["keydown","keyup","keypress"],function(){e.event.special[this]={add:t}})})(jQuery),function(e){function r(t){var n=t||window.event,r=[].slice.call(arguments,1),i=0,s=!0,o=0,u=0;return t=e.event.fix(n),t.type="mousewheel",n.wheelDelta&&(i=n.wheelDelta/120),n.detail&&(i=-n.detail/3),u=i,n.axis!==undefined&&n.axis===n.HORIZONTAL_AXIS&&(u=0,o=-1*i),n.wheelDeltaY!==undefined&&(u=n.wheelDeltaY/120),n.wheelDeltaX!==undefined&&(o=-1*n.wheelDeltaX/120),r.unshift(t,i,o,u),(e.event.dispatch||e.event.handle).apply(this,r)}var t=["DOMMouseScroll","mousewheel"];if(e.event.fixHooks)for(var n=t.length;n;)e.event.fixHooks[t[--n]]=e.event.mouseHooks;e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=t.length;e;)this.addEventListener(t[--e],r,!1);else this.onmousewheel=r},teardown:function(){if(this.removeEventListener)for(var e=t.length;e;)this.removeEventListener(t[--e],r,!1);else this.onmousewheel=null}},e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var e=3.14159265,t={x:0,y:0};$(document).mousemove(function(e){t.x=e.clientX,t.y=e.clientY,t.lastMove=(new Date).getTime()});var a=function(e,t,n,r,i){n in t?i?e[n]=i(t[n]):e[n]=t[n]:e[n]=r},f=function(e,t,n,r){n in t&&(r?e[n]=r(t[n]):e[n]=t[n])},M=!1,z=0,K=new function(){this.styles={},this.derivedStyle=function(e,t,n,r){if(!n)throw"Undefined operation";var i;return i=this.getStyle(e,n,r),i===null&&(i=this.getStyle(e,null,r),i===null&&(i=this.getStyle(t,n,r),i===null&&(i=this.getStyle(t,null,r),i===null&&(i=n.defaultStyle(e.type,r))))),i};var e=function(e){return e?e.id:"default"},t=function(t,n){var r=e(n);r in K.styles||(K.styles[r]={}),t.id in K.styles[r]||(K.styles[r][t.id]={})};this.getStyle=function(n,r,i){t(n,r);var s,o=e(r);return s=this.styles[o][n.id][i],s===undefined?null:s},this.setStyle=function(n,r,i,s){t(n,r);var o=e(r);this.styles[o][n.id][i]=s,Y.trigger(n,"style",[n,i])}},Y=new function(){this.listeners={},this.manage=function(e){e.id in this.listeners||(this.listeners[e.id]={parents:[],callbacks:{}})},this.linkParent=function(e,t){this.manage(e),this.manage(t),this.listeners[t.id].parents.push(e)},this.addEventHandler=function(e,t,n){this.manage(e),this.listeners[e.id].callbacks[t]||(this.listeners[e.id].callbacks[t]=[]),this.listeners[e.id].callbacks[t].push(n)};var e=null;this.moveMouse=function(e){},this.clickMouse=function(e){},this.mouseDown=function(e){},this.mouseOver=function(t){e!==null&&t!=e&&this.trigger(e,"mouseout",[e]),t!==null&&t!=e&&this.trigger(t,"mouseover",[t]),e=t},this.trigger=function(e,t,n){e.id in this.listeners&&(t in this.listeners[e.id].callbacks&&$.each(this.listeners[e.id].callbacks[t],function(t,r){r.apply(e,n)}),$.each(this.listeners[e.id].parents,function(e,r){Y.trigger(r,t,n)}))}},Z=null,tt=Backbone.Model.extend({defaults:{attr:[],index:0},setIndex:function(e){this.set({index:e})}}),nt=Backbone.View.extend({initialize:function(e){var t=this;this.model=new tt(e),$(window).on("mouseup",function(){t.stopDrag()}).on("mousemove",function(e){t.doDrag(vect(e.pageX,e.pageY))}),this.render()},className:"slider",events:{"mousedown .bar":"startDrag"},render:function(){return this.$el.html('<div class="exterior"><div class="bar"></div></div>'),this},change:function(e){var t=this;this.model.on("change:index",function(){e(t.model.get("index")),t.moveBar()})},dragging:!1,startDrag:function(){this.dragging=!0},stopDrag:function(){this.dragging=!1},doDrag:function(e){if(this.dragging){var t=this.sliderIndex(e.x);this.model.set("index",t)}},sliderIndex:function(e){var t=vect(this.$el.offset().left,this.$el.offset().top+this.$el.height()),n=this.model.get("attr").length,r=this.$el.find(".bar"),i=r.width(),s=this.$el.find(".exterior").width()-i/2;return e<=t.x?0:e>=t.x+s?n-1:Math.round((e-t.x)/s*(n-1))},moveBar:function(){var e=this.$el.find(".bar"),t=e.width(),n=this.$el.find(".exterior").width()-t,r=this.model.get("attr").length,i=n/(r-1)*this.model.get("index");e.css("left",i)}}),st=1024,ot=D(0,0,1,1),at=1024,ct=1024,vt=function(e,t,n){var r={};$.each(e.Queriers,function(i,s){r[i]=new s(e,t,n)}),this.boxSearch=function(e){var t=new ln([]);for(var n in r){var i=r[n].boxSearch(e);t=t.join(i)}return t},this.pointSearch=function(e){for(var t in r){var n=r[t].pointSearch(e);if(n)return n}return null}},mt=function(e,t,n){var r=t.features().type("Point"),i=[],s=0;r.each(function(n,r){var o=K.derivedStyle(r,t,e,"radius");o>s&&(s=o),$.each(r.geom,function(e,t){i.push({x:t[0],y:t[1],ref:r})})});var o=new qt(i);this.boxSearch=function(e){var t=o.search(e),n=[];return $.each(t,function(e,t){n.push(t.ref)}),new ln(n)};var u=function(e){return new vect(e[0],e[1])};this.pointSearch=function(n){var r=vect.add(n,new vect(-s,s)),i=vect.add(n,new vect(s,-s)),a=new Ft(e.camera.project(r),e.camera.project(i)),f=o.search(a);for(var l=0;l<f.length;l++){var c=f[l].ref,h=K.derivedStyle(c,t,e,"radius");for(var p=0;p<c.geom.length;p++){var d=e.camera.screen(u(c.geom[p]));if(vect.dist(d,n)<h)return c}}return null}},gt=function(e,t,n){var r=t.features().type("Polygon"),i=[];r.each(function(e,t){$.each(t.geom,function(e,n){$.each(n,function(e,n){$.each(n,function(e,n){i.push({ref:t,x:n[0],y:n[1]})})})})});var s=new qt(i);this.boxSearch=function(e){var t=s.search(e),n={};$.each(t,function(e,t){n[t.ref.id]=t.ref}),r.each(function(t,r){for(var i=0;i<4;i++)r.contains(e.vertex(i))&&(n[r.id]=r)});var i=[];for(var o in n)i.push(n[o]);return new ln(i)},this.pointSearch=function(t){var n=e.camera.project(t);for(var i=0;i<r.count();i++){var s=r.get(i);if(s.contains(n))return s}return null}},yt=function(e,t,n){var r=t.features(),i=[];t.features().each(function(e,t){$.each(n.geomFunc(t),function(e,n){$.each(n,function(e,n){$.each(n,function(e,n){i.push({ref:t,x:n[0],y:n[1]})})})})});var s=new qt(i);this.boxSearch=function(e){var t=s.search(e),n={};$.each(t,function(e,t){n[t.ref.id]=t.ref});var r=[];for(var i in n)r.push(n[i]);return new ln(r)},this.pointSearch=function(i){var s=e.camera.project(i),o=Math.floor(s.x);if(o<0||o>=n.order.length)return null;for(var u=0;u<r.count();u++){var a=r.get(u),f=a.attr(n.order[o]),l=a.attr(n.order[o+1]);if(isNaN(f)||isNaN(l))continue;var c=vect(o,f),h=vect(o+1,l),p=e.camera.screen(c),d=e.camera.screen(h),v=vect.dir(d,p),m=vect.sub(i,p),g=vect.dot(m,v),y=m.length(),b=Math.sqrt(Math.pow(y,2)-Math.pow(g,2));if(b<K.derivedStyle(a,t,e,"stroke-width"))return a}return null}},Et=function(e,t){var n=this;t===undefined&&(t={}),t.geomFunc=function(e){return e.geom},r(t,{width:360,center:new vect(0,0),base:"default","tile-server":"http://eland.ecohealthalliance.org/wigglemaps",preserveAspectRatio:!0}),wt.call(this,e,t),this.Renderers={Point:ut,Polygon:dt([ht,lt]),Line:lt},this.Queriers={Point:mt,Polygon:gt},this.styles={Point:{fill:new h(.02,.44,.69,1),opacity:1,radius:5,stroke:"none","stroke-width":2},Polygon:{fill:new h(.02,.44,.69,1),"fill-opacity":.5,stroke:new h(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":.75},Line:{stroke:new h(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":2},"default":{fill:new h(.02,.44,.69,1),"fill-opacity":.5,stroke:new h(.02,.44,.69,1),"stroke-opacity":1,"stroke-width":1}};var i=null,o=function(){if(t.base=="default"||t.base=="nasa"){var e=s(t);u(e,{source:"file",url:t["tile-server"]+"/tiles/nasa_topo_bathy",levels:8,size:256}),i=new Tn(e)}else if(t.base=="ne"){var e=s(t);u(e,{source:"file",url:t["tile-server"]+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),i=new Tn(e)}else if(t.base=="ne1"){var e=s(t);u(e,{source:"file",url:TILE_SERVER+"/tiles/NE1_HR_LC",levels:6,size:256}),i=new Tn(e)}else i=null;i&&(i.initialize(n),n.scene.push(i))};o(),this.append=function(e){if("draw"in e){this.scene.push(e);return}this.scene.push(new bt(n,e,t)),this.queriers[e.id]=new vt(this,e,t)}},Tt=function(e){var t=[],n=[];for(var r=0;r<e.length;r++){var i=[];if(e[r].length<=3)n.push(e[r]);else for(var s=1;s<e[r].length;s++)i.push($t(e[r][s][0],e[r][s][1]));i.push(t[0]),t.push(i)}var o=Ht(t);for(var s=0;s<n.length;s++)o.push(n[s][0][0]),o.push(n[s][0][1]),o.push(n[s][1][0]),o.push(n[s][1][1]),o.push(n[s][2][0]),o.push(n[s][2][1]);return o},Rt=1,Ut=2,zt=3,Wt=function(e,t){var n=this;this.id=Vt(),this.type="Feature",this.type=e.type;var r=e.attr;this.attr=function(e,t){if(t===undefined)return r[e];throw"Not Implemented"},this.geom=e.geom,this.geometry=function(){},this.style=function(e,t,n){var r,i,s;return!e||e.type=="Engine"?(r=e,i=t,s=n):(r=null,i=e,s=t),s===undefined?K.getStyle(this,r,i):(K.setStyle(this,r,i,s),this)}},Xt=6378.1,Vt=function(){var e=1;return function(){var t=e;return e++,t}}(),$t=function(){var e=1e-6,t={},n={};return function(r,i){return new vect(r+Math.random()*e-e/2,i+Math.random()*e-e/2);var s}}(),Jt=function(e,t){Wt.call(this,e,t);var n=function(e){return new vect(e[0],e[1])};this.bounds=null;for(var r=0;r<this.geom.length;r++){var i=n(this.geom[r]),s=new Ft(i.clone(),i.clone());this.bounds?this.bounds.union(s):this.bounds=s}this.map_contains=function(e,r){var i=r,s=K.derivedStyle(this,t,e,"radius");for(var o=0;o<this.geom.length;o++){var u=e.camera.screen(n(this.geom[o]));if(vect.dist(u,i)<s)return!0}return!1}},Kt=function(e){var t=[],n=0;$.each(e,function(e,r){var i=K.derivedStyle(this,layer,engine,"radius");i>n&&(n=i),$.each(r.geom,function(e,n){t.push({x:n[0],y:n[1],ref:r})})});var r=new qt(t);this.search=function(e){var t=r.search(e),n=[];return $.each(t,function(e,t){n.push(t.ref)}),new ln(n)},this.map_contains=function(e,t){var i=t,s=vect.add(i,new vect(-n,n)),o=vect.add(i,new vect(n,-n)),u=new Ft(e.camera.project(s),e.camera.project(o)),a=r.search(u);for(var f=0;f<a.length;f++){var l=a[f];if(l.ref.map_contains(e,t))return new ln([l.ref])}return new ln([])}},rn={Point:Jt,Polygon:Qt,Line:tn},on=null,ln=function(e){var t=null;this.length=e.length,this.count=function(){return e.length},this.items=function(){return e},this.type=function(t){var n=[];for(var r=0;r<e.length;r++)(t=="*"||e[r].type==t)&&n.push(e[r]);return new ln(n)},this.join=function(t){var n=[];for(var r=0;r<e.length;r++)n.push(e[r]);for(var r=0;r<t.count();r++){var i=t.get(r);this.id(i.id)||n.push(i)}return new ln(n)},this.attr=function(e){throw"Not Implemented"},this.get=function(t){return e[t]},this.subset=function(t){var n=[];for(var r=0;r<t.length;r++)n.push(e[t[r]]);return new ln(n)},this.id=function(n){if(!t){t={};for(var r=0;r<e.length;r++)t[e[r].id]=e[r]}return n in t?t[n]:null},this.each=function(t){for(var n=0;n<e.length;n++)t(n,e[n]);return this};var n={">":function(e,t){return e>t},"<":function(e,t){return e<t},"==":function(e,t){return e==t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t}};this.select=function(t){if(t.match(/^\s*\*\s*$/))return new ln(e);var r=t.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!r)throw"Bad Selector";var i=r[1],s=r[2],o=null,u=null;isNaN(r[3])?u=r[3]:o=parseFloat(r[3]),new_elem=[];if(u)for(var a=0;a<e.length;a++)n[s](e[a].attr(i),e[a].attr(u))&&new_elem.push(e[a]);else for(var a=0;a<e.length;a++)n[s](e[a].attr(i),o)&&new_elem.push(e[a]);return new ln(new_elem)},this.filter=function(t){var n=[];for(var r=0;r<e.length;r++)t(e[r])&&n.push(e[r]);return new ln(n)},this.quantile=function(t,n,r){var i=e.filter(function(e){return e.attr(t)!==undefined});i.sort(function(e,n){return e.attr(t)-n.attr(t)});var s=Math.round(n*i.length/r),o=Math.round((n-1)*i.length/r);return new ln(i.slice(o,s))},this.range=function(t){var n=Infinity,r=-Infinity,i=!1;for(var s=0;s<e.length;s++){var o=e[s].attr(t);isNaN(o)||(i=!0,n>o&&(n=o),r<o&&(r=o))}return i?{min:n,max:r}:null},this.style=function(t,n,r){var i=function(e,t,n){return typeof e=="function"?e(n):m(e)?e[t]:e},s,o,u;t.type=="Engine"?(s=t,o=n,u=r):(s=null,o=t,u=n);if(u!==undefined)return $.each(e,function(e,t){t.style(s,o,i(u,e,t))}),this;if(e[0])return e[0].style(s,o)}},cn=null,dn=Math.PI/4,vn=null,gn=null,dn=Math.PI/4,vn=null,bn=1e3,wn=0,En=8,Sn=0,xn=0,Cn=function(e,t){t===undefined&&(t={});var n=new sn(t);for(var r=0;r<e.features.length;r++){var i=e.features[r];if(i.type=="Feature"){i.geometry.type=="Point"&&n.append({type:"Point",geom:[i.geometry.coordinates],attr:i.properties}),i.geometry.type=="MultiPoint"&&n.append({type:"Point",geom:i.geometry.coordinates,attr:i.properties});if(i.geometry.type=="Polygon"){var s=i.geometry.coordinates,o=[];for(var u=0;u<=s.length-1;u++){var a=[];for(var f=s[u].length-1;f>=0;f--)a.push(s[u][f]);o.push(a)}n.append({type:"Polygon",geom:[o],attr:i.properties})}if(i.geometry.type=="MultiPolygon"){var l=[];$.each(i.geometry.coordinates,function(e,t){var n=[];for(var r=0;r<=t.length-1;r++){var i=[];for(var s=t[r].length-1;s>=0;s--)i.push(t[r][s]);n.push(i)}l.push(n)}),n.append({type:"Polygon",geom:l,attr:i.properties})}i.geometry.type=="MultiLineString"&&$.each(i.geometry.coordinates,function(e,t){n.append({type:"Line",geom:[[t]],attr:i.properties})})}}return n},kn=8,Ln=0,
An=1,On=5,Mn=function(e){var t=T(e,0),n=T(e,24),r=N(e,28),i=N(e,32),s=L(e,36),o=L(e,44),u=L(e,52),a=L(e,60);return{code:t,length:n,version:r,shapetype:i,bounds:new Ft(new vect(s,o),new(u,a))}},_n=function(e){var t=[],n=function(n){return t.push(2*T(e,n)),n+8},r=100;while(r<e.length)r=n(r);return t},Dn=function(e){var t=e.path;$.ajax({url:t+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(n){var r=_n(n);$.ajax({url:t+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(n){$.ajax({url:t+".dbf",mimeType:"text/plain; charset=x-user-defined",success:function(t){var i=Hn(n,t,r,e);e.success(i)}})}})}})},Pn=function(e){var t=function(t){var n=O(e,t,10),r=O(e,t+11,1),i=x(e,t+16);return{name:n,type:r,length:i}},n=x(e,0);if(n==4)throw"Level 7 dBASE not supported";var r=x(e,1),i=x(e,2),s=x(e,3),o=N(e,4),u=k(e,8),a=k(e,10),f=32,l=32,c=f,h=[];while(c<u-1)h.push(t(c)),c+=l;var p=[],d=u;while(d<u+o*a){var v=O(e,d,1);if(v=="*")d+=a;else{d++;var m={};for(var g=0;g<h.length;g++){var y=h[g],b=undefined;y.type=="C"?b=O(e,d,y.length).trim():y.type=="N"&&(b=parseFloat(O(e,d,y.length))),d+=y.length,m[y.name]=b}p.push(m)}}return p},Hn=function(e,t,n,r){var i=[],s=function(t,n,r){var i=[];for(var s=r-1;s>=n;s--){var o=L(e,t+16*s),u=L(e,t+16*s+8);i.push([o,u])}return i},o=function(t){var n=T(e,t),r=T(e,t+4),o=t+8,u=N(e,o);if(u==Ln)console.log("NULL Shape");else if(u==An){var a=L(e,o+4),f=L(e,o+12);i.push({type:"Point",attr:{},geom:[[a,f]]})}else{if(u!=On)throw"Not Implemented: "+u;var l=N(e,o+36),c=N(e,o+40),h=t+52,p=t+52+4*l,d=[];for(var v=0;v<l;v++){var m=N(e,h+v*4),g;v+1<l?g=N(e,h+(v+1)*4):g=c;var y=s(p,m,g);d.push(y)}i.push({type:"Polygon",attr:{},geom:[d]})}},u=Pn(t);for(var a=0;a<n.length;a++){var f=n[a];o(f)}var l=new sn;for(var a=0;a<i.length;a++){var c=i[a];c.attr=u[a],l.append(c)}return l},Bn=[];window.wiggle={Map:Et,TimeSeries:St,layer:{Layer:sn,Grid:un,Hillshade:mn,Elevation:yn,Raster:pn},io:{Shapefile:Dn,GeoJSON:Cn,KML:hn,SparseGrid:fn,AsciiGrid:an,WMS:Nn},util:{fcolor:d,icolor:p,Box:Ft,RangeTree:qt},widget:{Slider:nt},ready:function(e){Bn.push(e)}},$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(e,t){var n=/wigglemaps(\.min)?\.js/;$(t).attr("src").match(n)&&(BASE_DIR=$(t).attr("src").replace(n,""))}),$.each(Bn,function(e,t){t()})})}();