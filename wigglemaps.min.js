function vect(k,n,q){this.x=k;this.y=n;this.z=q?q:0;this.add=function(j){this.x+=j.x;this.y+=j.y;this.z+=j.z};this.sub=function(j){this.x-=j.x;this.y-=j.y;this.z-=j.z};this.scale=function(j){this.x*=j;this.y*=j;this.z*=j};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var j=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);0!=j&&(this.x/=j,this.y/=j,this.z/=j)};this.div=function(j){this.x/=j.x;this.y/=j.y;this.z/=j.z};this.floor=function(){this.x=
Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return 0==this.x+this.y+this.z};this.dot=function(j){return this.x*j.x+this.y*j.y+this.z*j.z};this.cross=function(){throw"Need to reimplement";};this.rotate=function(j){var k=Math.cos(j);j=Math.sin(j);xp=k*this.x-j*this.y;yp=j*this.x+k*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}vect.scale=function(k,n){return new vect(k.x*n,k.y*n,k.z*n)};
vect.add=function(k,n){return new vect(k.x+n.x,k.y+n.y,k.z+n.z)};vect.sub=function(k,n){if(!k||!n)throw"Bad Vector";return new vect(k.x-n.x,k.y-n.y,k.z-n.z)};vect.dist=function(k,n){var q=n.x-k.x,j=n.y-k.y,t=n.z-k.z;return Math.sqrt(q*q+j*j+t*t)};vect.dir=function(k,n){var q=vect.sub(k,n);q.normalize();return q};vect.dot2d=function(k,n){return k.x*n.x+k.y*n.y};vect.cross=function(k,n){return k.x*n.y-k.y*n.x};
vect.left=function(k,n,q,j){j||(j=0);n=vect.sub(n,k);k=vect.sub(q,k);return vect.cross(n,k)>=-j};vect.intersects=function(k,n,q,j,t){t||(t=0);return vect.left(k,n,q,t)!=vect.left(k,n,j,t)&&vect.left(q,j,n,t)!=vect.left(q,j,k,t)};vect.intersect2dt=function(k,n,q,j){j=k.x*(j.y-q.y)+n.x*(q.y-j.y)+j.x*(n.y-k.y)+q.x*(k.y-n.y);return 0==j?Infinity:-(k.x*(q.y-n.y)+n.x*(k.y-q.y)+q.x*(n.y-k.y))/j};
vect.intersect2dpos=function(k,n,q,j){var t=k.x*(j.y-q.y)+n.x*(q.y-j.y)+j.x*(n.y-k.y)+q.x*(k.y-n.y);if(0==t)return Infinity;q=(k.x*(j.y-q.y)+q.x*(k.y-j.y)+j.x*(q.y-k.y))/t;n=vect.sub(n,k);n.scale(q);return vect.add(k,n)};vect.rotate=function(k,n){var q=Math.cos(n),j=Math.sin(n);xp=q*k.x-j*k.y;yp=j*k.x+q*k.y;return k=new vect(xp,yp,k.z)};
(function(){function k(a,b){for(var c in b)c in a||(a[c]=b[c])}function n(a){var b={};for(key in a)b[key]=a[key];return b}function q(a,b){for(key in b)a[key]=b[key]}function j(a,b,c){return Math.min(Math.max(a,b),c)}function t(a,b,c,d){1>=a&&1>=b&&1>=c&&1>=d?(this.r=a,this.g=b,this.b=c,this.a=d):(this.r=a/255,this.g=b/255,this.b=c/255,this.a=d/255);this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(255*this.r)+","+parseInt(255*
this.g)+","+parseInt(255*this.b)+")"}}function ua(a,b,c,d){return new t(j(a,0,1),j(b,0,1),j(c,0,1),j(d,0,1))}function X(a){var b=parseInt(a.slice(1,3),16),c=parseInt(a.slice(3,5),16);a=parseInt(a.slice(5,7),16);return new t(b,c,a,255)}function ia(a,b){return((a.charCodeAt(b)&255)<<24)+((a.charCodeAt(b+1)&255)<<16)+((a.charCodeAt(b+2)&255)<<8)+(a.charCodeAt(b+3)&255)}function H(a,b){return((a.charCodeAt(b+3)&255)<<24)+((a.charCodeAt(b+2)&255)<<16)+((a.charCodeAt(b+1)&255)<<8)+(a.charCodeAt(b)&255)}
function da(a,b){var c=a.charCodeAt(b)&255,d=a.charCodeAt(b+1)&255,e=a.charCodeAt(b+2)&255,h=a.charCodeAt(b+3)&255,g=a.charCodeAt(b+4)&255,m=a.charCodeAt(b+5)&255,f=a.charCodeAt(b+6)&255,p=a.charCodeAt(b+7)&255,l=1-2*(p>>7),p=((p&127)<<4)+((f&240)>>4)-1023,c=(f&15)*Math.pow(2,48)+m*Math.pow(2,40)+g*Math.pow(2,32)+h*Math.pow(2,24)+e*Math.pow(2,16)+d*Math.pow(2,8)+c;return l*(1+c*Math.pow(2,-52))*Math.pow(2,p)}function ea(a,b){var c=a.charCodeAt(b)&255,d=a.charCodeAt(b+1)&255,e=a.charCodeAt(b+2)&255,
h=a.charCodeAt(b+3)&255,g=1-2*(h>>7),h=((h&127)<<1)+((e&254)>>7)-127,c=(e&127)*Math.pow(2,16)+d*Math.pow(2,8)+c;return g*(1+c*Math.pow(2,-23))*Math.pow(2,h)}function va(a,b,c,d){return[a-c,b+d,a-c,b-d,a+c,b+d,a-c,b-d,a+c,b-d,a+c,b+d]}function v(a,b,c){return 2==arguments.length?[a.x,b.y,a.x,a.y,b.x,b.y,a.x,a.y,b.x,a.y,b.x,b.y]:[a.x,b.y,c,a.x,a.y,c,b.x,b.y,c,a.x,a.y,c,b.x,a.y,c,b.x,b.y,c]}function B(a){if(!gl)return null;var b=gl.createProgram(),c=wa(gl.VERTEX_SHADER,a+"/vert.glsl");a=wa(gl.FRAGMENT_SHADER,
a+"/frag.glsl");gl.attachShader(b,c);gl.attachShader(b,a);gl.linkProgram(b);var d={},c=(c.source+a.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg);a=0;gl.useProgram(b);if(c){for(var e=0;e<c.length;e++){var h=c[e].split(" ");d[h[2]]={u:h[0],type:h[1],loc:null};if("uniform"==h[0])d[h[2]].loc=gl.getUniformLocation(b,h[2]);else{var g=gl.getAttribLocation(b,h[2]);d[h[2]].loc=g}"sampler2D"==h[1]&&(d[h[2]].tex=a,a++)}b.get=function(a){return d[a].loc};b.data=function(a,b){var c=d[a];if(!c)throw"Could not find shader variable "+
a;if("uniform"==c.u)if("float"==c.type)gl.uniform1f(c.loc,b);else if("vec2"==c.type)gl.uniform2fv(c.loc,b);else if("ivec2"==c.type)gl.uniform2iv(c.loc,b);else if("vec3"==c.type)gl.uniform3fv(c.loc,b);else if("ivec3"==c.type)gl.uniform3iv(c.loc,b);else if("vec4"==c.type)gl.uniform4fv(c.loc,b);else if("ivec4"==c.type)gl.uniform4iv(c.loc,b);else if("bool"==c.type)gl.uniform1i(c.loc,b);else if("mat4"==c.type)gl.uniformMatrix4fv(c.loc,!1,b);else if("mat3"==c.type)gl.uniformMatrix3fv(c.loc,!1,b);else if("sampler2D"==
c.type)"texture"in b&&(b=b.texture()),gl.activeTexture(gl["TEXTURE"+c.tex]),gl.bindTexture(gl.TEXTURE_2D,b),gl.uniform1i(c.loc,c.tex);else if("int"==c.type)gl.uniform1i(c.loc,b);else throw"Unsupported Type for Shader Helper: "+c.type;else if("attribute"==c.u)gl.enableVertexAttribArray(c.loc),gl.bindBuffer(gl.ARRAY_BUFFER,b),gl.vertexAttribPointer(c.loc,b.itemSize,gl.FLOAT,!1,0,0);else throw"Type: "+c.u+" Recieved";}}return b}function wa(a,b){var c=gl.createShader(a);$.ajax({async:!1,url:b,dataType:"text",
success:function(a){gl.shaderSource(c,a);gl.compileShader(c);if(!gl.getShaderParameter(c,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(c);c.source=a},error:function(){console.log("Could not load "+b)}});return c}function I(a,b){var c=gl.createBuffer(),d=new Float32Array(a);gl.bindBuffer(gl.ARRAY_BUFFER,c);c.itemSize=b;c.numItems=a.length/b;gl.bufferData(gl.ARRAY_BUFFER,d,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return c}function ja(a,b){if(!gl)return null;var c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,
c);var d=new Float32Array(a*b);c.itemSize=b;c.numItems=a;c.update=function(a,b){var d=new Float32Array(a);gl.bindBuffer(gl.ARRAY_BUFFER,c);gl.bufferSubData(gl.ARRAY_BUFFER,4*b,d);gl.bindBuffer(gl.ARRAY_BUFFER,null)};gl.bufferData(gl.ARRAY_BUFFER,d,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return c}function Y(a,b){var c=gl.createTexture();c.id=xa;xa++;var d=new Image;d.onload=function(){gl.bindTexture(gl.TEXTURE_2D,c);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,d);gl.texParameteri(gl.TEXTURE_2D,
gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);b&&b()};d.src=a;return c}function ka(a){var b=n(a);k(b,{mag_filter:gl.LINEAR,min_filter:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,mipmap:!1});var c=gl.createTexture(),d=null;this.image=function(a){d=a;gl.bindTexture(gl.TEXTURE_2D,
c);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,d);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,b.mag_filter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,b.min_filter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,b.wrap_s);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,b.wrap_t);b.mipmap&&gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null)};this.texture=function(){return d?c:null}}function Ma(a,b){b||(b={});"center"in b||(b.center=new vect(0,
0));"extents"in b||(b.extents=180);this.mat3=new Float32Array(9);var c=a.width()/a.height();this.mat3[0]=2/b.extents;this.mat3[4]=2*c/b.extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(b){b=new vect(2*(b.x-a.offset().left)/a.width()-1,-(2*(b.y-a.offset().top)/a.height()-1));b.x=b.x/this.mat3[0]-this.mat3[6]/this.mat3[0];b.y=b.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return b};this.screen=function(b){b=new vect(b.x*this.mat3[0]+this.mat3[6],b.y*this.mat3[4]+this.mat3[7]);
b.x=a.offset().left+a.width()*(b.x+1)/2;b.y=a.offset().top+a.height()*(-b.y+1)/2;return b};this.percent=function(b){return new vect(2*((b.x-a.offset().left)/a.width())-1,-(2*((b.y-a.offset().top)/a.height())-1))};this.pixel=function(b){return new vect(a.offset().left+(b.x+1)/2*a.width(),a.offset().top+(-b.y+1)/2*a.height())};this.move=function(a){this.mat3[6]-=a.x*this.mat3[0];this.mat3[7]-=a.y*this.mat3[4]};this.position=function(a){if(!a)return new vect(-this.mat3[6]/this.mat3[0],-this.mat3[7]/
this.mat3[4]);this.mat3[6]=-a.x*this.mat3[0];this.mat3[7]=-a.y*this.mat3[4]};this.position(b.center);this.extents=function(a){b.extents=a;a=this.position();this.level=1;this.mat3[0]=2/b.extents;this.mat3[4]=2*c/b.extents;this.position(a)};this.zoom=function(a){var b=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=a;this.mat3[4]*=a;this.mat3[6]=b.x*this.mat3[0];this.mat3[7]=b.y*this.mat3[4];this.level*=a};this.reset=function(){this.zoom(1/this.level)};this.reconfigure=function(){var b=
this.position();this.mat3[4]/=c;c=a.width()/a.height();this.mat3[4]*=c;this.position(b)}}function Na(a){var b=!1,c=new vect(0,0),d=new vect(0,0),e=null,h=0;a.canvas.mousedown(function(a){c=new vect(a.clientX,a.clientY);b=!0});$(window).bind("mouseup",function(){b=!1});$(document).bind("keypress","+",function(){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(){a.camera.reset()});a.canvas.bind("mousewheel",function(b,c){c*=
0.5;0>c?(c=-1*c+1,c=1/c):c+=1;a.camera.zoom(c);b.preventDefault()});var g=!0;this.disable=function(){g=!1};this.enable=function(){g=!0};this.update=function(m){d=new vect(S.x,S.y);if(b&&g){var f=vect.sub(a.camera.project(c),a.camera.project(d));a.camera.move(f);c=d;h=f.length()/m;e=f;e.normalize()}else 0.01<h&&e&&(a.camera.move(vect.scale(e,h*m)),h-=3*m*h)}}function Oa(a,b){b||(b={});k(b,{base:"default",background:new t(0,0,0,1),antialias:!0});var c=this;this.canvas=$("<canvas></canvas>").attr("id",
"viewer");a?($(a).append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height())):(a=window,$("body").append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height()),$(window).resize(function(){c.resize()}));this.resize=function(){c.canvas.attr("width",$(a).width());c.canvas.attr("height",$(a).height());gl.viewport(0,0,c.canvas.width(),c.canvas.height());c.camera.reconfigure();for(var b=0;b<p.length;b++)p[b].resize()};var d=
this.canvas;gl=Pa?WebGLDebugUtils.makeDebugContext(d.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),function(a,b){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+b;}):d.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});gl.viewport(0,0,c.canvas.width(),c.canvas.height());gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.BLEND);z||(z=B(y+"shaders/blur"));ya||(ya=B(y+"shaders/light"));var e=new L(6);
e.create("vert",2);e.create("tex",2);d=e.alloc(6);e.write("vert",v(new vect(-1,-1),new vect(1,1)),d,6);e.write("tex",v(new vect(0,0),new vect(1,1)),d,6);e.update();this.scene=[];this.camera=new Ma(this.canvas,b);this.scroller=new Na(this);this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.sel=new Qa(this);this.select=function(a){a?(this.scroller.disable(),this.sel.enable()):(this.scroller.enable(),this.sel.disable())};var h=(new Date).getTime(),g=[];this.attr=function(a,
c){"base"==a&&(b.base=c,f())};var m=null,f=function(){if("default"==b.base||"nasa"==b.base){var a=n(b);q(a,{source:"file",url:la+"/tiles/nasa_topo_bathy",levels:8,size:256});m=new ga(a)}else"ne"==b.base?(a=n(b),q(a,{source:"file",url:la+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),m=new ga(a)):"ne1"==b.base?(a=n(b),q(a,{source:"file",url:la+"/tiles/NE1_HR_LC",levels:6,size:256}),m=new ga(a)):m=null};f();this.enable_z=function(){gl.depthFunc(gl.LEQUAL);gl.enable(gl.DEPTH_TEST)};this.disable_z=function(){gl.disable(gl.DEPTH_TEST)};
var p=[],l=[null];this.framebuffer=function(){var a=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,a);a.width=c.canvas.width();a.height=c.canvas.height();var b=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,b);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,
0,gl.RGBA,a.width,a.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);var d=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,d);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a.width,a.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,b,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,d);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);var e={framebuffer:a,
renderbuffer:d,tex:b,resize:function(){a.width=c.canvas.width();a.height=c.canvas.height();gl.bindTexture(gl.TEXTURE_2D,b);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,a.width,a.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,d);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a.width,a.height);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null)},activate:function(b){b||(b={});k(b,{blend:!0,clear:!0});l.push(a);b.blend||gl.disable(gl.BLEND);
gl.bindFramebuffer(gl.FRAMEBUFFER,a);gl.viewport(0,0,c.canvas.width(),c.canvas.height());b.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT),gl.clearDepth(0))},deactivate:function(){var b=l.pop(),c=l[l.length-1];if(b!=a)throw"Non-nested use of framebuffers";gl.bindFramebuffer(gl.FRAMEBUFFER,c);gl.enable(gl.BLEND)}};p.push(e);return e};var r=this.framebuffer(),j=this.framebuffer();this.draw_blur=function(a){gl.useProgram(z);j.activate({blend:!1});z.data("pos",e.get("vert"));z.data("tex_in",
e.get("tex"));z.data("sampler",a);z.data("width",c.canvas.width());z.data("height",c.canvas.height());z.data("hor",!0);gl.drawArrays(gl.TRIANGLES,0,e.count());j.deactivate();z.data("pos",e.get("vert"));z.data("tex_in",e.get("tex"));z.data("sampler",j.tex);z.data("width",c.canvas.width());z.data("height",c.canvas.height());z.data("hor",!1);gl.drawArrays(gl.TRIANGLES,0,e.count())};this.dirty=!0;var za=function(){var a=(new Date).getTime(),d=(a-h)/1E3;c.scroller.update(d);60<=g.length&&g.splice(0,1);
g.push(d);for(var e=0,f=0;f<g.length;f++)e+=g[f];e/=g.length;$("#fps").text(Math.floor(1/e));h=a;gl.clearColor(b.background.r,b.background.g,b.background.b,b.background.a);gl.clear(gl.COLOR_BUFFER_BIT);gl.clearDepth(0);a=!1;c.shade&&(a=c.shade.ready());a&&r.activate();m&&m.draw(c,d);for(f=0;f<c.scene.length;f++)c.scene[f].draw(c,d,!1);c.sel.draw(c,d);requestAnimationFrame(za)};this.read_pixel=function(a,b){gl.bindFramebuffer(gl.FRAMEBUFFER,c.framebuffer);var d=new Uint8Array(4),e=(a-c.canvas.position().left)/
c.canvas.width(),h=(c.canvas.position().top+c.canvas.height()-b)/c.canvas.height();gl.readPixels(parseInt(e*c.framebuffer.width),parseInt(h*c.framebuffer.height),1,1,gl.RGBA,gl.UNSIGNED_BYTE,d);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return d};$(document).mousemove(function(a){S.x=a.clientX;S.y=a.clientY});this.canvas.click(function(){});this.canvas.dblclick(function(){});var s=!1;this.canvas.mousedown(function(){s=!0});this.canvas.mouseup(function(){s=!1});this.canvas.mousemove(function(){if(!s){var a=
c.camera.project(new vect(S.x,S.y));$.each(c.scene,function(b,d){d.update_move&&d.update_move(c,a)})}});this.canvas.mouseout(function(){$.each(c.scene,function(a,b){b.force_out&&b.force_out(c)})});requestAnimationFrame(za)}function L(a){var b={},c;c=a?a:256;var d=0,e=function(a,b,c,d){a||console.log("ack");c||(c=0);d||(d=b.length);for(var e=0;e<d;e++)a[c+e]=b[e]};this.create=function(a,d){if(!d)throw"Length of buffer must be a positive integer";var e=new Float32Array(c*d),f=ja(c,d);b[a]={array:e,
buffer:f,len:d,dirty:!1}};this.alloc=function(a){if(d+a>=c){for(var g=c;g<d+a;)g*=2;c=g;for(name in b){var m=new Float32Array(g*b[name].len),f=b[name].array,p=ja(c,b[name].len);e(m,f);b[name].array=m;b[name].buffer=p;b[name].dirty=!0}}g=d;d+=a;return g};this.get=function(a){return b[a].buffer};this.write=function(a,c,d,f){e(b[a].array,c,d*b[a].len,f*b[a].len);b[a].dirty=!0};this.repeat=function(a,c,d,f){for(var p=0;p<f;p++)e(b[a].array,c,(d+p)*b[a].len,b[a].len);b[a].dirty=!0};this.count=function(){return d};
this.data=function(a){return b[a].array};this.update=function(){for(name in b)b[name].dirty&&(b[name].buffer&&b[name].buffer.update(b[name].array,0),b[name].dirty=!1)}}function Qa(a){Z||(Z=B(y+"shaders/selbox"));var b=!1,c=!1,d=null,e=null,h=ja(6,2),g=I(va(0,0,1,1),2);a.canvas.bind("mousedown",function(f){b&&(show=c=!0,e=d=a.camera.percent(new vect(f.clientX,f.clientY)),h.update(v(d,e),0))});var m=function(){};this.select=function(a){m=a};$(document).bind("mouseup",function(){if(b&&c){var h=a.camera.project(a.camera.pixel(d)),
g=a.camera.project(a.camera.pixel(e));if(h.x>g.x){var l=h.x;h.x=g.x;g.x=l}h.y>g.y&&(l=h.y,h.y=g.y,g.y=l);c=!1;m(new aa(h,g))}});$(document).bind("click",function(){b&&(show=!1)});$(document).bind("mousemove",function(f){b&&c&&(e=a.camera.percent(new vect(f.clientX,f.clientY)),h.update(v(d,e),0))});this.enable=function(){b=!0};this.disable=function(){b=!1};this.draw=function(){c&&(gl.useProgram(Z),Z.data("pos",h),Z.data("edge_in",g),gl.drawArrays(gl.TRIANGLES,0,h.numItems))}}function Aa(a,b){for(;a>=
b;)a-=b;for(;0>a;)a+=b;return a}function Ra(a,b,c,d){this.current=a;this.upper=b;this.lower=c;this.index=d}function Ba(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return!0;return!1}function ha(a,b,c){if(void 0==b)throw"whoa";return 0==a[b+1].y-a[b].y?Math.min(a[b].x,a[b+1].x):a[b].x+(a[b+1].x-a[b].x)*((c-a[b].y)/(a[b+1].y-a[b].y))}function T(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return c;return!1}function C(a,b,c){return new vect(ha(b,c,b[a].y),b[a].y)}function J(a,b){if(!b)throw"eek";a.push(b.x);
a.push(b.y)}function U(a,b,c){if(!b||!c||3!=c.length+b.length&&4!=c.length+b.length)throw"ahh";if(3==b.length+c.length){for(var d=0;d<b.length;d++)J(a,b[d]);for(d=0;d<c.length;d++)J(a,c[d])}else b[1].x<b[0].x&&(d=b[0],b[0]=b[1],b[1]=d),c[1].x<c[0].x&&(d=c[0],c[0]=c[1],c[1]=d),J(a,b[0]),J(a,b[1]),J(a,c[1]),J(a,c[0]),J(a,c[1]),J(a,b[0])}function Sa(a){for(var b=[],c=0,d=[],e=0;e<a.length;e++){for(var h=0;h<a[e].length-1;h++){var g=Aa(h+1,a[e].length-1),m=Aa(h-1,a[e].length-1);b.push(new Ra(h+c,g+c,
m+c,e));d.push(a[e][h])}d.push(a[e][0]);c+=a[e].length}b.sort(function(a,b){return d[a.current].y-d[b.current].y});a=[];e=[];new vect(-200,0);new vect(200,0);c=0;c=[];m=[];for(h=0;h<b.length;h++){var f=b[h],g=Ba(a,f.lower),p=Ba(a,f.current),l,r;if(g&&!p)r=l=T(a,f.lower);else if(p&&!g)l=r=T(a,f.current);else if(g&&p)l=T(a,f.lower),r=T(a,f.current);else if(!g&&!p){a:{l=a;r=d;for(var j=d[f.current].x,k=d[f.current].y,s=0;s<l.length;s++){var x=ha(r,l[s],k);if(x>j||0==x-j&&r[l[s]].y>r[index].y){r=s;break a}}r=
l.length}l=r}if(1<Math.abs(l-r)){for(g=0;g<a.length;g++);throw"Bad";}j=vect.left(d[f.lower],d[f.current],d[f.upper]);k=Math.floor(Math.min(l,r)/2);!j&&!g&&!p?(U(m,e[k],[C(f.current,d,a[r-1]),C(f.current,d,a[r])]),e.splice(k,1,[C(f.current,d,a[r-1]),d[f.current]],[d[f.current],C(f.current,d,a[l])])):j&&!g&&!p?e.splice(k,0,[d[f.current]]):g&&!p?(U(m,e[k],[C(f.current,d,a[Math.max(l,r)-1]),d[f.current]]),e[k]=[C(f.current,d,a[Math.min(l,r)-1]),d[f.current]]):!g&&p?(U(m,e[k],[d[f.current],C(f.current,
d,a[Math.min(r,l)+1])]),e[k]=[d[f.current],C(f.current,d,a[Math.max(r,l)+1])]):!j&&g&&p?(U(m,e[k],[C(f.current,d,a[Math.min(l,r)-1]),d[f.current]]),U(m,e[k+1],[C(f.current,d,a[Math.max(l,r)+1]),d[f.current]]),e.splice(k,2,[C(f.current,d,a[Math.min(l,r)-1]),C(f.current,d,a[Math.max(l,r)+1])])):j&&(g&&p)&&(U(m,e[k],[d[f.current]]),e.splice(k,1));g&&!p?a[l]=f.current:p&&!g?a[r]=f.lower:g&&p?(a.splice(T(a,f.lower),1),a.splice(T(a,f.current),1)):!g&&!p&&(j?a.splice(l,0,f.lower,f.current):a.splice(l,0,
f.current,f.lower));for(g=0;g<a.length-1;g++)if(ha(d,a[g],d[f.current].y)>ha(d,a[g+1],d[f.current].y))throw console.log("Misplaced Sweep"),"Misplace!";}if(0<a.length)throw console.log(a),"Bad "+a.length;if(0<c.length)throw console.log(c),"Wrong";return m}function aa(a,b){this.min=a.clone();this.max=b.clone();this.contains=function(c){return a.x<=c.x&&b.x>=c.x&&a.y<=c.y&&b.y>=c.y};this.x_in=function(c){return a.x<=c.x&&b.x>=c.x};this.x_left=function(b){return a.x>=b.x};this.x_right=function(a){return b.x<=
a.x};this.y_in=function(c){return a.y<=c.y&&b.y>=c.y};this.y_left=function(b){return a.y>=b.y};this.y_right=function(a){return b.y<=a.y};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(a){switch(a){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);
default:throw"Index out of bounds: "+a;}};this.intersects=function(a){for(var b=0;4>b;b++)for(var e=0;4>e;e++)if(vect.intersects(this.vertex(b),this.vertex((b+1)%4),a.vertex(e),a.vertex((e+1)%4)))return!0;return this.contains(a.min)&&this.contains(a.max)&&this.contains(new vect(a.min.x,a.max.y))&&this.contains(new vect(a.max.x,a.min.y))||a.contains(this.min)&&a.contains(this.max)&&a.contains(new vect(this.min.x,this.max.y))&&a.contains(new vect(this.max.x,this.min.y))?!0:!1};this.union=function(a){this.min.x=
Math.min(this.min.x,a.min.x);this.min.y=Math.min(this.min.y,a.min.y);this.max.x=Math.max(this.max.x,a.max.x);this.max.y=Math.max(this.max.y,a.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new aa(a,b)}}function ma(a,b,c,d){this.data=a[d];this.right=this.left=null;b!=d&&(this.left=new ma(a,b,d-1,parseInt((b+(d-1))/2)));c!=d&&(this.right=new ma(a,d+1,c,parseInt((c+(d+1))/2)));this.subtree=[];for(d=b;d<=c;d++)this.subtree.push(a[d]);
this.subtree.sort(function(a,b){return a.y-b.y});this.yrange=function(a,b,c){return a.y_in(this.subtree[b])&&a.y_in(this.subtree[c])};this.subquery=function(a,b,c,d,f){if(this.yrange(b,c,d))for(b=c;b<=d;b++)a.push(this.subtree[b]);else b.y_in(this.subtree[f])&&a.push(this.subtree[f]),b.y_left(this.subtree[f])?f!=d&&this.subquery(a,b,f+1,d,parseInt((d+(f+1))/2)):(b.x_right(this.subtree[f])||f!=d&&this.subquery(a,b,f+1,d,parseInt((d+(f+1))/2)),f!=c&&this.subquery(a,b,c,f-1,parseInt((c+(f-1))/2)))};
this.search=function(d,h){h.x_in(a[b])&&h.x_in(a[c])?this.subquery(d,h,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2)):(h.contains(this.data)&&d.push(this.data),h.x_left(this.data)?this.right&&this.right.search(d,h):h.x_right(this.data)?this.left&&this.left.search(d,h):(this.left&&this.left.search(d,h),this.right&&this.right.search(d,h)))}}function Ca(a){a.sort(function(a,c){return a.x-c.x});this.root=new ma(a,0,a.length-1,parseInt((a.length-1)/2));this.search=function(a,c){var d=new aa(a,
c),e=[];this.root.search(e,d);return e}}function na(a){w||(w=B(y+"shaders/point"),Da=Y(y+"images/circle.png"));this.id=N();var b=new L(a);b.create("vert",2);b.create("unit",2);b.create("color",3);b.create("alpha",1);var c=this,d=function(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=N();var d=new vect(a.geom[0][0],a.geom[0][1]);this.bounds=new aa(d.clone(),d.clone());var e,h,d=0,f={};F(f,a.style,"fill",X);F(f,a.style,"opacity",
parseFloat);var g=function(){var a=f.fill;a||(a=c.style("fill"));a||(a=Ta);b.repeat("color",a.array,e,h)},m=function(){var a=f.opacity;a||(a=c.style("opacity"));a||(a=Ua);b.repeat("alpha",[a],e,h)};this.style=function(a,b){if(1==arguments.length)return f[a];f[a]=b;"fill"==a&&g();"opacity"==a&&m()};d=this.geom.length;h=6*d;e=b.alloc(h);$.each(this.geom,function(a,c){b.repeat("vert",c,e+6*a,6);b.write("unit",Va,e+6*a,6)});g();m()},e=null,h=0,g=!1,m={},f={};this.bounds=null;this.append=function(a){a=
new d(a);for(key in a.attr)m[key]=!0;f[a.id]=a;h++;g=!0;e=null;this.bounds?this.bounds.union(a.bounds):this.bounds=a.bounds.clone();return a};this.features=function(){var a=[];for(key in f)a.push(f[key]);return new G(a)};this.attr=function(){var a=[];for(key in m)a.push(key);return a};this.search=function(a){a=e.search(a.min,a.max);var b=[];$.each(a,function(a,c){b.push(f[c.key])});return new G(b)};this.mouseover=function(){};this.mouseout=function(){};this.click=function(){};this.style=function(a,
b){if(1<arguments.length)throw"Not Implemented";return null};this.update_move=function(){};this.draw=function(a,c,d){b.update(c);if(0<h){if(g){if(!e){var m=[],k;for(k in f)$.each(f[k].geom,function(a,b){m.push({key:k,x:b[0],y:b[1]})});e=new Ca(m)}g=!1}gl.useProgram(w);w.data("screen",a.camera.mat3);w.data("pos",b.get("vert"));w.data("circle_in",b.get("unit"));d||(w.data("color_in",b.get("color")),w.data("alpha_in",b.get("alpha")),w.data("select",d),w.data("aspect",a.canvas.width()/a.canvas.height()),
w.data("pix_w",2/a.canvas.width()),w.data("rad",5),w.data("glyph",Da),w.data("zoom",1/a.camera.level),gl.drawArrays(gl.TRIANGLES,0,b.count()))}}}function oa(a){function b(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=N();var b,c,d,e=0,h=function(){var a;a="fill"in j?j.fill:f.style("fill");g.repeat("color",a.array,b,c);a="stroke"in j?j.stroke:f.style("stroke");m.repeat("color",a.array,d,e)},p=function(){var a;a="fill-opacity"in
j?j["fill-opacity"]:f.style("fill-opacity");g.repeat("alpha",[a],b,c);a="stroke-opacity"in j?j["stroke-opacity"]:f.style("stroke-opacity");m.repeat("alpha",[a],d,e)},l=[];c=0;$.each(this.geom,function(a,b){for(var d,e=0;100>e;)try{for(var h=b,f=[],g=0;g<h.length;g++){for(var m=[],p=1;p<h[g].length;p++)m.push(Ea(h[g][p][0],h[g][p][1]));m.push(f[0]);f.push(m)}d=Sa(f)}catch(fa){e++}100==e&&console.log("rendering polygon failed");c+=d.length/2;l.push(d)});var k=new vect(Infinity,Infinity),x=new vect(-Infinity,
-Infinity);$.each(this.geom,function(a,b){$.each(b,function(a,b){$.each(b,function(a,b){b[0]<k.x&&(k.x=b[0]);b[0]>x.x&&(x.x=b[0]);b[1]<k.y&&(k.y=b[1]);b[1]>x.y&&(x.y=b[1])})})});this.bounds=new aa(k,x);var r=b=g.alloc(c);$.each(l,function(a,b){var c=b.length/2;g.write("vert",b,r,c);r+=c});d=m.count();$.each(this.geom,function(a,b){for(a=0;a<b.length;a++)e+=6*b[a].length,Fa(m,b[a])});var j={};F(j,a.style,"fill",X);F(j,a.style,"stroke",X);F(j,a.style,"fill-opacity",parseFloat);F(j,a.style,"stroke-opacity",
parseFloat);this.style=function(a,b){if(1==arguments.length)return j[a];j[a]=b;"fill"==a&&h();"stroke"==a&&h();"fill-opacity"==a&&p();"stroke-opacity"==a&&p()};h();p()}a||(a={});a.style||(a.style={});var c,d,e,h;c="fill"in a.style?a.style.fill:new t(0.02,0.44,0.69,1);d="stroke"in a.style?a.style.stroke:new t(0.02,0.44,0.69,1);e="fill-opacity"in a.style?a.style["fill-opacity"]:0.5;h="stroke-opacity"in a.style?a.style["stroke-opacity"]:1;O||(O=B(y+"shaders/poly"));u||(u=B(y+"shaders/line"));this.id=
N();var g=new L(1024);g.create("vert",2);g.create("color",3);g.create("alpha",1);var m=new L(1024);m.create("vert",2);m.create("norm",2);m.create("color",3);m.create("alpha",1);var f=this,p={},l=0,r=null;this.features=function(){var a=[];for(key in p)a.push(p[key]);return new G(a)};this.search=function(a){a=r.search(a.min,a.max);var b={};$.each(a,function(a,c){b[c.key]=!0});a=[];for(var c in b)a.push(p[c]);return new G(a)};this.contains=function(a){var b=0,c=[],d;for(d in p){var e=p[d];if(e.bounds.contains(a)){b++;
for(var h=0;h<e.geom.length;h++){var f=0;$.each(e.geom[h],function(b,c){for(var d=0;d<c.length;d++){var e=(d+1)%c.length;if(0>(a.y-c[d][1])/(a.y-c[e][1])){var h=new vect(720,a.y),g=new vect(c[d][0],c[d][1]),e=new vect(c[e][0],c[e][1]);vect.intersects(a,h,g,e)&&f++}}});1==f%2&&c.push(e)}}}return new G(c)};this.aggregate=function(a,b){a.features().each(function(a,c){$.each(c.geom,function(a,d){var e=f.contains(new vect(d[0],d[1]));e&&b(e,c)})})};this.bounds=null;var k=!1;this.append=function(a){a=new b(a);
this.bounds?this.bounds.union(a.bounds):this.bounds=a.bounds.clone();p[a.id]=a;l++;k=!0;r=null};this.style=function(a,b){if(1<arguments.length)throw"Not Implemented";return"fill"==a?c:"stroke"==a?d:"fill-opacity"==a?e:"stroke-opacity"==a?h:null};var j=null,s=null;this.mouseover=function(a){j=a};this.mouseout=function(a){s=a};var x={};this.update_move=function(a,b){if(j||s){var c=this.contains(b),d={};c&&c.each(function(a,b){d[b.id]=b});for(var e in x)!(e in d)&&s&&s(x[e]);for(e in d)!(e in x)&&j&&
j(d[e]);x=d}};this.force_out=function(){for(var a in x)s&&s(x[a]);x={}};this.draw=function(a,b,c){if(!c){g.update(b);m.update(b);if(k){var d=[],e;for(e in p)$.each(p[e].geom,function(a,b){$.each(b,function(a,b){$.each(b,function(a,b){d.push({key:e,x:b[0],y:b[1]})})})});r=new Ca(d);k=!1}gl.useProgram(O);O.data("screen",a.camera.mat3);O.data("pos",g.get("vert"));O.data("color_in",g.get("color"));O.data("alpha_in",g.get("alpha"));gl.drawArrays(gl.TRIANGLES,0,g.count());gl.useProgram(u);u.data("screen",
a.camera.mat3);u.data("pos",m.get("vert"));u.data("norm",m.get("norm"));u.data("color_in",m.get("color"));u.data("alpha_in",m.get("alpha"));u.data("px_w",2/a.canvas.width());u.data("px_h",2/a.canvas.height());gl.drawArrays(gl.TRIANGLES,0,m.count())}}}function Fa(a,b){for(var c=a.alloc(6*b.length),d=0,e=function(){if(b[d]){var a=new vect(b[d][0],b[d][1]);d++;return a}return null},h=[],g=[],m=function(a,b,c,d){d?(a[c]=-b.x,a[c+1]=-b.y):(a[c]=b.x,a[c+1]=b.y)},f=function(a,b,c,d){m(a,b,0,!1);m(a,c,2,
!1);m(a,b,4,d);m(a,c,6,d);m(a,b,8,d);m(a,c,10,!1)},p=e(),l=e(),j=e(),k=vect.dir(l,p).rotate(pa/2),n,s=c;l;)n=j?vect.dir(j,p).rotate(pa/2):vect.dir(l,p).rotate(pa/2),f(h,p,l,!1),f(g,k,n,!0),a.write("vert",h,s,6),a.write("norm",g,s,6),s+=6,p=l,l=j,j=e(),k=n;return c}function Ga(){function a(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=N();var b,e=0,f=function(){var a;a="stroke"in l?l.stroke:d.style("stroke");c.repeat("color",a.array,
b,e)},p=function(){var a;a="stroke-opacity"in l?l["stroke-opacity"]:d.style("stroke-opacity");c.repeat("alpha",[a],b,e)};b=c.count();Fa(c,this.geom);var e=6*this.geom.length,l={};F(l,a.style,"fill",X);F(l,a.style,"stroke",X);F(l,a.style,"fill-opacity",parseFloat);F(l,a.style,"stroke-opacity",parseFloat);this.style=function(a,b){if(1==arguments.length)return l[a];l[a]=b;"fill"==a&&f();"stroke"==a&&f();"fill-opacity"==a&&p();"stroke-opacity"==a&&p()};f();p()}var b=new t(0.02,0.44,0.69,1);u||(u=B(y+
"shaders/line"));this.id=N();var c=new L(1024);c.create("vert",2);c.create("norm",2);c.create("unit",2);c.create("color",3);c.create("alpha",1);var d=this,e=0;this.append=function(b){b=new a(b);for(key in b.attr);e++;return b};this.style=function(a,c){if(1<arguments.length)throw"Not Implemented";return"stroke"==a?b:"stroke-opacity"==a?1:null};this.draw=function(a,b){c.update(b);0<e&&(gl.useProgram(u),u.data("screen",a.camera.mat3),u.data("pos",c.get("vert")),u.data("norm",c.get("norm")),u.data("color_in",
c.get("color")),u.data("alpha_in",c.get("alpha")),u.data("px_w",2/a.canvas.width()),u.data("px_h",2/a.canvas.height()),gl.drawArrays(gl.TRIANGLES,0,c.count()))}}function qa(a){D||(D=B(y+"shaders/grid"));a||(a={});a.style||(a.style={});var b=a.lower,c=a.upper,d=a.rows,e=a.cols,h=(c.x-b.x)/e,g=(c.y-b.y)/d,m=new Float32Array(d*e),f=new Uint8Array(4*e*d),p=!1,l=new L(6);l.create("vert",2);l.create("screen",2);l.create("tex",2);var j=new vect(b.x,b.y),k=new vect(c.x,c.y),n=new vect(0,0),s=new vect(1,1),
x=l.alloc(6);l.write("vert",v(j,k),x,6);l.write("screen",v(new vect(-1,-1),new vect(1,1)),x,6);l.write("tex",v(n,s),x,6);var fa=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,fa);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);this.lower=function(){return b.clone()};
this.upper=function(){return c.clone()};this.rows=function(){return d};this.cols=function(){return e};this.centroid=function(a,c){return new vect(b.x+h*c+h/2,b.y+g*a+g/2)};this.get=function(a,b){return m[e*a+b]};var q=-Infinity,t=Infinity;this.qunatiles=function(a,b){b||(b=function(a,b){return a-b});for(var c=[],d=0;d<m.length;d++)c.push(m[d]);c.sort(b);for(var e=[-Infinity],d=1;d<a;d++){var f=parseInt(inc*d);e.push(c[f])}e.push(Infinity);return e};this.set=function(a,b,c){if(a>=d||b>=e)throw"Index Out of Bounds";
m[e*a+b]=c;p=!0};this.raw_set=function(a,b){if(a>=d*e)throw"Index Out of Bounds: "+a;m[a]=b;p=!0};this.clear=function(a){for(var b=0;b<d*e;b++)m[b]=a};var M=null;this.draw=function(b){M||(M=b.framebuffer());l.update();if(p){q=-Infinity;t=Infinity;for(var c=0;c<d*e;c++){var h=m[c];h>q&&(q=h);h<t&&(t=h)}for(c=0;c<d*e;c++){var h=c,g=a.map(t,q,m[c]);f[4*h]=parseInt(255*g.r);f[4*h+1]=parseInt(255*g.g);f[4*h+2]=parseInt(255*g.b);f[4*h+3]=parseInt(255*g.a)}gl.bindTexture(gl.TEXTURE_2D,fa);gl.texImage2D(gl.TEXTURE_2D,
0,gl.RGBA,e,d,0,gl.RGBA,gl.UNSIGNED_BYTE,f);gl.bindTexture(gl.TEXTURE_2D,null);p=!1}a.style.antialias&&M.activate({blend:!1});gl.useProgram(D);D.data("screen",b.camera.mat3);D.data("pos",l.get("vert"));D.data("tex_in",l.get("tex"));D.data("sampler",fa);c=vect.sub(b.camera.screen(k),b.camera.screen(j));D.data("width",c.x);D.data("height",-c.y);D.data("rows",d);D.data("cols",e);D.data("blur",a.blur);gl.drawArrays(gl.TRIANGLES,0,l.count());a.style.antialias&&(M.deactivate(),b.draw_blur(M.tex))}}function Wa(a,
b,c){P||(P=B(y+"shaders/raster"));this.image=Y(a);var d=I(v(new vect(0,1),new vect(1,0)),2),e=I(v(b,c),2);this.draw=function(a,b,c){c||(gl.useProgram(P),P.data("screen",a.camera.mat3),P.data("pos",e),P.data("tex_in",d),P.data("sampler",this.image),gl.drawArrays(gl.TRIANGLES,0,e.numItems))}}function ra(a){A||(A=B(y+"shaders/hillshade"));var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),d=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));
a=$(a).find("GroundOverlay Icon href").text();var e=!1,h=Y(a,function(){e=!0});this.ready=function(){return e};var g=I(v(new vect(0,1),new vect(1,0)),2),m=I(v(c,d),2),f=315;this.draw=function(a){if(e){for(gl.useProgram(altitude_shader);1<=f;)f-=1;altitude_shader.data("azimuth",f);altitude_shader.data("altitude",Math.PI/4/(2*Math.PI));altitude_shader.data("screen",a.camera.mat3);altitude_shader.data("pos",m);altitude_shader.data("tex_in",g);altitude_shader.data("elevation",h);a=vect.sub(a.camera.screen(d),
a.camera.screen(c));altitude_shader.data("pix_w",1/a.x);altitude_shader.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,m.numItems);return f}}}function ra(a){A||(A=B(y+"shaders/hillshade"));var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),d=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=!1,h=Y(a,function(){e=!0});this.ready=function(){return e};var g=I(v(new vect(0,
1),new vect(1,0)),2),m=I(v(c,d),2),f=315;this.draw=function(a){if(e){for(gl.useProgram(A);1<=f;)f-=1;A.data("azimuth",f);A.data("altitude",Math.PI/4/(2*Math.PI));A.data("screen",a.camera.mat3);A.data("pos",m);A.data("tex_in",g);A.data("elevation",h);a=vect.sub(a.camera.screen(d),a.camera.screen(c));A.data("pix_w",1/a.x);A.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,m.numItems);return f}}}function ga(a){for(var b=[],c=[],d=0;25>d;d++)c.push(new ka);for(d=0;d<a.levels;d++){var e=n(a);"file"==e.source&&
(e.url+="/"+a.size*Math.pow(2,d+1));e.min=new vect(-180,-90);e.rows=Math.pow(2,d);e.cols=2*e.rows;e.cellsize=180/e.rows;e.z_index=1-sa-d/1E3;e.available=c;e=new Xa(e);b.push(e)}sa+=(a.levels+2)/1E3;b[0].fetch_all();b[0].noexpire(!0);var h=new L(6*ba);h.create("vert",3);h.create("tex",2);h.create("lookup",1);h.alloc(6*ba);this.draw=function(c,d){Ha=Ia=0;for(var e=Infinity,p=b[0],l,j=0;j<b.length;j++){var k=a.size*b[j].cols/b[j].size(c).x;1>k&&(k=1/k);k<e&&(e=k,p=b[j],l=j)}for(j=l;0<=j;j--)b[j].fetch();
gl.useProgram(E);E.data("screen",c.camera.mat3);if(p.ready())p.draw(c,d,h,0,!0);else{c.enable_z();e=0;for(j=l;0<=j;j--)e=b[j].draw(c,d,h,e,0==j);c.disable_z()}$.each(b,function(a,b){b.cull()})}}function Xa(a){a||(a={});a.desaturate||(a.desaturate=0);a.darken||(a.darken=0);a.hue||(a.hue=0);a.hue_color||(a.hue_color=ua(0,0,0,1));if(!a.available){a.available=[];for(var b=0;8>b;b++)a.available.push(new ka)}E||(E=B(y+"shaders/tile"));var c=a.url,d=a.min,e=a.rows,h=a.cols,g=a.cellsize;this.rows=e;this.cols=
h;for(var m={},f={},j=function(b,c){var e=new vect(d.x+b*g,d.y+c*g),j=new vect(d.x+(b+1)*g,d.y+(c+1)*g),e={vert:v(e,j,a.z_index),tex:null,i:b,j:c,id:b+h*c,ready:!1,min:e,max:j};f[b][c]=e;m[e.id]=e},b=0;b<h;b++)f[b]={};this.size=function(a){var b=a.camera.screen(d);a=a.camera.screen(vect.add(d,new vect(g*h,g*e)));b=vect.sub(a,b);b.y=Math.abs(b.y);return b};var l=!1;this.noexpire=function(a){l=a};this.cull=function(){if(!l){var b=(new Date).getTime(),c;for(c in n)if(b-n[c]>Ya){var d=m[c];delete m[c];
delete f[d.i][d.j];a.available.push(d.tex);d.tex=null;d.ready=!1;delete n[c]}}};var k=function(){var a=engine.camera.project(new vect(engine.canvas.offset().left,engine.canvas.offset().top+engine.canvas.height())),b=engine.camera.project(new vect(engine.canvas.offset().left+engine.canvas.width(),engine.canvas.offset().top)),c=Math.floor((a.x-d.x)/g),e=Math.ceil((b.x-d.x)/g),a=Math.floor((a.y-d.y)/g),b=Math.ceil((b.y-d.y)/g);return{min_col:c,max_col:e,min_row:a,max_row:b}},n={};this.ready=function(){for(var a=
k(),b=Math.max(0,a.min_col);b<Math.min(h,a.max_col);b++)for(var c=Math.max(0,a.min_row);c<Math.min(e,a.max_row);c++)if(!f[b][c]||!f[b][c].ready)return!1;return!0};var q=function(b,d){if(!f[b][d].tex){var e;if("file"==a.source)e=c+"/"+f[b][d].id+".png";else if("wms"==a.source){e={service:"wms",version:"1.1.0",request:"GetMap",layers:a.layer,bbox:[f[b][d].min.x,f[b][d].min.y,f[b][d].max.x,f[b][d].max.y].join(),width:a.size,height:a.size,srs:"EPSG:4326",format:"image/png",transparent:"true"};var h=[],
g;for(g in e)h.push(g+"="+e[g]);e=c+"?"+h.join("&")}f[b][d].tex=a.available.pop();f[b][d].tex||(f[b][d].tex=new ka);g=e;var m=f[b][d],j=new Image;j.crossOrigin="";j.onload=function(){m.tex&&(m.tex.image(j),m.ready=!0)};j.src=g}};this.fetch_all=function(){for(var a=(new Date).getTime(),b=0;b<h;b++)for(var c=0;c<e;c++)f[b][c]||j(b,c),f[b][c].tex||q(b,c),n[f[b][c].id]=a};this.fetch=function(){for(var a=k(),b=(new Date).getTime(),c=Math.max(0,a.min_col-1);c<Math.min(h,a.max_col+1);c++)for(var d=Math.max(0,
a.min_row-1);d<Math.min(e,a.max_row+1);d++)f[c][d]||j(c,d),f[c][d].tex||q(c,d),n[f[c][d].id]=b};this.draw=function(b,c,d,g,m){b=function(){Ha++;d.update();E.data("pos",d.get("vert"));E.data("tex_in",d.get("tex"));E.data("lookup_in",d.get("lookup"));E.data("desaturate",a.desaturate);E.data("darken",a.darken);E.data("hue",a.hue);E.data("hue_color",a.hue_color.array);gl.drawArrays(gl.TRIANGLES,0,6*g)};c=k();for(var j=(new Date).getTime(),l=Math.max(0,c.min_col);l<Math.min(h,c.max_col);l++)for(var p=
Math.max(0,c.min_row);p<Math.min(e,c.max_row);p++)if(f[l][p]&&f[l][p].ready&&f[l][p].tex){d.write("vert",f[l][p].vert,6*g,6);d.write("tex",v(new vect(0,0),new vect(1,1)),6*g,6);d.repeat("lookup",[g/ba+1/(2*ba)],6*g,6);n[f[l][p].id]=j;E.data("sampler"+g,f[l][p].tex);if(null==f[l][p].tex)throw"bad";g++;Ia++;g>=ba&&(b(),g=0)}m&&b();return g}}var y="",V=jQuery,Za=function(a){if("string"===typeof a.data){var b=a.handler,c=a.data.toLowerCase().split(" ");a.handler=function(a){if(!(this!==a.target&&(/textarea|select/i.test(a.target.nodeName)||
"text"===a.target.type))){var e="keypress"!==a.type&&V.hotkeys.specialKeys[a.which],h=String.fromCharCode(a.which).toLowerCase(),g="",m={};a.altKey&&"alt"!==e&&(g+="alt+");a.ctrlKey&&"ctrl"!==e&&(g+="ctrl+");a.metaKey&&(!a.ctrlKey&&"meta"!==e)&&(g+="meta+");a.shiftKey&&"shift"!==e&&(g+="shift+");e?m[g+e]=!0:(m[g+h]=!0,m[g+V.hotkeys.shiftNums[h]]=!0,"shift+"===g&&(m[V.hotkeys.shiftNums[h]]=!0));e=0;for(h=c.length;e<h;e++)if(m[c[e]])return b.apply(this,arguments)}}}};V.hotkeys={version:"0.8",specialKeys:{8:"backspace",
9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",
191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}};V.each(["keydown","keyup","keypress"],function(){V.event.special[this]={add:Za}});var K=jQuery,ta=function(a){var b=a||window.event,c=[].slice.call(arguments,1),d=0,e=0,h=0;a=K.event.fix(b);a.type="mousewheel";b.wheelDelta&&(d=b.wheelDelta/120);b.detail&&(d=-b.detail/3);h=d;void 0!==
b.axis&&b.axis===b.HORIZONTAL_AXIS&&(h=0,e=-1*d);void 0!==b.wheelDeltaY&&(h=b.wheelDeltaY/120);void 0!==b.wheelDeltaX&&(e=-1*b.wheelDeltaX/120);c.unshift(a,d,e,h);return(K.event.dispatch||K.event.handle).apply(this,c)},W=["DOMMouseScroll","mousewheel"];if(K.event.fixHooks)for(var Q=W.length;Q;)K.event.fixHooks[W[--Q]]=K.event.mouseHooks;K.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=W.length;a;)this.addEventListener(W[--a],ta,!1);else this.onmousewheel=ta},teardown:function(){if(this.removeEventListener)for(var a=
W.length;a;)this.removeEventListener(W[--a],ta,!1);else this.onmousewheel=null}};K.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}});for(var Ja=0,Q=["ms","moz","webkit","o"],ca=0;ca<Q.length&&!window.requestAnimationFrame;++ca)window.requestAnimationFrame=window[Q[ca]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[Q[ca]+"CancelAnimationFrame"]||window[Q[ca]+"CancelRequestAnimationFrame"];
window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-Ja)),d=window.setTimeout(function(){a(b+c)},c);Ja=b+c;return d});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});var pa=3.14159265,F=function(a,b,c,d){c in b&&(a[c]=d?d(b[c]):b[c])},Pa=!1;gl=null;var xa=0,la="http://eland.ecohealthalliance.org:8080/wigglemaps",S={x:0,y:0},z=null,ya=null,Z=null,N,Ka=1;N=function(){var a=Ka;Ka++;return a};var Ea;
Ea=function(a,b){return new vect(a+1E-6*Math.random()-5E-7,b+1E-6*Math.random()-5E-7)};var w=null,Da,Va=va(0,0,1,1),Ta=new t(0.02,0.44,0.69,1),Ua=1,O=null,u,D=null,G=function(a){var b=null;this.length=a.length;this.count=function(){return a.length};this.attr=function(b){return a.length?a[0].attr[b]:null};this.get=function(b){return a[b]};this.subset=function(b){for(var c=[],h=0;h<b.length;h++)c.push(a[b[h]]);return new G(c)};this.id=function(c){if(!b){b={};for(var e=0;e<a.length;e++)b[a[e].id]=a[e]}return c in
b?b[c]:null};this.each=function(b){for(var c=0;c<a.length;c++)b(c,a[c]);return this};var c={">":function(a,b){return a>b},"<":function(a,b){return a<b},"==":function(a,b){return a==b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b}};this.select=function(b){if(b.match(/^\s*\*\s*$/))return new G(a);var e=b.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!e)throw"Bad Selector";b=e[1];var h=e[2],g=null,m=null;isNaN(e[3])?m=e[3]:g=parseFloat(e[3]);new_elem=[];if(m)for(e=0;e<a.length;e++)c[h](a[e].attr[b],
a[e].attr[m])&&new_elem.push(a[e]);else for(e=0;e<a.length;e++)c[h](a[e].attr[b],g)&&new_elem.push(a[e]);return new G(new_elem)};this.filter=function(b){for(var c=[],h=0;h<a.length;h++)b(a[h])&&c.push(a[h]);return new G(c)};this.quantile=function(b,c,h){a.sort(function(a,c){return a.attr[b]-c.attr[b]});var g=Math.round(c*this.length/h);c=Math.round((c-1)*this.length/h);return new G(a.slice(c,g))};this.range=function(b){for(var c=Infinity,h=-Infinity,g=0;g<a.length;g++)c>a[g].attr[b]&&(c=a[g].attr[b]),
h<a[g].attr[b]&&(h=a[g].attr[b]);return{min:c,max:h}};this.style=function(b,c){if(1==arguments.length){var h=[];$.each(a,function(a,c){h.push(c.style(b))});return h}if("function"==typeof c)$.each(a,function(a,f){f.style(b,c(f))});else{var g;a:if(null==c||void 0==c.length)g=!1;else{for(g=0;g<c.length;g++)if(!(g in c)){g=!1;break a}g=!0}g?$.each(a,function(a,f){f.style(b,c[a])}):$.each(a,function(a,f){f.style(b,c)})}return this}},P=null,A=null,R=null,A=null,Ya=1E3,sa=0,ba=8,Ia=0,Ha=0,E=null,La=[];window.wiggle=
{Map:function(a,b){engine=new Oa(a,b);this.center=function(a,b){engine.camera.position(new vect(a,b))};this.vcenter=function(a){this.center(a.x,a.y)};this.extents=function(a){engine.camera.extents(a)};this.append=function(a){engine.scene.push(a)};this.remove=function(a){for(var b=0;b<engine.scene.length;b++)if(engine.scene[b]==a)return engine.scene.splice(b,1),!0;return!1};this.shade=function(a){a=new ra(a);engine.shade=a};this.select=function(a){a?(engine.sel.select(a),engine.select(!0)):engine.select(!1)};
this.resize=function(){engine.resize()};this.attr=function(a,b){engine.attr(a,b)};this.png=function(){var a=engine.canvas.get(0).toDataURL();$.ajax({url:"../server/export.png",type:"POST",data:a})};this.width=function(){return engine.canvas.innerWidth()};this.height=function(){return engine.canvas.innerHeight()};var c=null;this.click=function(a){c=a};engine.canvas.click(function(a){c&&(a=new vect(a.pageX,a.pageY),a=engine.camera.project(a),c(a))})},layer:{PointLayer:na,LineLayer:Ga,PolygonLayer:oa,
Grid:qa,Hillshade:ra,Elevation:function(a){R||(R=B(y+"shaders/elevation"));var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),d=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=Y(a),h=I(v(new vect(0,1),new vect(1,0)),2),g=I(v(c,d),2);this.draw=function(a,b,j){j||(gl.useProgram(R),R.data("screen",a.camera.mat3),R.data("pos",g),R.data("tex_in",h),R.data("elevation",
e),vect.sub(a.camera.screen(d),a.camera.screen(c)),gl.drawArrays(gl.TRIANGLES,0,g.numItems))}}},io:{Shapefile:function(a){var b=a.path;$.ajax({url:b+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(c){for(var d=[],e=100;e<c.length;)d.push(2*ia(c,e)),e+=8;$.ajax({url:b+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(b){for(var c=[],e=[],f=0;f<d.length;f++){var j=d[f];ia(b,j);ia(b,j+4);var l=j+8,k=H(b,l);if(0==k)console.log("NULL Shape");else if(1==k)k=da(b,
l+4),l=da(b,l+12),c.push({attr:{},geom:[[k,l]]});else if(5==k){for(var k=H(b,l+36),l=H(b,l+40),n=j+52,j=j+52+4*k,q=[],s=0;s<k;s++){var t=H(b,n+4*s),u;u=s+1<k?H(b,n+4*(s+1)):l;var v=j,y=[];for(u-=1;u>=t;u--){var M=da(b,v+16*u),z=da(b,v+16*u+8);y.push([M,z])}q.push(y)}e.push({attr:{},geom:[q]})}else throw"Not Implemented: "+k;}if(0<c.length){var w=new na(c.length);$.each(c,function(a,b){w.append(b)});b=w}else 0<e.length?(w=new oa(a),$.each(e,function(a,b){for(var c=0;100>c;)try{w.append(b),c=101}catch(d){c++}100==
c&&console.log("rendering polygon failed")}),b=w):b=void 0;a.success(b)}})}})},GeoJSON:function(a,b){for(var c=0,d=0,e=0,h=[],g=[],j=[],f=0;f<a.features.length;f++){var k=a.features[f];if("Feature"==k.type){"Point"==k.geometry.type&&(c++,h.push({geom:[k.geometry.coordinates],attr:k.properties}));"MultiPoint"==k.geometry.type&&(c+=k.geometry.cooordinates.length,h.push({geom:k.geometry.coordinates,attr:k.properties}));if("Polygon"==k.geometry.type){for(var l=k.geometry.coordinates,n=[],q=0;q<=l.length-
1;q++){for(var t=[],s=l[q].length-1;0<=s;s--)t.push(l[q][s]);n.push(t)}d++;g.push({geom:[n],attr:k.properties})}if("MultiPolygon"==k.geometry.type){var u=[];$.each(k.geometry.coordinates,function(a,b){for(var c=[],d=0;d<=b.length-1;d++){for(var e=[],f=b[d].length-1;0<=f;f--)e.push(b[d][f]);c.push(e)}u.push(c)});d++;g.push({geom:u,attr:k.properties})}"MultiLineString"==k.geometry.type&&$.each(k.geometry.coordinates,function(a,b){e++;j.push({geom:b,attr:k.properties})})}}if(0<c){var v=new na(c);$.each(h,
function(a,b){v.append(b)});return v}if(0<d)return v=new oa(b),$.each(g,function(a,b){for(var c=0;100>c;)try{v.append(b),c=101}catch(d){c++}100==c&&console.log("rendering polygon failed")}),v;if(0<e){var w=new Ga;$.each(j,function(a,b){w.append(b)});return w}},KML:function(a){var b=$(a).find("LatLonBox"),c=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),b=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();
return new Wa(y+a,c,b)},SparseGrid:function(a,b){var c=ea(a,0),d=ea(a,4),e=H(a,8),h=H(a,12),g=ea(a,16),j={};for(key in b)j[key]=b[key];j.lower=new vect(c,d);j.upper=new vect(c+g*e,d+g*h);j.rows=h;j.cols=e;c=new qa(j);for(d=20;d<a.length;){for(var g=H(a,d),e=H(a,d+4),h=d+4,j=e,f=0;f<j;f++){var k=ea(a,h+4*f);c.raw_set(g+f,k)}d+=8+4*e}return c},AsciiGrid:function(a,b){var c=a.split("\n"),d=c.splice(0,6),e=parseInt(d[0].slice(14)),h=parseInt(d[1].slice(14)),g=parseFloat(d[2].slice(14)),j=parseFloat(d[3].slice(14)),
f=parseFloat(d[4].slice(14)),d=d[5].slice(14),k={};for(key in b)k[key]=b[key];k.lower=new vect(g,j);k.upper=new vect(g+f*e,j+f*h);k.rows=h;k.cols=e;g=new qa(k);for(j=0;j<h;j++){f=c[j].split(" ");for(k=0;k<e;k++)f[k]==d?g.set(h-1-j,k,NaN):g.set(h-1-j,k,parseFloat(f[k]))}return g},WMS:function(a){a=n(a);for(var b=["url","layer"],c=0;c<b.length;c++){var d=b[c];if(!(d in a))throw"Key "+d+" not found";}k(a,{levels:16,size:256});var b={source:"wms"},e;for(e in b)a[e]=b[e];return new ga(a)}},util:{fcolor:ua,
icolor:function(a,b,c,d){return new t(j(a/255,0,1),j(b/255,0,1),j(c/255,0,1),j(d/255,0,1))}},widget:{Slider:function(a,b,c){var d=function(a){if(a>=c)throw"Slider index out of bounds";return b.x/(c-1)*a},e=function(d){return d<=a.x?0:d>=a.x+b.x?c-1:Math.round((d-a.x)/b.x*(c-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",a.x).css("top",a.y).css("width",b.x).css("height",b.y);var h=!1,g=0,j=$("<div></div>").addClass("slider-box").css("position","relative").css("left",
-10).css("height",b.y).css("width",20).mousedown(function(){h=!0});this.tick=function(){return g};this.count=function(){return c};var f=function(){};this.change=function(a){f=a};var k=function(){};this.release=function(a){k=a};this.dragging=function(){return h};this.dom.append(j);this.set=function(a){a!=g&&f(a);g=a;var b=d(a);j.css("left",b-10);k(a)};$(document).bind("mouseup",function(){if(h){h=!1;var a=e(event.clientX);k(a)}});$(document).bind("mousemove",function(a){h&&(a=e(a.clientX),a!=g&&f(a),
g=a,a=d(a),j.css("left",a-10))})}},ready:function(a){La.push(a)}};$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(a,b){var c=/wigglemaps(\.min)?\.js/;$(b).attr("src").match(c)&&(y=$(b).attr("src").replace(c,""))});$.each(La,function(a,b){b()})})})();
