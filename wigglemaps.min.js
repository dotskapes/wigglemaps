function vect(g,j,n){this.x=g;this.y=j;this.z=n?n:0;this.add=function(g){this.x+=g.x;this.y+=g.y;this.z+=g.z};this.sub=function(g){this.x-=g.x;this.y-=g.y;this.z-=g.z};this.scale=function(g){this.x*=g;this.y*=g;this.z*=g;return this};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var g=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(0==g)return this;this.x/=g;this.y/=g;this.z/=g;return this};this.div=function(g){this.x/=g.x;this.y/=
g.y;this.z/=g.z};this.floor=function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return 0==this.x+this.y+this.z};this.dot=function(g){return this.x*g.x+this.y*g.y+this.z*g.z};this.cross=function(){throw"Need to reimplement";};this.rotate=function(g){var j=Math.cos(g);g=Math.sin(g);xp=j*this.x-g*this.y;yp=g*this.x+j*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}
vect.scale=function(g,j){return new vect(g.x*j,g.y*j,g.z*j)};vect.add=function(g,j){return new vect(g.x+j.x,g.y+j.y,g.z+j.z)};vect.sub=function(g,j){if(!g||!j)throw"Bad Vector";return new vect(g.x-j.x,g.y-j.y,g.z-j.z)};vect.dist=function(g,j){var n=j.x-g.x,p=j.y-g.y,q=j.z-g.z;return Math.sqrt(n*n+p*p+q*q)};vect.dir=function(g,j){var n=vect.sub(g,j);n.normalize();return n};vect.dot2d=function(g,j){return g.x*j.x+g.y*j.y};vect.cross=function(g,j){return g.x*j.y-g.y*j.x};
vect.left=function(g,j,n,p){p||(p=0);j=vect.sub(j,g);g=vect.sub(n,g);return vect.cross(j,g)>=-p};vect.intersects=function(g,j,n,p,q){q||(q=0);return vect.left(g,j,n,q)!=vect.left(g,j,p,q)&&vect.left(n,p,j,q)!=vect.left(n,p,g,q)};vect.intersect2dt=function(g,j,n,p){p=g.x*(p.y-n.y)+j.x*(n.y-p.y)+p.x*(j.y-g.y)+n.x*(g.y-j.y);return 0==p?Infinity:-(g.x*(n.y-j.y)+j.x*(g.y-n.y)+n.x*(j.y-g.y))/p};
vect.intersect2dpos=function(g,j,n,p){var q=g.x*(p.y-n.y)+j.x*(n.y-p.y)+p.x*(j.y-g.y)+n.x*(g.y-j.y);if(0==q)return Infinity;n=(g.x*(p.y-n.y)+n.x*(g.y-p.y)+p.x*(n.y-g.y))/q;j=vect.sub(j,g);j.scale(n);return vect.add(g,j)};vect.rotate=function(g,j){var n=Math.cos(j),p=Math.sin(j);xp=n*g.x-p*g.y;yp=p*g.x+n*g.y;return g=new vect(xp,yp,g.z)};vect.normalize=function(g){g=g.clone();var j=Math.sqrt(g.x*g.x+g.y*g.y+g.z*g.z);if(0==j)return g;g.x/=j;g.y/=j;g.z/=j;return g};
(function(){function g(a,c){for(var b in c)b in a||(a[b]=c[b])}function j(a){var c={};for(key in a)c[key]=a[key];return c}function n(a,c){for(key in c)a[key]=c[key]}function p(a,c,b){return Math.min(Math.max(a,c),b)}function q(a,c,b,d){1>=a&&1>=c&&1>=b&&1>=d?(this.r=a,this.g=c,this.b=b,this.a=d):(this.r=a/255,this.g=c/255,this.b=b/255,this.a=d/255);this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(255*this.r)+","+parseInt(255*
this.g)+","+parseInt(255*this.b)+")"}}function sa(a,c,b,d){return new q(p(a,0,1),p(c,0,1),p(b,0,1),p(d,0,1))}function Ia(a){if(null==a||void 0==a.length)return!1;for(var c=0;c<a.length;c++)if(!(c in a))return!1;return!0}function ga(a,c){return((a.charCodeAt(c)&255)<<24)+((a.charCodeAt(c+1)&255)<<16)+((a.charCodeAt(c+2)&255)<<8)+(a.charCodeAt(c+3)&255)}function D(a,c){return((a.charCodeAt(c+3)&255)<<24)+((a.charCodeAt(c+2)&255)<<16)+((a.charCodeAt(c+1)&255)<<8)+(a.charCodeAt(c)&255)}function Y(a,c){var b=
a.charCodeAt(c)&255,d=a.charCodeAt(c+1)&255,e=a.charCodeAt(c+2)&255,f=a.charCodeAt(c+3)&255,l=a.charCodeAt(c+4)&255,k=a.charCodeAt(c+5)&255,h=a.charCodeAt(c+6)&255,r=a.charCodeAt(c+7)&255,m=1-2*(r>>7),r=((r&127)<<4)+((h&240)>>4)-1023,b=(h&15)*Math.pow(2,48)+k*Math.pow(2,40)+l*Math.pow(2,32)+f*Math.pow(2,24)+e*Math.pow(2,16)+d*Math.pow(2,8)+b;return m*(1+b*Math.pow(2,-52))*Math.pow(2,r)}function Z(a,c){var b=a.charCodeAt(c)&255,d=a.charCodeAt(c+1)&255,e=a.charCodeAt(c+2)&255,f=a.charCodeAt(c+3)&255,
l=1-2*(f>>7),f=((f&127)<<1)+((e&254)>>7)-127,b=(e&127)*Math.pow(2,16)+d*Math.pow(2,8)+b;return l*(1+b*Math.pow(2,-23))*Math.pow(2,f)}function ta(a,c,b,d){return[a-b,c+d,a-b,c-d,a+b,c+d,a-b,c-d,a+b,c-d,a+b,c+d]}function t(a,c,b){return 2==arguments.length?[a.x,c.y,a.x,a.y,c.x,c.y,a.x,a.y,c.x,a.y,c.x,c.y]:[a.x,c.y,b,a.x,a.y,b,c.x,c.y,b,a.x,a.y,b,c.x,a.y,b,c.x,c.y,b]}function C(a,c){if(!a)return null;var b=a.createProgram(),d=ua(a,a.VERTEX_SHADER,c+"/vert.glsl"),e=ua(a,a.FRAGMENT_SHADER,c+"/frag.glsl");
a.attachShader(b,d);a.attachShader(b,e);a.linkProgram(b);var f={},d=(d.source+e.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg),e=0;a.useProgram(b);if(d){for(var l=0;l<d.length;l++){var k=d[l].split(" ");f[k[2]]={u:k[0],type:k[1],loc:null};if("uniform"==k[0])f[k[2]].loc=a.getUniformLocation(b,k[2]);else{var h=a.getAttribLocation(b,k[2]);f[k[2]].loc=h}"sampler2D"==k[1]&&(f[k[2]].tex=e,e++)}b.get=function(a){return f[a].loc};b.data=function(d,b){var c=f[d];if(!c)throw"Could not find shader variable "+
d;if("uniform"==c.u)if("float"==c.type)a.uniform1f(c.loc,b);else if("vec2"==c.type)a.uniform2fv(c.loc,b);else if("ivec2"==c.type)a.uniform2iv(c.loc,b);else if("vec3"==c.type)a.uniform3fv(c.loc,b);else if("ivec3"==c.type)a.uniform3iv(c.loc,b);else if("vec4"==c.type)a.uniform4fv(c.loc,b);else if("ivec4"==c.type)a.uniform4iv(c.loc,b);else if("bool"==c.type)a.uniform1i(c.loc,b);else if("mat4"==c.type)a.uniformMatrix4fv(c.loc,!1,b);else if("mat3"==c.type)a.uniformMatrix3fv(c.loc,!1,b);else if("sampler2D"==
c.type)"texture"in b&&(b=b.texture()),a.activeTexture(a["TEXTURE"+c.tex]),a.bindTexture(a.TEXTURE_2D,b),a.uniform1i(c.loc,c.tex);else if("int"==c.type)a.uniform1i(c.loc,b);else throw"Unsupported Type for Shader Helper: "+c.type;else if("attribute"==c.u)a.enableVertexAttribArray(c.loc),a.bindBuffer(a.ARRAY_BUFFER,b),a.vertexAttribPointer(c.loc,b.itemSize,a.FLOAT,!1,0,0);else throw"Type: "+c.u+" Recieved";}}return b}function ua(a,c,b){var d=a.createShader(c);$.ajax({async:!1,url:b,dataType:"text",success:function(b){a.shaderSource(d,
b);a.compileShader(d);if(!a.getShaderParameter(d,a.COMPILE_STATUS))throw a.getShaderInfoLog(d);d.source=b},error:function(){console.log("Could not load "+b)}});return d}function E(a,c,b){var d=a.createBuffer(),e=new Float32Array(c);a.bindBuffer(a.ARRAY_BUFFER,d);d.itemSize=b;d.numItems=c.length/b;a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return d}function ha(a,c,b){if(!a)return null;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);var e=new Float32Array(c*
b);d.itemSize=b;d.numItems=c;d.update=function(b,c){var e=new Float32Array(b);a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferSubData(a.ARRAY_BUFFER,4*c,e);a.bindBuffer(a.ARRAY_BUFFER,null)};a.bufferData(a.ARRAY_BUFFER,e,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return d}function aa(a,c,b){var d=a.createTexture();d.id=va;va++;var e=new Image;e.onload=function(){a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,
a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);b&&b()};e.src=c;return d}function ia(a,c){var b=j(c);g(b,{mag_filter:a.LINEAR,min_filter:a.LINEAR,wrap_s:a.CLAMP_TO_EDGE,wrap_t:a.CLAMP_TO_EDGE,mipmap:!1});var d=a.createTexture(),e=null;this.image=function(c){e=c;a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,
a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,b.mag_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,b.min_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,b.wrap_s);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,b.wrap_t);b.mipmap&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)};this.texture=function(){return e?d:null}}function Ja(a,c){var b=a.width()/a.height();c||(c={});"center"in c||(c.center=new vect(0,0));"extents"in c||(c.extents=
180);"v_extents"in c||(c.v_extents=c.extents/b);this.mat3=new Float32Array(9);this.mat3[0]=2/c.extents;this.mat3[4]=2/c.v_extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(b){b=new vect(2*(b.x-a.offset().left)/a.width()-1,-(2*(b.y-a.offset().top)/a.height()-1));b.x=b.x/this.mat3[0]-this.mat3[6]/this.mat3[0];b.y=b.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return b};this.screen=function(b){b=new vect(b.x*this.mat3[0]+this.mat3[6],b.y*this.mat3[4]+this.mat3[7]);b.x=
a.offset().left+a.width()*(b.x+1)/2;b.y=a.offset().top+a.height()*(-b.y+1)/2;return b};this.percent=function(b){return new vect(2*((b.x-a.offset().left)/a.width())-1,-(2*((b.y-a.offset().top)/a.height())-1))};this.pixel=function(b){return new vect(a.offset().left+(b.x+1)/2*a.width(),a.offset().top+(-b.y+1)/2*a.height())};this.move=function(a){this.mat3[6]-=a.x*this.mat3[0];this.mat3[7]-=a.y*this.mat3[4]};this.position=function(a){if(!a)return new vect(-this.mat3[6]/this.mat3[0],-this.mat3[7]/this.mat3[4]);
this.mat3[6]=-a.x*this.mat3[0];this.mat3[7]=-a.y*this.mat3[4]};this.position(c.center);this.extents=function(a,e){c.extents=a;c.v_extents=e?e:c.extents/b;var f=this.position();this.level=1;this.mat3[0]=2/c.extents;this.mat3[4]=2/c.v_extents;this.position(f)};this.zoom=function(a){var b=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=a;this.mat3[4]*=a;this.mat3[6]=b.x*this.mat3[0];this.mat3[7]=b.y*this.mat3[4];this.level*=a};this.reset=function(){this.zoom(1/this.level)};
this.reconfigure=function(){var c=this.position();this.mat3[4]/=b;b=a.width()/a.height();this.mat3[4]*=b;this.position(c)}}function Ka(a){var c=!1,b=new vect(0,0),d=new vect(0,0),e=null,f=0;a.canvas.mousedown(function(a){b=new vect(a.clientX,a.clientY);c=!0});$(window).bind("mouseup",function(){c=!1});$(document).bind("keypress","+",function(){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(){a.camera.reset()});a.canvas.bind("mousewheel",
function(b,c){c*=0.5;0>c?(c=-1*c+1,c=1/c):c+=1;a.camera.zoom(c);b.preventDefault()});var l=!0;this.disable=function(){l=!1};this.enable=function(){l=!0};this.update=function(k){d=new vect(ba.x,ba.y);if(c&&l){var h=vect.sub(a.camera.project(b),a.camera.project(d));a.camera.move(h);b=d;f=h.length()/k;e=h;e.normalize()}else 0.01<f&&e&&(a.camera.move(vect.scale(e,f*k)),f-=3*k*f)}}function ca(a){this.engine=a;this.views=[];this.update=function(a){for(var b=0;b<views.length;b++)this.views[b].update(a)};
this.view_factory=function(){throw"Not Implemented";};this.create=function(c,b){var d=this.view_factory(c,b,a);d.update_all();this.views.push(d);return d}}function ja(a,c,b){this.style_map={};this.update=function(d){var e=F.derivedStyle(a,c,b,d);if(null===e)throw"Style property does not exist";this.style_map[d](e)};this.update_all=function(){for(var a in this.style_map)this.update(a)}}function La(a,c){ca.call(this,a,c);a.shaders.point||(a.shaders.point=C(a.gl,y+"shaders/point"));var b=a.shaders.point,
d=10,e=new T(a.gl,Ma);e.create("vert",2);e.create("unit",2);e.create("stroke_width",1);e.create("rad",1);e.create("fill_color",3);e.create("fill",1);e.create("stroke_color",3);e.create("stroke",1);e.create("alpha",1);var f=function(b){ja.call(this,b,c,a);var f,h;this.style_map={fill:function(a){"none"==a?e.repeat("fill",[-0.75],f,h):(e.repeat("fill",[0.75],f,h),e.repeat("fill_color",a.array,f,h))},opacity:function(a){e.repeat("alpha",[a],f,h)},radius:function(a){a>d&&(d=a);e.repeat("rad",[a],f,h)},
stroke:function(a){"none"==a?e.repeat("stroke",[-0.75],f,h):(e.repeat("stroke",[0.75],f,h),e.repeat("stroke_color",a.array,f,h))},"stroke-width":function(a){e.repeat("stroke_width",[a],f,h)}};b=b.geom;h=6*b.length;f=e.alloc(h);$.each(b,function(a,b){e.repeat("vert",b,f+6*a,6);e.write("unit",Na,f+6*a,6)});this.update_all()};this.view_factory=function(a){return new f(a)};this.draw=function(){var c=a.gl;e.update();c.useProgram(b);b.data("screen",a.camera.mat3);b.data("pos",e.get("vert"));b.data("circle_in",
e.get("unit"));b.data("color_in",e.get("fill_color"));b.data("stroke_color_in",e.get("stroke_color"));b.data("alpha_in",e.get("alpha"));b.data("fill_in",e.get("fill"));b.data("stroke_in",e.get("stroke"));b.data("aspect",a.canvas.width()/a.canvas.height());b.data("pix_w",2/a.canvas.width());b.data("rad",e.get("rad"));b.data("stroke_width_in",e.get("stroke_width"));b.data("max_rad",d);c.drawArrays(c.TRIANGLES,0,e.count())}}function ka(a,c){ca.call(this,a,c);a.shaders.line||(a.shaders.line=C(a.gl,y+
"shaders/line"));var b=a.shaders.line,d=new T(a.gl,1024);d.create("vert",2);d.create("norm",2);d.create("width",2);d.create("color",3);d.create("unit",2);d.create("alpha",1);var e=function(b,e){ja.call(this,b,c,a);var k=d.count(),h=0;this.style_map={stroke:function(a){d.repeat("color",a.array,k,h)},"stroke-opacity":function(a){d.repeat("alpha",[a],k,h)},"stroke-width":function(a){d.repeat("width",[a],k,h)}};e||(e=b.geom);$.each(e,function(a,b){for(a=0;a<b.length;a++){h+=6*b[a].length;if(!(b[a][0][0]==
b[a][b[a].length-1][0]&&b[a][0][1]==b[a][b[a].length-1][1]))throw"Bad ring";Oa(d,b[a])}});this.update_all()};this.view_factory=function(a,b,c){return new e(a,b,c)};this.draw=function(){var c=a.gl;d.update();c.useProgram(b);b.data("screen",a.camera.mat3);b.data("pos",d.get("vert"));b.data("norm",d.get("norm"));b.data("color_in",d.get("color"));b.data("alpha_in",d.get("alpha"));b.data("circle_in",d.get("unit"));b.data("width_in",d.get("width"));b.data("px_w",2/a.canvas.width());b.data("px_h",2/a.canvas.height());
c.drawArrays(c.TRIANGLES,0,d.count())}}function Pa(a,c){ca.call(this,a,c);a.shaders.polygon||(a.shaders.polygon=C(a.gl,y+"shaders/poly"));var b=a.shaders.polygon,d=new ka(a,c),e=new T(a.gl,Qa);e.create("vert",2);e.create("color",3);e.create("alpha",1);var f=function(b){ja.call(this,b,c,a);d.create(b);var f,h;this.style_map={fill:function(a){e.repeat("color",a.array,f,h)},"fill-opacity":function(a){e.repeat("alpha",[a],f,h)}};b=b.geom;var r=[];h=0;$.each(b,function(a,b){for(var c,d=0;100>d;)try{for(var e=
b,f=[],l=0;l<e.length;l++){for(var m=[],k=1;k<e[l].length;k++)m.push(wa(e[l][k][0],e[l][k][1]));m.push(f[0]);f.push(m)}c=Ra(f);break}catch(g){d++}if(100==d)throw"Rendering Polygon Failed";h+=c.length/2;r.push(c)});var m=f=e.alloc(h);$.each(r,function(a,b){var c=b.length/2;e.write("vert",b,m,c);m+=c});this.update_all()};this.view_factory=function(a){return new f(a)};this.draw=function(){var c=a.gl;e.update();c.useProgram(b);b.data("screen",a.camera.mat3);b.data("pos",e.get("vert"));b.data("color_in",
e.get("color"));b.data("alpha_in",e.get("alpha"));c.drawArrays(c.TRIANGLES,0,e.count());d.draw()}}function Sa(a,c,b){ca.call(this,a,c,b);var d=new ka(a,c);this.view_factory=function(a){for(var f=[],l=[],k=c.attr("order"),h=0;h<k.length;h++){var r=a.attr(k[h]);isNaN(r)?0<l.length&&(f.push(l),l=[]):l.push([(h-b.range.min.x)/b.range.width(),(r-b.range.min.y)/b.range.height()])}0<l.length&&f.push(l);return d.create(a,[f])};this.draw=function(){d.draw()}}function xa(a,c){var b=this;g(c,{background:new q(0,
0,0,1)});this.type="Engine";this.id=da();this.canvas=$("<canvas></canvas>").attr("id","viewer");var d=null;a?($(a).append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height())):(a=window,$("body").append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height()),$(window).resize(function(){b.resize()}));this.resize=function(){this.canvas.attr("width",$(a).width());this.canvas.attr("height",$(a).height());d.viewport(0,0,this.canvas.width(),
this.canvas.height());this.camera.reconfigure();for(var b=0;b<framebuffers.length;b++)framebuffers[b].resize()};var e=this.canvas;this.gl=d=gl=Ta?WebGLDebugUtils.makeDebugContext(e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),function(a,b){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+b;}):e.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});d.viewport(0,0,this.canvas.width(),this.canvas.height());d.blendFunc(d.SRC_ALPHA,
d.ONE_MINUS_SRC_ALPHA);d.enable(d.BLEND);this.camera=new Ja(this.canvas,c);this.scroller=new Ka(this);this.extents=function(a,b){this.camera.extents(a,b)};this.center=function(a,b){this.camera.position(new vect(a,b))};this.vcenter=function(a){this.center(a.x,a.y)};this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.Renderers={};this.renderers={};this.views={};this.styles={};this.defaultStyle=function(a,b){var c;a in this.styles&&(c=this.styles[a][b]);if(null===c||void 0===
c)c=this.styles["default"][b];return null===c||void 0===c?null:c};var f=function(a,c){b.views[a.id].update(c)};this.append=function(a){if("draw"in a)this.scene[a.id]=a;else{if(a.id in this.renderers)throw"Added layer to Engine twice";this.renderers[a.id]={};a.features().each(function(d,e){var h;h=e.type in b.Renderers?e.type:"default";h in b.renderers[a.id]||(b.renderers[a.id][h]=new b.Renderers[h](b,a,c));h=b.renderers[a.id][h].create(e);h.update_all();if(void 0!==b.views[e.id])throw"Cannot add a feature twice to the same Engine";
b.views[e.id]=h;F.registerCallback(b,e,f)});this.layers[a.id]=a}};this.style=function(a,b,c){void 0===this.styles[a.id]&&(this.styles[a.id]={});if(void 0===c)return void 0!==this.styles[a.id][b]?this.styles[a.id][b]:null;this.styles[a.id][b]=c;a.id in this.views?this.views[a.id].update(b):a.id in this.renderers&&$.each(this.renderers[a.id],function(a,b){b.update()})};this.sel=new Ua(this);var l=(new Date).getTime(),k=[],h,r=this;h=function(){r.draw()};this.shaders={};this.scene={};this.layers={};
this.draw=function(){var a=(new Date).getTime(),e=(a-l)/1E3;this.scroller.update(e);60<=k.length&&k.splice(0,1);k.push(e);for(var f=0,r=0;r<k.length;r++)f+=k[r];f/=k.length;$("#fps").text(Math.floor(1/f));l=a;d.clearColor(c.background.r,c.background.g,c.background.b,c.background.a);d.clear(d.COLOR_BUFFER_BIT);d.clearDepth(0);$.each(this.layers,function(a,b){b.update()});$.each(this.scene,function(a,c){c.draw(b,e)});$.each(this.renderers,function(a,b){$.each(b,function(a,b){b.draw(e)})});requestAnimationFrame(h);
this.sel.draw(this,e)};this.enableZ=function(){d.depthFunc(d.LEQUAL);d.enable(d.DEPTH_TEST)};this.disableZ=function(){d.disable(d.DEPTH_TEST)};requestAnimationFrame(h)}function T(a,c){var b={},d;d=c?c:256;var e=0,f=function(a,b,c,d){a||console.log("ack");c||(c=0);d||(d=b.length);for(var e=0;e<d;e++)a[c+e]=b[e]};this.create=function(c,e){if(!e)throw"Length of buffer must be a positive integer";var f=new Float32Array(d*e),r=ha(a,d,e);b[c]={array:f,buffer:r,len:e,dirty:!1}};this.alloc=function(c){if(e+
c>=d){for(var k=d;k<e+c;)k*=2;d=k;for(name in b){var h=new Float32Array(k*b[name].len),r=b[name].array,m=ha(a,d,b[name].len);f(h,r);b[name].array=h;b[name].buffer=m;b[name].dirty=!0}}k=e;e+=c;return k};this.get=function(a){return b[a].buffer};this.write=function(a,c,d,e){f(b[a].array,c,d*b[a].len,e*b[a].len);b[a].dirty=!0};this.repeat=function(a,c,d,e){for(var m=0;m<e;m++)f(b[a].array,c,(d+m)*b[a].len,b[a].len);b[a].dirty=!0};this.count=function(){return e};this.data=function(a){return b[a].array};
this.update=function(){for(name in b)b[name].dirty&&(b[name].buffer&&b[name].buffer.update(b[name].array,0),b[name].dirty=!1)}}function Ua(a){V||(V=C(a.gl,y+"shaders/selbox"));var c=!1,b=!1,d=null,e=null,f=ha(a.gl,6,2),l=E(a.gl,ta(0,0,1,1),2);a.canvas.bind("mousedown",function(h){c&&(show=b=!0,e=d=a.camera.percent(new vect(h.clientX,h.clientY)),f.update(t(d,e),0))});var k=function(){};this.select=function(a){k=a};$(document).bind("mouseup",function(){if(c&&b){var f=a.camera.project(a.camera.pixel(d)),
l=a.camera.project(a.camera.pixel(e));if(f.x>l.x){var m=f.x;f.x=l.x;l.x=m}f.y>l.y&&(m=f.y,f.y=l.y,l.y=m);b=!1;k(new N(f,l))}});$(document).bind("click",function(){c&&(show=!1)});$(document).bind("mousemove",function(h){c&&b&&(e=a.camera.percent(new vect(h.clientX,h.clientY)),f.update(t(d,e),0))});this.enable=function(){c=!0};this.disable=function(){c=!1};this.draw=function(){b&&(gl.useProgram(V),V.data("pos",f),V.data("edge_in",l),gl.drawArrays(gl.TRIANGLES,0,f.numItems))}}function ya(a,c){for(;a>=
c;)a-=c;for(;0>a;)a+=c;return a}function Va(a,c,b,d){this.current=a;this.upper=c;this.lower=b;this.index=d}function za(a,c){for(var b=0;b<a.length;b++)if(a[b]==c)return!0;return!1}function ea(a,c,b){if(void 0==c)throw"whoa";return 0==a[c+1].y-a[c].y?Math.min(a[c].x,a[c+1].x):a[c].x+(a[c+1].x-a[c].x)*((b-a[c].y)/(a[c+1].y-a[c].y))}function O(a,c){for(var b=0;b<a.length;b++)if(a[b]==c)return b;return!1}function v(a,c,b){return new vect(ea(c,b,c[a].y),c[a].y)}function G(a,c){if(!c)throw"eek";a.push(c.x);
a.push(c.y)}function P(a,c,b){if(!c||!b||3!=b.length+c.length&&4!=b.length+c.length)throw"ahh";if(3==c.length+b.length){for(var d=0;d<c.length;d++)G(a,c[d]);for(d=0;d<b.length;d++)G(a,b[d])}else c[1].x<c[0].x&&(d=c[0],c[0]=c[1],c[1]=d),b[1].x<b[0].x&&(d=b[0],b[0]=b[1],b[1]=d),G(a,c[0]),G(a,c[1]),G(a,b[1]),G(a,b[0]),G(a,b[1]),G(a,c[0])}function Ra(a){for(var c=[],b=0,d=[],e=0;e<a.length;e++){for(var f=0;f<a[e].length-1;f++){var l=ya(f+1,a[e].length-1),k=ya(f-1,a[e].length-1);c.push(new Va(f+b,l+b,
k+b,e));d.push(a[e][f])}d.push(a[e][0]);b+=a[e].length}c.sort(function(a,b){return d[a.current].y-d[b.current].y});a=[];e=[];new vect(-200,0);new vect(200,0);b=0;b=[];k=[];for(f=0;f<c.length;f++){var h=c[f],l=za(a,h.lower),r=za(a,h.current),m,g;if(l&&!r)g=m=O(a,h.lower);else if(r&&!l)m=g=O(a,h.current);else if(l&&r)m=O(a,h.lower),g=O(a,h.current);else if(!l&&!r){a:{m=a;g=d;for(var j=d[h.current].x,z=d[h.current].y,A=0;A<m.length;A++){var n=ea(g,m[A],z);if(n>j||0==n-j&&g[m[A]].y>g[index].y){g=A;break a}}g=
m.length}m=g}if(1<Math.abs(m-g)){for(l=0;l<a.length;l++);throw"Bad";}j=vect.left(d[h.lower],d[h.current],d[h.upper]);z=Math.floor(Math.min(m,g)/2);!j&&!l&&!r?(P(k,e[z],[v(h.current,d,a[g-1]),v(h.current,d,a[g])]),e.splice(z,1,[v(h.current,d,a[g-1]),d[h.current]],[d[h.current],v(h.current,d,a[m])])):j&&!l&&!r?e.splice(z,0,[d[h.current]]):l&&!r?(P(k,e[z],[v(h.current,d,a[Math.max(m,g)-1]),d[h.current]]),e[z]=[v(h.current,d,a[Math.min(m,g)-1]),d[h.current]]):!l&&r?(P(k,e[z],[d[h.current],v(h.current,
d,a[Math.min(g,m)+1])]),e[z]=[d[h.current],v(h.current,d,a[Math.max(g,m)+1])]):!j&&l&&r?(P(k,e[z],[v(h.current,d,a[Math.min(m,g)-1]),d[h.current]]),P(k,e[z+1],[v(h.current,d,a[Math.max(m,g)+1]),d[h.current]]),e.splice(z,2,[v(h.current,d,a[Math.min(m,g)-1]),v(h.current,d,a[Math.max(m,g)+1])])):j&&(l&&r)&&(P(k,e[z],[d[h.current]]),e.splice(z,1));l&&!r?a[m]=h.current:r&&!l?a[g]=h.lower:l&&r?(a.splice(O(a,h.lower),1),a.splice(O(a,h.current),1)):!l&&!r&&(j?a.splice(m,0,h.lower,h.current):a.splice(m,0,
h.current,h.lower));for(l=0;l<a.length-1;l++)if(ea(d,a[l],d[h.current].y)>ea(d,a[l+1],d[h.current].y))throw console.log("Misplaced Sweep"),"Misplace!";}if(0<a.length)throw console.log(a),"Bad "+a.length;if(0<b.length)throw console.log(b),"Wrong";return k}function N(a,c){this.min=a.clone();this.max=c.clone();this.contains=function(b){return a.x<=b.x&&c.x>=b.x&&a.y<=b.y&&c.y>=b.y};this.x_in=function(b){return a.x<=b.x&&c.x>=b.x};this.x_left=function(b){return a.x>=b.x};this.x_right=function(a){return c.x<=
a.x};this.y_in=function(b){return a.y<=b.y&&c.y>=b.y};this.y_left=function(b){return a.y>=b.y};this.y_right=function(a){return c.y<=a.y};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(a){switch(a){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);
default:throw"Index out of bounds: "+a;}};this.intersects=function(a){for(var c=0;4>c;c++)for(var e=0;4>e;e++)if(vect.intersects(this.vertex(c),this.vertex((c+1)%4),a.vertex(e),a.vertex((e+1)%4)))return!0;return this.contains(a.min)&&this.contains(a.max)&&this.contains(new vect(a.min.x,a.max.y))&&this.contains(new vect(a.max.x,a.min.y))||a.contains(this.min)&&a.contains(this.max)&&a.contains(new vect(this.min.x,this.max.y))&&a.contains(new vect(this.max.x,this.min.y))?!0:!1};this.union=function(a){this.min.x=
Math.min(this.min.x,a.min.x);this.min.y=Math.min(this.min.y,a.min.y);this.max.x=Math.max(this.max.x,a.max.x);this.max.y=Math.max(this.max.y,a.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new N(a,c)}}function la(a,c,b,d){this.data=a[d];this.right=this.left=null;c!=d&&(this.left=new la(a,c,d-1,parseInt((c+(d-1))/2)));b!=d&&(this.right=new la(a,d+1,b,parseInt((b+(d+1))/2)));this.subtree=[];for(d=c;d<=b;d++)this.subtree.push(a[d]);
this.subtree.sort(function(a,b){return a.y-b.y});this.yrange=function(a,b,c){return a.y_in(this.subtree[b])&&a.y_in(this.subtree[c])};this.subquery=function(a,b,c,d,h){if(this.yrange(b,c,d))for(b=c;b<=d;b++)a.push(this.subtree[b]);else b.y_in(this.subtree[h])&&a.push(this.subtree[h]),b.y_left(this.subtree[h])?h!=d&&this.subquery(a,b,h+1,d,parseInt((d+(h+1))/2)):(b.x_right(this.subtree[h])||h!=d&&this.subquery(a,b,h+1,d,parseInt((d+(h+1))/2)),h!=c&&this.subquery(a,b,c,h-1,parseInt((c+(h-1))/2)))};
this.search=function(d,f){f.x_in(a[c])&&f.x_in(a[b])?this.subquery(d,f,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2)):(f.contains(this.data)&&d.push(this.data),f.x_left(this.data)?this.right&&this.right.search(d,f):f.x_right(this.data)?this.left&&this.left.search(d,f):(this.left&&this.left.search(d,f),this.right&&this.right.search(d,f)))}}function ma(a){a.sort(function(a,b){return a.x-b.x});0<a.length?this.root=new la(a,0,a.length-1,parseInt((a.length-1)/2)):null==this.root;this.search=
function(a){if(!this.root)return[];a=a.clone();var b=[];this.root.search(b,a);return b}}function Aa(a){this.id=da();this.type="Layer";var c={},b={},d=!1;if(a.style)for(var e in a.style);this.style=function(){throw"Not Implemented";};this.bounds=null;this.features=function(){var a=[],c;for(c in b)a.push(b[c]);return new s(a)};var f={};this.properties=function(a){var b=[],c;for(c in f)(!a||a&&f[c])&&b.push(c);return b};this.search=function(a){d&&this.update();var b=new s([]),e;for(e in c)var f=c[e].search(a),
b=b.join(f);return b};this.map_contains=function(a,b){d&&this.update();var e=new s([]),f;for(f in c)var h=c[f].map_contains(a,b),e=e.join(h);return e};var l={};this.attr=function(a,b){if(2>arguments.length)return void 0!==l[a]?l[a]:null;l[a]=b};this.append=function(a){var c=new na[a.type].geometry(a,this);b[c.id]=c;this.bounds?this.bounds.union(c.bounds):this.bounds=c.bounds.clone();for(var e in a.attr)f[e]=void 0===f[e]?isNaN(a.attr[e])?!1:!0:!isNaN(a.attr[e])&&f[e]?!0:!1;d=!0};var k=null,h=null;
this.mouseover=function(a){k=a};this.mouseout=function(a){h=a};var g={};this.update_move=function(a,b){if(k||h){var c=this.map_contains(a,b),d={};c&&c.each(function(a,b){d[b.id]=b});for(var e in g)!(e in d)&&h&&h(g[e]);for(e in d)!(e in g)&&k&&k(d[e]);g=d}};this.force_out=function(){for(var a in g)h&&h(g[a]);g={}};this.update=function(){if(d){var a=this.features(),b;for(b in na)c[b]=new na[b].collection(a.type(b).items())}d=!1}}function Ba(a){var c=new vect(Infinity,Infinity),b=new vect(-Infinity,
-Infinity);$.each(a,function(a,e){$.each(e,function(a,d){$.each(d,function(a,d){d[0]<c.x&&(c.x=d[0]);d[0]>b.x&&(b.x=d[0]);d[1]<c.y&&(c.y=d[1]);d[1]>b.y&&(b.y=d[1])})})});return new N(c,b)}function Oa(a,c){for(var b=6*c.length,d=a.alloc(b),e=[new vect(1,1),new vect(1,-1),new vect(-1,-1),new vect(-1,1)],f=0,l=function(){if(c[f]){var a=new vect(c[f][0],c[f][1]);f++;return a}return null},k=l(),h=l(),g=l(),m=function(a,b,c){var d=vect.dir(a,b).rotate(Q/2),e=vect.dir(b,c).rotate(Q/2);a=vect.add(a,d);var f=
vect.add(b,d),h=vect.add(b,e);c=vect.add(c,e);c=vect.intersect2dpos(a,f,h,c);return Infinity==c?vect.add(b,d):c},j=vect.dir(k,h).rotate(-Q/2),n=vect.dir(k,h).rotate(Q/2),p,A,q=function(a,b,c,d,e){a.push(b.x);a.push(b.y);a.push(c.x);a.push(c.y);a.push(d.x);a.push(d.y);a.push(b.x);a.push(b.y);a.push(d.x);a.push(d.y);a.push(e.x);a.push(e.y)},u=[],I=[],J=[];h;)g?(p=vect.sub(m(k,h,g),h),A=vect.sub(m(g,h,k),h)):(p=vect.dir(k,h).rotate(Q/2),A=vect.dir(k,h).rotate(-Q/2)),q(u,k,k,h,h),q(I,j,n,p,A),q(J,e[0],
e[1],e[2],e[3]),j=A,n=p,k=h,h=g,g=l();a.write("vert",u,d,b);a.write("norm",I,d,b);a.write("unit",J,d,b);return d}function oa(a){B||(B=C(engine.gl,y+"shaders/grid"));a||(a={});a.style||(a.style={});var c=a.lower,b=a.upper,d=a.rows,e=a.cols,f=(b.x-c.x)/e,l=(b.y-c.y)/d,k=new Float32Array(d*e),h=new Uint8Array(4*e*d),g=!1,m=new T(engine.gl,6);m.create("vert",2);m.create("screen",2);m.create("tex",2);var j=new vect(c.x,c.y),n=new vect(b.x,b.y),p=new vect(0,0),A=new vect(1,1),q=m.alloc(6);m.write("vert",
t(j,n),q,6);m.write("screen",t(new vect(-1,-1),new vect(1,1)),q,6);m.write("tex",t(p,A),q,6);var u=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,u);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);this.lower=function(){return c.clone()};this.upper=function(){return b.clone()};
this.rows=function(){return d};this.cols=function(){return e};this.centroid=function(a,b){return new vect(c.x+f*b+f/2,c.y+l*a+l/2)};this.get=function(a,b){return k[e*a+b]};var I=-Infinity,J=Infinity;this.qunatiles=function(a,b){b||(b=function(a,b){return a-b});for(var c=[],d=0;d<k.length;d++)c.push(k[d]);c.sort(b);for(var e=[-Infinity],d=1;d<a;d++){var f=parseInt(inc*d);e.push(c[f])}e.push(Infinity);return e};this.set=function(a,b,c){if(a>=d||b>=e)throw"Index Out of Bounds";k[e*a+b]=c;g=!0};this.raw_set=
function(a,b){if(a>=d*e)throw"Index Out of Bounds: "+a;k[a]=b;g=!0};this.clear=function(a){for(var b=0;b<d*e;b++)k[b]=a};this.initialize=function(){};var U=null;this.draw=function(b){U||(U=b.framebuffer());m.update();if(g){I=-Infinity;J=Infinity;for(var c=0;c<d*e;c++){var f=k[c];f>I&&(I=f);f<J&&(J=f)}for(c=0;c<d*e;c++){var f=c,l=a.map(J,I,k[c]);h[4*f]=parseInt(255*l.r);h[4*f+1]=parseInt(255*l.g);h[4*f+2]=parseInt(255*l.b);h[4*f+3]=parseInt(255*l.a)}gl.bindTexture(gl.TEXTURE_2D,u);gl.texImage2D(gl.TEXTURE_2D,
0,gl.RGBA,e,d,0,gl.RGBA,gl.UNSIGNED_BYTE,h);gl.bindTexture(gl.TEXTURE_2D,null);g=!1}a.style.antialias&&U.activate({blend:!1});gl.useProgram(B);B.data("screen",b.camera.mat3);B.data("pos",m.get("vert"));B.data("tex_in",m.get("tex"));B.data("sampler",u);c=vect.sub(b.camera.screen(n),b.camera.screen(j));B.data("width",c.x);B.data("height",-c.y);B.data("rows",d);B.data("cols",e);B.data("blur",a.blur);gl.drawArrays(gl.TRIANGLES,0,m.count());a.style.antialias&&(U.deactivate(),b.draw_blur(U.tex))}}function Wa(a,
c,b){K||(K=C(y+"shaders/raster"));this.image=aa(a);var d=E(t(new vect(0,1),new vect(1,0)),2),e=E(t(c,b),2);this.draw=function(a,b,c){c||(gl.useProgram(K),K.data("screen",a.camera.mat3),K.data("pos",e),K.data("tex_in",d),K.data("sampler",this.image),gl.drawArrays(gl.TRIANGLES,0,e.numItems))}}function Ca(a){w||(w=C(y+"shaders/hillshade"));var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),d=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));
a=$(a).find("GroundOverlay Icon href").text();var e=!1,f=aa(a,function(){e=!0});this.ready=function(){return e};var l=E(t(new vect(0,1),new vect(1,0)),2),k=E(t(b,d),2),h=315;this.draw=function(a){if(e){for(gl.useProgram(altitude_shader);1<=h;)h-=1;altitude_shader.data("azimuth",h);altitude_shader.data("altitude",Math.PI/4/(2*Math.PI));altitude_shader.data("screen",a.camera.mat3);altitude_shader.data("pos",k);altitude_shader.data("tex_in",l);altitude_shader.data("elevation",f);a=vect.sub(a.camera.screen(d),
a.camera.screen(b));altitude_shader.data("pix_w",1/a.x);altitude_shader.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,k.numItems);return h}}}function Ca(a){w||(w=C(engine.gl,y+"shaders/hillshade"));var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),d=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=!1,f=aa(engine.gl,a,function(){e=!0});this.ready=function(){return e};
var l=E(engine.gl,t(new vect(0,1),new vect(1,0)),2),k=E(engine.gl,t(b,d),2),h=315;this.initialize=function(){};this.draw=function(a){if(e){for(gl.useProgram(w);1<=h;)h-=1;w.data("azimuth",h);w.data("altitude",Math.PI/4/(2*Math.PI));w.data("screen",a.camera.mat3);w.data("pos",k);w.data("tex_in",l);w.data("elevation",f);a=vect.sub(a.camera.screen(d),a.camera.screen(b));w.data("pix_w",1/a.x);w.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,k.numItems);return h}}}function fa(a){for(var c=[],b=[],d=
0;d<a.levels;d++){var e=j(a);"file"==e.source&&(e.url+="/"+a.size*Math.pow(2,d+1));e.min=new vect(-180,-90);e.rows=Math.pow(2,d);e.cols=2*e.rows;e.cellsize=180/e.rows;e.z_index=1-pa-d/1E3;e.available=b;e=new Xa(e);c.push(e)}pa+=(a.levels+2)/1E3;var f=null;this.initialize=function(a){x||(x=C(a.gl,y+"shaders/tile"));f=new T(a.gl,6*W);f.create("vert",3);f.create("tex",2);f.create("lookup",1);f.alloc(6*W);for(var d=0;25>d;d++)b.push(new ia(a.gl));for(d=0;d<c.length;d++)c[d].initialize(a);c[0].fetch_all();
c[0].noexpire(!0)};this.draw=function(b,d){gl.useProgram(x);x.data("screen",b.camera.mat3);Da=Ea=0;for(var e=Infinity,g=c[0],m,j=0;j<c.length;j++){var n=a.size*c[j].cols/c[j].size(b).x;1>n&&(n=1/n);n<e&&(e=n,g=c[j],m=j)}for(j=m;0<=j;j--)c[j].fetch();if(g.ready())g.draw(b,d,f,0,!0);else{b.enableZ();e=0;for(j=m;0<=j;j--)e=c[j].draw(b,d,f,e,0==j);b.disableZ()}$.each(c,function(a,b){b.cull()})}}function Xa(a){a||(a={});a.desaturate||(a.desaturate=0);a.darken||(a.darken=0);a.hue||(a.hue=0);a.hue_color||
(a.hue_color=sa(0,0,0,1));if(!a.available){a.available=[];for(var c=0;8>c;c++)a.available.push(new ia(d))}var b,d=null,e=a.url,f=a.min,l=a.rows,k=a.cols,h=a.cellsize;this.rows=l;this.cols=k;for(var g={},m={},j=function(b,c){var d=new vect(f.x+b*h,f.y+c*h),e=new vect(f.x+(b+1)*h,f.y+(c+1)*h),d={vert:t(d,e,a.z_index),tex:null,i:b,j:c,id:b+k*c,ready:!1,min:d,max:e};m[b][c]=d;g[d.id]=d},c=0;c<k;c++)m[c]={};this.size=function(a){var b=a.camera.screen(f);a=a.camera.screen(vect.add(f,new vect(h*k,h*l)));
b=vect.sub(a,b);b.y=Math.abs(b.y);return b};var n=!1;this.noexpire=function(a){n=a};this.cull=function(){if(!n){var b=(new Date).getTime(),c;for(c in q)if(b-q[c]>Ya){var d=g[c];delete g[c];delete m[d.i][d.j];a.available.push(d.tex);d.tex=null;d.ready=!1;delete q[c]}}};var p=function(){var a=b.camera.project(new vect(b.canvas.offset().left,b.canvas.offset().top+b.canvas.height())),c=b.camera.project(new vect(b.canvas.offset().left+b.canvas.width(),b.canvas.offset().top)),d=Math.floor((a.x-f.x)/h),
e=Math.ceil((c.x-f.x)/h),a=Math.floor((a.y-f.y)/h),c=Math.ceil((c.y-f.y)/h);return{min_col:d,max_col:e,min_row:a,max_row:c}},q={};this.ready=function(){for(var a=p(),b=Math.max(0,a.min_col);b<Math.min(k,a.max_col);b++)for(var c=Math.max(0,a.min_row);c<Math.min(l,a.max_row);c++)if(!m[b][c]||!m[b][c].ready)return!1;return!0};var s=function(b,c){if(!m[b][c].tex){var f;if("file"==a.source)f=e+"/"+m[b][c].id+".png";else if("wms"==a.source){f={service:"wms",version:"1.1.0",request:"GetMap",layers:a.layer,
bbox:[m[b][c].min.x,m[b][c].min.y,m[b][c].max.x,m[b][c].max.y].join(),width:a.size,height:a.size,srs:"EPSG:4326",format:"image/png",transparent:"true"};var h=[],l;for(l in f)h.push(l+"="+f[l]);f=e+"?"+h.join("&")}m[b][c].tex=a.available.pop();m[b][c].tex||(m[b][c].tex=new ia(d));l=f;var k=m[b][c],g=new Image;g.crossOrigin="";g.onload=function(){k.tex&&(k.tex.image(g),k.ready=!0)};g.src=l}};this.fetch_all=function(){for(var a=(new Date).getTime(),b=0;b<k;b++)for(var c=0;c<l;c++)m[b][c]||j(b,c),m[b][c].tex||
s(b,c),q[m[b][c].id]=a};this.fetch=function(){for(var a=p(),b=(new Date).getTime(),c=Math.max(0,a.min_col-1);c<Math.min(k,a.max_col+1);c++)for(var d=Math.max(0,a.min_row-1);d<Math.min(l,a.max_row+1);d++)m[c][d]||j(c,d),m[c][d].tex||s(c,d),q[m[c][d].id]=b};var u=!1;this.initialize=function(a){if(u)throw"Not Implemented: Migrating Tile Layers to New Map";x||(x=C(a.gl,y+"shaders/tile"));b=a;d=b.gl;u=!0};this.draw=function(b,c,e,f,h){u||this.initialize(b);b=function(){Da++;e.update();x.data("pos",e.get("vert"));
x.data("tex_in",e.get("tex"));x.data("lookup_in",e.get("lookup"));x.data("desaturate",a.desaturate);x.data("darken",a.darken);x.data("hue",a.hue);x.data("hue_color",a.hue_color.array);d.drawArrays(d.TRIANGLES,0,6*f)};c=p();for(var g=(new Date).getTime(),j=Math.max(0,c.min_col);j<Math.min(k,c.max_col);j++)for(var r=Math.max(0,c.min_row);r<Math.min(l,c.max_row);r++)if(m[j][r]&&m[j][r].ready&&m[j][r].tex){e.write("vert",m[j][r].vert,6*f,6);e.write("tex",t(new vect(0,0),new vect(1,1)),6*f,6);e.repeat("lookup",
[f/W+1/(2*W)],6*f,6);q[m[j][r].id]=g;x.data("sampler"+f,m[j][r].tex);if(null==m[j][r].tex)throw"badness";f++;Ea++;f>=W&&(b(),f=0)}h&&b();return f}}var y="",R=jQuery,Za=function(a){if("string"===typeof a.data){var c=a.handler,b=a.data.toLowerCase().split(" ");a.handler=function(a){if(!(this!==a.target&&(/textarea|select/i.test(a.target.nodeName)||"text"===a.target.type))){var e="keypress"!==a.type&&R.hotkeys.specialKeys[a.which],f=String.fromCharCode(a.which).toLowerCase(),l="",k={};a.altKey&&"alt"!==
e&&(l+="alt+");a.ctrlKey&&"ctrl"!==e&&(l+="ctrl+");a.metaKey&&(!a.ctrlKey&&"meta"!==e)&&(l+="meta+");a.shiftKey&&"shift"!==e&&(l+="shift+");e?k[l+e]=!0:(k[l+f]=!0,k[l+R.hotkeys.shiftNums[f]]=!0,"shift+"===l&&(k[R.hotkeys.shiftNums[f]]=!0));e=0;for(f=b.length;e<f;e++)if(k[b[e]])return c.apply(this,arguments)}}}};R.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",
37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(","0":")","-":"_",
"=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}};R.each(["keydown","keyup","keypress"],function(){R.event.special[this]={add:Za}});var H=jQuery,qa=function(a){var c=a||window.event,b=[].slice.call(arguments,1),d=0,e=0,f=0;a=H.event.fix(c);a.type="mousewheel";c.wheelDelta&&(d=c.wheelDelta/120);c.detail&&(d=-c.detail/3);f=d;void 0!==c.axis&&c.axis===c.HORIZONTAL_AXIS&&(f=0,e=-1*d);void 0!==c.wheelDeltaY&&(f=c.wheelDeltaY/120);void 0!==c.wheelDeltaX&&(e=-1*c.wheelDeltaX/120);
b.unshift(a,d,e,f);return(H.event.dispatch||H.event.handle).apply(this,b)},S=["DOMMouseScroll","mousewheel"];if(H.event.fixHooks)for(var L=S.length;L;)H.event.fixHooks[S[--L]]=H.event.mouseHooks;H.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=S.length;a;)this.addEventListener(S[--a],qa,!1);else this.onmousewheel=qa},teardown:function(){if(this.removeEventListener)for(var a=S.length;a;)this.removeEventListener(S[--a],qa,!1);else this.onmousewheel=null}};H.fn.extend({mousewheel:function(a){return a?
this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}});for(var Fa=0,L=["ms","moz","webkit","o"],X=0;X<L.length&&!window.requestAnimationFrame;++X)window.requestAnimationFrame=window[L[X]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[L[X]+"CancelAnimationFrame"]||window[L[X]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var c=(new Date).getTime(),b=Math.max(0,16-(c-Fa)),
d=window.setTimeout(function(){a(c+b)},b);Fa=c+b;return d});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});var Q=3.14159265,ba={x:0,y:0};$(document).mousemove(function(a){ba.x=a.clientX;ba.y=a.clientY});var Ta=!1,va=0,F=new function(){this.styles={};this.derivedStyle=function(a,c,e,f){if(!e)throw"Undefined operation";var l;l=this.getStyle(a,e,f);null===l&&(l=this.getStyle(a,null,f),null===l&&(l=this.getStyle(c,e,f),null===l&&(l=this.getStyle(c,e,f),null===
l&&(l=e.defaultStyle(a.type,f)))));return l};var a={};this.registerCallback=function(b,c,e){a[b.id]||(a[b.id]={});a[b.id][c.id]=e};var c=function(a,c){var e=c?c.id:"default";e in F.styles||(F.styles[e]={});a.id in F.styles[e]||(F.styles[e][a.id]={})};this.getStyle=function(a,d,e){c(a,d);a=this.styles[d?d.id:"default"][a.id][e];return void 0===a?null:a};this.setStyle=function(b,d,e,f){c(b,d);this.styles[d?d.id:"default"][b.id][e]=f;if(d){if(a[d.id]&&a[d.id][b.id])a[d.id][b.id](b,e)}else $.each(a,function(a,
c){if(c[b.id])c[b.id](b,e)})}},Ma=1024,Na=ta(0,0,1,1),Qa=1024,V=null,na={Point:{geometry:function(a,c){ra.call(this,a,c);this.bounds=null;for(var b=0;b<this.geom.length;b++){var d=new vect(this.geom[b][0],this.geom[b][1]),d=new N(d.clone(),d.clone());this.bounds?this.bounds.union(d):this.bounds=d}this.map_contains=function(a,b){for(var c=this.compute("radius"),d=0;d<this.geom.length;d++){var h=a.camera.screen(new vect(this.geom[d][0],this.geom[d][1]));if(vect.dist(h,b)<c)return!0}return!1}},collection:function(a){var c=
[],b=0;$.each(a,function(a,d){var l=d.compute("radius");l>b&&(b=l);$.each(d.geom,function(a,b){c.push({x:b[0],y:b[1],ref:d})})});var d=new ma(c);this.search=function(a){a=d.search(a);var b=[];$.each(a,function(a,c){b.push(c.ref)});return new s(b)};this.map_contains=function(a,c){for(var l=vect.add(c,new vect(-b,b)),g=vect.add(c,new vect(b,-b)),l=new N(a.camera.project(l),a.camera.project(g)),l=d.search(l),g=0;g<l.length;g++){var h=l[g];if(h.ref.map_contains(a,c))return new s([h.ref])}return new s([])}}},
Polygon:{geometry:function(a,c){ra.call(this,a,c);this.bounds=Ba(this.geom);this.map_contains=function(a,c){return this.contains(a.camera.project(c))};this.contains=function(a){var c=0;if(this.bounds.contains(a)){c++;for(c=0;c<this.geom.length;c++){var e=0;$.each(this.geom[c],function(c,d){for(var g=0;g<d.length;g++){var h=(g+1)%d.length;if(0>(a.y-d[g][1])/(a.y-d[h][1])){var j=new vect(720,a.y),m=new vect(d[g][0],d[g][1]),h=new vect(d[h][0],d[h][1]);vect.intersects(a,j,m,h)&&e++}}});if(1==e%2)return!0}}return!1}},
collection:function(a){for(var c=[],b=0;b<a.length;b++)$.each(a[b].geom,function(d,e){$.each(e,function(d,e){$.each(e,function(d,e){c.push({ref:a[b],x:e[0],y:e[1]})})})});tree=new ma(c);this.search=function(b){var c=tree.search(b),f={};$.each(c,function(a,b){f[b.ref.id]=b.ref});for(c=0;c<a.length;c++)for(var g=0;4>g;g++)a[c].contains(b.vertex(g))&&(f[a[c].id]=a[c]);b=[];for(var k in f)b.push(f[k]);return new s(b)};this.map_contains=function(a,b){return this.contains(a.camera.project(b))};this.contains=
function(b){for(var c=[],f=0;f<a.length;f++)a[f].contains(b)&&c.push(a[f]);return new s(c)}}},Line:{geometry:function(a,c){ra.call(this,a,c);this.bounds=Ba(this.geom);this.map_contains=function(){return!1}},collection:function(){this.search=function(){return new s([])};this.map_contains=function(){return new s([])};this.contains=function(){return new s([])}}}},ra=function(a){this.id=da();this.type="Feature";this.type=a.type;var c=a.attr;this.attr=function(a,d){if(2>arguments.length)return c[a];throw"Not Implemented";
};this.geom=a.geom;this.geometry=function(){};this.style=function(a,c,e){var f;!a||"Engine"==a.type?(f=a,a=c,c=e):f=null;if(void 0===c)return F.getStyle(this,f,a);F.setStyle(this,f,a,c);return this}},da,Ga=1;da=function(){var a=Ga;Ga++;return a};var wa;wa=function(a,c){return new vect(a+1E-6*Math.random()-5E-7,c+1E-6*Math.random()-5E-7)};var B=null,s=function(a){var c=null;this.length=a.length;this.count=function(){return a.length};this.items=function(){return a};this.type=function(b){for(var c=[],
f=0;f<a.length;f++)a[f].type==b&&c.push(a[f]);return new s(c)};this.join=function(b){for(var c=[],f=0;f<a.length;f++)c.push(a[f]);for(f=0;f<b.count();f++){var g=b.get(f);this.id(g.id)||c.push(g)}return new s(c)};this.attr=function(){throw"Not Implemented";};this.get=function(b){return a[b]};this.subset=function(b){for(var c=[],f=0;f<b.length;f++)c.push(a[b[f]]);return new s(c)};this.id=function(b){if(!c){c={};for(var e=0;e<a.length;e++)c[a[e].id]=a[e]}return b in c?c[b]:null};this.each=function(b){for(var c=
0;c<a.length;c++)b(c,a[c]);return this};var b={">":function(a,b){return a>b},"<":function(a,b){return a<b},"==":function(a,b){return a==b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b}};this.select=function(c){if(c.match(/^\s*\*\s*$/))return new s(a);var e=c.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!e)throw"Bad Selector";c=e[1];var f=e[2],g=null,k=null;isNaN(e[3])?k=e[3]:g=parseFloat(e[3]);new_elem=[];if(k)for(e=0;e<a.length;e++)b[f](a[e].attr(c),a[e].attr(k))&&new_elem.push(a[e]);
else for(e=0;e<a.length;e++)b[f](a[e].attr(c),g)&&new_elem.push(a[e]);return new s(new_elem)};this.filter=function(b){for(var c=[],f=0;f<a.length;f++)b(a[f])&&c.push(a[f]);return new s(c)};this.quantile=function(b,c,f){a.sort(function(a,c){return a.attr(b)-c.attr(b)});var g=Math.round(c*this.length/f);c=Math.round((c-1)*this.length/f);return new s(a.slice(c,g))};this.range=function(b){for(var c=Infinity,f=-Infinity,g=!1,k=0;k<a.length;k++){var h=a[k].attr(b);isNaN(h)||(g=!0,c>h&&(c=h),f<h&&(f=h))}return!g?
null:{min:c,max:f}};this.style=function(b,c,f){var g,k,h;"Engine"==b.type?(g=b,k=c,h=f):(g=null,k=b,h=c);if(void 0===h){if(a[0])return a[0].style(g,k)}else return $.each(a,function(a,b){b.style(g,k,"function"==typeof h?h(b):Ia(h)?h[a]:h)}),this}},K=null,w=null,M=null,w=null,Ya=1E3,pa=0,W=8,Ea=0,Da=0,x=null,Ha=[];window.wiggle={Map:function(a,c){void 0===c&&(c={});xa.call(this,a,c);g(c,{base:"default","tile-server":"http://eland.ecohealthalliance.org/wigglemaps"});this.Renderers={Point:La,Polygon:Pa,
Line:ka};this.styles={Point:{fill:new q(0.02,0.44,0.69,1),opacity:1,radius:5,stroke:"none","stroke-width":2},Polygon:{fill:new q(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new q(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":0.75},Line:{stroke:new q(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":2},"default":{fill:new q(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new q(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":1}};var b=null;"default"==c.base||"nasa"==c.base?(b=j(c),n(b,{source:"file",
url:c["tile-server"]+"/tiles/nasa_topo_bathy",levels:8,size:256}),b=new fa(b)):"ne"==c.base?(b=j(c),n(b,{source:"file",url:c["tile-server"]+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),b=new fa(b)):"ne1"==c.base?(b=j(c),n(b,{source:"file",url:TILE_SERVER+"/tiles/NE1_HR_LC",levels:6,size:256}),b=new fa(b)):b=null;b&&(b.initialize(this),this.scene[b.id]=b)},TimeSeries:function(a,c){void 0===c&&(c={});xa.call(this,a,c);this.styles={"default":{fill:new q(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new q(0.02,
0.44,0.69,1),"stroke-opacity":1,"stroke-width":2}};this.extents(1,1);this.center(0.5,0.5);this.Renderers={"default":Sa}},layer:{Layer:Aa,Grid:oa,Hillshade:Ca,Elevation:function(a){M||(M=C(y+"shaders/elevation"));var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),d=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=aa(a),f=E(t(new vect(0,1),new vect(1,0)),2),g=
E(t(b,d),2);this.draw=function(a,c,j){j||(gl.useProgram(M),M.data("screen",a.camera.mat3),M.data("pos",g),M.data("tex_in",f),M.data("elevation",e),vect.sub(a.camera.screen(d),a.camera.screen(b)),gl.drawArrays(gl.TRIANGLES,0,g.numItems))}}},io:{Shapefile:function(a){var c=a.path;$.ajax({url:c+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(b){for(var d=[],e=100;e<b.length;)d.push(2*ga(b,e)),e+=8;$.ajax({url:c+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(b){for(var c=
[],e=[],h=0;h<d.length;h++){var g=d[h];ga(b,g);ga(b,g+4);var m=g+8,j=D(b,m);if(0==j)console.log("NULL Shape");else if(1==j)j=Y(b,m+4),m=Y(b,m+12),c.push({attr:{},geom:[[j,m]]});else if(5==j){for(var j=D(b,m+36),m=D(b,m+40),n=g+52,g=g+52+4*j,p=[],q=0;q<j;q++){var s=D(b,n+4*q),u;u=q+1<j?D(b,n+4*(q+1)):m;var t=g,w=[];for(u-=1;u>=s;u--){var x=Y(b,t+16*u),y=Y(b,t+16*u+8);w.push([x,y])}p.push(w)}e.push({attr:{},geom:[p]})}else throw"Not Implemented: "+j;}if(0<c.length){var v=new PointLayer(c.length);$.each(c,
function(a,b){v.append(b)});b=v}else 0<e.length?(v=new PolygonLayer(a),$.each(e,function(a,b){for(var c=0;100>c;)try{v.append(b),c=101}catch(d){c++}100==c&&console.log("rendering polygon failed")}),b=v):b=void 0;a.success(b)}})}})},GeoJSON:function(a,c){void 0===c&&(c={});for(var b=new Aa(c),d=0;d<a.features.length;d++){var e=a.features[d];if("Feature"==e.type){"Point"==e.geometry.type&&b.append({type:"Point",geom:[e.geometry.coordinates],attr:e.properties});"MultiPoint"==e.geometry.type&&b.append({type:"Point",
geom:e.geometry.coordinates,attr:e.properties});if("Polygon"==e.geometry.type){for(var f=e.geometry.coordinates,g=[],k=0;k<=f.length-1;k++){for(var h=[],j=f[k].length-1;0<=j;j--)h.push(f[k][j]);g.push(h)}b.append({type:"Polygon",geom:[g],attr:e.properties})}if("MultiPolygon"==e.geometry.type){var m=[];$.each(e.geometry.coordinates,function(a,b){for(var c=[],d=0;d<=b.length-1;d++){for(var e=[],f=b[d].length-1;0<=f;f--)e.push(b[d][f]);c.push(e)}m.push(c)});b.append({type:"Polygon",geom:m,attr:e.properties})}"MultiLineString"==
e.geometry.type&&$.each(e.geometry.coordinates,function(a,c){b.append({type:"Line",geom:[[c]],attr:e.properties})})}}return b},KML:function(a){var c=$(a).find("LatLonBox"),b=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text())),c=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();return new Wa(y+a,b,c)},SparseGrid:function(a,c){var b=Z(a,0),d=Z(a,4),e=D(a,8),f=D(a,12),g=Z(a,16),k={};for(key in c)k[key]=
c[key];k.lower=new vect(b,d);k.upper=new vect(b+g*e,d+g*f);k.rows=f;k.cols=e;b=new oa(k);for(d=20;d<a.length;){for(var g=D(a,d),e=D(a,d+4),f=d+4,k=e,h=0;h<k;h++){var j=Z(a,f+4*h);b.raw_set(g+h,j)}d+=8+4*e}return b},AsciiGrid:function(a,c){var b=a.split("\n"),d=b.splice(0,6),e=parseInt(d[0].slice(14)),f=parseInt(d[1].slice(14)),g=parseFloat(d[2].slice(14)),k=parseFloat(d[3].slice(14)),h=parseFloat(d[4].slice(14)),d=d[5].slice(14),j={};for(key in c)j[key]=c[key];j.lower=new vect(g,k);j.upper=new vect(g+
h*e,k+h*f);j.rows=f;j.cols=e;g=new oa(j);for(k=0;k<f;k++){h=b[k].split(" ");for(j=0;j<e;j++)h[j]==d?g.set(f-1-k,j,NaN):g.set(f-1-k,j,parseFloat(h[j]))}return g},WMS:function(a){a=j(a);for(var c=["url","layer"],b=0;b<c.length;b++){var d=c[b];if(!(d in a))throw"Key "+d+" not found";}g(a,{levels:16,size:256});var c={source:"wms"},e;for(e in c)a[e]=c[e];return new fa(a)}},util:{fcolor:sa,icolor:function(a,c,b,d){return new q(p(a/255,0,1),p(c/255,0,1),p(b/255,0,1),p(d/255,0,1))},Box:N,RangeTree:ma},widget:{Slider:function(a,
c,b){var d=function(a){if(a>=b)throw"Slider index out of bounds";return c.x/(b-1)*a},e=function(d){return d<=a.x?0:d>=a.x+c.x?b-1:Math.round((d-a.x)/c.x*(b-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",a.x).css("top",a.y).css("width",c.x).css("height",c.y);var f=!1,g=0,k=$("<div></div>").addClass("slider-box").css("position","relative").css("left",-10).css("height",c.y).css("width",20).mousedown(function(){f=!0});this.tick=function(){return g};this.count=
function(){return b};var h=function(){};this.change=function(a){h=a};var j=function(){};this.release=function(a){j=a};this.dragging=function(){return f};this.dom.append(k);this.set=function(a){a!=g&&h(a);g=a;var b=d(a);k.css("left",b-10);j(a)};$(document).bind("mouseup",function(){if(f){f=!1;var a=e(event.clientX);j(a)}});$(document).bind("mousemove",function(a){f&&(a=e(a.clientX),a!=g&&h(a),g=a,a=d(a),k.css("left",a-10))})}},ready:function(a){Ha.push(a)}};$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(a,
c){var b=/wigglemaps(\.min)?\.js/;$(c).attr("src").match(b)&&(y=$(c).attr("src").replace(b,""))});$.each(Ha,function(a,c){c()})})})();
