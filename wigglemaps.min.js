wiggle={};$(document).ready(function(){BASE_DIR=$('script[src*="wigglemaps.min.js"]').attr("src").replace("wigglemaps.min.js","")});(function(b){b.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}};function a(d){if(typeof d.data!=="string"){return}var c=d.handler,e=d.data.toLowerCase().split(" ");d.handler=function(n){if(this!==n.target&&(/textarea|select/i.test(n.target.nodeName)||n.target.type==="text")){return}var k=n.type!=="keypress"&&b.hotkeys.specialKeys[n.which],o=String.fromCharCode(n.which).toLowerCase(),j,m="",g={};if(n.altKey&&k!=="alt"){m+="alt+"}if(n.ctrlKey&&k!=="ctrl"){m+="ctrl+"}if(n.metaKey&&!n.ctrlKey&&k!=="meta"){m+="meta+"}if(n.shiftKey&&k!=="shift"){m+="shift+"}if(k){g[m+k]=true}else{g[m+o]=true;g[m+b.hotkeys.shiftNums[o]]=true;if(m==="shift+"){g[b.hotkeys.shiftNums[o]]=true}}for(var h=0,f=e.length;h<f;h++){if(g[e[h]]){return c.apply(this,arguments)}}}}b.each(["keydown","keyup","keypress"],function(){b.event.special[this]={add:a}})})(jQuery);(function(d){var b=["DOMMouseScroll","mousewheel"];if(d.event.fixHooks){for(var a=b.length;a;){d.event.fixHooks[b[--a]]=d.event.mouseHooks}}d.event.special.mousewheel={setup:function(){if(this.addEventListener){for(var e=b.length;e;){this.addEventListener(b[--e],c,false)}}else{this.onmousewheel=c}},teardown:function(){if(this.removeEventListener){for(var e=b.length;e;){this.removeEventListener(b[--e],c,false)}}else{this.onmousewheel=null}}};d.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}});function c(i){var g=i||window.event,f=[].slice.call(arguments,1),k=0,e=true,h=0,j=0;i=d.event.fix(g);i.type="mousewheel";if(g.wheelDelta){k=g.wheelDelta/120}if(g.detail){k=-g.detail/3}j=k;if(g.axis!==undefined&&g.axis===g.HORIZONTAL_AXIS){j=0;h=-1*k}if(g.wheelDeltaY!==undefined){j=g.wheelDeltaY/120}if(g.wheelDeltaX!==undefined){h=-1*g.wheelDeltaX/120}f.unshift(i,k,h,j);return(d.event.dispatch||d.event.handle).apply(this,f)}})(jQuery);WebGLDebugUtils=function(){var f=function(n){if(window.console&&window.console.log){window.console.log(n)}};var i={enable:{0:true},disable:{0:true},getParameter:{0:true},drawArrays:{0:true},drawElements:{0:true,2:true},createShader:{0:true},getShaderParameter:{1:true},getProgramParameter:{1:true},getVertexAttrib:{1:true},vertexAttribPointer:{2:true},bindTexture:{0:true},activeTexture:{0:true},getTexParameter:{0:true,1:true},texParameterf:{0:true,1:true},texParameteri:{0:true,1:true,2:true},texImage2D:{0:true,2:true,6:true,7:true},texSubImage2D:{0:true,6:true,7:true},copyTexImage2D:{0:true,2:true},copyTexSubImage2D:{0:true},generateMipmap:{0:true},bindBuffer:{0:true},bufferData:{0:true,2:true},bufferSubData:{0:true},getBufferParameter:{0:true,1:true},pixelStorei:{0:true,1:true},readPixels:{4:true,5:true},bindRenderbuffer:{0:true},bindFramebuffer:{0:true},checkFramebufferStatus:{0:true},framebufferRenderbuffer:{0:true,1:true,2:true},framebufferTexture2D:{0:true,1:true,2:true},getFramebufferAttachmentParameter:{0:true,1:true,2:true},getRenderbufferParameter:{0:true,1:true},renderbufferStorage:{0:true,1:true},clear:{0:true},depthFunc:{0:true},blendFunc:{0:true,1:true},blendFuncSeparate:{0:true,1:true,2:true,3:true},blendEquation:{0:true},blendEquationSeparate:{0:true,1:true},stencilFunc:{0:true},stencilFuncSeparate:{0:true,1:true},stencilMaskSeparate:{0:true},stencilOp:{0:true,1:true,2:true},stencilOpSeparate:{0:true,1:true,2:true,3:true},cullFace:{0:true},frontFace:{0:true},};var l=null;function m(n){if(l==null){l={};for(var o in n){if(typeof n[o]=="number"){l[n[o]]=o}}}}function e(){if(l==null){throw"WebGLDebugUtils.init(ctx) not called"}}function g(n){e();return(l[n]!==undefined)}function d(o){e();var n=l[o];return(n!==undefined)?n:("*UNKNOWN WebGL ENUM (0x"+o.toString(16)+")")}function b(n,p,q){var o=i[n];if(o!==undefined){if(o[p]){return d(q)}}return q.toString()}function h(p,n,o){p.__defineGetter__(o,function(){return n[o]});p.__defineSetter__(o,function(q){n[o]=q})}function j(o,n){var p=o[n];return function(){var q=p.apply(o,arguments);return q}}function k(n,q){m(n);q=q||function(w,t,u){var x="";for(var v=0;v<u.length;++v){x+=((v==0)?"":", ")+b(t,v,u[v])}f("WebGL error "+d(w)+" in "+t+"("+x+")")};var s={};function p(u,t){return function(){var w=u[t].apply(u,arguments);var v=u.getError();if(v!=0){s[v]=true;q(v,t,arguments)}return w}}var r={};for(var o in n){if(typeof n[o]=="function"){r[o]=p(n,o)}else{h(r,n,o)}}r.getError=function(){for(var t in s){if(s[t]){s[t]=false;return t}}return n.NO_ERROR};return r}function a(n){var r=n.getParameter(n.MAX_VERTEX_ATTRIBS);var o=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,o);for(var q=0;q<r;++q){n.disableVertexAttribArray(q);n.vertexAttribPointer(q,4,n.FLOAT,false,0,0);n.vertexAttrib1f(q,0)}n.deleteBuffer(o);var p=n.getParameter(n.MAX_TEXTURE_IMAGE_UNITS);for(var q=0;q<p;++q){n.activeTexture(n.TEXTURE0+q);n.bindTexture(n.TEXTURE_CUBE_MAP,null);n.bindTexture(n.TEXTURE_2D,null)}n.activeTexture(n.TEXTURE0);n.useProgram(null);n.bindBuffer(n.ARRAY_BUFFER,null);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);n.bindFramebuffer(n.FRAMEBUFFER,null);n.bindRenderbuffer(n.RENDERBUFFER,null);n.disable(n.BLEND);n.disable(n.CULL_FACE);n.disable(n.DEPTH_TEST);n.disable(n.DITHER);n.disable(n.SCISSOR_TEST);n.blendColor(0,0,0,0);n.blendEquation(n.FUNC_ADD);n.blendFunc(n.ONE,n.ZERO);n.clearColor(0,0,0,0);n.clearDepth(1);n.clearStencil(-1);n.colorMask(true,true,true,true);n.cullFace(n.BACK);n.depthFunc(n.LESS);n.depthMask(true);n.depthRange(0,1);n.frontFace(n.CCW);n.hint(n.GENERATE_MIPMAP_HINT,n.DONT_CARE);n.lineWidth(1);n.pixelStorei(n.PACK_ALIGNMENT,4);n.pixelStorei(n.UNPACK_ALIGNMENT,4);n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,false);n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(n.UNPACK_COLORSPACE_CONVERSION_WEBGL){n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,n.BROWSER_DEFAULT_WEBGL)}n.polygonOffset(0,0);n.sampleCoverage(1,false);n.scissor(0,0,n.canvas.width,n.canvas.height);n.stencilFunc(n.ALWAYS,0,4294967295);n.stencilMask(4294967295);n.stencilOp(n.KEEP,n.KEEP,n.KEEP);n.viewport(0,0,n.canvas.width,n.canvas.height);n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT);while(n.getError()){}}function c(x){var n;var J;var I=[];var s=[];var J={};var w=1;var C=false;var y=0;var M=[];var A=0;var o=0;var u=false;var H=0;var r={};x.getContext=function(N){return function(){var O=N.apply(x,arguments);if(O instanceof WebGLRenderingContext){if(O!=n){if(n){throw"got different context"}n=O;J=D(n)}return J}return O}}(x.getContext);function z(N){if(typeof(N)=="function"){return N}else{return function(O){N.handleEvent(O)}}}var L=function(N){I.push(z(N))};var t=function(N){s.push(z(N))};function q(N){var O=N.addEventListener;N.addEventListener=function(P,R,Q){switch(P){case"webglcontextlost":L(R);break;case"webglcontextrestored":t(R);break;default:O.apply(N,arguments)}}}q(x);x.loseContext=function(){if(!C){C=true;A=0;++w;while(n.getError()){}K();r[n.CONTEXT_LOST_WEBGL]=true;var O=B("context lost");var N=I.slice();setTimeout(function(){for(var P=0;P<N.length;++P){N[P](O)}if(H>=0){setTimeout(function(){x.restoreContext()},H)}},0)}};x.restoreContext=function(){if(C){if(s.length){setTimeout(function(){if(!u){throw"can not restore. webglcontestlost listener did not call event.preventDefault"}F();a(n);C=false;o=0;u=false;var N=s.slice();var P=B("context restored");for(var O=0;O<N.length;++O){N[O](P)}},0)}}};x.loseContextInNCalls=function(N){if(C){throw"You can not ask a lost contet to be lost"}A=o+N};x.getNumCalls=function(){return o};x.setRestoreTimeout=function(N){H=N};function p(N){return(N instanceof WebGLBuffer||N instanceof WebGLFramebuffer||N instanceof WebGLProgram||N instanceof WebGLRenderbuffer||N instanceof WebGLShader||N instanceof WebGLTexture)}function G(O){for(var P=0;P<O.length;++P){var N=O[P];if(p(N)){return N.__webglDebugContextLostId__==w}}return true}function K(){var N=Object.keys(r);for(var O=0;O<N.length;++O){delete r[N]}}function v(){++o;if(!C){if(A==o){x.loseContext()}}}function E(O,N){var P=O[N];return function(){v();if(!C){var Q=P.apply(O,arguments);return Q}}}function F(){for(var O=0;O<M.length;++O){var N=M[O];if(N instanceof WebGLBuffer){n.deleteBuffer(N)}else{if(N instanceof WebGLFramebuffer){n.deleteFramebuffer(N)}else{if(N instanceof WebGLProgram){n.deleteProgram(N)}else{if(N instanceof WebGLRenderbuffer){n.deleteRenderbuffer(N)}else{if(N instanceof WebGLShader){n.deleteShader(N)}else{if(N instanceof WebGLTexture){n.deleteTexture(N)}}}}}}}}function B(N){return{statusMessage:N,preventDefault:function(){u=true}}}return x;function D(Q){for(var S in Q){if(typeof Q[S]=="function"){J[S]=E(Q,S)}else{h(J,Q,S)}}J.getError=function(){v();if(!C){var U;while(U=n.getError()){r[U]=true}}for(var U in r){if(r[U]){delete r[U];return U}}return J.NO_ERROR};var O=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(var R=0;R<O.length;++R){var N=O[R];J[N]=function(U){return function(){v();if(C){return null}var V=U.apply(Q,arguments);V.__webglDebugContextLostId__=w;M.push(V);return V}}(Q[N])}var T=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(var R=0;R<T.length;++R){var N=T[R];J[N]=function(U){return function(){v();if(C){return null}return U.apply(Q,arguments)}}(J[N])}var P=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(var R=0;R<P.length;++R){var N=P[R];J[N]=function(U){return function(){v();if(C){return false}return U.apply(Q,arguments)}}(J[N])}J.checkFramebufferStatus=function(U){return function(){v();if(C){return J.FRAMEBUFFER_UNSUPPORTED}return U.apply(Q,arguments)}}(J.checkFramebufferStatus);J.getAttribLocation=function(U){return function(){v();if(C){return -1}return U.apply(Q,arguments)}}(J.getAttribLocation);J.getVertexAttribOffset=function(U){return function(){v();if(C){return 0}return U.apply(Q,arguments)}}(J.getVertexAttribOffset);J.isContextLost=function(){return C};return J}}return{init:m,mightBeEnum:g,glEnumToString:d,glFunctionArgToString:b,makeDebugContext:k,makeLostContextSimulatingCanvas:c,resetToInitialState:a}}();(function(){var c=0;var b=["ms","moz","webkit","o"];for(var a=0;a<b.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[b[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[b[a]+"CancelAnimationFrame"]||window[b[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(g,e){var d=new Date().getTime();var f=Math.max(0,16-(d-c));var h=window.setTimeout(function(){g(d+f)},f);c=d+f;return h}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());var PI=3.14159265;function make_url(c,d){var a=[];for(var b in d){a.push(b+"="+d[b])}return c+"?"+a.join("&")}function default_model(c,a){for(var b in a){if(!(b in c)){c[b]=a[b]}}}function force_model(c,a){for(var b in a){c[b]=a[b]}}function copy(a){var b={};for(key in a){b[key]=a[key]}return b}function require(d,c){for(var b=0;b<c.length;b++){var a=c[b];if(!(a in d)){throw"Key "+a+" not found"}}}function copy_to(b,a){for(key in a){b[key]=a[key]}}var default_copy=function(e,d,b,c,a){if(b in d){if(a){e[b]=a(d[b])}else{e[b]=d[b]}}else{e[b]=c}};var copy_value=function(d,c,b,a){if(b in c){if(a){d[b]=a(c[b])}else{d[b]=c[b]}}};function as_rgb(a){return"rgb("+Math.round(a[0]*255)+","+Math.round(a[1]*255)+","+Math.round(a[2]*255)+")"}function clamp(c,b,a){return Math.min(Math.max(c,b),a)}function Color(f,e,c,d){if(f<=1&&e<=1&&c<=1&&d<=1){this.r=f;this.g=e;this.b=c;this.a=d}else{this.r=f/255;this.g=e/255;this.b=c/255;this.a=d/255}this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(this.r*255)+","+parseInt(this.g*255)+","+parseInt(this.b*255)+")"}}function icolor(f,e,c,d){return new Color(clamp(f/255,0,1),clamp(e/255,0,1),clamp(c/255,0,1),clamp(d/255,0,1))}function fcolor(f,e,c,d){return new Color(clamp(f,0,1),clamp(e,0,1),clamp(c,0,1),clamp(d,0,1))}function hex_to_color(e){var d=parseInt(e.slice(1,3),16);var c=parseInt(e.slice(3,5),16);var a=parseInt(e.slice(5,7),16);return new Color(d,c,a,255)}function is_list(b){if(b==null){return false}if(b.length==undefined){return false}for(var a=0;a<b.length;a++){if(!(a in b)){return false}}return true}function isQuoted(a){var b=a[0];if(b=='"'||b=="'"){if(a[a.length-1]==b){return true}}return false}function isRGB(a){if(a.match(/^rgb\(\d+,\d+,\d+\)$/)){return true}else{return false}}function isFloat(a){if(a.match(/^(\+|\-)?\d*\.\d*$/)&&a.length>1){return true}else{if(a.match(/^(\+|\-)?\d*\.\d*e(\+|\-)?\d+$/)&&a.length>1){return true}else{return false}}}function isInt(a){if(a.length==1){return a.match(/^\d$/)}else{return a.match(/^(\+|\-)?\d+$/)}}function parseRGB(a){var b=a.match(/^rgb\((\d+),(\d+),(\d+)\)$/);if(!b){return null}else{return new Color(b[1],b[2],b[3],255)}}function str_contains(a,b){return a.indexOf(b)!=-1}function bint32(a,b){return(((a.charCodeAt(b)&255)<<24)+((a.charCodeAt(b+1)&255)<<16)+((a.charCodeAt(b+2)&255)<<8)+(a.charCodeAt(b+3)&255))}function lint32(a,b){return(((a.charCodeAt(b+3)&255)<<24)+((a.charCodeAt(b+2)&255)<<16)+((a.charCodeAt(b+1)&255)<<8)+(a.charCodeAt(b)&255))}function ldbl64(e,d){var m=e.charCodeAt(d)&255;var l=e.charCodeAt(d+1)&255;var k=e.charCodeAt(d+2)&255;var j=e.charCodeAt(d+3)&255;var i=e.charCodeAt(d+4)&255;var h=e.charCodeAt(d+5)&255;var g=e.charCodeAt(d+6)&255;var f=e.charCodeAt(d+7)&255;var b=1-2*(f>>7);var c=(((f&127)<<4)+((g&240)>>4))-1023;var a=(g&15)*Math.pow(2,48)+h*Math.pow(2,40)+i*Math.pow(2,32)+j*Math.pow(2,24)+k*Math.pow(2,16)+l*Math.pow(2,8)+m;return b*(1+a*Math.pow(2,-52))*Math.pow(2,c)}function lfloat32(e,d){var i=e.charCodeAt(d)&255;var h=e.charCodeAt(d+1)&255;var g=e.charCodeAt(d+2)&255;var f=e.charCodeAt(d+3)&255;var b=1-2*(f>>7);var c=(((f&127)<<1)+((g&254)>>7))-127;var a=(g&127)*Math.pow(2,16)+h*Math.pow(2,8)+i;return b*(1+a*Math.pow(2,-23))*Math.pow(2,c)}function vect(a,c,b){this.x=a;this.y=c;if(!b){this.z=0}else{this.z=b}this.add=function(d){this.x+=d.x;this.y+=d.y;this.z+=d.z};this.sub=function(d){this.x-=d.x;this.y-=d.y;this.z-=d.z};this.scale=function(d){this.x*=d;this.y*=d;this.z*=d};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var d=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(d==0){return}this.x/=d;this.y/=d;this.z/=d};this.div=function(d){this.x/=d.x;this.y/=d.y;this.z/=d.z};this.floor=function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return((this.x+this.y+this.z)==0)};this.dot=function(d){return(this.x*d.x)+(this.y*d.y)+(this.z*d.z)};this.cross=function(d){throw"Need to reimplement"};this.rotate=function(f){var e=Math.cos(f);var d=Math.sin(f);xp=e*this.x-d*this.y;yp=d*this.x+e*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}vect.scale=function(a,b){return new vect(a.x*b,a.y*b,a.z*b)};vect.add=function(b,a){return new vect(b.x+a.x,b.y+a.y,b.z+a.z)};vect.sub=function(b,a){if(!b||!a){throw"Bad Vector"}return new vect(b.x-a.x,b.y-a.y,b.z-a.z)};vect.dist=function(e,c){var a=c.x-e.x;var d=c.y-e.y;var b=c.z-e.z;return Math.sqrt(a*a+d*d+b*b)};vect.dir=function(c,b){var a=vect.sub(c,b);a.normalize();return a};vect.dot2d=function(b,a){return(b.x*a.x)+(b.y*a.y)};vect.cross=function(b,a){return(b.x*a.y)-(b.y*a.x)};vect.left=function(f,d,i,e){if(!e){e=0}var h=vect.sub(d,f);var g=vect.sub(i,f);return(vect.cross(h,g)>=-e)};vect.intersects=function(g,e,i,h,f){if(!f){f=0}return(vect.left(g,e,i,f)!=vect.left(g,e,h,f)&&vect.left(i,h,e,f)!=vect.left(i,h,g,f))};vect.intersect2dt=function(k,j,i,h){var f=k.x*(h.y-i.y)+j.x*(i.y-h.y)+h.x*(j.y-k.y)+i.x*(k.y-j.y);if(f==0){return Infinity}var g=k.x*(h.y-i.y)+i.x*(k.y-h.y)+h.x*(i.y-k.y);var m=g/f;var e=-(k.x*(i.y-j.y)+j.x*(k.y-i.y)+i.x*(j.y-k.y));var l=e/f;return l};vect.intersect2dpos=function(l,k,j,i){var g=l.x*(i.y-j.y)+k.x*(j.y-i.y)+i.x*(k.y-l.y)+j.x*(l.y-k.y);if(g==0){return Infinity}var h=l.x*(i.y-j.y)+j.x*(l.y-i.y)+i.x*(j.y-l.y);var n=h/g;var f=-(l.x*(j.y-k.y)+k.x*(l.y-j.y)+j.x*(k.y-l.y));var m=f/g;var e=vect.sub(k,l);e.scale(n);return vect.add(l,e)};vect.rotate=function(b,d){var c=Math.cos(d);var a=Math.sin(d);xp=c*b.x-a*b.y;yp=a*b.x+c*b.y;var b=new vect(xp,yp,b.z);return b};var DEBUG=false;gl=null;function setContext(b){if(!DEBUG){gl=b.get(0).getContext("experimental-webgl",{alpha:false,antialias:true,premultipliedAlpha:false})}else{function a(d,e,c){throw WebGLDebugUtils.glEnumToString(d)+" was caused by call to "+e}gl=WebGLDebugUtils.makeDebugContext(b.get(0).getContext("experimental-webgl",{alpha:false,antialias:true,premultipliedAlpha:false}),a)}}function rect(a,e,b,c){var d=[a-b,e+c,a-b,e-c,a+b,e+c,a-b,e-c,a+b,e-c,a+b,e+c];return d}function rectv(c,a,b){var d;if(arguments.length==2){d=[c.x,a.y,c.x,c.y,a.x,a.y,c.x,c.y,a.x,c.y,a.x,a.y]}else{d=[c.x,a.y,b,c.x,c.y,b,a.x,a.y,b,c.x,c.y,b,a.x,c.y,b,a.x,a.y,b]}return d}function makeProgram(c){if(!gl){return null}var a=gl.createProgram();var b=getShader(gl.VERTEX_SHADER,c+"/vert.glsl");var d=getShader(gl.FRAGMENT_SHADER,c+"/frag.glsl");gl.attachShader(a,b);gl.attachShader(a,d);gl.linkProgram(a);addVars(a,b,d);return a}function getShader(b,c){var a=gl.createShader(b);$.ajax({async:false,url:c,dataType:"text",success:function(d){gl.shaderSource(a,d);gl.compileShader(a);if(!gl.getShaderParameter(a,gl.COMPILE_STATUS)){throw (gl.getShaderInfoLog(a))}a.source=d},error:function(d){console.log("Could not load "+c)}});return a}function addVars(a,c,k){var j={};var e={};var h=(c.source+k.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg);var f=0;gl.useProgram(a);if(h){for(var b=0;b<h.length;b++){var g=h[b].split(" ");j[g[2]]={u:g[0],type:g[1],loc:null};if(g[0]=="uniform"){j[g[2]].loc=gl.getUniformLocation(a,g[2])}else{var d=gl.getAttribLocation(a,g[2]);j[g[2]].loc=d}if(g[1]=="sampler2D"){j[g[2]].tex=f;f++}}a.get=function(i){return j[i].loc};a.data=function(i,l){var m=j[i];if(!m){throw"Could not find shader variable "+i}if(m.u=="uniform"){if(m.type=="float"){gl.uniform1f(m.loc,l)}else{if(m.type=="vec2"){gl.uniform2fv(m.loc,l)}else{if(m.type=="ivec2"){gl.uniform2iv(m.loc,l)}else{if(m.type=="vec3"){gl.uniform3fv(m.loc,l)}else{if(m.type=="ivec3"){gl.uniform3iv(m.loc,l)}else{if(m.type=="vec4"){gl.uniform4fv(m.loc,l)}else{if(m.type=="ivec4"){gl.uniform4iv(m.loc,l)}else{if(m.type=="bool"){gl.uniform1i(m.loc,l)}else{if(m.type=="mat4"){gl.uniformMatrix4fv(m.loc,false,l)}else{if(m.type=="mat3"){gl.uniformMatrix3fv(m.loc,false,l)}else{if(m.type=="sampler2D"){if("texture" in l){l=l.texture()}gl.activeTexture(gl["TEXTURE"+m.tex]);gl.bindTexture(gl.TEXTURE_2D,l);gl.uniform1i(m.loc,m.tex)}else{if(m.type=="int"){gl.uniform1i(m.loc,l)}else{throw"Unsupported Type for Shader Helper: "+m.type}}}}}}}}}}}}}else{if(m.u=="attribute"){gl.enableVertexAttribArray(m.loc);gl.bindBuffer(gl.ARRAY_BUFFER,l);gl.vertexAttribPointer(m.loc,l.itemSize,gl.FLOAT,false,0,0)}else{throw"Type: "+m.u+" Recieved"}}}}}function repeats(f,g,e){var d=gl.createBuffer();d.itemSize=g;d.numItems=e;var c=new Float32Array(f.length*e*g);for(var b=0;b<e;b++){for(var a=0;a<f.length;a++){c[b*f.length+a]=f[a]}}gl.bindBuffer(gl.ARRAY_BUFFER,d);gl.bufferData(gl.ARRAY_BUFFER,c,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return d}function staticBuffer(c,d){var b=gl.createBuffer();var a=new Float32Array(c);gl.bindBuffer(gl.ARRAY_BUFFER,b);b.itemSize=d;b.numItems=c.length/d;gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return b}function staticBufferJoin(g,h){var f=gl.createBuffer();var e=0;for(var c=0;c<g.length;c++){e+=g[c].length}var d=new Float32Array(e);var b=0;for(var c=0;c<g.length;c++){for(var a=0;a<g[c].length;a++){d[b]=g[c][a];b++}}gl.bindBuffer(gl.ARRAY_BUFFER,f);f.itemSize=h;f.numItems=e/h;gl.bufferData(gl.ARRAY_BUFFER,d,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return f}function dynamicBuffer(a,d){if(!gl){return null}var c=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,c);var b=new Float32Array(a*d);c.itemSize=d;c.numItems=a;c.update=function(g,e){var f=new Float32Array(g);gl.bindBuffer(gl.ARRAY_BUFFER,c);gl.bufferSubData(gl.ARRAY_BUFFER,4*e,f);gl.bindBuffer(gl.ARRAY_BUFFER,null)};gl.bufferData(gl.ARRAY_BUFFER,b,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);return c}function indexBuffer(a,d){var c=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,c);var b=new Uint16Array(a);c.itemSize=d;c.numItems=a/d;c.update=function(g,e){var f=new Uint16Array(g);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,c);gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,2*e,f);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)};gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,b,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null);return c}var tex_count=0;function getTexture(d,c){var b=gl.createTexture();b.id=tex_count;tex_count++;var a=new Image();a.onload=function(){gl.bindTexture(gl.TEXTURE_2D,b);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);if(c){c()}};a.src=d;return b}function Texture(c){var d=copy(c);default_model(d,{mag_filter:gl.LINEAR,min_filter:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,mipmap:false});var b=gl.createTexture();var a=null;this.image=function(e){a=e;gl.bindTexture(gl.TEXTURE_2D,b);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,d.mag_filter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,d.min_filter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,d.wrap_s);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,d.wrap_t);if(d.mipmap){gl.generateMipmap(gl.TEXTURE_2D)}gl.bindTexture(gl.TEXTURE_2D,null)};this.texture=function(){if(!a){return null}else{return b}}}function getImage(c,b){var a=new Image();a.crossOrigin="";a.onload=function(){b(a)};a.src=c}function Camera(b,a){if(!a){a={}}if(!("center" in a)){a.center=new vect(0,0)}if(!("extents" in a)){a.extents=180}this.mat3=new Float32Array(9);var c=b.width()/b.height();this.mat3[0]=2/a.extents;this.mat3[4]=c*2/a.extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(d){var e=new vect(2*(d.x-b.offset().left)/b.width()-1,-(2*(d.y-b.offset().top)/b.height()-1));e.x=e.x/this.mat3[0]-this.mat3[6]/this.mat3[0];e.y=e.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return e};this.screen=function(d){var e=new vect(d.x*this.mat3[0]+this.mat3[6],d.y*this.mat3[4]+this.mat3[7]);e.x=b.offset().left+b.width()*(e.x+1)/2;e.y=b.offset().top+b.height()*(-e.y+1)/2;return e};this.percent=function(d){return new vect(2*((d.x-b.offset().left)/b.width())-1,-(2*((d.y-b.offset().top)/b.height())-1))};this.pixel=function(d){return new vect(b.offset().left+((d.x+1)/2)*b.width(),b.offset().top+((-d.y+1)/2)*b.height())};this.move=function(d){this.mat3[6]-=d.x*this.mat3[0];this.mat3[7]-=d.y*this.mat3[4]};this.position=function(d){if(!d){return new vect(-this.mat3[6]/this.mat3[0],-this.mat3[7]/this.mat3[4])}this.mat3[6]=-d.x*this.mat3[0];this.mat3[7]=-d.y*this.mat3[4]};this.position(a.center);this.extents=function(d){a.extents=d;var e=this.position();this.level=1;this.mat3[0]=2/a.extents;this.mat3[4]=c*2/a.extents;this.position(e)};this.zoom=function(d){var e=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=d;this.mat3[4]*=d;this.mat3[6]=e.x*this.mat3[0];this.mat3[7]=e.y*this.mat3[4];this.level*=d};this.reset=function(){this.zoom(1/this.level)};this.reconfigure=function(){var d=this.position();this.mat3[4]/=c;c=b.width()/b.height();this.mat3[4]*=c;this.position(d)}}function Scroller(a){var d=false;var g=new vect(0,0);var f=new vect(0,0);var b=null;var e=0;a.canvas.mousedown(function(h){g=new vect(h.clientX,h.clientY);d=true});$(window).bind("mouseup",function(){d=false});$(document).bind("keypress","+",function(h){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(h){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(h){a.camera.reset()});a.canvas.bind("mousewheel",function(h,i){i*=0.5;if(i<0){i*=-1;i+=1;i=1/i}else{i+=1}a.camera.zoom(i);h.preventDefault()});var c=true;this.disable=function(){c=false};this.enable=function(){c=true};this.update=function(i){f=new vect(Mouse.x,Mouse.y);if(d&&c){var h=vect.sub(a.camera.project(g),a.camera.project(f));a.camera.move(h);g=f;e=h.length()/i;b=h;b.normalize()}else{if(e>0.01){if(b){a.camera.move(vect.scale(b,e*i));e-=3*i*e}}}}}function EventManager(q){var n={mouseover:{},mouseout:{},click:{}};var d={};var j={};var a=0;var i=0;var m=0;var o=function(){m++;if(m>255){m=0;i++}if(i>255){i=0;a++}if(a>255){throw"Too many elements to assign unique id"}return{r:a,g:i,b:m}};this.register=function(g,r){var s=o();var b=s.r+","+s.g+","+s.b;d[b]=g;j[b]=r;if(!(g.id in n.click)){for(b in n){n[b][g.id]=[]}}return s};this.bind=function(g,b,r){if(!(g in n)){throw"Event type "+g+" does not exist"}n[g][b.id].push(r)};var f=-1;var e=-1;var k=new Uint8Array(4);var h=function(b){return(b[0]==0&&b[1]==0&&b[2]==0)};var c=function(u,g){var t=g[0]+","+g[1]+","+g[2];var s=d[t];var b=j[t];for(var r=0;r<n[u][s.id].length;r++){n[u][s.id][r](new LayerSelector([b]))}};var p=false;var l=[];this.click=function(b,g){p=true;l.push({x:b,y:g})};this.update=function(s){if(f!=Mouse.x||e!=Mouse.y){var b=q.read_pixel(Mouse.x,Mouse.y);f=Mouse.x;e=Mouse.y;var u=true;for(var r=0;r<4;r++){if(k[r]!=b[r]){u=false}}if(u){return null}if(!h(k)){c("mouseout",k)}for(var r=0;r<4;r++){k[r]=b[r]}if(h(b)){return null}c("mouseover",b)}if(p){p=false;while(l.length>0){var t=l.splice(0,1)[0];var g=q.read_pixel(t.x,t.y);if(!h(g)){c("click",g)}}}}}var TILE_SERVER="http://eland.ecohealthalliance.org:8080/wigglemaps";var Mouse={x:0,y:0};var blur_shader=null;var light_shader=null;function Engine(e,j){if(!j){j={}}default_model(j,{base:"default",background:new Color(0,0,0,1),antialias:true});var i=this;this.canvas=$("<canvas></canvas>").attr("id","viewer");if(e){$(e).append(this.canvas);this.canvas.attr("width",$(e).width());this.canvas.attr("height",$(e).height())}else{e=window;$("body").append(this.canvas);this.canvas.attr("width",$(e).width());this.canvas.attr("height",$(e).height());$(window).resize(function(){i.resize()})}this.resize=function(){i.canvas.attr("width",$(e).width());i.canvas.attr("height",$(e).height());gl.viewport(0,0,i.canvas.width(),i.canvas.height());i.camera.reconfigure();for(var p=0;p<d.length;p++){d[p].resize()}};setContext(this.canvas,DEBUG);gl.viewport(0,0,i.canvas.width(),i.canvas.height());gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);gl.enable(gl.BLEND);if(!blur_shader){blur_shader=makeProgram(BASE_DIR+"shaders/blur")}if(!light_shader){light_shader=makeProgram(BASE_DIR+"shaders/light")}var o=new Buffers(6);o.create("vert",2);o.create("tex",2);var c=o.alloc(6);o.write("vert",rectv(new vect(-1,-1),new vect(1,1)),c,6);o.write("tex",rectv(new vect(0,0),new vect(1,1)),c,6);o.update();this.scene=[];this.camera=new Camera(this.canvas,j);this.scroller=new Scroller(this);this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.sel=new SelectionBox(this);this.select=function(p){if(p){this.scroller.disable();this.sel.enable()}else{this.scroller.enable();this.sel.disable()}};var f=new Date().getTime();var n=[];this.attr=function(p,q){if(p=="base"){j.base=q;h()}};var b=null;var h=function(){if(j.base=="default"||j.base=="nasa"){var p=copy(j);copy_to(p,{source:"file",url:TILE_SERVER+"/tiles/nasa_topo_bathy",levels:8,size:256});b=new MultiTileLayer(p)}else{if(j.base=="ne"){var p=copy(j);copy_to(p,{source:"file",url:TILE_SERVER+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256});b=new MultiTileLayer(p)}else{if(j.base=="ne1"){var p=copy(j);copy_to(p,{source:"file",url:TILE_SERVER+"/tiles/NE1_HR_LC",levels:6,size:256});b=new MultiTileLayer(p)}else{b=null}}}};h();this.enable_z=function(){gl.depthFunc(gl.LEQUAL);gl.enable(gl.DEPTH_TEST)};this.disable_z=function(){gl.disable(gl.DEPTH_TEST)};var d=[];var l=[null];this.framebuffer=function(){var r=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,r);r.width=i.canvas.width();r.height=i.canvas.height();var q=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,q);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,r.width,r.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);var p=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,p);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,r.width,r.height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,q,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,p);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);var s={framebuffer:r,renderbuffer:p,tex:q,resize:function(){r.width=i.canvas.width();r.height=i.canvas.height();gl.bindTexture(gl.TEXTURE_2D,q);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,r.width,r.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.bindRenderbuffer(gl.RENDERBUFFER,p);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,r.width,r.height);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null)},activate:function(t){if(!t){t={}}default_model(t,{blend:true,clear:true});l.push(r);if(!t.blend){gl.disable(gl.BLEND)}gl.bindFramebuffer(gl.FRAMEBUFFER,r);gl.viewport(0,0,i.canvas.width(),i.canvas.height());if(t.clear){gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);gl.clearDepth(0)}},deactivate:function(){var u=l.pop();var t=l[l.length-1];if(u!=r){throw"Non-nested use of framebuffers"}gl.bindFramebuffer(gl.FRAMEBUFFER,t);gl.enable(gl.BLEND)},};d.push(s);return s};var a=this.framebuffer();var g=this.framebuffer();this.draw_blur=function(p){gl.useProgram(blur_shader);g.activate({blend:false});blur_shader.data("pos",o.get("vert"));blur_shader.data("tex_in",o.get("tex"));blur_shader.data("sampler",p);blur_shader.data("width",i.canvas.width());blur_shader.data("height",i.canvas.height());blur_shader.data("hor",true);gl.drawArrays(gl.TRIANGLES,0,o.count());g.deactivate();blur_shader.data("pos",o.get("vert"));blur_shader.data("tex_in",o.get("tex"));blur_shader.data("sampler",g.tex);blur_shader.data("width",i.canvas.width());blur_shader.data("height",i.canvas.height());blur_shader.data("hor",false);gl.drawArrays(gl.TRIANGLES,0,o.count())};this.dirty=true;var k=function(){var s=new Date().getTime();var q=(s-f)/1000;i.scroller.update(q);if(n.length>=60){n.splice(0,1)}n.push(q);var r=0;for(var p=0;p<n.length;p++){r+=n[p]}r/=n.length;$("#fps").text(Math.floor(1/r));f=s;gl.clearColor(j.background.r,j.background.g,j.background.b,j.background.a);gl.clear(gl.COLOR_BUFFER_BIT);gl.clearDepth(0);var t=false;if(i.shade){t=i.shade.ready()}if(t){a.activate()}if(b){b.draw(i,q)}for(var p=0;p<i.scene.length;p++){i.scene[p].draw(i,q,false)}i.sel.draw(i,q);requestAnimationFrame(k)};this.read_pixel=function(p,t){gl.bindFramebuffer(gl.FRAMEBUFFER,i.framebuffer);var r=new Uint8Array(4);var s=(p-i.canvas.position().left)/i.canvas.width();var q=(i.canvas.position().top+i.canvas.height()-t)/i.canvas.height();gl.readPixels(parseInt(s*i.framebuffer.width),parseInt(q*i.framebuffer.height),1,1,gl.RGBA,gl.UNSIGNED_BYTE,r);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return r};$(document).mousemove(function(p){Mouse.x=p.clientX;Mouse.y=p.clientY});this.canvas.click(function(p){});this.canvas.dblclick(function(p){});var m=false;this.canvas.mousedown(function(p){m=true});this.canvas.mouseup(function(p){m=false});this.canvas.mousemove(function(q){if(m){}else{var r=i.camera.project(new vect(Mouse.x,Mouse.y));$.each(i.scene,function(s,p){if(p.update_move){p.update_move(i,r)}})}});this.canvas.mouseout(function(p){$.each(i.scene,function(r,q){if(q.force_out){q.force_out(i)}})});requestAnimationFrame(k)}function Buffers(e){var d={};var b;if(!e){b=256}else{b=e}var f=0;var c=function(l,j,k,h){if(!l){console.log("ack")}if(!k){k=0}if(!h){h=j.length}for(var g=0;g<h;g++){l[k+g]=j[g]}};var a=function(h){var k=b;while(k<h){k*=2}b=k;for(name in d){var g=new Float32Array(k*d[name].len);var j=d[name].array;var i=dynamicBuffer(b,d[name].len);c(g,j);d[name].array=g;d[name].buffer=i;d[name].dirty=true}};this.create=function(h,g){if(!g){throw"Length of buffer must be a positive integer"}var j=new Float32Array(b*g);var i=dynamicBuffer(b,g);d[h]={array:j,buffer:i,len:g,dirty:false}};this.alloc=function(g){if((f+g)>=b){a(f+g)}var h=f;f+=g;return h};this.get=function(g){return d[g].buffer};this.write=function(g,j,i,h){c(d[g].array,j,i*d[g].len,h*d[g].len);d[g].dirty=true};this.repeat=function(g,k,l,j){for(var h=0;h<j;h++){c(d[g].array,k,(l+h)*d[g].len,d[g].len)}d[g].dirty=true};this.count=function(){return f};this.data=function(g){return d[g].array};this.update=function(g){for(name in d){if(d[name].dirty){if(d[name].buffer){d[name].buffer.update(d[name].array,0)}d[name].dirty=false}}}}var sel_box_shader=null;function SelectionBox(i){if(!sel_box_shader){sel_box_shader=makeProgram(BASE_DIR+"shaders/selbox")}var b=false;var g=false;var c=null;var d=null;var e=dynamicBuffer(6,2);var f=staticBuffer(rect(0,0,1,1),2);var h=function(){e.update(rectv(c,d),0)};i.canvas.bind("mousedown",function(j){if(!b){return}g=true;show=true;c=i.camera.percent(new vect(j.clientX,j.clientY));d=c;h()});var a=function(){};this.select=function(j){a=j};$(document).bind("mouseup",function(m){if(!b){return}if(!g){return}var l=i.camera.project(i.camera.pixel(c));var j=i.camera.project(i.camera.pixel(d));if(l.x>j.x){var k=l.x;l.x=j.x;j.x=k}if(l.y>j.y){var k=l.y;l.y=j.y;j.y=k}g=false;a(new Box(l,j))});$(document).bind("click",function(j){if(!b){return}show=false});$(document).bind("mousemove",function(j){if(!b){return}if(g){d=i.camera.percent(new vect(j.clientX,j.clientY));h()}});this.enable=function(){b=true};this.disable=function(){b=false};this.draw=function(j,k){if(g){gl.useProgram(sel_box_shader);sel_box_shader.data("pos",e);sel_box_shader.data("edge_in",f);gl.drawArrays(gl.TRIANGLES,0,e.numItems)}}}function circle(b,a){while(b>=a){b-=a}while(b<0){b+=a}return b}function Vertex(d,c,b,a){this.current=d;this.upper=c;this.lower=b;this.index=a}function xsearch(e,d,b){var c=e.length-1;var a=0;var f=parseInt((e.length-1)/2);if(e.length==0){return 0}while(true){if(c<0||a>=e.length){console.log(c,a,f,e.length);throw"Index Out of Bounds"}if(e[f]==b){return f}if(c==a){if(d[e[f]].x>d[b].x){return f}else{return f+1}}if(d[e[f]].x>d[b].x){c=f}else{if(d[e[f]].x<d[b].x){a=f+1}else{if(d[e[f]].y>d[b].y){if(a==f){return a}c=f-1}else{if(c==f){return f}a=f+1}}}f=parseInt((c+a)/2)}}function set_contains(c,a){for(var b=0;b<c.length;b++){if(c[b]==a){return true}}return false}function solvex(c,a,d){if(a==undefined){throw"whoa"}if((c[a+1].y-c[a].y)==0){return Math.min(c[a].x,c[a+1].x)}var b=(d-c[a].y)/(c[a+1].y-c[a].y);return c[a].x+(c[a+1].x-c[a].x)*b}function find_index(c,a){for(var b=0;b<c.length;b++){if(c[b]==a){return b}}return false}function sorted_index(d,c,a,e){for(var b=0;b<d.length;b++){var f=solvex(c,d[b],e);if(f>a){return b}if(f-a==0){if(c[d[b]].y>c[index].y){return b}}}return d.length}function intersect(a,c,b){return new vect(solvex(c,b,c[a].y),c[a].y)}function add_point(c,b){if(!b){throw"eek"}c.push(b.x);c.push(b.y)}function add_trap(a,d,e){if(!d||!e||((e.length+d.length!=3)&&(e.length+d.length!=4))){throw"ahh"}if((d.length+e.length)==3){for(var c=0;c<d.length;c++){add_point(a,d[c])}for(var c=0;c<e.length;c++){add_point(a,e[c])}}else{if(d[1].x<d[0].x){var b=d[0];d[0]=d[1];d[1]=b}if(e[1].x<e[0].x){var b=e[0];e[0]=e[1];e[1]=b}add_point(a,d[0]);add_point(a,d[1]);add_point(a,e[1]);add_point(a,e[0]);add_point(a,e[1]);add_point(a,d[0])}}function trapezoid_polygon(n){var e=[];var g=0;var f=[];for(var r=0;r<n.length;r++){for(var t=0;t<n[r].length-1;t++){var s=circle(t+1,n[r].length-1);var u=circle(t-1,n[r].length-1);e.push(new Vertex(t+g,s+g,u+g,r));f.push(n[r][t])}f.push(n[r][0]);g+=n[r].length}e.sort(function(i,h){return f[i.current].y-f[h.current].y});var p=[];var d=[];var x=new vect(-200,0);var w=new vect(200,0);var g=0;var A=[];var c=0;var y=[];for(var t=0;t<e.length;t++){var m=e[t];var a=set_contains(p,m.lower);var l=set_contains(p,m.current);var b,q;if(a&&!l){b=find_index(p,m.lower);q=b}else{if(l&&!a){q=find_index(p,m.current);b=q}else{if(a&&l){b=find_index(p,m.lower);q=find_index(p,m.current)}else{if(!a&&!l){q=sorted_index(p,f,f[m.current].x,f[m.current].y);b=q}}}}if(Math.abs(b-q)>1){for(var s=0;s<p.length;s++){}throw"Bad"}var o=vect.left(f[m.lower],f[m.current],f[m.upper]);var z=Math.floor(Math.min(b,q)/2);if(!o&&!a&&!l){add_trap(y,d[z],[intersect(m.current,f,p[q-1]),intersect(m.current,f,p[q])]);d.splice(z,1,[intersect(m.current,f,p[q-1]),f[m.current]],[f[m.current],intersect(m.current,f,p[b])])}else{if(o&&!a&&!l){d.splice(z,0,[f[m.current]])}else{if(a&&!l){add_trap(y,d[z],[intersect(m.current,f,p[Math.max(b,q)-1]),f[m.current]]);d[z]=[intersect(m.current,f,p[Math.min(b,q)-1]),f[m.current]]}else{if(!a&&l){add_trap(y,d[z],[f[m.current],intersect(m.current,f,p[Math.min(q,b)+1])]);d[z]=[f[m.current],intersect(m.current,f,p[Math.max(q,b)+1])]}else{if(!o&&a&&l){add_trap(y,d[z],[intersect(m.current,f,p[Math.min(b,q)-1]),f[m.current]]);add_trap(y,d[z+1],[intersect(m.current,f,p[Math.max(b,q)+1]),f[m.current]]);d.splice(z,2,[intersect(m.current,f,p[Math.min(b,q)-1]),intersect(m.current,f,p[Math.max(b,q)+1])])}else{if(o&&a&&l){add_trap(y,d[z],[f[m.current]]);d.splice(z,1)}}}}}}if(a&&!l){p[b]=m.current}else{if(l&&!a){p[q]=m.lower}else{if(a&&l){p.splice(find_index(p,m.lower),1);p.splice(find_index(p,m.current),1)}else{if(!a&&!l){if(!o){p.splice(b,0,m.current,m.lower)}else{p.splice(b,0,m.lower,m.current)}}}}}for(var s=0;s<p.length-1;s++){if(solvex(f,p[s],f[m.current].y)>solvex(f,p[s+1],f[m.current].y)){console.log("Misplaced Sweep");throw"Misplace!"}}}if(p.length>0){console.log(p);throw"Bad "+p.length}if(A.length>0){console.log(A);throw"Wrong"}return y}function Box(b,a){this.min=b;this.max=a;this.contains=function(c){return(b.x<=c.x)&&(a.x>=c.x)&&(b.y<=c.y)&&(a.y>=c.y)};this.x_in=function(c){return(b.x<=c.x)&&(a.x>=c.x)};this.x_left=function(c){return(b.x>=c.x)};this.x_right=function(c){return(a.x<=c.x)};this.y_in=function(c){return(b.y<=c.y)&&(a.y>=c.y)};this.y_left=function(c){return(b.y>=c.y)};this.y_right=function(c){return(a.y<=c.y)};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(c){switch(c){case 0:return this.min.clone();break;case 1:return new vect(this.max.x,this.min.y);break;case 2:return this.max.clone();break;case 3:return new vect(this.min.x,this.max.y);break;default:throw"Index out of bounds: "+c}};this.intersects=function(e){for(var d=0;d<4;d++){for(var c=0;c<4;c++){if(vect.intersects(this.vertex(d),this.vertex((d+1)%4),e.vertex(c),e.vertex((c+1)%4))){return true}}}if(this.contains(e.min)&&this.contains(e.max)&&this.contains(new vect(e.min.x,e.max.y))&&this.contains(new vect(e.max.x,e.min.y))){return true}if(e.contains(this.min)&&e.contains(this.max)&&e.contains(new vect(this.min.x,this.max.y))&&e.contains(new vect(this.max.x,this.min.y))){return true}return false};this.union=function(c){this.min.x=Math.min(this.min.x,c.min.x);this.min.y=Math.min(this.min.y,c.min.y);this.max.x=Math.max(this.max.x,c.max.x);this.max.y=Math.max(this.max.y,c.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new Box(b,a)}}function RangeNode(d,f,a,e){this.data=d[e];this.left=null;this.right=null;if(f!=e){this.left=new RangeNode(d,f,e-1,parseInt((f+(e-1))/2))}if(a!=e){this.right=new RangeNode(d,e+1,a,parseInt((a+(e+1))/2))}this.subtree=[];for(var c=f;c<=a;c++){this.subtree.push(d[c])}this.subtree.sort(function(h,g){return h.y-g.y});var b=function(g){return(g.x_in(d[f])&&g.x_in(d[a]))};this.yrange=function(g,i,h){return(g.y_in(this.subtree[i])&&g.y_in(this.subtree[h]))};this.subquery=function(k,j,m,g,l){if(this.yrange(j,m,g)){for(var h=m;h<=g;h++){k.push(this.subtree[h])}return}if(j.y_in(this.subtree[l])){k.push(this.subtree[l])}if(j.y_left(this.subtree[l])){if(l!=g){this.subquery(k,j,l+1,g,parseInt((g+(l+1))/2))}}else{if(j.x_right(this.subtree[l])){if(l!=m){this.subquery(k,j,m,l-1,parseInt((m+(l-1))/2))}}else{if(l!=g){this.subquery(k,j,l+1,g,parseInt((g+(l+1))/2))}if(l!=m){this.subquery(k,j,m,l-1,parseInt((m+(l-1))/2))}}}};this.search=function(h,g){if(b(g)){this.subquery(h,g,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2));return}else{if(g.contains(this.data)){h.push(this.data)}if(g.x_left(this.data)){if(this.right){this.right.search(h,g)}}else{if(g.x_right(this.data)){if(this.left){this.left.search(h,g)}}else{if(this.left){this.left.search(h,g)}if(this.right){this.right.search(h,g)}}}}}}function RangeTree(a){a.sort(function(d,c){return d.x-c.x});this.root=new RangeNode(a,0,a.length-1,parseInt((a.length-1)/2));this.search=function(c,b){var d=new Box(c,b);var e=[];this.root.search(e,d);return e}}var EARTH=6378.1;var new_feature_id=(function(){var a=1;return function(){var b=a;a++;return b}})();var rand_map=(function(){var b=0.000001;var a={};var c={};return function(d,f){return new vect(d+Math.random()*b-(b/2),f+Math.random()*b-(b/2));var e=d.toString()+","+f.toString();if(!(e in a)){a[e]=d+Math.random()*b-(b/2);c[e]=f+Math.random()*b-(b/2)}return new vect(a[e],c[e])}})();function Polygon(c,h){if(!h){h={}}if(!h.attr){h.attr={}}if(!h.style){h.style={}}this.geom=c;this.attr=h.attr;this.id=null;var b=null;var e,f;var g,d;var a=null}var point_shader=null;var circle_tex;var unit=rect(0,0,1,1);var default_point_color=new Color(0.02,0.44,0.69,1);var default_point_alpha=1;function PointLayer(a){if(!point_shader){point_shader=makeProgram(BASE_DIR+"shaders/point");circle_tex=getTexture(BASE_DIR+"images/circle.png")}this.id=new_feature_id();var j=new Buffers(a);j.create("vert",2);j.create("unit",2);j.create("color",3);j.create("alpha",1);var c=this;var g=function(q){if(!q){q={}}if(!q.geom){q.geom=[]}if(!q.attr){q.attr={}}if(!q.style){q.style={}}this.geom=q.geom;this.attr=q.attr;this.id=new_feature_id();var p,l;var n=0;var m={};copy_value(m,q.style,"fill",hex_to_color);copy_value(m,q.style,"opacity",parseFloat);var o=function(){var r=m.fill;if(!r){r=c.style("fill")}if(!r){r=default_point_color}j.repeat("color",r.array,p,l)};var k=function(){var r=m.opacity;if(!r){r=c.style("opacity")}if(!r){r=default_point_alpha}j.repeat("alpha",[r],p,l)};this.style=function(r,s){if(arguments.length==1){return m[r]}m[r]=s;if(r=="fill"){o()}if(r=="opacity"){k()}};n=this.geom.length;l=6*n;p=j.alloc(l);$.each(this.geom,function(s,r){j.repeat("vert",r,p+s*6,6);j.write("unit",unit,p+s*6,6)});o();k()};var i=null;var f=0;var b=false;var h={};var e={};this.append=function(k){var l=new g(k);for(key in l.attr){h[key]=true}e[l.id]=l;f++;b=true;i=null;return l};this.features=function(){var k=[];for(key in e){k.push(e[key])}return new LayerSelector(k)};this.attr=function(){var k=[];for(key in h){k.push(key)}return k};this.search=function(o){var m=o.min;var k=o.max;var n=i.search(m,k);var l=[];$.each(n,function(q,p){l.push(e[p.key])});return new LayerSelector(l)};this.mouseover=function(k){};this.mouseout=function(k){};this.click=function(k){};this.style=function(k,l){if(arguments.length>1){throw"Not Implemented"}return null};this.update_move=function(k,l){};var d=0;this.draw=function(k,m,o){j.update(m);if(f>0){if(b){if(!i){var n=[];for(var l in e){$.each(e[l].geom,function(q,p){n.push({key:l,x:p[0],y:p[1]})})}i=new RangeTree(n)}b=false}gl.useProgram(point_shader);point_shader.data("screen",k.camera.mat3);point_shader.data("pos",j.get("vert"));point_shader.data("circle_in",j.get("unit"));if(o){return}else{point_shader.data("color_in",j.get("color"));point_shader.data("alpha_in",j.get("alpha"))}point_shader.data("select",o);point_shader.data("aspect",k.canvas.width()/k.canvas.height());point_shader.data("pix_w",2/k.canvas.width());point_shader.data("rad",5);point_shader.data("glyph",circle_tex);point_shader.data("zoom",1/k.camera.level);gl.drawArrays(gl.TRIANGLES,0,j.count())}}}var poly_shader=null;var triangulate_polygon=function(c){var d=[];for(var a=0;a<c.length;a++){var e=[];for(var b=1;b<c[a].length;b++){e.push(rand_map(c[a][b][0],c[a][b][1]))}e.push(d[0]);d.push(e)}return trapezoid_polygon(d)};function PolygonLayer(c){if(!c){c={}}if(!c.style){c.style={}}var h,f,d,k;if("fill" in c.style){h=c.style.fill}else{h=new Color(0.02,0.44,0.69,1)}if("stroke" in c.style){f=c.style.stroke}else{f=new Color(0.02,0.44,0.69,1)}if("fill-opacity" in c.style){d=c.style["fill-opacity"]}else{d=0.5}if("stroke-opacity" in c.style){k=c.style["stroke-opacity"]}else{k=1}if(!poly_shader){poly_shader=makeProgram(BASE_DIR+"shaders/poly")}if(!line_shader){line_shader=makeProgram(BASE_DIR+"shaders/line")}this.id=new_feature_id();var o=new Buffers(1024);o.create("vert",2);o.create("color",3);o.create("alpha",1);var b=new Buffers(1024);b.create("vert",2);b.create("norm",2);b.create("color",3);b.create("alpha",1);var l=this;function j(t){if(!t){t={}}if(!t.geom){t.geom=[]}if(!t.attr){t.attr={}}if(!t.style){t.style={}}this.geom=t.geom;this.attr=t.attr;this.id=new_feature_id();var q,y;var A,u=0;var s=function(){var C;if(("fill" in w)){C=w.fill}else{C=l.style("fill")}o.repeat("color",C.array,q,y);if(("stroke" in w)){C=w.stroke}else{C=l.style("stroke")}b.repeat("color",C.array,A,u)};var r=function(){var C;if(("fill-opacity" in w)){C=w["fill-opacity"]}else{C=l.style("fill-opacity")}o.repeat("alpha",[C],q,y);if("stroke-opacity" in w){C=w["stroke-opacity"]}else{C=l.style("stroke-opacity")}b.repeat("alpha",[C],A,u)};var z=[];var y=0;$.each(this.geom,function(C,D){var E=triangulate_polygon(D);y+=E.length/2;z.push(E)});var v=new vect(Infinity,Infinity);var B=new vect(-Infinity,-Infinity);$.each(this.geom,function(C,D){$.each(D,function(E,F){$.each(F,function(G,H){if(H[0]<v.x){v.x=H[0]}if(H[0]>B.x){B.x=H[0]}if(H[1]<v.y){v.y=H[1]}if(H[1]>B.y){B.y=H[1]}})})});this.bounds=new Box(v,B);q=o.alloc(y);var x=q;$.each(z,function(C,E){var D=E.length/2;o.write("vert",E,x,D);x+=D});A=b.count();$.each(this.geom,function(C,D){for(var C=0;C<D.length;C++){u+=D[C].length*6;draw_lines(b,D[C])}});var w={};copy_value(w,t.style,"fill",hex_to_color);copy_value(w,t.style,"stroke",hex_to_color);copy_value(w,t.style,"fill-opacity",parseFloat);copy_value(w,t.style,"stroke-opacity",parseFloat);this.style=function(C,D){if(arguments.length==1){return w[C]}w[C]=D;if(C=="fill"){s()}if(C=="stroke"){s()}if(C=="fill-opacity"){r()}if(C=="stroke-opacity"){r()}};s();r()}var m={};var i=0;var p=null;this.features=function(){var q=[];for(key in m){q.push(m[key])}return new LayerSelector(q)};this.search=function(w){var t=w.min;var q=w.max;var v=p.search(t,q);var u={};$.each(v,function(x,y){u[y.key]=true});var s=[];for(var r in u){s.push(m[r])}return new LayerSelector(s)};this.contains=function(y){var v=0;var u=[];for(var t in m){var r=m[t];if(r.bounds.contains(y)){v++;for(var q=0;q<r.geom.length;q++){var x=r.geom[q];var w=0;$.each(x,function(A,B){for(var z=0;z<B.length;z++){var s=(z+1)%B.length;if((y.y-B[z][1])/(y.y-B[s][1])<0){var C=new vect(720,y.y);var E=new vect(B[z][0],B[z][1]);var D=new vect(B[s][0],B[s][1]);if(vect.intersects(y,C,E,D)){w++}}}});if((w%2)==1){u.push(r)}}}}return new LayerSelector(u)};this.aggregate=function(q,r){q.features().each(function(s,t){$.each(t.geom,function(v,u){var w=l.contains(new vect(u[0],u[1]));if(w){r(w,t)}})})};this.bounds=null;var a=false;this.append=function(q){var r=new j(q);if(this.bounds){this.bounds.union(r.bounds)}else{this.bounds=r.bounds.clone()}m[r.id]=r;i++;a=true;p=null};this.style=function(q,r){if(arguments.length>1){throw"Not Implemented"}if(q=="fill"){return h}if(q=="stroke"){return f}if(q=="fill-opacity"){return d}if(q=="stroke-opacity"){return k}return null};var e=null,g=null;this.mouseover=function(q){e=q};this.mouseout=function(q){g=q};var n={};this.update_move=function(r,t){if(e||g){var u=this.contains(t);var q={};if(u){u.each(function(v,w){q[w.id]=w})}for(var s in n){if(!(s in q)&&g){g(n[s])}}for(var s in q){if(!(s in n)&&e){e(q[s])}}n=q}};this.force_out=function(q){for(var r in n){if(g){g(n[r])}}n={}};this.draw=function(q,s,u){if(u){return}o.update(s);b.update(s);if(a){var t=[];for(var r in m){$.each(m[r].geom,function(v,w){$.each(w,function(y,x){$.each(x,function(z,A){t.push({key:r,x:A[0],y:A[1]})})})})}p=new RangeTree(t);a=false}gl.useProgram(poly_shader);poly_shader.data("screen",q.camera.mat3);poly_shader.data("pos",o.get("vert"));poly_shader.data("color_in",o.get("color"));poly_shader.data("alpha_in",o.get("alpha"));gl.drawArrays(gl.TRIANGLES,0,o.count());gl.useProgram(line_shader);line_shader.data("screen",q.camera.mat3);line_shader.data("pos",b.get("vert"));line_shader.data("norm",b.get("norm"));line_shader.data("color_in",b.get("color"));line_shader.data("alpha_in",b.get("alpha"));line_shader.data("px_w",2/q.canvas.width());line_shader.data("px_h",2/q.canvas.height());gl.drawArrays(gl.TRIANGLES,0,b.count())}}var line_shader;function draw_lines(a,o){var k=6*o.length;var b=a.alloc(k);var j=0;var g=function(){if(o[j]){var q=new vect(o[j][0],o[j][1]);j++;return q}else{return null}};var p=[];var f=[];var e=function(s,q,r,t){if(!t){s[r]=q.x;s[r+1]=q.y}else{s[r]=-q.x;s[r+1]=-q.y}};var d=function(q,t,s,r){e(q,t,0,false);e(q,s,2,false);e(q,t,4,r);e(q,s,6,r);e(q,t,8,r);e(q,s,10,false)};var c=g();var m=g();var h=g();var l=vect.dir(m,c).rotate(PI/2);var i;var n=b;while(m){if(h){i=vect.dir(h,c).rotate(PI/2)}else{i=vect.dir(m,c).rotate(PI/2)}d(p,c,m,false);d(f,l,i,true);a.write("vert",p,n,6);a.write("norm",f,n,6);n+=6;c=m;m=h;h=g();l=i}return b}function LineLayer(){var d=new Color(0.02,0.44,0.69,1);var e=1;if(!line_shader){line_shader=makeProgram(BASE_DIR+"shaders/line")}this.id=new_feature_id();var b=new Buffers(1024);b.create("vert",2);b.create("norm",2);b.create("unit",2);b.create("color",3);b.create("alpha",1);var f=this;function c(o){if(!o){o={}}if(!o.geom){o.geom=[]}if(!o.attr){o.attr={}}if(!o.style){o.style={}}this.geom=o.geom;this.attr=o.attr;this.id=new_feature_id();var j,m=0;var n=function(){var p;if(("stroke" in l)){p=l.stroke}else{p=f.style("stroke")}b.repeat("color",p.array,j,m)};var k=function(){var p;if("stroke-opacity" in l){p=l["stroke-opacity"]}else{p=f.style("stroke-opacity")}b.repeat("alpha",[p],j,m)};j=b.count();draw_lines(b,this.geom);m=this.geom.length*6;var l={};copy_value(l,o.style,"fill",hex_to_color);copy_value(l,o.style,"stroke",hex_to_color);copy_value(l,o.style,"fill-opacity",parseFloat);copy_value(l,o.style,"stroke-opacity",parseFloat);this.style=function(p,q){if(arguments.length==1){return l[p]}l[p]=q;if(p=="fill"){n()}if(p=="stroke"){n()}if(p=="fill-opacity"){k()}if(p=="stroke-opacity"){k()}};n();k()}var h=0;var a=false;var i={};var g={};this.append=function(k){var j=new c(k);for(key in j.attr){i[key]=true}g[j.id]=j;h++;a=true;return j};this.style=function(j,k){if(arguments.length>1){throw"Not Implemented"}if(j=="stroke"){return d}if(j=="stroke-opacity"){return e}return null};this.draw=function(j,k){b.update(k);if(h>0){gl.useProgram(line_shader);line_shader.data("screen",j.camera.mat3);line_shader.data("pos",b.get("vert"));line_shader.data("norm",b.get("norm"));line_shader.data("color_in",b.get("color"));line_shader.data("alpha_in",b.get("alpha"));line_shader.data("px_w",2/j.canvas.width());line_shader.data("px_h",2/j.canvas.height());gl.drawArrays(gl.TRIANGLES,0,b.count())}}}var grid_shader=null;function Grid(i){if(!grid_shader){grid_shader=makeProgram(BASE_DIR+"shaders/grid")}if(!i){i={}}if(!i.style){i.style={}}var t=i.lower;var q=i.upper;var j=i.rows;var k=i.cols;var r=(q.x-t.x)/k;var a=(q.y-t.y)/j;var v=new Float32Array(j*k);var p=new Uint8Array(k*j*4);var g=false;var d=function(x,y){p[x*4]=parseInt(y.r*255);p[x*4+1]=parseInt(y.g*255);p[x*4+2]=parseInt(y.b*255);p[x*4+3]=parseInt(y.a*255)};var s=new Buffers(6);s.create("vert",2);s.create("screen",2);s.create("tex",2);var n=new vect(t.x,t.y);var o=new vect(q.x,q.y);var u=new vect(0,0);var b=new vect(1,1);var e=s.alloc(6);s.write("vert",rectv(n,o),e,6);s.write("screen",rectv(new vect(-1,-1),new vect(1,1)),e,6);s.write("tex",rectv(u,b),e,6);var w=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,w);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);var f=function(y,x){return k*y+x};this.lower=function(){return t.clone()};this.upper=function(){return q.clone()};this.rows=function(){return j};this.cols=function(){return k};this.centroid=function(y,x){return new vect(t.x+r*x+r/2,t.y+a*y+a/2)};this.get=function(y,x){return v[f(y,x)]};var l=-Infinity;var h=Infinity;var m={};this.qunatiles=function(C,B){if(!B){B=function(E,D){return E-D}}var y=[];for(var A=0;A<v.length;A++){y.push(v[A])}y.sort(B);var z=[-Infinity];for(var A=1;A<C;A++){var x=parseInt(inc*A);z.push(y[x])}z.push(Infinity);return z};this.set=function(z,y,A){if(z>=j||y>=k){throw"Index Out of Bounds"}var x=f(z,y);v[x]=A;g=true};this.raw_set=function(x,y){if(x>=j*k){throw"Index Out of Bounds: "+x}v[x]=y;g=true};this.clear=function(y){for(var x=0;x<j*k;x++){v[x]=y}};var c=null;this.draw=function(x,A){if(!c){c=x.framebuffer()}s.update();if(g){l=-Infinity;h=Infinity;for(var z=0;z<j*k;z++){var B=v[z];if(B>l){l=B}if(B<h){h=B}}for(var z=0;z<j*k;z++){d(z,i.map(h,l,v[z]))}gl.bindTexture(gl.TEXTURE_2D,w);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,k,j,0,gl.RGBA,gl.UNSIGNED_BYTE,p);gl.bindTexture(gl.TEXTURE_2D,null);g=false}if(i.style.antialias){c.activate({blend:false})}gl.useProgram(grid_shader);grid_shader.data("screen",x.camera.mat3);grid_shader.data("pos",s.get("vert"));grid_shader.data("tex_in",s.get("tex"));grid_shader.data("sampler",w);var y=vect.sub(x.camera.screen(o),x.camera.screen(n));grid_shader.data("width",y.x);grid_shader.data("height",-y.y);grid_shader.data("rows",j);grid_shader.data("cols",k);grid_shader.data("blur",i.blur);gl.drawArrays(gl.TRIANGLES,0,s.count());if(i.style.antialias){c.deactivate();x.draw_blur(c.tex)}}}function AsciiGrid(u,d){var l=u.split("\n");var k=l.splice(0,6);var f=parseInt(k[0].slice(14));var e=parseInt(k[1].slice(14));var m=parseFloat(k[2].slice(14));var h=parseFloat(k[3].slice(14));var p=parseFloat(k[4].slice(14));var o=k[5].slice(14);var g=-Infinity;var c=Infinity;var b=function(v,r){return f*v+r};var t={};for(key in d){t[key]=d[key]}t.lower=new vect(m,h);t.upper=new vect(m+p*f,h+p*e);t.rows=e;t.cols=f;var a=new Grid(t);for(var s=0;s<e;s++){var n=l[s].split(" ");for(var q=0;q<f;q++){if(n[q]==o){a.set(e-1-s,q,NaN)}else{a.set(e-1-s,q,parseFloat(n[q]))}}}return a}function SparseGrid(g,j){var b=lfloat32(g,0);var l=lfloat32(g,4);var k=lint32(g,8);var n=lint32(g,12);var m=lfloat32(g,16);var c=20;var d={};for(key in j){d[key]=j[key]}d.lower=new vect(b,l);d.upper=new vect(b+m*k,l+m*n);d.rows=n;d.cols=k;var a=new Grid(d);var f=function(s,o,q){for(var p=0;p<q;p++){var r=lfloat32(g,s+p*4);a.raw_set(o+p,r)}};var e=c;while(e<g.length){var i=lint32(g,e);var h=lint32(g,e+4);f(e+4,i,h);e+=8+h*4}return a}var LayerSelector=function(b){var c=null;this.length=b.length;this.count=function(){return b.length};this.attr=function(d){if(!b.length){return null}else{return b[0].attr[d]}};this.get=function(d){return b[d]};this.subset=function(e){var f=[];for(var d=0;d<e.length;d++){f.push(b[e[d]])}return new LayerSelector(f)};this.id=function(e){if(!c){c={};for(var d=0;d<b.length;d++){c[b[d].id]=b[d]}}if(e in c){return c[e]}else{return null}};this.each=function(e){for(var d=0;d<b.length;d++){e(d,b[d])}return this};var a={">":function(e,d){return e>d},"<":function(e,d){return e<d},"==":function(e,d){return e==d},">=":function(e,d){return e>=d},"<=":function(e,d){return e<=d}};this.select=function(e){if(e.match(/^\s*\*\s*$/)){return new LayerSelector(b)}var g=e.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!g){throw"Bad Selector"}var f=g[1];var k=g[2];var j=null;var h=null;if(isNaN(g[3])){h=g[3]}else{j=parseFloat(g[3])}new_elem=[];if(h){for(var d=0;d<b.length;d++){if(a[k](b[d].attr[f],b[d].attr[h])){new_elem.push(b[d])}}}else{for(var d=0;d<b.length;d++){if(a[k](b[d].attr[f],j)){new_elem.push(b[d])}}}return new LayerSelector(new_elem)};this.filter=function(f){var e=[];for(var d=0;d<b.length;d++){if(f(b[d])){e.push(b[d])}}return new LayerSelector(e)};this.quantile=function(h,f,e){b.sort(function(j,i){return j.attr[h]-i.attr[h]});var g=Math.round(f*this.length/e);var d=Math.round((f-1)*this.length/e);return new LayerSelector(b.slice(d,g))};this.range=function(g){var f=Infinity;var d=-Infinity;for(var e=0;e<b.length;e++){if(f>b[e].attr[g]){f=b[e].attr[g]}if(d<b[e].attr[g]){d=b[e].attr[g]}}return{min:f,max:d}};this.style=function(d,f){if(arguments.length==1){var e=[];$.each(b,function(h,g){e.push(g.style(d))});return e}if((typeof f)=="function"){$.each(b,function(h,g){g.style(d,f(g))})}else{if(is_list(f)){$.each(b,function(h,g){g.style(d,f[h])})}else{$.each(b,function(h,g){g.style(d,f)})}}return this}};var raster_shader=null;function KML(e){var b=$(e).find("LatLonBox");var d=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text()));var a=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));var c=$(e).find("GroundOverlay Icon href").text();return new Raster(BASE_DIR+c,d,a)}function Raster(c,d,b){if(!raster_shader){raster_shader=makeProgram(BASE_DIR+"shaders/raster")}this.image=getTexture(c);var e=staticBuffer(rectv(new vect(0,1),new vect(1,0)),2);var a=staticBuffer(rectv(d,b),2);this.draw=function(f,g,h){if(h){return}gl.useProgram(raster_shader);raster_shader.data("screen",f.camera.mat3);raster_shader.data("pos",a);raster_shader.data("tex_in",e);raster_shader.data("sampler",this.image);gl.drawArrays(gl.TRIANGLES,0,a.numItems)}}var OMEGA=Math.PI/4;var altitude_shader=null;function Hillshade(e){if(!altitude_shader){altitude_shader=makeProgram(BASE_DIR+"shaders/hillshade")}var f=$(e).find("LatLonBox");var d=new vect(parseFloat(f.find("west").text()),parseFloat(f.find("south").text()));var h=new vect(parseFloat(f.find("east").text()),parseFloat(f.find("north").text()));var a=$(e).find("GroundOverlay Icon href").text();var j=false;var b=getTexture(a,function(){j=true});this.ready=function(){return j};var i=staticBuffer(rectv(new vect(0,1),new vect(1,0)),2);var c=staticBuffer(rectv(d,h),2);var g=315;this.draw=function(k,m){if(!j){return}gl.useProgram(altitude_shader);while(g>=1){g-=1}altitude_shader.data("azimuth",g);altitude_shader.data("altitude",(Math.PI/4)/(2*Math.PI));altitude_shader.data("screen",k.camera.mat3);altitude_shader.data("pos",c);altitude_shader.data("tex_in",i);altitude_shader.data("elevation",b);var l=vect.sub(k.camera.screen(h),k.camera.screen(d));altitude_shader.data("pix_w",1/l.x);altitude_shader.data("pix_h",1/l.y);gl.drawArrays(gl.TRIANGLES,0,c.numItems);return g}}var elevation_shader=null;function Elevation(f){if(!elevation_shader){elevation_shader=makeProgram(BASE_DIR+"shaders/elevation")}var c=$(f).find("LatLonBox");var e=new vect(parseFloat(c.find("west").text()),parseFloat(c.find("south").text()));var b=new vect(parseFloat(c.find("east").text()),parseFloat(c.find("north").text()));var d=$(f).find("GroundOverlay Icon href").text();var h=getTexture(d);var g=staticBuffer(rectv(new vect(0,1),new vect(1,0)),2);var a=staticBuffer(rectv(e,b),2);this.draw=function(i,k,l){if(l){return}gl.useProgram(elevation_shader);elevation_shader.data("screen",i.camera.mat3);elevation_shader.data("pos",a);elevation_shader.data("tex_in",g);elevation_shader.data("elevation",h);var j=vect.sub(i.camera.screen(b),i.camera.screen(e));gl.drawArrays(gl.TRIANGLES,0,a.numItems)}}var TIMEOUT=1000;var z_base=0;var NUM_TILES=8;var total_drawn=0;var total_calls=0;function MultiTileLayer(f){var h=[];var a=[];for(var e=0;e<25;e++){a.push(new Texture())}for(var e=0;e<f.levels;e++){var g=copy(f);if(g.source=="file"){g.url+="/"+f.size*Math.pow(2,(e+1))}g.min=new vect(-180,-90);g.rows=Math.pow(2,e);g.cols=g.rows*2;g.cellsize=180/g.rows;g.z_index=1-z_base-e/1000;g.available=a;var d=new TileLayer(g);h.push(d)}var c=1-z_base-f.levels/1000;z_base+=(f.levels+2)/1000;h[0].fetch_all();h[0].noexpire(true);var b=new Buffers(NUM_TILES*6);b.create("vert",3);b.create("tex",2);b.create("lookup",1);b.alloc(NUM_TILES*6);this.draw=function(r,j){total_drawn=0;total_calls=0;var l=Infinity;var o=h[0];var k,q;for(var m=0;m<h.length;m++){var p=(f.size*h[m].cols)/h[m].size(r).x;if(p<1){p=1/p}if(p<l){l=p;o=h[m];k=m}}for(var m=k;m>=0;m--){h[m].fetch()}gl.useProgram(tile_shader);tile_shader.data("screen",r.camera.mat3);if(o.ready()){o.draw(r,j,b,0,true)}else{r.enable_z();var n=0;for(var m=k;m>=0;m--){n=h[m].draw(r,j,b,n,m==0)}r.disable_z()}$.each(h,function(t,s){s.cull()})}}var tile_shader=null;function TileLayer(g){if(!g){g={}}if(!g.desaturate){g.desaturate=0}if(!g.darken){g.darken=0}if(!g.hue){g.hue=0}if(!g.hue_color){g.hue_color=fcolor(0,0,0,1)}if(!g.available){g.available=[];for(var d=0;d<8;d++){g.available.push(new Texture())}}if(!tile_shader){tile_shader=makeProgram(BASE_DIR+"shaders/tile")}var a=g.url;var c=g.min;var o=g.rows;var h=g.cols;var n=g.cellsize;this.rows=o;this.cols=h;var l={};var k={};var b=function(r,q){var p=new vect(c.x+r*n,c.y+q*n);var t=new vect(c.x+(r+1)*n,c.y+(q+1)*n);var s={vert:rectv(p,t,g.z_index),tex:null,i:r,j:q,id:(r+h*q),ready:false,min:p,max:t};k[r][q]=s;l[s.id]=s};for(var d=0;d<h;d++){k[d]={}}this.size=function(q){var i=q.camera.screen(c);var r=q.camera.screen(vect.add(c,new vect(n*h,n*o)));var p=vect.sub(r,i);p.y=Math.abs(p.y);return p};var e=false;this.noexpire=function(i){e=i};this.cull=function(){if(!e){var q=new Date().getTime();for(var i in f){if(q-f[i]>TIMEOUT){var p=l[i];delete l[i];delete k[p.i][p.j];g.available.push(p.tex);p.tex=null;p.ready=false;delete f[i]}}}};var j=function(){var p=engine.camera.project(new vect(engine.canvas.offset().left,engine.canvas.offset().top+engine.canvas.height()));var s=engine.camera.project(new vect(engine.canvas.offset().left+engine.canvas.width(),engine.canvas.offset().top));var i=Math.floor((p.x-c.x)/n);var q=Math.ceil((s.x-c.x)/n);var r=Math.floor((p.y-c.y)/n);var t=Math.ceil((s.y-c.y)/n);return{min_col:i,max_col:q,min_row:r,max_row:t,}};var f={};this.ready=function(){var p=j();for(var r=Math.max(0,p.min_col);r<Math.min(h,p.max_col);r++){for(var q=Math.max(0,p.min_row);q<Math.min(o,p.max_row);q++){if(!k[r][q]){return false}if(!k[r][q].ready){return false}}}return true};var m=function(r,q){if(!k[r][q].tex){var s;if(g.source=="file"){var p=k[r][q].id;s=a+"/"+p+".png"}else{if(g.source=="wms"){s=make_url(a,{service:"wms",version:"1.1.0",request:"GetMap",layers:g.layer,bbox:[k[r][q].min.x,k[r][q].min.y,k[r][q].max.x,k[r][q].max.y].join(","),width:g.size,height:g.size,srs:"EPSG:4326",format:"image/png",transparent:"true"})}}k[r][q].tex=g.available.pop();if(!k[r][q].tex){k[r][q].tex=new Texture()}getImage(s,(function(i){return function(t){if(i.tex){i.tex.image(t);i.ready=true}}})(k[r][q]))}};this.fetch_all=function(){var r=new Date().getTime();for(var q=0;q<h;q++){for(var p=0;p<o;p++){if(!k[q][p]){b(q,p)}if(!k[q][p].tex){m(q,p)}f[k[q][p].id]=r}}};this.fetch=function(){var p=j();var s=new Date().getTime();for(var r=Math.max(0,p.min_col-1);r<Math.min(h,p.max_col+1);r++){for(var q=Math.max(0,p.min_row-1);q<Math.min(o,p.max_row+1);q++){if(!k[r][q]){b(r,q)}if(!k[r][q].tex){m(r,q)}f[k[r][q].id]=s}}};this.draw=function(y,p,x,t,w){var v=function(){total_calls++;x.update();tile_shader.data("pos",x.get("vert"));tile_shader.data("tex_in",x.get("tex"));tile_shader.data("lookup_in",x.get("lookup"));tile_shader.data("desaturate",g.desaturate);tile_shader.data("darken",g.darken);tile_shader.data("hue",g.hue);tile_shader.data("hue_color",g.hue_color.array);gl.drawArrays(gl.TRIANGLES,0,t*6)};var u=j();var q=new Date().getTime();for(var s=Math.max(0,u.min_col);s<Math.min(h,u.max_col);s++){for(var r=Math.max(0,u.min_row);r<Math.min(o,u.max_row);r++){if(k[s][r]&&k[s][r].ready&&k[s][r].tex){x.write("vert",k[s][r].vert,t*6,6);x.write("tex",rectv(new vect(0,0),new vect(1,1)),t*6,6);x.repeat("lookup",[t/NUM_TILES+1/(NUM_TILES*2)],t*6,6);f[k[s][r].id]=q;tile_shader.data("sampler"+t,k[s][r].tex);if(k[s][r].tex==null){throw"bad"}t++;total_drawn++;if(t>=NUM_TILES){v();t=0}}}}if(w){v()}return t}}function WMS(b){var c=copy(b);require(c,["url","layer"]);default_model(c,{levels:16,size:256});force_model(c,{source:"wms"});var a=new MultiTileLayer(c);return a}function GeoJSON(t,h){var r=0,a=0,s=0;var q=[],d=[],c=[];for(var p=0;p<t.features.length;p++){var g=t.features[p];if(g.type=="Feature"){if(g.geometry.type=="Point"){r++;q.push({geom:[g.geometry.coordinates],attr:g.properties})}if(g.geometry.type=="MultiPoint"){r+=g.geometry.cooordinates.length;q.push({geom:g.geometry.coordinates,attr:g.properties})}if(g.geometry.type=="Polygon"){var f=g.geometry.coordinates;var b=[];for(var n=0;n<=f.length-1;n++){var u=[];for(var o=f[n].length-1;o>=0;o--){u.push(f[n][o])}b.push(u)}a++;d.push({geom:[b],attr:g.properties})}if(g.geometry.type=="MultiPolygon"){var l=[];$.each(g.geometry.coordinates,function(y,A){var w=[];for(var v=0;v<=A.length-1;v++){var z=[];for(var x=A[v].length-1;x>=0;x--){z.push(A[v][x])}w.push(z)}l.push(w)});a++;d.push({geom:l,attr:g.properties})}if(g.geometry.type=="MultiLineString"){$.each(g.geometry.coordinates,function(k,j){s++;c.push({geom:j,attr:g.properties})})}}}if(r>0){var e=new PointLayer(r);$.each(q,function(k,j){e.append(j)});return e}else{if(a>0){var e=new PolygonLayer(h);$.each(d,function(k,j){var w=0;while(w<100){try{e.append(j);w=101}catch(x){w++}}if(w==100){console.log("rendering polygon failed")}});return e}else{if(s>0){var m=new LineLayer();$.each(c,function(k,j){m.append(j)});return m}}}}var SHP_HEADER_LEN=8;var SHP_NULL=0;var SHP_POINT=1;var SHP_POLYGON=5;function Shapefile(i,n){var p=[];var m=[];var e=function(u,w,r){var s=[];for(var t=r-1;t>=w;t--){var q=ldbl64(i,u+16*t);var v=ldbl64(i,u+16*t+8);s.push([q,v])}return s};var b=function(v){var A=bint32(i,v);var q=bint32(i,v+4);var H=v+8;var z=lint32(i,H);if(z==SHP_NULL){console.log("NULL Shape");return v+12}else{if(z==SHP_POINT){var G=ldbl64(i,H+4);var E=ldbl64(i,H+12);p.push({attr:{},geom:[[G,E]]})}else{if(z==SHP_POLYGON){var s=lint32(i,H+36);var C=lint32(i,H+40);var D=v+52;var B=v+52+4*s;var F=[];for(var w=0;w<s;w++){var r=lint32(i,D+w*4);var u;if(w+1<s){u=lint32(i,D+(w+1)*4)}else{u=C}var t=e(B,r,u);F.push(t)}m.push({attr:{},geom:[F]})}else{throw"Not Implemented: "+z}}}return v+2*q+SHP_HEADER_LEN};var c=bint32(i,0);var j=bint32(i,24);var k=lint32(i,28);var l=lint32(i,32);console.log("meta",j,k,l);var a=ldbl64(i,36);var o=ldbl64(i,44);var h=ldbl64(i,52);var d=ldbl64(i,60);console.log("bounds",a,o,h,d);var g=100;while(g<j*2){g=b(g)}if(p.length>0){console.log(p);var f=new PointLayer(p.length);$.each(p,function(r,q){f.append(q)});return f}else{if(m.length>0){var f=new PolygonLayer(n);$.each(m,function(r,q){var s=0;while(s<100){try{f.append(q);s=101}catch(t){s++}}if(s==100){console.log("rendering polygon failed")}});return f}}}var basic_shader=null;function RangeBar(t,n,m,q,h){if(!basic_shader){basic_shader=makeProgram(BASE_DIR+"shaders/basic")}var o=[];var r=[];if(!h){var s=Math.abs((q.x-m.x)/n.length);var l=Math.abs(q.y-m.y);for(var g=0;g<n.length;g++){var f=new vect(m.x+s*g,m.y);var p=new vect(m.x+s*(g+1),q.y);r.push.apply(r,rectv(t.camera.percent(f),t.camera.percent(p)));for(var d=0;d<6;d++){o.push.apply(o,n[g].vect())}}}else{var s=Math.abs(q.x-m.x);var l=Math.abs((q.y-m.y)/n.length);for(var g=0;g<n.length;g++){var e=n.length-1-g;var f=new vect(m.x,m.y+l*(e+1));var p=new vect(q.x,m.y-l*e);console.log("box",f,p);r.push.apply(r,rectv(t.camera.percent(f),t.camera.percent(p)));for(var d=0;d<6;d++){o.push.apply(o,n[g].vect())}}}var b=staticBuffer(r,2);var a=staticBuffer(o,4);this.update=function(c,i){};this.draw=function(c,i,j){if(j){return}gl.useProgram(basic_shader);basic_shader.data("pos",b);basic_shader.data("color_in",a);gl.drawArrays(gl.TRIANGLES,0,b.numItems)}}var SLIDER_WIDTH=20;function Slider(h,j,e){var d=function(k){if(k>=e){throw"Slider index out of bounds"}return(j.x/(e-1))*k};var a=function(k){if(k<=h.x){return 0}if(k>=h.x+j.x){return e-1}return Math.round(((k-h.x)/j.x)*(e-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",h.x).css("top",h.y).css("width",j.x).css("height",j.y);var i=false;var g=0;var f=$("<div></div>").addClass("slider-box").css("position","relative").css("left",-SLIDER_WIDTH/2).css("height",j.y).css("width",SLIDER_WIDTH).mousedown(function(){i=true});this.tick=function(){return g};this.count=function(){return e};var c=function(k){};this.change=function(k){c=k};var b=function(k){};this.release=function(k){b=k};this.dragging=function(){return i};this.dom.append(f);this.set=function(k){if(k!=g){c(k)}g=k;var l=d(k);f.css("left",l-SLIDER_WIDTH/2);b(k)};$(document).bind("mouseup",function(){if(!i){return}i=false;var k=a(event.clientX);b(k)});$(document).bind("mousemove",function(m){if(i){var k=a(m.clientX);if(k!=g){c(k)}g=k;var l=d(k);f.css("left",l-SLIDER_WIDTH/2)}})}var Map=function(a,c){engine=new Engine(a,c);this.center=function(d,e){engine.camera.position(new vect(d,e))};this.vcenter=function(d){this.center(d.x,d.y)};this.extents=function(d){engine.camera.extents(d)};this.append=function(d){engine.scene.push(d)};this.shade=function(e){var d=new Hillshade(e);engine.shade=d};this.select=function(d){if(!d){engine.select(false)}else{engine.sel.select(d);engine.select(true)}};this.resize=function(){engine.resize()};this.attr=function(d,e){engine.attr(d,e)};this.png=function(){var d=engine.canvas.get(0).toDataURL();$.ajax({url:"../server/export.png",type:"POST",data:d})};this.width=function(){return engine.canvas.innerWidth()};this.height=function(){return engine.canvas.innerHeight()};var b=null;this.click=function(d){b=d};engine.canvas.click(function(e){if(b){var d=new vect(e.pageX,e.pageY);var f=engine.camera.project(d);b(f)}})};