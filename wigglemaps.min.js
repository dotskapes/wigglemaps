function vect(p,n,r){this.x=p;this.y=n;this.z=r?r:0;this.add=function(l){this.x+=l.x;this.y+=l.y;this.z+=l.z};this.sub=function(l){this.x-=l.x;this.y-=l.y;this.z-=l.z};this.scale=function(l){this.x*=l;this.y*=l;this.z*=l};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var l=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);0!=l&&(this.x/=l,this.y/=l,this.z/=l)};this.div=function(l){this.x/=l.x;this.y/=l.y;this.z/=l.z};this.floor=function(){this.x=
Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return 0==this.x+this.y+this.z};this.dot=function(l){return this.x*l.x+this.y*l.y+this.z*l.z};this.cross=function(){throw"Need to reimplement";};this.rotate=function(l){var p=Math.cos(l);l=Math.sin(l);xp=p*this.x-l*this.y;yp=l*this.x+p*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}vect.scale=function(p,n){return new vect(p.x*n,p.y*n,p.z*n)};
vect.add=function(p,n){return new vect(p.x+n.x,p.y+n.y,p.z+n.z)};vect.sub=function(p,n){if(!p||!n)throw"Bad Vector";return new vect(p.x-n.x,p.y-n.y,p.z-n.z)};vect.dist=function(p,n){var r=n.x-p.x,l=n.y-p.y,v=n.z-p.z;return Math.sqrt(r*r+l*l+v*v)};vect.dir=function(p,n){var r=vect.sub(p,n);r.normalize();return r};vect.dot2d=function(p,n){return p.x*n.x+p.y*n.y};vect.cross=function(p,n){return p.x*n.y-p.y*n.x};
vect.left=function(p,n,r,l){l||(l=0);n=vect.sub(n,p);p=vect.sub(r,p);return vect.cross(n,p)>=-l};vect.intersects=function(p,n,r,l,v){v||(v=0);return vect.left(p,n,r,v)!=vect.left(p,n,l,v)&&vect.left(r,l,n,v)!=vect.left(r,l,p,v)};vect.intersect2dt=function(p,n,r,l){l=p.x*(l.y-r.y)+n.x*(r.y-l.y)+l.x*(n.y-p.y)+r.x*(p.y-n.y);return 0==l?Infinity:-(p.x*(r.y-n.y)+n.x*(p.y-r.y)+r.x*(n.y-p.y))/l};
vect.intersect2dpos=function(p,n,r,l){var v=p.x*(l.y-r.y)+n.x*(r.y-l.y)+l.x*(n.y-p.y)+r.x*(p.y-n.y);if(0==v)return Infinity;r=(p.x*(l.y-r.y)+r.x*(p.y-l.y)+l.x*(r.y-p.y))/v;n=vect.sub(n,p);n.scale(r);return vect.add(p,n)};vect.rotate=function(p,n){var r=Math.cos(n),l=Math.sin(n);xp=r*p.x-l*p.y;yp=l*p.x+r*p.y;return p=new vect(xp,yp,p.z)};
(function(){function p(a,b){for(var d in b)d in a||(a[d]=b[d])}function n(a){var b={};for(key in a)b[key]=a[key];return b}function r(a,b){for(key in b)a[key]=b[key]}function l(a,b,d){return Math.min(Math.max(a,b),d)}function v(a,b,d,c){1>=a&&1>=b&&1>=d&&1>=c?(this.r=a,this.g=b,this.b=d,this.a=c):(this.r=a/255,this.g=b/255,this.b=d/255,this.a=c/255);this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(255*this.r)+","+parseInt(255*
this.g)+","+parseInt(255*this.b)+")"}}function Aa(a,b,d,c){return new v(l(a,0,1),l(b,0,1),l(d,0,1),l(c,0,1))}function X(a){var b=parseInt(a.slice(1,3),16),d=parseInt(a.slice(3,5),16);a=parseInt(a.slice(5,7),16);return new v(b,d,a,255)}function ma(a,b){return((a.charCodeAt(b)&255)<<24)+((a.charCodeAt(b+1)&255)<<16)+((a.charCodeAt(b+2)&255)<<8)+(a.charCodeAt(b+3)&255)}function J(a,b){return((a.charCodeAt(b+3)&255)<<24)+((a.charCodeAt(b+2)&255)<<16)+((a.charCodeAt(b+1)&255)<<8)+(a.charCodeAt(b)&255)}
function ea(a,b){var d=a.charCodeAt(b)&255,c=a.charCodeAt(b+1)&255,e=a.charCodeAt(b+2)&255,f=a.charCodeAt(b+3)&255,h=a.charCodeAt(b+4)&255,j=a.charCodeAt(b+5)&255,g=a.charCodeAt(b+6)&255,k=a.charCodeAt(b+7)&255,m=1-2*(k>>7),k=((k&127)<<4)+((g&240)>>4)-1023,d=(g&15)*Math.pow(2,48)+j*Math.pow(2,40)+h*Math.pow(2,32)+f*Math.pow(2,24)+e*Math.pow(2,16)+c*Math.pow(2,8)+d;return m*(1+d*Math.pow(2,-52))*Math.pow(2,k)}function fa(a,b){var d=a.charCodeAt(b)&255,c=a.charCodeAt(b+1)&255,e=a.charCodeAt(b+2)&255,
f=a.charCodeAt(b+3)&255,h=1-2*(f>>7),f=((f&127)<<1)+((e&254)>>7)-127,d=(e&127)*Math.pow(2,16)+c*Math.pow(2,8)+d;return h*(1+d*Math.pow(2,-23))*Math.pow(2,f)}function na(a,b,d,c){return[a-d,b+c,a-d,b-c,a+d,b+c,a-d,b-c,a+d,b-c,a+d,b+c]}function w(a,b,d){return 2==arguments.length?[a.x,b.y,a.x,a.y,b.x,b.y,a.x,a.y,b.x,a.y,b.x,b.y]:[a.x,b.y,d,a.x,a.y,d,b.x,b.y,d,a.x,a.y,d,b.x,a.y,d,b.x,b.y,d]}function z(a,b){if(!a)return null;var d=a.createProgram(),c=Ba(a,a.VERTEX_SHADER,b+"/vert.glsl"),e=Ba(a,a.FRAGMENT_SHADER,
b+"/frag.glsl");a.attachShader(d,c);a.attachShader(d,e);a.linkProgram(d);var f={},c=(c.source+e.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg),e=0;a.useProgram(d);if(c){for(var h=0;h<c.length;h++){var j=c[h].split(" ");f[j[2]]={u:j[0],type:j[1],loc:null};if("uniform"==j[0])f[j[2]].loc=a.getUniformLocation(d,j[2]);else{var g=a.getAttribLocation(d,j[2]);f[j[2]].loc=g}"sampler2D"==j[1]&&(f[j[2]].tex=e,e++)}d.get=function(a){return f[a].loc};d.data=function(c,e){var b=f[c];if(!b)throw"Could not find shader variable "+
c;if("uniform"==b.u)if("float"==b.type)a.uniform1f(b.loc,e);else if("vec2"==b.type)a.uniform2fv(b.loc,e);else if("ivec2"==b.type)a.uniform2iv(b.loc,e);else if("vec3"==b.type)a.uniform3fv(b.loc,e);else if("ivec3"==b.type)a.uniform3iv(b.loc,e);else if("vec4"==b.type)a.uniform4fv(b.loc,e);else if("ivec4"==b.type)a.uniform4iv(b.loc,e);else if("bool"==b.type)a.uniform1i(b.loc,e);else if("mat4"==b.type)a.uniformMatrix4fv(b.loc,!1,e);else if("mat3"==b.type)a.uniformMatrix3fv(b.loc,!1,e);else if("sampler2D"==
b.type)"texture"in e&&(e=e.texture()),a.activeTexture(a["TEXTURE"+b.tex]),a.bindTexture(a.TEXTURE_2D,e),a.uniform1i(b.loc,b.tex);else if("int"==b.type)a.uniform1i(b.loc,e);else throw"Unsupported Type for Shader Helper: "+b.type;else if("attribute"==b.u)a.enableVertexAttribArray(b.loc),a.bindBuffer(a.ARRAY_BUFFER,e),a.vertexAttribPointer(b.loc,e.itemSize,a.FLOAT,!1,0,0);else throw"Type: "+b.u+" Recieved";}}return d}function Ba(a,b,d){var c=a.createShader(b);$.ajax({async:!1,url:d,dataType:"text",success:function(e){a.shaderSource(c,
e);a.compileShader(c);if(!a.getShaderParameter(c,a.COMPILE_STATUS))throw a.getShaderInfoLog(c);c.source=e},error:function(){console.log("Could not load "+d)}});return c}function K(a,b,d){var c=a.createBuffer(),e=new Float32Array(b);a.bindBuffer(a.ARRAY_BUFFER,c);c.itemSize=d;c.numItems=b.length/d;a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return c}function oa(a,b,d){if(!a)return null;var c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);var e=new Float32Array(b*
d);c.itemSize=d;c.numItems=b;c.update=function(e,b){var d=new Float32Array(e);a.bindBuffer(a.ARRAY_BUFFER,c);a.bufferSubData(a.ARRAY_BUFFER,4*b,d);a.bindBuffer(a.ARRAY_BUFFER,null)};a.bufferData(a.ARRAY_BUFFER,e,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return c}function Y(a,b,d){var c=a.createTexture();c.id=Ca;Ca++;var e=new Image;e.onload=function(){a.bindTexture(a.TEXTURE_2D,c);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,
a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);d&&d()};e.src=b;return c}function pa(a,b){var d=n(b);p(d,{mag_filter:a.LINEAR,min_filter:a.LINEAR,wrap_s:a.CLAMP_TO_EDGE,wrap_t:a.CLAMP_TO_EDGE,mipmap:!1});var c=a.createTexture(),e=null;this.image=function(b){e=b;a.bindTexture(a.TEXTURE_2D,c);a.texImage2D(a.TEXTURE_2D,0,
a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,d.mag_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,d.min_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,d.wrap_s);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,d.wrap_t);d.mipmap&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)};this.texture=function(){return e?c:null}}function ga(a,b,d){var c=a.style(d);null===c&&(c=b.style(d),null===c&&(c=Ra[a.type][d]));return c}function Sa(a,
b){b||(b={});"center"in b||(b.center=new vect(0,0));"extents"in b||(b.extents=180);this.mat3=new Float32Array(9);var d=a.width()/a.height();this.mat3[0]=2/b.extents;this.mat3[4]=2*d/b.extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(c){c=new vect(2*(c.x-a.offset().left)/a.width()-1,-(2*(c.y-a.offset().top)/a.height()-1));c.x=c.x/this.mat3[0]-this.mat3[6]/this.mat3[0];c.y=c.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return c};this.screen=function(c){c=new vect(c.x*
this.mat3[0]+this.mat3[6],c.y*this.mat3[4]+this.mat3[7]);c.x=a.offset().left+a.width()*(c.x+1)/2;c.y=a.offset().top+a.height()*(-c.y+1)/2;return c};this.percent=function(c){return new vect(2*((c.x-a.offset().left)/a.width())-1,-(2*((c.y-a.offset().top)/a.height())-1))};this.pixel=function(c){return new vect(a.offset().left+(c.x+1)/2*a.width(),a.offset().top+(-c.y+1)/2*a.height())};this.move=function(a){this.mat3[6]-=a.x*this.mat3[0];this.mat3[7]-=a.y*this.mat3[4]};this.position=function(a){if(!a)return new vect(-this.mat3[6]/
this.mat3[0],-this.mat3[7]/this.mat3[4]);this.mat3[6]=-a.x*this.mat3[0];this.mat3[7]=-a.y*this.mat3[4]};this.position(b.center);this.extents=function(a){b.extents=a;a=this.position();this.level=1;this.mat3[0]=2/b.extents;this.mat3[4]=2*d/b.extents;this.position(a)};this.zoom=function(a){var e=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=a;this.mat3[4]*=a;this.mat3[6]=e.x*this.mat3[0];this.mat3[7]=e.y*this.mat3[4];this.level*=a};this.reset=function(){this.zoom(1/this.level)};
this.reconfigure=function(){var c=this.position();this.mat3[4]/=d;d=a.width()/a.height();this.mat3[4]*=d;this.position(c)}}function Ta(a){var b=!1,d=new vect(0,0),c=new vect(0,0),e=null,f=0;a.canvas.mousedown(function(a){d=new vect(a.clientX,a.clientY);b=!0});$(window).bind("mouseup",function(){b=!1});$(document).bind("keypress","+",function(){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(){a.camera.reset()});a.canvas.bind("mousewheel",
function(c,e){e*=0.5;0>e?(e=-1*e+1,e=1/e):e+=1;a.camera.zoom(e);c.preventDefault()});var h=!0;this.disable=function(){h=!1};this.enable=function(){h=!0};this.update=function(j){c=new vect(S.x,S.y);if(b&&h){var g=vect.sub(a.camera.project(d),a.camera.project(c));a.camera.move(g);d=c;f=g.length()/j;e=g;e.normalize()}else 0.01<f&&e&&(a.camera.move(vect.scale(e,f*j)),f-=3*j*f)}}function Ua(a,b,d){d||(d={});p(d,{base:"default",background:new v(0,0,0,1),antialias:!0});var c=this;this.canvas=$("<canvas></canvas>").attr("id",
"viewer");a?($(a).append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height())):(a=window,$("body").append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height()),$(window).resize(function(){c.resize()}));this.resize=function(){c.canvas.attr("width",$(a).width());c.canvas.attr("height",$(a).height());e.viewport(0,0,c.canvas.width(),c.canvas.height());c.camera.reconfigure();for(var b=0;b<m.length;b++)m[b].resize()};var e;b=
this.canvas;this.gl=e=gl=Va?WebGLDebugUtils.makeDebugContext(b.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),function(a,c){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+c;}):b.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1});e.viewport(0,0,c.canvas.width(),c.canvas.height());e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);e.enable(e.BLEND);A||(A=z(e,x+"shaders/blur"));Da||(Da=z(e,x+"shaders/light"));var f=
new G(e,6);f.create("vert",2);f.create("tex",2);b=f.alloc(6);f.write("vert",w(new vect(-1,-1),new vect(1,1)),b,6);f.write("tex",w(new vect(0,0),new vect(1,1)),b,6);f.update();this.scene=[];this.camera=new Sa(this.canvas,d);this.scroller=new Ta(this);this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.sel=new Wa(this);this.select=function(a){a?(this.scroller.disable(),this.sel.enable()):(this.scroller.enable(),this.sel.disable())};var h=(new Date).getTime(),j=[];this.attr=
function(a,c){"base"==a&&(d.base=c,k())};var g=null,k=function(){if("default"==d.base||"nasa"==d.base){var a=n(d);r(a,{source:"file",url:qa+"/tiles/nasa_topo_bathy",levels:8,size:256});g=new ia(a)}else"ne"==d.base?(a=n(d),r(a,{source:"file",url:qa+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),g=new ia(a)):"ne1"==d.base?(a=n(d),r(a,{source:"file",url:qa+"/tiles/NE1_HR_LC",levels:6,size:256}),g=new ia(a)):g=null;g&&g.initialize(c)};k();this.enable_z=function(){e.depthFunc(e.LEQUAL);e.enable(e.DEPTH_TEST)};
this.disable_z=function(){e.disable(e.DEPTH_TEST)};var m=[],q=[null];this.framebuffer=function(){var a=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,a);a.width=c.canvas.width();a.height=c.canvas.height();var b=e.createTexture();e.bindTexture(e.TEXTURE_2D,b);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);
e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a.width,a.height,0,e.RGBA,e.UNSIGNED_BYTE,null);var d=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,d);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,a.width,a.height);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,b,0);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,d);e.bindTexture(e.TEXTURE_2D,null);e.bindRenderbuffer(e.RENDERBUFFER,null);e.bindFramebuffer(e.FRAMEBUFFER,null);var f={framebuffer:a,
renderbuffer:d,tex:b,resize:function(){a.width=c.canvas.width();a.height=c.canvas.height();e.bindTexture(e.TEXTURE_2D,b);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,a.width,a.height,0,e.RGBA,e.UNSIGNED_BYTE,null);e.bindRenderbuffer(e.RENDERBUFFER,d);e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,a.width,a.height);e.bindTexture(e.TEXTURE_2D,null);e.bindRenderbuffer(e.RENDERBUFFER,null)},activate:function(b){b||(b={});p(b,{blend:!0,clear:!0});q.push(a);b.blend||e.disable(e.BLEND);e.bindFramebuffer(e.FRAMEBUFFER,
a);e.viewport(0,0,c.canvas.width(),c.canvas.height());b.clear&&(e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.clearDepth(0))},deactivate:function(){var c=q.pop(),b=q[q.length-1];if(c!=a)throw"Non-nested use of framebuffers";e.bindFramebuffer(e.FRAMEBUFFER,b);e.enable(e.BLEND)}};m.push(f);return f};var Xa=this.framebuffer(),ra=this.framebuffer();this.draw_blur=function(a){e.useProgram(A);ra.activate({blend:!1});A.data("pos",f.get("vert"));A.data("tex_in",f.get("tex"));A.data("sampler",a);A.data("width",
c.canvas.width());A.data("height",c.canvas.height());A.data("hor",!0);e.drawArrays(e.TRIANGLES,0,f.count());ra.deactivate();A.data("pos",f.get("vert"));A.data("tex_in",f.get("tex"));A.data("sampler",ra.tex);A.data("width",c.canvas.width());A.data("height",c.canvas.height());A.data("hor",!1);e.drawArrays(e.TRIANGLES,0,f.count())};this.dirty=!0;var l=function(){var a=(new Date).getTime(),b=(a-h)/1E3;c.scroller.update(b);60<=j.length&&j.splice(0,1);j.push(b);for(var f=0,k=0;k<j.length;k++)f+=j[k];f/=
j.length;$("#fps").text(Math.floor(1/f));h=a;e.clearColor(d.background.r,d.background.g,d.background.b,d.background.a);e.clear(e.COLOR_BUFFER_BIT);e.clearDepth(0);a=!1;c.shade&&(a=c.shade.ready());a&&Xa.activate();g&&g.draw(c,b);for(k=0;k<c.scene.length;k++)c.scene[k].draw(c,b,!1);c.sel.draw(c,b);requestAnimationFrame(l)};this.read_pixel=function(a,b){e.bindFramebuffer(e.FRAMEBUFFER,c.framebuffer);var d=new Uint8Array(4),f=(a-c.canvas.position().left)/c.canvas.width(),k=(c.canvas.position().top+c.canvas.height()-
b)/c.canvas.height();e.readPixels(parseInt(f*c.framebuffer.width),parseInt(k*c.framebuffer.height),1,1,e.RGBA,e.UNSIGNED_BYTE,d);e.bindFramebuffer(e.FRAMEBUFFER,null);return d};$(document).mousemove(function(a){S.x=a.clientX;S.y=a.clientY});this.canvas.click(function(){});this.canvas.dblclick(function(){});var H=!1;this.canvas.mousedown(function(){H=!0});this.canvas.mouseup(function(){H=!1});this.canvas.mousemove(function(){if(!H){var a=new vect(S.x,S.y);$.each(c.scene,function(e,b){b.update_move&&
b.update_move(c,a)})}});this.canvas.mouseout(function(){$.each(c.scene,function(a,e){e.force_out&&e.force_out(c)})});requestAnimationFrame(l)}function G(a,b){var d={},c;c=b?b:256;var e=0,f=function(a,c,e,b){a||console.log("ack");e||(e=0);b||(b=c.length);for(var d=0;d<b;d++)a[e+d]=c[d]};this.create=function(e,b){if(!b)throw"Length of buffer must be a positive integer";var f=new Float32Array(c*b),k=oa(a,c,b);d[e]={array:f,buffer:k,len:b,dirty:!1}};this.alloc=function(b){if(e+b>=c){for(var j=c;j<e+b;)j*=
2;c=j;for(name in d){var g=new Float32Array(j*d[name].len),k=d[name].array,m=oa(a,c,d[name].len);f(g,k);d[name].array=g;d[name].buffer=m;d[name].dirty=!0}}j=e;e+=b;return j};this.get=function(a){return d[a].buffer};this.write=function(a,c,e,b){f(d[a].array,c,e*d[a].len,b*d[a].len);d[a].dirty=!0};this.repeat=function(a,c,e,b){for(var m=0;m<b;m++)f(d[a].array,c,(e+m)*d[a].len,d[a].len);d[a].dirty=!0};this.count=function(){return e};this.data=function(a){return d[a].array};this.update=function(){for(name in d)d[name].dirty&&
(d[name].buffer&&d[name].buffer.update(d[name].array,0),d[name].dirty=!1)}}function Wa(a){aa||(aa=z(a.gl,x+"shaders/selbox"));var b=!1,d=!1,c=null,e=null,f=oa(a.gl,6,2),h=K(a.gl,na(0,0,1,1),2);a.canvas.bind("mousedown",function(g){b&&(show=d=!0,e=c=a.camera.percent(new vect(g.clientX,g.clientY)),f.update(w(c,e),0))});var j=function(){};this.select=function(a){j=a};$(document).bind("mouseup",function(){if(b&&d){var f=a.camera.project(a.camera.pixel(c)),k=a.camera.project(a.camera.pixel(e));if(f.x>
k.x){var h=f.x;f.x=k.x;k.x=h}f.y>k.y&&(h=f.y,f.y=k.y,k.y=h);d=!1;j(new O(f,k))}});$(document).bind("click",function(){b&&(show=!1)});$(document).bind("mousemove",function(g){b&&d&&(e=a.camera.percent(new vect(g.clientX,g.clientY)),f.update(w(c,e),0))});this.enable=function(){b=!0};this.disable=function(){b=!1};this.draw=function(){d&&(gl.useProgram(aa),aa.data("pos",f),aa.data("edge_in",h),gl.drawArrays(gl.TRIANGLES,0,f.numItems))}}function Ea(a,b){for(;a>=b;)a-=b;for(;0>a;)a+=b;return a}function Ya(a,
b,d,c){this.current=a;this.upper=b;this.lower=d;this.index=c}function Fa(a,b){for(var d=0;d<a.length;d++)if(a[d]==b)return!0;return!1}function ka(a,b,d){if(void 0==b)throw"whoa";return 0==a[b+1].y-a[b].y?Math.min(a[b].x,a[b+1].x):a[b].x+(a[b+1].x-a[b].x)*((d-a[b].y)/(a[b+1].y-a[b].y))}function T(a,b){for(var d=0;d<a.length;d++)if(a[d]==b)return d;return!1}function E(a,b,d){return new vect(ka(b,d,b[a].y),b[a].y)}function L(a,b){if(!b)throw"eek";a.push(b.x);a.push(b.y)}function U(a,b,d){if(!b||!d||
3!=d.length+b.length&&4!=d.length+b.length)throw"ahh";if(3==b.length+d.length){for(var c=0;c<b.length;c++)L(a,b[c]);for(c=0;c<d.length;c++)L(a,d[c])}else b[1].x<b[0].x&&(c=b[0],b[0]=b[1],b[1]=c),d[1].x<d[0].x&&(c=d[0],d[0]=d[1],d[1]=c),L(a,b[0]),L(a,b[1]),L(a,d[1]),L(a,d[0]),L(a,d[1]),L(a,b[0])}function O(a,b){this.min=a.clone();this.max=b.clone();this.contains=function(d){return a.x<=d.x&&b.x>=d.x&&a.y<=d.y&&b.y>=d.y};this.x_in=function(d){return a.x<=d.x&&b.x>=d.x};this.x_left=function(b){return a.x>=
b.x};this.x_right=function(a){return b.x<=a.x};this.y_in=function(d){return a.y<=d.y&&b.y>=d.y};this.y_left=function(b){return a.y>=b.y};this.y_right=function(a){return b.y<=a.y};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(a){switch(a){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();
case 3:return new vect(this.min.x,this.max.y);default:throw"Index out of bounds: "+a;}};this.intersects=function(a){for(var c=0;4>c;c++)for(var b=0;4>b;b++)if(vect.intersects(this.vertex(c),this.vertex((c+1)%4),a.vertex(b),a.vertex((b+1)%4)))return!0;return this.contains(a.min)&&this.contains(a.max)&&this.contains(new vect(a.min.x,a.max.y))&&this.contains(new vect(a.max.x,a.min.y))||a.contains(this.min)&&a.contains(this.max)&&a.contains(new vect(this.min.x,this.max.y))&&a.contains(new vect(this.max.x,
this.min.y))?!0:!1};this.union=function(a){this.min.x=Math.min(this.min.x,a.min.x);this.min.y=Math.min(this.min.y,a.min.y);this.max.x=Math.max(this.max.x,a.max.x);this.max.y=Math.max(this.max.y,a.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new O(a,b)}}function sa(a,b,d,c){this.data=a[c];this.right=this.left=null;b!=c&&(this.left=new sa(a,b,c-1,parseInt((b+(c-1))/2)));d!=c&&(this.right=new sa(a,c+1,d,parseInt((d+
(c+1))/2)));this.subtree=[];for(c=b;c<=d;c++)this.subtree.push(a[c]);this.subtree.sort(function(a,c){return a.y-c.y});this.yrange=function(a,c,b){return a.y_in(this.subtree[c])&&a.y_in(this.subtree[b])};this.subquery=function(a,c,b,d,g){if(this.yrange(c,b,d))for(c=b;c<=d;c++)a.push(this.subtree[c]);else c.y_in(this.subtree[g])&&a.push(this.subtree[g]),c.y_left(this.subtree[g])?g!=d&&this.subquery(a,c,g+1,d,parseInt((d+(g+1))/2)):(c.x_right(this.subtree[g])||g!=d&&this.subquery(a,c,g+1,d,parseInt((d+
(g+1))/2)),g!=b&&this.subquery(a,c,b,g-1,parseInt((b+(g-1))/2)))};this.search=function(c,f){f.x_in(a[b])&&f.x_in(a[d])?this.subquery(c,f,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2)):(f.contains(this.data)&&c.push(this.data),f.x_left(this.data)?this.right&&this.right.search(c,f):f.x_right(this.data)?this.left&&this.left.search(c,f):(this.left&&this.left.search(c,f),this.right&&this.right.search(c,f)))}}function la(a){a.sort(function(a,d){return a.x-d.x});0<a.length?this.root=new sa(a,
0,a.length-1,parseInt((a.length-1)/2)):null==this.root;this.search=function(a){if(!this.root)return[];a=a.clone();var d=[];this.root.search(d,a);return d}}function Ga(a){t||(t=z(x+"shaders/point"),Ha=Y(x+"images/circle.png"));this.id=M();var b=new G(a);b.create("vert",2);b.create("unit",2);b.create("color",3);b.create("alpha",1);var d=this,c=function(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=M();var c=new vect(a.geom[0][0],
a.geom[0][1]);this.bounds=new O(c.clone(),c.clone());var e,f,c=0,g={};I(g,a.style,"fill",X);I(g,a.style,"opacity",parseFloat);var j=function(){var a=g.fill;a||(a=d.style("fill"));a||(a=Za);b.repeat("color",a.array,e,f)},h=function(){var a=g.opacity;a||(a=d.style("opacity"));a||(a=$a);b.repeat("alpha",[a],e,f)};this.style=function(a,c){if(1==arguments.length)return g[a];g[a]=c;"fill"==a&&j();"opacity"==a&&h()};c=this.geom.length;f=6*c;e=b.alloc(f);$.each(this.geom,function(a,c){b.repeat("vert",c,e+
6*a,6);b.write("unit",ta,e+6*a,6)});j();h()},e=null,f=0,h=!1,j={},g={};this.bounds=null;this.append=function(a){a=new c(a);for(key in a.attr)j[key]=!0;g[a.id]=a;f++;h=!0;e=null;this.bounds?this.bounds.union(a.bounds):this.bounds=a.bounds.clone();return a};this.features=function(){var a=[];for(key in g)a.push(g[key]);return new y(a)};this.attr=function(){var a=[];for(key in j)a.push(key);return a};this.search=function(a){a=e.search(a.min,a.max);var c=[];$.each(a,function(a,b){c.push(g[b.key])});return new y(c)};
this.mouseover=function(){};this.mouseout=function(){};this.click=function(){};this.style=function(a,c){if(1<arguments.length)throw"Not Implemented";return null};this.update_move=function(){};this.draw=function(a,c,d){b.update(c);if(0<f){if(h){if(!e){var j=[],l;for(l in g)$.each(g[l].geom,function(a,c){j.push({key:l,x:c[0],y:c[1]})});e=new la(j)}h=!1}gl.useProgram(t);t.data("screen",a.camera.mat3);t.data("pos",b.get("vert"));t.data("circle_in",b.get("unit"));d||(t.data("color_in",b.get("color")),
t.data("alpha_in",b.get("alpha")),t.data("select",d),t.data("aspect",a.canvas.width()/a.canvas.height()),t.data("pix_w",2/a.canvas.width()),t.data("rad",5),t.data("glyph",Ha),t.data("zoom",1/a.camera.level),gl.drawArrays(gl.TRIANGLES,0,b.count()))}}}function ab(a,b){u||(u=z(a.gl,x+"shaders/line"));var d=new G(a.gl,1024);d.create("vert",2);d.create("norm",2);d.create("color",3);d.create("alpha",1);var c=[],e=function(a){var c=d.count(),e=0,g={stroke:function(a){d.repeat("color",a.array,c,e)},"stroke-opacity":function(a){d.repeat("alpha",
[a],c,e)}};this.update=function(c){var e=ga(a,b,c);if(null===e)throw"Style property does not exist";g[c](e)};this.update_all=function(){for(var a in g)this.update(a)};$.each(a.geom,function(a,c){for(a=0;a<c.length;a++)e+=6*c[a].length,ua(d,c[a])});this.update_all()};this.create=function(a,b){var d=new e(a,b);c.push(d);return d};this.update=function(a){for(var b=0;b<c.length;b++)c[b].update(a)};this.draw=function(){d.update();gl.useProgram(u);u.data("screen",a.camera.mat3);u.data("pos",d.get("vert"));
u.data("norm",d.get("norm"));u.data("color_in",d.get("color"));u.data("alpha_in",d.get("alpha"));u.data("px_w",2/a.canvas.width());u.data("px_h",2/a.canvas.height());gl.drawArrays(gl.TRIANGLES,0,d.count())}}function bb(){var a={},b={},d=!1,c={},e={},f=!1;this.style=function(b,e){if(2>arguments.length)return void 0!==c[b]?c[b]:null;c[b]=e;if(d)for(var f in a)a[f].update(b)};this.bounds=null;this.features=function(){var a=[],c;for(c in e)a.push(e[c]);return new y(a)};this.search=function(a){f&&this.update();
var c=new y([]),e;for(e in b)var d=b[e].search(a),c=c.join(d);return c};this.map_contains=function(a,c){f&&this.update();var e=new y([]),d;for(d in b)var g=b[d].map_contains(a,c),e=e.join(g);return e};this.append=function(c){c=new ba[c.type].geometry(c,this);e[c.id]=c;this.bounds?this.bounds.union(c.bounds):this.bounds=c.bounds.clone();d&&c.initialize(a[c.type]);f=!0};var h=null,j=null;this.mouseover=function(a){h=a};this.mouseout=function(a){j=a};var g={};this.update_move=function(a,c){if(h||j){var b=
this.map_contains(a,c),e={};b&&b.each(function(a,c){e[c.id]=c});for(var d in g)!(d in e)&&j&&j(g[d]);for(d in e)!(d in g)&&h&&h(e[d]);g=e}};this.force_out=function(){for(var a in g)j&&j(g[a]);g={}};this.initialize=function(c){for(var b in ba)a[b]=new ba[b].renderer(c,this);d=!0;for(var f in e)e[f].initialize(a[e[f].type])};this.update=function(){var a=this.features(),c;for(c in ba)b[c]=new ba[c].collection(a.type(c).items());f=!1};this.draw=function(){f&&this.update();if(!d)throw"Layer has not yet been initialized";
for(var c in a)a[c].draw()}}function Ia(a){function b(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=M();var c,b,e,d=0,f=function(){var a;a="fill"in s?s.fill:k.style("fill");j.repeat("color",a.array,c,b);a="stroke"in s?s.stroke:k.style("stroke");g.repeat("color",a.array,e,d)},h=function(){var a;a="fill-opacity"in s?s["fill-opacity"]:k.style("fill-opacity");j.repeat("alpha",[a],c,b);a="stroke-opacity"in s?s["stroke-opacity"]:k.style("stroke-opacity");
g.repeat("alpha",[a],e,d)},m=new vect(Infinity,Infinity),q=new vect(-Infinity,-Infinity);$.each(this.geom,function(a,c){$.each(c,function(a,c){$.each(c,function(a,c){c[0]<m.x&&(m.x=c[0]);c[0]>q.x&&(q.x=c[0]);c[1]<m.y&&(m.y=c[1]);c[1]>q.y&&(q.y=c[1])})})});this.bounds=new O(m,q);this.initialize=function(){var a=[];b=0;$.each(this.geom,function(c,e){for(var d,f=0;100>f;)try{d=Ja(e);break}catch(g){f++}if(100==f)throw"Rendering Polygon Failed";b+=d.length/2;a.push(d)});var k=c=j.alloc(b);$.each(a,function(a,
c){var b=c.length/2;j.write("vert",c,k,b);k+=b});e=g.count();$.each(this.geom,function(a,c){for(a=0;a<c.length;a++)d+=6*c[a].length,ua(g,c[a])});f();h()};var s={};I(s,a.style,"fill",X);I(s,a.style,"stroke",X);I(s,a.style,"fill-opacity",parseFloat);I(s,a.style,"stroke-opacity",parseFloat);this.style=function(a,c){if(1==arguments.length)return s[a];s[a]=c;"fill"==a&&f();"stroke"==a&&f();"fill-opacity"==a&&h();"stroke-opacity"==a&&h()}}a||(a={});a.style||(a.style={});var d,c,e,f;d="fill"in a.style?a.style.fill:
new v(0.02,0.44,0.69,1);c="stroke"in a.style?a.style.stroke:new v(0.02,0.44,0.69,1);e="fill-opacity"in a.style?a.style["fill-opacity"]:0.5;f="stroke-opacity"in a.style?a.style["stroke-opacity"]:1;var h=!1;this.id=M();var j,g,k=this,m={},q=0,l=null;this.features=function(){var a=[];for(key in m)a.push(m[key]);return new y(a)};this.search=function(a){a=l.search(a.min,a.max);var c={};$.each(a,function(a,b){c[b.key]=!0});a=[];for(var b in c)a.push(m[b]);return new y(a)};this.contains=function(a){var c=
0,b=[],e;for(e in m){var d=m[e];if(d.bounds.contains(a)){c++;for(var f=0;f<d.geom.length;f++){var g=0;$.each(d.geom[f],function(c,b){for(var e=0;e<b.length;e++){var d=(e+1)%b.length;if(0>(a.y-b[e][1])/(a.y-b[d][1])){var f=new vect(720,a.y),j=new vect(b[e][0],b[e][1]),d=new vect(b[d][0],b[d][1]);vect.intersects(a,f,j,d)&&g++}}});1==g%2&&b.push(d)}}}return new y(b)};this.aggregate=function(a,c){a.features().each(function(a,b){$.each(b.geom,function(a,e){var d=k.contains(new vect(e[0],e[1]));d&&c(d,
b)})})};this.bounds=null;var p=!1;this.append=function(a){a=new b(a);this.bounds?this.bounds.union(a.bounds):this.bounds=a.bounds.clone();m[a.id]=a;q++;p=!0;l=null;h&&a.initialize()};this.style=function(a,b){if(1<arguments.length)throw"Not Implemented";return"fill"==a?d:"stroke"==a?c:"fill-opacity"==a?e:"stroke-opacity"==a?f:null};var n=null,H=null;this.mouseover=function(a){n=a};this.mouseout=function(a){H=a};var s={};this.update_move=function(a,c){if(n||H){var b=this.contains(c),e={};b&&b.each(function(a,
c){e[c.id]=c});for(var d in s)!(d in e)&&H&&H(s[d]);for(d in e)!(d in s)&&n&&n(e[d]);s=e}};this.force_out=function(){for(var a in s)H&&H(s[a]);s={}};this.initialize=function(a){B||(B=z(a.gl,x+"shaders/poly"));u||(u=z(a.gl,x+"shaders/line"));j=new G(a.gl,1024);j.create("vert",2);j.create("color",3);j.create("alpha",1);g=new G(a.gl,1024);g.create("vert",2);g.create("norm",2);g.create("color",3);g.create("alpha",1);for(var c in m)m[c].initialize();h=!0};this.draw=function(a,c,b){if(!b){b=a.gl;j.update(c);
g.update(c);if(p){var e=[],d;for(d in m)$.each(m[d].geom,function(a,c){$.each(c,function(a,c){$.each(c,function(a,c){e.push({key:d,x:c[0],y:c[1]})})})});l=new la(e);p=!1}b.useProgram(B);B.data("screen",a.camera.mat3);B.data("pos",j.get("vert"));B.data("color_in",j.get("color"));B.data("alpha_in",j.get("alpha"));b.drawArrays(b.TRIANGLES,0,j.count());b.useProgram(u);u.data("screen",a.camera.mat3);u.data("pos",g.get("vert"));u.data("norm",g.get("norm"));u.data("color_in",g.get("color"));u.data("alpha_in",
g.get("alpha"));u.data("px_w",2/a.canvas.width());u.data("px_h",2/a.canvas.height());b.drawArrays(b.TRIANGLES,0,g.count())}}}function ua(a,b){for(var d=a.alloc(6*b.length),c=0,e=function(){if(b[c]){var a=new vect(b[c][0],b[c][1]);c++;return a}return null},f=[],h=[],j=function(a,c,b,e){e?(a[b]=-c.x,a[b+1]=-c.y):(a[b]=c.x,a[b+1]=c.y)},g=function(a,c,b,e){j(a,c,0,!1);j(a,b,2,!1);j(a,c,4,e);j(a,b,6,e);j(a,c,8,e);j(a,b,10,!1)},k=e(),m=e(),q=e(),l=vect.dir(m,k).rotate(va/2),p,n=d;m;)p=q?vect.dir(q,k).rotate(va/
2):vect.dir(m,k).rotate(va/2),g(f,k,m,!1),g(h,l,p,!0),a.write("vert",f,n,6),a.write("norm",h,n,6),n+=6,k=m,m=q,q=e(),l=p;return d}function wa(a){F||(F=z(x+"shaders/grid"));a||(a={});a.style||(a.style={});var b=a.lower,d=a.upper,c=a.rows,e=a.cols,f=(d.x-b.x)/e,h=(d.y-b.y)/c,j=new Float32Array(c*e),g=new Uint8Array(4*e*c),k=!1,m=new G(6);m.create("vert",2);m.create("screen",2);m.create("tex",2);var q=new vect(b.x,b.y),l=new vect(d.x,d.y),p=new vect(0,0),n=new vect(1,1),r=m.alloc(6);m.write("vert",w(q,
l),r,6);m.write("screen",w(new vect(-1,-1),new vect(1,1)),r,6);m.write("tex",w(p,n),r,6);var s=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,s);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);this.lower=function(){return b.clone()};this.upper=function(){return d.clone()};
this.rows=function(){return c};this.cols=function(){return e};this.centroid=function(a,c){return new vect(b.x+f*c+f/2,b.y+h*a+h/2)};this.get=function(a,c){return j[e*a+c]};var ha=-Infinity,ja=Infinity;this.qunatiles=function(a,c){c||(c=function(a,c){return a-c});for(var b=[],e=0;e<j.length;e++)b.push(j[e]);b.sort(c);for(var d=[-Infinity],e=1;e<a;e++){var f=parseInt(inc*e);d.push(b[f])}d.push(Infinity);return d};this.set=function(a,b,d){if(a>=c||b>=e)throw"Index Out of Bounds";j[e*a+b]=d;k=!0};this.raw_set=
function(a,b){if(a>=c*e)throw"Index Out of Bounds: "+a;j[a]=b;k=!0};this.clear=function(a){for(var b=0;b<c*e;b++)j[b]=a};var Z=null;this.draw=function(b){Z||(Z=b.framebuffer());m.update();if(k){ha=-Infinity;ja=Infinity;for(var d=0;d<c*e;d++){var f=j[d];f>ha&&(ha=f);f<ja&&(ja=f)}for(d=0;d<c*e;d++){var f=d,h=a.map(ja,ha,j[d]);g[4*f]=parseInt(255*h.r);g[4*f+1]=parseInt(255*h.g);g[4*f+2]=parseInt(255*h.b);g[4*f+3]=parseInt(255*h.a)}gl.bindTexture(gl.TEXTURE_2D,s);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,
e,c,0,gl.RGBA,gl.UNSIGNED_BYTE,g);gl.bindTexture(gl.TEXTURE_2D,null);k=!1}a.style.antialias&&Z.activate({blend:!1});gl.useProgram(F);F.data("screen",b.camera.mat3);F.data("pos",m.get("vert"));F.data("tex_in",m.get("tex"));F.data("sampler",s);d=vect.sub(b.camera.screen(l),b.camera.screen(q));F.data("width",d.x);F.data("height",-d.y);F.data("rows",c);F.data("cols",e);F.data("blur",a.blur);gl.drawArrays(gl.TRIANGLES,0,m.count());a.style.antialias&&(Z.deactivate(),b.draw_blur(Z.tex))}}function cb(a,b,
d){P||(P=z(x+"shaders/raster"));this.image=Y(a);var c=K(w(new vect(0,1),new vect(1,0)),2),e=K(w(b,d),2);this.draw=function(a,b,d){d||(gl.useProgram(P),P.data("screen",a.camera.mat3),P.data("pos",e),P.data("tex_in",c),P.data("sampler",this.image),gl.drawArrays(gl.TRIANGLES,0,e.numItems))}}function xa(a){C||(C=z(x+"shaders/hillshade"));var b=$(a).find("LatLonBox"),d=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),c=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));
a=$(a).find("GroundOverlay Icon href").text();var e=!1,f=Y(a,function(){e=!0});this.ready=function(){return e};var h=K(w(new vect(0,1),new vect(1,0)),2),j=K(w(d,c),2),g=315;this.draw=function(a){if(e){for(gl.useProgram(altitude_shader);1<=g;)g-=1;altitude_shader.data("azimuth",g);altitude_shader.data("altitude",Math.PI/4/(2*Math.PI));altitude_shader.data("screen",a.camera.mat3);altitude_shader.data("pos",j);altitude_shader.data("tex_in",h);altitude_shader.data("elevation",f);a=vect.sub(a.camera.screen(c),
a.camera.screen(d));altitude_shader.data("pix_w",1/a.x);altitude_shader.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,j.numItems);return g}}}function xa(a){C||(C=z(x+"shaders/hillshade"));var b=$(a).find("LatLonBox"),d=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),c=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=!1,f=Y(a,function(){e=!0});this.ready=function(){return e};var h=K(w(new vect(0,
1),new vect(1,0)),2),j=K(w(d,c),2),g=315;this.draw=function(a){if(e){for(gl.useProgram(C);1<=g;)g-=1;C.data("azimuth",g);C.data("altitude",Math.PI/4/(2*Math.PI));C.data("screen",a.camera.mat3);C.data("pos",j);C.data("tex_in",h);C.data("elevation",f);a=vect.sub(a.camera.screen(c),a.camera.screen(d));C.data("pix_w",1/a.x);C.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,j.numItems);return g}}}function ia(a){for(var b=[],d=[],c=0;c<a.levels;c++){var e=n(a);"file"==e.source&&(e.url+="/"+a.size*Math.pow(2,
c+1));e.min=new vect(-180,-90);e.rows=Math.pow(2,c);e.cols=2*e.rows;e.cellsize=180/e.rows;e.z_index=1-ya-c/1E3;e.available=d;e=new db(e);b.push(e)}ya+=(a.levels+2)/1E3;var f=null;this.initialize=function(a){D||(D=z(a.gl,x+"shaders/tile"));f=new G(a.gl,6*ca);f.create("vert",3);f.create("tex",2);f.create("lookup",1);f.alloc(6*ca);for(var c=0;25>c;c++)d.push(new pa(a.gl));for(c=0;c<b.length;c++)b[c].initialize(a);b[0].fetch_all();b[0].noexpire(!0)};this.draw=function(c,e){gl.useProgram(D);D.data("screen",
c.camera.mat3);Ka=La=0;for(var d=Infinity,k=b[0],m,q=0;q<b.length;q++){var l=a.size*b[q].cols/b[q].size(c).x;1>l&&(l=1/l);l<d&&(d=l,k=b[q],m=q)}for(q=m;0<=q;q--)b[q].fetch();if(k.ready())k.draw(c,e,f,0,!0);else{c.enable_z();d=0;for(q=m;0<=q;q--)d=b[q].draw(c,e,f,d,0==q);c.disable_z()}$.each(b,function(a,c){c.cull()})}}function db(a){a||(a={});a.desaturate||(a.desaturate=0);a.darken||(a.darken=0);a.hue||(a.hue=0);a.hue_color||(a.hue_color=Aa(0,0,0,1));if(!a.available){a.available=[];for(var b=0;8>
b;b++)a.available.push(new pa(d))}var d=null,c=a.url,e=a.min,f=a.rows,h=a.cols,j=a.cellsize;this.rows=f;this.cols=h;for(var g={},k={},m=function(c,b){var d=new vect(e.x+c*j,e.y+b*j),f=new vect(e.x+(c+1)*j,e.y+(b+1)*j),d={vert:w(d,f,a.z_index),tex:null,i:c,j:b,id:c+h*b,ready:!1,min:d,max:f};k[c][b]=d;g[d.id]=d},b=0;b<h;b++)k[b]={};this.size=function(a){var c=a.camera.screen(e);a=a.camera.screen(vect.add(e,new vect(j*h,j*f)));c=vect.sub(a,c);c.y=Math.abs(c.y);return c};var q=!1;this.noexpire=function(a){q=
a};this.cull=function(){if(!q){var c=(new Date).getTime(),b;for(b in p)if(c-p[b]>eb){var e=g[b];delete g[b];delete k[e.i][e.j];a.available.push(e.tex);e.tex=null;e.ready=!1;delete p[b]}}};var l=function(){var a=engine.camera.project(new vect(engine.canvas.offset().left,engine.canvas.offset().top+engine.canvas.height())),c=engine.camera.project(new vect(engine.canvas.offset().left+engine.canvas.width(),engine.canvas.offset().top)),b=Math.floor((a.x-e.x)/j),d=Math.ceil((c.x-e.x)/j),a=Math.floor((a.y-
e.y)/j),c=Math.ceil((c.y-e.y)/j);return{min_col:b,max_col:d,min_row:a,max_row:c}},p={};this.ready=function(){for(var a=l(),c=Math.max(0,a.min_col);c<Math.min(h,a.max_col);c++)for(var b=Math.max(0,a.min_row);b<Math.min(f,a.max_row);b++)if(!k[c][b]||!k[c][b].ready)return!1;return!0};var n=function(b,e){if(!k[b][e].tex){var f;if("file"==a.source)f=c+"/"+k[b][e].id+".png";else if("wms"==a.source){f={service:"wms",version:"1.1.0",request:"GetMap",layers:a.layer,bbox:[k[b][e].min.x,k[b][e].min.y,k[b][e].max.x,
k[b][e].max.y].join(),width:a.size,height:a.size,srs:"EPSG:4326",format:"image/png",transparent:"true"};var g=[],j;for(j in f)g.push(j+"="+f[j]);f=c+"?"+g.join("&")}k[b][e].tex=a.available.pop();k[b][e].tex||(k[b][e].tex=new pa(d));j=f;var h=k[b][e],m=new Image;m.crossOrigin="";m.onload=function(){h.tex&&(h.tex.image(m),h.ready=!0)};m.src=j}};this.fetch_all=function(){for(var a=(new Date).getTime(),c=0;c<h;c++)for(var b=0;b<f;b++)k[c][b]||m(c,b),k[c][b].tex||n(c,b),p[k[c][b].id]=a};this.fetch=function(){for(var a=
l(),c=(new Date).getTime(),b=Math.max(0,a.min_col-1);b<Math.min(h,a.max_col+1);b++)for(var e=Math.max(0,a.min_row-1);e<Math.min(f,a.max_row+1);e++)k[b][e]||m(b,e),k[b][e].tex||n(b,e),p[k[b][e].id]=c};var r=!1;this.initialize=function(a){if(r)throw"Not Implemented: Migrating Tile Layers to New Map";D||(D=z(a.gl,x+"shaders/tile"));d=a.gl;r=!0};this.draw=function(c,b,e,g,j){r||this.initialize(c);c=function(){Ka++;e.update();D.data("pos",e.get("vert"));D.data("tex_in",e.get("tex"));D.data("lookup_in",
e.get("lookup"));D.data("desaturate",a.desaturate);D.data("darken",a.darken);D.data("hue",a.hue);D.data("hue_color",a.hue_color.array);d.drawArrays(d.TRIANGLES,0,6*g)};b=l();for(var m=(new Date).getTime(),q=Math.max(0,b.min_col);q<Math.min(h,b.max_col);q++)for(var n=Math.max(0,b.min_row);n<Math.min(f,b.max_row);n++)if(k[q][n]&&k[q][n].ready&&k[q][n].tex){e.write("vert",k[q][n].vert,6*g,6);e.write("tex",w(new vect(0,0),new vect(1,1)),6*g,6);e.repeat("lookup",[g/ca+1/(2*ca)],6*g,6);p[k[q][n].id]=m;
D.data("sampler"+g,k[q][n].tex);if(null==k[q][n].tex)throw"badness";g++;La++;g>=ca&&(c(),g=0)}j&&c();return g}}var x="",V=jQuery,fb=function(a){if("string"===typeof a.data){var b=a.handler,d=a.data.toLowerCase().split(" ");a.handler=function(a){if(!(this!==a.target&&(/textarea|select/i.test(a.target.nodeName)||"text"===a.target.type))){var e="keypress"!==a.type&&V.hotkeys.specialKeys[a.which],f=String.fromCharCode(a.which).toLowerCase(),h="",j={};a.altKey&&"alt"!==e&&(h+="alt+");a.ctrlKey&&"ctrl"!==
e&&(h+="ctrl+");a.metaKey&&(!a.ctrlKey&&"meta"!==e)&&(h+="meta+");a.shiftKey&&"shift"!==e&&(h+="shift+");e?j[h+e]=!0:(j[h+f]=!0,j[h+V.hotkeys.shiftNums[f]]=!0,"shift+"===h&&(j[V.hotkeys.shiftNums[f]]=!0));e=0;for(f=d.length;e<f;e++)if(j[d[e]])return b.apply(this,arguments)}}}};V.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",
45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(","0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">",
"/":"?","\\":"|","[":"{","]":"}"}};V.each(["keydown","keyup","keypress"],function(){V.event.special[this]={add:fb}});var N=jQuery,za=function(a){var b=a||window.event,d=[].slice.call(arguments,1),c=0,e=0,f=0;a=N.event.fix(b);a.type="mousewheel";b.wheelDelta&&(c=b.wheelDelta/120);b.detail&&(c=-b.detail/3);f=c;void 0!==b.axis&&b.axis===b.HORIZONTAL_AXIS&&(f=0,e=-1*c);void 0!==b.wheelDeltaY&&(f=b.wheelDeltaY/120);void 0!==b.wheelDeltaX&&(e=-1*b.wheelDeltaX/120);d.unshift(a,c,e,f);return(N.event.dispatch||
N.event.handle).apply(this,d)},W=["DOMMouseScroll","mousewheel"];if(N.event.fixHooks)for(var Q=W.length;Q;)N.event.fixHooks[W[--Q]]=N.event.mouseHooks;N.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=W.length;a;)this.addEventListener(W[--a],za,!1);else this.onmousewheel=za},teardown:function(){if(this.removeEventListener)for(var a=W.length;a;)this.removeEventListener(W[--a],za,!1);else this.onmousewheel=null}};N.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",
a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}});for(var Ma=0,Q=["ms","moz","webkit","o"],da=0;da<Q.length&&!window.requestAnimationFrame;++da)window.requestAnimationFrame=window[Q[da]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[Q[da]+"CancelAnimationFrame"]||window[Q[da]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),d=Math.max(0,16-(b-Ma)),c=window.setTimeout(function(){a(b+
d)},d);Ma=b+d;return c});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});var va=3.14159265,I=function(a,b,d,c){d in b&&(a[d]=c?c(b[d]):b[d])},Va=!1,Ca=0,Ra={Point:{fill:new v(0.02,0.44,0.69,1),opacity:1,radius:5,stroke:"none","stroke-width":2},Polygon:{fill:new v(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new v(0.02,0.44,0.69,1),"stroke-opacity":1}},qa="http://eland.ecohealthalliance.org/wigglemaps",S={x:0,y:0},A=null,Da=null,aa=null,Ja=function(a){for(var b=
[],d=0;d<a.length;d++){for(var c=[],e=1;e<a[d].length;e++)c.push(Na(a[d][e][0],a[d][e][1]));c.push(b[0]);b.push(c)}a=[];for(var e=0,f=[],c=0;c<b.length;c++){for(d=0;d<b[c].length-1;d++){var h=Ea(d+1,b[c].length-1),j=Ea(d-1,b[c].length-1);a.push(new Ya(d+e,h+e,j+e,c));f.push(b[c][d])}f.push(b[c][0]);e+=b[c].length}a.sort(function(a,c){return f[a.current].y-f[c.current].y});b=[];c=[];new vect(-200,0);new vect(200,0);e=0;e=[];j=[];for(d=0;d<a.length;d++){var g=a[d],h=Fa(b,g.lower),k=Fa(b,g.current),
m,q;if(h&&!k)q=m=T(b,g.lower);else if(k&&!h)m=q=T(b,g.current);else if(h&&k)m=T(b,g.lower),q=T(b,g.current);else if(!h&&!k){a:{m=b;q=f;for(var l=f[g.current].x,n=f[g.current].y,p=0;p<m.length;p++){var r=ka(q,m[p],n);if(r>l||0==r-l&&q[m[p]].y>q[index].y){q=p;break a}}q=m.length}m=q}if(1<Math.abs(m-q)){for(h=0;h<b.length;h++);throw"Bad";}l=vect.left(f[g.lower],f[g.current],f[g.upper]);n=Math.floor(Math.min(m,q)/2);!l&&!h&&!k?(U(j,c[n],[E(g.current,f,b[q-1]),E(g.current,f,b[q])]),c.splice(n,1,[E(g.current,
f,b[q-1]),f[g.current]],[f[g.current],E(g.current,f,b[m])])):l&&!h&&!k?c.splice(n,0,[f[g.current]]):h&&!k?(U(j,c[n],[E(g.current,f,b[Math.max(m,q)-1]),f[g.current]]),c[n]=[E(g.current,f,b[Math.min(m,q)-1]),f[g.current]]):!h&&k?(U(j,c[n],[f[g.current],E(g.current,f,b[Math.min(q,m)+1])]),c[n]=[f[g.current],E(g.current,f,b[Math.max(q,m)+1])]):!l&&h&&k?(U(j,c[n],[E(g.current,f,b[Math.min(m,q)-1]),f[g.current]]),U(j,c[n+1],[E(g.current,f,b[Math.max(m,q)+1]),f[g.current]]),c.splice(n,2,[E(g.current,f,b[Math.min(m,
q)-1]),E(g.current,f,b[Math.max(m,q)+1])])):l&&(h&&k)&&(U(j,c[n],[f[g.current]]),c.splice(n,1));h&&!k?b[m]=g.current:k&&!h?b[q]=g.lower:h&&k?(b.splice(T(b,g.lower),1),b.splice(T(b,g.current),1)):!h&&!k&&(l?b.splice(m,0,g.lower,g.current):b.splice(m,0,g.current,g.lower));for(h=0;h<b.length-1;h++)if(ka(f,b[h],f[g.current].y)>ka(f,b[h+1],f[g.current].y))throw console.log("Misplaced Sweep"),"Misplace!";}if(0<b.length)throw console.log(b),"Bad "+b.length;if(0<e.length)throw console.log(e),"Wrong";return j},
t=null,Ha,ta=na(0,0,1,1),Za=new v(0.02,0.44,0.69,1),$a=1,t=null,ta=na(0,0,1,1),u=null,B=null,ba={Point:{geometry:function(a,b){Oa.call(this,a,b);this.bounds=null;for(var d=0;d<this.geom.length;d++){var c=new vect(this.geom[d][0],this.geom[d][1]),c=new O(c.clone(),c.clone());this.bounds?this.bounds.union(c):this.bounds=c}this.map_contains=function(a,c){for(var b=this.compute("radius"),d=0;d<this.geom.length;d++){var g=a.camera.screen(new vect(this.geom[d][0],this.geom[d][1]));if(vect.dist(g,c)<b)return!0}return!1}},
renderer:function(a,b){t||(t=z(a.gl,x+"shaders/point"));var d=10,c=new G(a.gl,1024);c.create("vert",2);c.create("unit",2);c.create("stroke_width",1);c.create("rad",1);c.create("fill_color",3);c.create("fill",1);c.create("stroke_color",3);c.create("stroke",1);c.create("alpha",1);var e=[],f=function(a){var e,f,k={fill:function(a){"none"==a?c.repeat("fill",[-0.75],e,f):(c.repeat("fill",[0.75],e,f),c.repeat("fill_color",a.array,e,f))},opacity:function(a){c.repeat("alpha",[a],e,f)},radius:function(a){a>
d&&(d=a);c.repeat("rad",[a],e,f)},stroke:function(a){"none"==a?c.repeat("stroke",[-0.75],e,f):(c.repeat("stroke",[0.75],e,f),c.repeat("stroke_color",a.array,e,f))},"stroke-width":function(a){c.repeat("stroke_width",[a],e,f)}};this.update=function(c){var e=ga(a,b,c);if(null===e)throw"Style property does not exist";k[c](e)};this.update_all=function(){for(var a in k)this.update(a)};var m=a.geom;f=6*m.length;e=c.alloc(f);$.each(m,function(a,b){c.repeat("vert",b,e+6*a,6);c.write("unit",ta,e+6*a,6)});this.update_all()};
this.create=function(a,c){var b=new f(a,c);e.push(b);return b};this.update=function(a){for(var c=0;c<e.length;c++)e[c].update(a)};this.draw=function(){c.update();gl.useProgram(t);t.data("screen",a.camera.mat3);t.data("pos",c.get("vert"));t.data("circle_in",c.get("unit"));t.data("color_in",c.get("fill_color"));t.data("stroke_color_in",c.get("stroke_color"));t.data("alpha_in",c.get("alpha"));t.data("fill_in",c.get("fill"));t.data("stroke_in",c.get("stroke"));t.data("aspect",a.canvas.width()/a.canvas.height());
t.data("pix_w",2/a.canvas.width());t.data("rad",c.get("rad"));t.data("stroke_width_in",c.get("stroke_width"));t.data("max_rad",d);gl.drawArrays(gl.TRIANGLES,0,c.count())}},collection:function(a){var b=[],d=0;$.each(a,function(a,c){var h=c.compute("radius");h>d&&(d=h);$.each(c.geom,function(a,e){b.push({x:e[0],y:e[1],ref:c})})});var c=new la(b);this.search=function(a){a=c.search(a);var b=[];$.each(a,function(a,c){b.push(c.ref)});return new y(b)};this.map_contains=function(a,b){for(var h=vect.add(b,
new vect(-d,d)),j=vect.add(b,new vect(d,-d)),h=new O(a.camera.project(h),a.camera.project(j)),h=c.search(h),j=0;j<h.length;j++){var g=h[j];if(g.ref.map_contains(a,b))return new y([g.ref])}return new y([])}}},Polygon:{geometry:function(a,b){Oa.call(this,a,b);var d=new vect(Infinity,Infinity),c=new vect(-Infinity,-Infinity);$.each(this.geom,function(a,b){$.each(b,function(a,b){$.each(b,function(a,b){b[0]<d.x&&(d.x=b[0]);b[0]>c.x&&(c.x=b[0]);b[1]<d.y&&(d.y=b[1]);b[1]>c.y&&(c.y=b[1])})})});this.bounds=
new O(d,c);this.map_contains=function(a,c){return this.contains(a.camera.project(c))};this.contains=function(a){var c=0;if(this.bounds.contains(a)){c++;for(c=0;c<this.geom.length;c++){var b=0;$.each(this.geom[c],function(c,d){for(var f=0;f<d.length;f++){var m=(f+1)%d.length;if(0>(a.y-d[f][1])/(a.y-d[m][1])){var q=new vect(720,a.y),l=new vect(d[f][0],d[f][1]),m=new vect(d[m][0],d[m][1]);vect.intersects(a,q,l,m)&&b++}}});if(1==b%2)return!0}}return!1}},renderer:function(a,b){B||(B=z(a.gl,x+"shaders/poly"));
var d=new ab(a,b),c=new G(a.gl,1024);c.create("vert",2);c.create("color",3);c.create("alpha",1);var e=[],f=function(a){d.create(a);var e,f,k={fill:function(a){c.repeat("color",a.array,e,f)},"fill-opacity":function(a){c.repeat("alpha",[a],e,f)}};this.update=function(c){var e=ga(a,b,c);if(null===e)throw"Style property does not exist";k[c](e)};this.update_all=function(){for(var a in k)this.update(a)};var m=a.geom,q=[];f=0;$.each(m,function(a,c){for(var b,e=0;100>e;)try{b=Ja(c);break}catch(d){e++}if(100==
e)throw"Rendering Polygon Failed";f+=b.length/2;q.push(b)});var l=e=c.alloc(f);$.each(q,function(a,b){var e=b.length/2;c.write("vert",b,l,e);l+=e});this.update_all()};this.create=function(a,c){var b=new f(a,c);e.push(b);return b};this.update=function(a){for(var c=0;c<e.length;c++)e[c].update(a)};this.draw=function(){c.update();gl.useProgram(B);B.data("screen",a.camera.mat3);B.data("pos",c.get("vert"));B.data("color_in",c.get("color"));B.data("alpha_in",c.get("alpha"));gl.drawArrays(gl.TRIANGLES,0,
c.count());d.draw()}},collection:function(a){for(var b=[],d=0;d<a.length;d++)$.each(a[d].geom,function(c,e){$.each(e,function(c,e){$.each(e,function(c,e){b.push({ref:a[d],x:e[0],y:e[1]})})})});tree=new la(b);this.search=function(c){var b=tree.search(c),d={};$.each(b,function(a,c){d[c.ref.id]=c.ref});for(b=0;b<a.length;b++)for(var h=0;4>h;h++)a[b].contains(c.vertex(h))&&(d[a[b].id]=a[b]);c=[];for(var j in d)c.push(d[j]);return new y(c)};this.map_contains=function(a,b){return this.contains(a.camera.project(b))};
this.contains=function(c){for(var b=[],d=0;d<a.length;d++)a[d].contains(c)&&b.push(a[d]);return new y(b)}}}},Oa=function(a,b){var d={},c=null;this.id=M();this.type=a.type;var e=a.attr;this.attr=function(a,c){if(2>arguments.length)return e[a]};this.geom=a.geom;this.geometry=function(){};this.initialize=function(a){c=a.create(this);c.update_all()};this.compute=function(a){return ga(this,b,a)};this.style=function(a,b,e){if(2>arguments.length)return void 0!==d[a]?d[a]:null;d[a]=b;c&&c.update(a)}},M,Pa=
1;M=function(){var a=Pa;Pa++;return a};var Na;Na=function(a,b){return new vect(a+1E-6*Math.random()-5E-7,b+1E-6*Math.random()-5E-7)};var F=B=null,y=function(a){var b=null;this.length=a.length;this.count=function(){return a.length};this.items=function(){return a};this.type=function(c){for(var b=[],d=0;d<a.length;d++)a[d].type==c&&b.push(a[d]);return new y(b)};this.join=function(c){for(var b=[],d=0;d<a.length;d++)b.push(a[d]);for(d=0;d<c.count();d++){var h=c.get(d);this.id(h.id)||b.push(h)}return new y(b)};
this.attr=function(){throw"Not Implemented";};this.get=function(c){return a[c]};this.subset=function(c){for(var b=[],d=0;d<c.length;d++)b.push(a[c[d]]);return new y(b)};this.id=function(c){if(!b){b={};for(var e=0;e<a.length;e++)b[a[e].id]=a[e]}return c in b?b[c]:null};this.each=function(c){for(var b=0;b<a.length;b++)c(b,a[b]);return this};var d={">":function(a,b){return a>b},"<":function(a,b){return a<b},"==":function(a,b){return a==b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=
b}};this.select=function(c){if(c.match(/^\s*\*\s*$/))return new y(a);var b=c.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!b)throw"Bad Selector";c=b[1];var f=b[2],h=null,j=null;isNaN(b[3])?j=b[3]:h=parseFloat(b[3]);new_elem=[];if(j)for(b=0;b<a.length;b++)d[f](a[b].attr(c),a[b].attr(j))&&new_elem.push(a[b]);else for(b=0;b<a.length;b++)d[f](a[b].attr(c),h)&&new_elem.push(a[b]);return new y(new_elem)};this.filter=function(b){for(var e=[],d=0;d<a.length;d++)b(a[d])&&e.push(a[d]);return new y(e)};
this.quantile=function(b,e,d){a.sort(function(a,e){return a.attr(b)-e.attr(b)});var h=Math.round(e*this.length/d);e=Math.round((e-1)*this.length/d);return new y(a.slice(e,h))};this.range=function(b){for(var e=Infinity,d=-Infinity,h=0;h<a.length;h++)e>a[h].attr(b)&&(e=a[h].attr(b)),d<a[h].attr(b)&&(d=a[h].attr(b));return{min:e,max:d}};this.style=function(b,e){if(1==arguments.length){var d=[];$.each(a,function(a,e){d.push(e.style(b))});return d}if("function"==typeof e)$.each(a,function(a,d){d.style(b,
e(d))});else{var h;a:if(null==e||void 0==e.length)h=!1;else{for(h=0;h<e.length;h++)if(!(h in e)){h=!1;break a}h=!0}h?$.each(a,function(a,d){d.style(b,e[a])}):$.each(a,function(a,d){d.style(b,e)})}return this}},P=null,C=null,R=null,C=null,eb=1E3,ya=0,ca=8,La=0,Ka=0,D=null,Qa=[];window.wiggle={Map:function(a,b){this.center=function(a,b){engine.camera.position(new vect(a,b))};this.vcenter=function(a){this.center(a.x,a.y)};this.extents=function(a){engine.camera.extents(a)};this.append=function(a){a.initialize(engine);
engine.scene.push(a)};this.remove=function(a){for(var b=0;b<engine.scene.length;b++)if(engine.scene[b]==a)return engine.scene.splice(b,1),!0;return!1};this.shade=function(a){a=new xa(a);engine.shade=a};this.select=function(a){a?(engine.sel.select(a),engine.select(!0)):engine.select(!1)};this.resize=function(){engine.resize()};this.attr=function(a,b){engine.attr(a,b)};this.png=function(){var a=engine.canvas.get(0).toDataURL();$.ajax({url:"../server/export.png",type:"POST",data:a})};this.width=function(){return engine.canvas.innerWidth()};
this.height=function(){return engine.canvas.innerHeight()};var d=null;this.click=function(a){d=a};engine=new Ua(a,this,b);engine.canvas.click(function(a){d&&(a=new vect(a.pageX,a.pageY),a=engine.camera.project(a),d(a))})},layer:{PointLayer:Ga,LineLayer:function(){function a(a){a||(a={});a.geom||(a.geom=[]);a.attr||(a.attr={});a.style||(a.style={});this.geom=a.geom;this.attr=a.attr;this.id=M();var b,e=0,g=function(){var a;a="stroke"in m?m.stroke:c.style("stroke");d.repeat("color",a.array,b,e)},k=function(){var a;
a="stroke-opacity"in m?m["stroke-opacity"]:c.style("stroke-opacity");d.repeat("alpha",[a],b,e)};b=d.count();ua(d,this.geom);var e=6*this.geom.length,m={};I(m,a.style,"fill",X);I(m,a.style,"stroke",X);I(m,a.style,"fill-opacity",parseFloat);I(m,a.style,"stroke-opacity",parseFloat);this.style=function(a,b){if(1==arguments.length)return m[a];m[a]=b;"fill"==a&&g();"stroke"==a&&g();"fill-opacity"==a&&k();"stroke-opacity"==a&&k()};g();k()}var b=new v(0.02,0.44,0.69,1);u||(u=z(x+"shaders/line"));this.id=
M();var d=new G(1024);d.create("vert",2);d.create("norm",2);d.create("unit",2);d.create("color",3);d.create("alpha",1);var c=this,e=0;this.append=function(b){b=new a(b);for(key in b.attr);e++;return b};this.style=function(a,c){if(1<arguments.length)throw"Not Implemented";return"stroke"==a?b:"stroke-opacity"==a?1:null};this.draw=function(a,b){d.update(b);0<e&&(gl.useProgram(u),u.data("screen",a.camera.mat3),u.data("pos",d.get("vert")),u.data("norm",d.get("norm")),u.data("color_in",d.get("color")),
u.data("alpha_in",d.get("alpha")),u.data("px_w",2/a.canvas.width()),u.data("px_h",2/a.canvas.height()),gl.drawArrays(gl.TRIANGLES,0,d.count()))}},PolygonLayer:Ia,Grid:wa,Hillshade:xa,Elevation:function(a){R||(R=z(x+"shaders/elevation"));var b=$(a).find("LatLonBox"),d=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),c=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var e=Y(a),f=K(w(new vect(0,
1),new vect(1,0)),2),h=K(w(d,c),2);this.draw=function(a,b,k){k||(gl.useProgram(R),R.data("screen",a.camera.mat3),R.data("pos",h),R.data("tex_in",f),R.data("elevation",e),vect.sub(a.camera.screen(c),a.camera.screen(d)),gl.drawArrays(gl.TRIANGLES,0,h.numItems))}}},io:{Shapefile:function(a){var b=a.path;$.ajax({url:b+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(d){for(var c=[],e=100;e<d.length;)c.push(2*ma(d,e)),e+=8;$.ajax({url:b+".shp",mimeType:"text/plain; charset=x-user-defined",
success:function(b){for(var d=[],e=[],g=0;g<c.length;g++){var k=c[g];ma(b,k);ma(b,k+4);var m=k+8,l=J(b,m);if(0==l)console.log("NULL Shape");else if(1==l)l=ea(b,m+4),m=ea(b,m+12),d.push({attr:{},geom:[[l,m]]});else if(5==l){for(var l=J(b,m+36),m=J(b,m+40),n=k+52,k=k+52+4*l,p=[],r=0;r<l;r++){var t=J(b,n+4*r),s;s=r+1<l?J(b,n+4*(r+1)):m;var u=k,v=[];for(s-=1;s>=t;s--){var x=ea(b,u+16*s),y=ea(b,u+16*s+8);v.push([x,y])}p.push(v)}e.push({attr:{},geom:[p]})}else throw"Not Implemented: "+l;}if(0<d.length){var w=
new Ga(d.length);$.each(d,function(a,b){w.append(b)});b=w}else 0<e.length?(w=new Ia(a),$.each(e,function(a,b){for(var c=0;100>c;)try{w.append(b),c=101}catch(d){c++}100==c&&console.log("rendering polygon failed")}),b=w):b=void 0;a.success(b)}})}})},GeoJSON:function(a){for(var b=new bb,d=0;d<a.features.length;d++){var c=a.features[d];if("Feature"==c.type){"Point"==c.geometry.type&&b.append({type:"Point",geom:[c.geometry.coordinates],attr:c.properties});"MultiPoint"==c.geometry.type&&b.append({type:"Point",
geom:c.geometry.coordinates,attr:c.properties});if("Polygon"==c.geometry.type){for(var e=c.geometry.coordinates,f=[],h=0;h<=e.length-1;h++){for(var j=[],g=e[h].length-1;0<=g;g--)j.push(e[h][g]);f.push(j)}b.append({type:"Polygon",geom:[f],attr:c.properties})}if("MultiPolygon"==c.geometry.type){var k=[];$.each(c.geometry.coordinates,function(a,b){for(var c=[],d=0;d<=b.length-1;d++){for(var e=[],f=b[d].length-1;0<=f;f--)e.push(b[d][f]);c.push(e)}k.push(c)});b.append({type:"Polygon",geom:k,attr:c.properties})}"MultiLineString"==
c.geometry.type&&$.each(c.geometry.coordinates,function(a,d){b.append({type:"Line",geom:d,attr:c.properties})})}}return b},KML:function(a){var b=$(a).find("LatLonBox"),d=new vect(parseFloat(b.find("west").text()),parseFloat(b.find("south").text())),b=new vect(parseFloat(b.find("east").text()),parseFloat(b.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();return new cb(x+a,d,b)},SparseGrid:function(a,b){var d=fa(a,0),c=fa(a,4),e=J(a,8),f=J(a,12),h=fa(a,16),j={};for(key in b)j[key]=
b[key];j.lower=new vect(d,c);j.upper=new vect(d+h*e,c+h*f);j.rows=f;j.cols=e;d=new wa(j);for(c=20;c<a.length;){for(var h=J(a,c),e=J(a,c+4),f=c+4,j=e,g=0;g<j;g++){var k=fa(a,f+4*g);d.raw_set(h+g,k)}c+=8+4*e}return d},AsciiGrid:function(a,b){var d=a.split("\n"),c=d.splice(0,6),e=parseInt(c[0].slice(14)),f=parseInt(c[1].slice(14)),h=parseFloat(c[2].slice(14)),j=parseFloat(c[3].slice(14)),g=parseFloat(c[4].slice(14)),c=c[5].slice(14),k={};for(key in b)k[key]=b[key];k.lower=new vect(h,j);k.upper=new vect(h+
g*e,j+g*f);k.rows=f;k.cols=e;h=new wa(k);for(j=0;j<f;j++){g=d[j].split(" ");for(k=0;k<e;k++)g[k]==c?h.set(f-1-j,k,NaN):h.set(f-1-j,k,parseFloat(g[k]))}return h},WMS:function(a){a=n(a);for(var b=["url","layer"],d=0;d<b.length;d++){var c=b[d];if(!(c in a))throw"Key "+c+" not found";}p(a,{levels:16,size:256});var b={source:"wms"},e;for(e in b)a[e]=b[e];return new ia(a)}},util:{fcolor:Aa,icolor:function(a,b,d,c){return new v(l(a/255,0,1),l(b/255,0,1),l(d/255,0,1),l(c/255,0,1))}},widget:{Slider:function(a,
b,d){var c=function(a){if(a>=d)throw"Slider index out of bounds";return b.x/(d-1)*a},e=function(c){return c<=a.x?0:c>=a.x+b.x?d-1:Math.round((c-a.x)/b.x*(d-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",a.x).css("top",a.y).css("width",b.x).css("height",b.y);var f=!1,h=0,j=$("<div></div>").addClass("slider-box").css("position","relative").css("left",-10).css("height",b.y).css("width",20).mousedown(function(){f=!0});this.tick=function(){return h};this.count=
function(){return d};var g=function(){};this.change=function(a){g=a};var k=function(){};this.release=function(a){k=a};this.dragging=function(){return f};this.dom.append(j);this.set=function(a){a!=h&&g(a);h=a;var b=c(a);j.css("left",b-10);k(a)};$(document).bind("mouseup",function(){if(f){f=!1;var a=e(event.clientX);k(a)}});$(document).bind("mousemove",function(a){f&&(a=e(a.clientX),a!=h&&g(a),h=a,a=c(a),j.css("left",a-10))})}},ready:function(a){Qa.push(a)}};$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(a,
b){var d=/wigglemaps(\.min)?\.js/;$(b).attr("src").match(d)&&(x=$(b).attr("src").replace(d,""))});$.each(Qa,function(a,b){b()})})})();
