function vect(f,j,p){this.x=f;this.y=j;this.z=p?p:0;this.add=function(f){this.x+=f.x;this.y+=f.y;this.z+=f.z};this.sub=function(f){this.x-=f.x;this.y-=f.y;this.z-=f.z};this.scale=function(f){this.x*=f;this.y*=f;this.z*=f;return this};this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)};this.normalize=function(){var f=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);if(0==f)return this;this.x/=f;this.y/=f;this.z/=f;return this};this.div=function(f){this.x/=f.x;this.y/=
f.y;this.z/=f.z};this.floor=function(){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z)};this.zero=function(){return 0==this.x+this.y+this.z};this.dot=function(f){return this.x*f.x+this.y*f.y+this.z*f.z};this.cross=function(){throw"Need to reimplement";};this.rotate=function(f){var j=Math.cos(f);f=Math.sin(f);xp=j*this.x-f*this.y;yp=f*this.x+j*this.y;this.x=xp;this.y=yp;return this};this.clone=function(){return new vect(this.x,this.y,this.z)}}
vect.scale=function(f,j){return new vect(f.x*j,f.y*j,f.z*j)};vect.add=function(f,j){return new vect(f.x+j.x,f.y+j.y,f.z+j.z)};vect.sub=function(f,j){if(!f||!j)throw"Bad Vector";return new vect(f.x-j.x,f.y-j.y,f.z-j.z)};vect.dist=function(f,j){var p=j.x-f.x,m=j.y-f.y,s=j.z-f.z;return Math.sqrt(p*p+m*m+s*s)};vect.dir=function(f,j){var p=vect.sub(f,j);p.normalize();return p};vect.dot2d=function(f,j){return f.x*j.x+f.y*j.y};vect.cross=function(f,j){return f.x*j.y-f.y*j.x};
vect.left=function(f,j,p,m){m||(m=0);j=vect.sub(j,f);f=vect.sub(p,f);return vect.cross(j,f)>=-m};vect.intersects=function(f,j,p,m,s){s||(s=0);return vect.left(f,j,p,s)!=vect.left(f,j,m,s)&&vect.left(p,m,j,s)!=vect.left(p,m,f,s)};vect.intersect2dt=function(f,j,p,m){m=f.x*(m.y-p.y)+j.x*(p.y-m.y)+m.x*(j.y-f.y)+p.x*(f.y-j.y);return 0==m?Infinity:-(f.x*(p.y-j.y)+j.x*(f.y-p.y)+p.x*(j.y-f.y))/m};
vect.intersect2dpos=function(f,j,p,m){var s=f.x*(m.y-p.y)+j.x*(p.y-m.y)+m.x*(j.y-f.y)+p.x*(f.y-j.y);if(0==s)return Infinity;p=(f.x*(m.y-p.y)+p.x*(f.y-m.y)+m.x*(p.y-f.y))/s;j=vect.sub(j,f);j.scale(p);return vect.add(f,j)};vect.rotate=function(f,j){var p=Math.cos(j),m=Math.sin(j);xp=p*f.x-m*f.y;yp=m*f.x+p*f.y;return f=new vect(xp,yp,f.z)};vect.normalize=function(f){f=f.clone();var j=Math.sqrt(f.x*f.x+f.y*f.y+f.z*f.z);if(0==j)return f;f.x/=j;f.y/=j;f.z/=j;return f};
(function(){function f(a,e){for(var c in e)c in a||(a[c]=e[c])}function j(a){var e={};for(key in a)e[key]=a[key];return e}function p(a,e){for(key in e)a[key]=e[key]}function m(a,e,c){return Math.min(Math.max(a,e),c)}function s(a,e,c,d){1>=a&&1>=e&&1>=c&&1>=d?(this.r=a,this.g=e,this.b=c,this.a=d):(this.r=a/255,this.g=e/255,this.b=c/255,this.a=d/255);this.array=[this.r,this.g,this.b,this.a];this.vect=function(){return this.array};this.rgb=function(){return"rgb("+parseInt(255*this.r)+","+parseInt(255*
this.g)+","+parseInt(255*this.b)+")"}}function wa(a,e,c,d){return new s(m(a,0,1),m(e,0,1),m(c,0,1),m(d,0,1))}function ia(a,e){return((a.charCodeAt(e)&255)<<24)+((a.charCodeAt(e+1)&255)<<16)+((a.charCodeAt(e+2)&255)<<8)+(a.charCodeAt(e+3)&255)}function F(a,e){return((a.charCodeAt(e+3)&255)<<24)+((a.charCodeAt(e+2)&255)<<16)+((a.charCodeAt(e+1)&255)<<8)+(a.charCodeAt(e)&255)}function ba(a,e){var c=a.charCodeAt(e)&255,d=a.charCodeAt(e+1)&255,b=a.charCodeAt(e+2)&255,g=a.charCodeAt(e+3)&255,l=a.charCodeAt(e+
4)&255,k=a.charCodeAt(e+5)&255,h=a.charCodeAt(e+6)&255,r=a.charCodeAt(e+7)&255,q=1-2*(r>>7),r=((r&127)<<4)+((h&240)>>4)-1023,c=(h&15)*Math.pow(2,48)+k*Math.pow(2,40)+l*Math.pow(2,32)+g*Math.pow(2,24)+b*Math.pow(2,16)+d*Math.pow(2,8)+c;return q*(1+c*Math.pow(2,-52))*Math.pow(2,r)}function ca(a,e){var c=a.charCodeAt(e)&255,d=a.charCodeAt(e+1)&255,b=a.charCodeAt(e+2)&255,g=a.charCodeAt(e+3)&255,l=1-2*(g>>7),g=((g&127)<<1)+((b&254)>>7)-127,c=(b&127)*Math.pow(2,16)+d*Math.pow(2,8)+c;return l*(1+c*Math.pow(2,
-23))*Math.pow(2,g)}function xa(a){return gl=ja?WebGLDebugUtils.makeDebugContext(a.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1}),function(a,c){throw WebGLDebugUtils.glEnumToString(a)+" was caused by call to "+c;}):a.get(0).getContext("experimental-webgl",{alpha:!1,antialias:!0,premultipliedAlpha:!1})}function ya(a,e,c,d){return[a-c,e+d,a-c,e-d,a+c,e+d,a-c,e-d,a+c,e-d,a+c,e+d]}function x(a,e,c){return 2==arguments.length?[a.x,e.y,a.x,a.y,e.x,e.y,a.x,a.y,e.x,
a.y,e.x,e.y]:[a.x,e.y,c,a.x,a.y,c,e.x,e.y,c,a.x,a.y,c,e.x,a.y,c,e.x,e.y,c]}function C(a,e){if(!a)return null;var c=a.createProgram(),d=za(a,a.VERTEX_SHADER,e+"/vert.glsl"),b=za(a,a.FRAGMENT_SHADER,e+"/frag.glsl");a.attachShader(c,d);a.attachShader(c,b);a.linkProgram(c);var g={},d=(d.source+b.source).match(/((uniform)|(attribute)) (\w+) (\w+)/mg),b=0;a.useProgram(c);if(d){for(var l=0;l<d.length;l++){var k=d[l].split(" ");g[k[2]]={u:k[0],type:k[1],loc:null};if("uniform"==k[0])g[k[2]].loc=a.getUniformLocation(c,
k[2]);else{var h=a.getAttribLocation(c,k[2]);g[k[2]].loc=h}"sampler2D"==k[1]&&(g[k[2]].tex=b,b++)}c.get=function(a){return g[a].loc};c.data=function(b,d){var c=g[b];if(!c)throw"Could not find shader variable "+b;if("uniform"==c.u)if("float"==c.type)a.uniform1f(c.loc,d);else if("vec2"==c.type)a.uniform2fv(c.loc,d);else if("ivec2"==c.type)a.uniform2iv(c.loc,d);else if("vec3"==c.type)a.uniform3fv(c.loc,d);else if("ivec3"==c.type)a.uniform3iv(c.loc,d);else if("vec4"==c.type)a.uniform4fv(c.loc,d);else if("ivec4"==
c.type)a.uniform4iv(c.loc,d);else if("bool"==c.type)a.uniform1i(c.loc,d);else if("mat4"==c.type)a.uniformMatrix4fv(c.loc,!1,d);else if("mat3"==c.type)a.uniformMatrix3fv(c.loc,!1,d);else if("sampler2D"==c.type)"texture"in d&&(d=d.texture()),a.activeTexture(a["TEXTURE"+c.tex]),a.bindTexture(a.TEXTURE_2D,d),a.uniform1i(c.loc,c.tex);else if("int"==c.type)a.uniform1i(c.loc,d);else throw"Unsupported Type for Shader Helper: "+c.type;else if("attribute"==c.u)a.enableVertexAttribArray(c.loc),a.bindBuffer(a.ARRAY_BUFFER,
d),a.vertexAttribPointer(c.loc,d.itemSize,a.FLOAT,!1,0,0);else throw"Type: "+c.u+" Recieved";}}return c}function za(a,e,c){var d=a.createShader(e);$.ajax({async:!1,url:c,dataType:"text",success:function(b){a.shaderSource(d,b);a.compileShader(d);if(!a.getShaderParameter(d,a.COMPILE_STATUS))throw a.getShaderInfoLog(d);d.source=b},error:function(){console.log("Could not load "+c)}});return d}function G(a,e,c){var d=a.createBuffer(),b=new Float32Array(e);a.bindBuffer(a.ARRAY_BUFFER,d);d.itemSize=c;d.numItems=
e.length/c;a.bufferData(a.ARRAY_BUFFER,b,a.STATIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return d}function ka(a,e,c){if(!a)return null;var d=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,d);var b=new Float32Array(e*c);d.itemSize=c;d.numItems=e;d.update=function(b,c){var e=new Float32Array(b);a.bindBuffer(a.ARRAY_BUFFER,d);a.bufferSubData(a.ARRAY_BUFFER,4*c,e);a.bindBuffer(a.ARRAY_BUFFER,null)};a.bufferData(a.ARRAY_BUFFER,b,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,null);return d}function da(a,e,
c){var d=a.createTexture();d.id=Aa;Aa++;var b=new Image;b.onload=function(){a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.bindTexture(a.TEXTURE_2D,null);c&&c()};b.src=e;return d}function la(a,e){var c=j(e);f(c,
{mag_filter:a.LINEAR,min_filter:a.LINEAR,wrap_s:a.CLAMP_TO_EDGE,wrap_t:a.CLAMP_TO_EDGE,mipmap:!1});var d=a.createTexture(),b=null;this.image=function(e){b=e;a.bindTexture(a.TEXTURE_2D,d);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,c.mag_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,c.min_filter);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,c.wrap_s);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,c.wrap_t);c.mipmap&&a.generateMipmap(a.TEXTURE_2D);
a.bindTexture(a.TEXTURE_2D,null)};this.texture=function(){return b?d:null}}function Ba(a,e,c){var d=a.style(c);null===d&&(d=e.style(c),null===d&&(d=Ra[a.type][c]));return d}function Ca(a,e){var c=a.width()/a.height();e||(e={});"center"in e||(e.center=new vect(0,0));"extents"in e||(e.extents=180);"v_extents"in e||(e.v_extents=e.extents/c);this.mat3=new Float32Array(9);this.mat3[0]=2/e.extents;this.mat3[4]=2/e.v_extents;this.mat3[8]=1;this.mat3[6]=0;this.mat3[7]=0;this.level=1;this.project=function(d){d=
new vect(2*(d.x-a.offset().left)/a.width()-1,-(2*(d.y-a.offset().top)/a.height()-1));d.x=d.x/this.mat3[0]-this.mat3[6]/this.mat3[0];d.y=d.y/this.mat3[4]-this.mat3[7]/this.mat3[4];return d};this.screen=function(d){d=new vect(d.x*this.mat3[0]+this.mat3[6],d.y*this.mat3[4]+this.mat3[7]);d.x=a.offset().left+a.width()*(d.x+1)/2;d.y=a.offset().top+a.height()*(-d.y+1)/2;return d};this.percent=function(d){return new vect(2*((d.x-a.offset().left)/a.width())-1,-(2*((d.y-a.offset().top)/a.height())-1))};this.pixel=
function(d){return new vect(a.offset().left+(d.x+1)/2*a.width(),a.offset().top+(-d.y+1)/2*a.height())};this.move=function(a){this.mat3[6]-=a.x*this.mat3[0];this.mat3[7]-=a.y*this.mat3[4]};this.position=function(a){if(!a)return new vect(-this.mat3[6]/this.mat3[0],-this.mat3[7]/this.mat3[4]);this.mat3[6]=-a.x*this.mat3[0];this.mat3[7]=-a.y*this.mat3[4]};this.position(e.center);this.extents=function(a,b){e.extents=a;e.v_extents=b?b:e.extents/c;var g=this.position();this.level=1;this.mat3[0]=2/e.extents;
this.mat3[4]=2/e.v_extents;this.position(g)};this.zoom=function(a){var b=new vect(this.mat3[6]/this.mat3[0],this.mat3[7]/this.mat3[4]);this.mat3[0]*=a;this.mat3[4]*=a;this.mat3[6]=b.x*this.mat3[0];this.mat3[7]=b.y*this.mat3[4];this.level*=a};this.reset=function(){this.zoom(1/this.level)};this.reconfigure=function(){var d=this.position();this.mat3[4]/=c;c=a.width()/a.height();this.mat3[4]*=c;this.position(d)}}function Da(a){var e=!1,c=new vect(0,0),d=new vect(0,0),b=null,g=0;a.canvas.mousedown(function(a){c=
new vect(a.clientX,a.clientY);e=!0});$(window).bind("mouseup",function(){e=!1});$(document).bind("keypress","+",function(){a.camera.zoom(1.1)});$(document).bind("keypress","-",function(){a.camera.zoom(10/11)});$(document).bind("keypress","0",function(){a.camera.reset()});a.canvas.bind("mousewheel",function(b,d){d*=0.5;0>d?(d=-1*d+1,d=1/d):d+=1;a.camera.zoom(d);b.preventDefault()});var l=!0;this.disable=function(){l=!1};this.enable=function(){l=!0};this.update=function(k){d=new vect(H.x,H.y);if(e&&
l){var h=vect.sub(a.camera.project(c),a.camera.project(d));a.camera.move(h);c=d;g=h.length()/k;b=h;b.normalize()}else 0.01<g&&b&&(a.camera.move(vect.scale(b,g*k)),g-=3*k*g)}}function ea(){this.views=[];this.update=function(a){for(var e=0;e<views.length;e++)this.views[e].update(a)};this.view_factory=function(){throw"Not Implemented";};this.create=function(a,e){var c=this.view_factory(a,e);this.views.push(c);return c}}function ma(a,e){this.style_map={};this.update=function(c){var d=Ba(a,e,c);if(null===
d)throw"Style property does not exist";this.style_map[c](d)};this.update_all=function(){for(var a in this.style_map)this.update(a)}}function Sa(a,e){ea.call(this,a,e);a.shaders.point||(a.shaders.point=C(a.gl,z+"shaders/point"));var c=a.shaders.point,d=10,b=new R(a.gl,Ta);b.create("vert",2);b.create("unit",2);b.create("stroke_width",1);b.create("rad",1);b.create("fill_color",3);b.create("fill",1);b.create("stroke_color",3);b.create("stroke",1);b.create("alpha",1);var g=function(a){ma.call(this,a,e);
var c,g;this.style_map={fill:function(a){"none"==a?b.repeat("fill",[-0.75],c,g):(b.repeat("fill",[0.75],c,g),b.repeat("fill_color",a.array,c,g))},opacity:function(a){b.repeat("alpha",[a],c,g)},radius:function(a){a>d&&(d=a);b.repeat("rad",[a],c,g)},stroke:function(a){"none"==a?b.repeat("stroke",[-0.75],c,g):(b.repeat("stroke",[0.75],c,g),b.repeat("stroke_color",a.array,c,g))},"stroke-width":function(a){b.repeat("stroke_width",[a],c,g)}};a=a.geom;g=6*a.length;c=b.alloc(g);$.each(a,function(a,d){b.repeat("vert",
d,c+6*a,6);b.write("unit",Ua,c+6*a,6)});this.update_all()};this.view_factory=function(a){return new g(a)};this.draw=function(){var e=a.gl;b.update();e.useProgram(c);c.data("screen",a.camera.mat3);c.data("pos",b.get("vert"));c.data("circle_in",b.get("unit"));c.data("color_in",b.get("fill_color"));c.data("stroke_color_in",b.get("stroke_color"));c.data("alpha_in",b.get("alpha"));c.data("fill_in",b.get("fill"));c.data("stroke_in",b.get("stroke"));c.data("aspect",a.canvas.width()/a.canvas.height());c.data("pix_w",
2/a.canvas.width());c.data("rad",b.get("rad"));c.data("stroke_width_in",b.get("stroke_width"));c.data("max_rad",d);e.drawArrays(e.TRIANGLES,0,b.count())}}function na(a,e){ea.call(this,a,e);a.shaders.line||(a.shaders.line=C(a.gl,z+"shaders/line"));var c=a.shaders.line,d=new R(a.gl,1024);d.create("vert",2);d.create("norm",2);d.create("width",2);d.create("color",3);d.create("unit",2);d.create("alpha",1);var b=function(a,b){ma.call(this,a,e);var c=d.count(),h=0;this.style_map={stroke:function(a){d.repeat("color",
a.array,c,h)},"stroke-opacity":function(a){d.repeat("alpha",[a],c,h)},"stroke-width":function(a){d.repeat("width",[a],c,h)}};b||(b=a.geom);$.each(b,function(a,b){for(a=0;a<b.length;a++)h+=6*b[a].length,b[a][0][0]==b[a][b[a].length-1][0]&&b[a][0][1]==b[a][b[a].length-1][1]?Va(d,b[a]):Wa(d,b[a])});this.update_all()};this.view_factory=function(a,d,c){return new b(a,d,c)};this.draw=function(){var b=a.gl;d.update();b.useProgram(c);c.data("screen",a.camera.mat3);c.data("pos",d.get("vert"));c.data("norm",
d.get("norm"));c.data("color_in",d.get("color"));c.data("alpha_in",d.get("alpha"));c.data("circle_in",d.get("unit"));c.data("width_in",d.get("width"));c.data("px_w",2/a.canvas.width());c.data("px_h",2/a.canvas.height());b.drawArrays(b.TRIANGLES,0,d.count())}}function Xa(a,e){ea.call(this,a,e);a.shaders.polygon||(a.shaders.polygon=C(a.gl,z+"shaders/poly"));var c=a.shaders.polygon,d=new na(a,e),b=new R(a.gl,Ya);b.create("vert",2);b.create("color",3);b.create("alpha",1);var g=function(a){ma.call(this,
a,e);d.create(a);var c,g;this.style_map={fill:function(a){b.repeat("color",a.array,c,g)},"fill-opacity":function(a){b.repeat("alpha",[a],c,g)}};a=a.geom;var r=[];g=0;$.each(a,function(a,b){for(var d,c=0;100>c;)try{for(var e=b,l=[],k=0;k<e.length;k++){for(var q=[],f=1;f<e[k].length;f++)q.push(Ea(e[k][f][0],e[k][f][1]));q.push(l[0]);l.push(q)}d=$a(l);break}catch(j){c++}if(100==c)throw"Rendering Polygon Failed";g+=d.length/2;r.push(d)});var q=c=b.alloc(g);$.each(r,function(a,d){var c=d.length/2;b.write("vert",
d,q,c);q+=c});this.update_all()};this.view_factory=function(a){return new g(a)};this.draw=function(){var e=a.gl;b.update();e.useProgram(c);c.data("screen",a.camera.mat3);c.data("pos",b.get("vert"));c.data("color_in",b.get("color"));c.data("alpha_in",b.get("alpha"));e.drawArrays(e.TRIANGLES,0,b.count());d.draw()}}function ab(a,e){ea.call(this,a,e);var c=new na(a,e);this.view_factory=function(a){for(var b=[],g=e.attr("order"),l=0;l<g.length;l++){var k=a.attr(g[l]);if(isNaN(k))throw"Not Implemented";
b.push([l/51,k/6500])}return c.create(a,[[b]])};this.draw=function(){c.draw()}}function bb(a,e,c){c||(c={});f(c,{base:"default",background:new s(0,0,0,1),antialias:!0});var d=this;this.canvas=$("<canvas></canvas>").attr("id","viewer");a?($(a).append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height())):(a=window,$("body").append(this.canvas),this.canvas.attr("width",$(a).width()),this.canvas.attr("height",$(a).height()),$(window).resize(function(){d.resize()}));
this.resize=function(){d.canvas.attr("width",$(a).width());d.canvas.attr("height",$(a).height());b.viewport(0,0,d.canvas.width(),d.canvas.height());d.camera.reconfigure();for(var c=0;c<q.length;c++)q[c].resize()};var b=xa(this.canvas,ja);this.gl=b;b.viewport(0,0,d.canvas.width(),d.canvas.height());b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA);b.enable(b.BLEND);A||(A=C(b,z+"shaders/blur"));Fa||(Fa=C(b,z+"shaders/light"));var g=new R(b,6);g.create("vert",2);g.create("tex",2);e=g.alloc(6);g.write("vert",
x(new vect(-1,-1),new vect(1,1)),e,6);g.write("tex",x(new vect(0,0),new vect(1,1)),e,6);g.update();this.scene=[];this.shaders={};this.camera=new Ca(this.canvas,c);this.scroller=new Da(this);this.pxW=1/this.canvas.attr("width");this.pxH=1/this.canvas.attr("height");this.Renderer={Point:Sa,Polygon:Xa,Line:na};this.sel=new Ga(this);this.select=function(a){a?(this.scroller.disable(),this.sel.enable()):(this.scroller.enable(),this.sel.disable())};var l=(new Date).getTime(),k=[];this.attr=function(a,b){"base"==
a&&(c.base=b,r())};var h=null,r=function(){if("default"==c.base||"nasa"==c.base){var a=j(c);p(a,{source:"file",url:oa+"/tiles/nasa_topo_bathy",levels:8,size:256});h=new fa(a)}else"ne"==c.base?(a=j(c),p(a,{source:"file",url:oa+"/tiles/NE1_HR_LC_SR_W_DR",levels:6,size:256}),h=new fa(a)):"ne1"==c.base?(a=j(c),p(a,{source:"file",url:oa+"/tiles/NE1_HR_LC",levels:6,size:256}),h=new fa(a)):h=null;h&&h.initialize(d)};r();this.enable_z=function(){b.depthFunc(b.LEQUAL);b.enable(b.DEPTH_TEST)};this.disable_z=
function(){b.disable(b.DEPTH_TEST)};var q=[],n=[null];this.framebuffer=function(){var a=b.createFramebuffer();b.bindFramebuffer(b.FRAMEBUFFER,a);a.width=d.canvas.width();a.height=d.canvas.height();var c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.texImage2D(b.TEXTURE_2D,
0,b.RGBA,a.width,a.height,0,b.RGBA,b.UNSIGNED_BYTE,null);var e=b.createRenderbuffer();b.bindRenderbuffer(b.RENDERBUFFER,e);b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,a.width,a.height);b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,c,0);b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,e);b.bindTexture(b.TEXTURE_2D,null);b.bindRenderbuffer(b.RENDERBUFFER,null);b.bindFramebuffer(b.FRAMEBUFFER,null);var g={framebuffer:a,renderbuffer:e,tex:c,
resize:function(){a.width=d.canvas.width();a.height=d.canvas.height();b.bindTexture(b.TEXTURE_2D,c);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,a.width,a.height,0,b.RGBA,b.UNSIGNED_BYTE,null);b.bindRenderbuffer(b.RENDERBUFFER,e);b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,a.width,a.height);b.bindTexture(b.TEXTURE_2D,null);b.bindRenderbuffer(b.RENDERBUFFER,null)},activate:function(c){c||(c={});f(c,{blend:!0,clear:!0});n.push(a);c.blend||b.disable(b.BLEND);b.bindFramebuffer(b.FRAMEBUFFER,a);b.viewport(0,
0,d.canvas.width(),d.canvas.height());c.clear&&(b.clearColor(0,0,0,0),b.clear(b.COLOR_BUFFER_BIT),b.clearDepth(0))},deactivate:function(){var d=n.pop(),c=n[n.length-1];if(d!=a)throw"Non-nested use of framebuffers";b.bindFramebuffer(b.FRAMEBUFFER,c);b.enable(b.BLEND)}};q.push(g);return g};var Za=this.framebuffer(),t=this.framebuffer();this.draw_blur=function(a){b.useProgram(A);t.activate({blend:!1});A.data("pos",g.get("vert"));A.data("tex_in",g.get("tex"));A.data("sampler",a);A.data("width",d.canvas.width());
A.data("height",d.canvas.height());A.data("hor",!0);b.drawArrays(b.TRIANGLES,0,g.count());t.deactivate();A.data("pos",g.get("vert"));A.data("tex_in",g.get("tex"));A.data("sampler",t.tex);A.data("width",d.canvas.width());A.data("height",d.canvas.height());A.data("hor",!1);b.drawArrays(b.TRIANGLES,0,g.count())};this.dirty=!0;var u=function(){var a=(new Date).getTime(),e=(a-l)/1E3;d.scroller.update(e);60<=k.length&&k.splice(0,1);k.push(e);for(var g=0,r=0;r<k.length;r++)g+=k[r];g/=k.length;$("#fps").text(Math.floor(1/
g));l=a;b.clearColor(c.background.r,c.background.g,c.background.b,c.background.a);b.clear(b.COLOR_BUFFER_BIT);b.clearDepth(0);a=!1;d.shade&&(a=d.shade.ready());a&&Za.activate();h&&h.draw(d,e);for(r=0;r<d.scene.length;r++)d.scene[r].draw(d,e,!1);d.sel.draw(d,e);requestAnimationFrame(u)};this.read_pixel=function(a,c){b.bindFramebuffer(b.FRAMEBUFFER,d.framebuffer);var e=new Uint8Array(4),g=(a-d.canvas.position().left)/d.canvas.width(),h=(d.canvas.position().top+d.canvas.height()-c)/d.canvas.height();
b.readPixels(parseInt(g*d.framebuffer.width),parseInt(h*d.framebuffer.height),1,1,b.RGBA,b.UNSIGNED_BYTE,e);b.bindFramebuffer(b.FRAMEBUFFER,null);return e};$(document).mousemove(function(a){H.x=a.clientX;H.y=a.clientY});this.canvas.click(function(){});this.canvas.dblclick(function(){});var v=!1;this.canvas.mousedown(function(){v=!0});this.canvas.mouseup(function(){v=!1});this.canvas.mousemove(function(){if(!v){var a=new vect(H.x,H.y);$.each(d.scene,function(b,c){c.update_move&&c.update_move(d,a)})}});
this.canvas.mouseout(function(){$.each(d.scene,function(a,b){b.force_out&&b.force_out(d)})});requestAnimationFrame(u)}function cb(a,e){var c=a;f(e,{background:new s(0,0,0,1)});this.canvas=$("<canvas></canvas>").attr("id","viewer");var d=null;c?($(c).append(this.canvas),this.canvas.attr("width",$(c).width()),this.canvas.attr("height",$(c).height())):(c=window,$("body").append(this.canvas),this.canvas.attr("width",$(c).width()),this.canvas.attr("height",$(c).height()),$(window).resize(function(a){return function(){this.resize.call(a)}}(this)));
this.resize=function(){this.canvas.attr("width",$(c).width());this.canvas.attr("height",$(c).height());d.viewport(0,0,this.canvas.width(),this.canvas.height());this.camera.reconfigure();for(var a=0;a<framebuffers.length;a++)framebuffers[a].resize()};this.gl=d=xa(this.canvas,ja);d.viewport(0,0,this.canvas.width(),this.canvas.height());d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA);d.enable(d.BLEND);this.camera=new Ca(this.canvas,e);this.scroller=new Da(this);this.pxW=1/this.canvas.attr("width");this.pxH=
1/this.canvas.attr("height");this.Renderer={"*":ab};this.sel=new Ga(this);var b=(new Date).getTime(),g=[],l,k=this;l=function(){k.draw()};this.shaders={};this.scene=[];this.draw=function(){var a=(new Date).getTime(),c=(a-b)/1E3;this.scroller.update(c);60<=g.length&&g.splice(0,1);g.push(c);for(var k=0,f=0;f<g.length;f++)k+=g[f];k/=g.length;$("#fps").text(Math.floor(1/k));b=a;d.clearColor(e.background.r,e.background.g,e.background.b,e.background.a);d.clear(d.COLOR_BUFFER_BIT);d.clearDepth(0);for(f=
0;f<this.scene.length;f++)this.scene[f].draw(this,c,!1);requestAnimationFrame(l);this.sel.draw(this,c)};$(document).mousemove(function(a){H.x=a.clientX;H.y=a.clientY});requestAnimationFrame(l)}function R(a,e){var c={},d;d=e?e:256;var b=0,g=function(a,b,d,c){a||console.log("ack");d||(d=0);c||(c=b.length);for(var e=0;e<c;e++)a[d+e]=b[e]};this.create=function(b,e){if(!e)throw"Length of buffer must be a positive integer";var g=new Float32Array(d*e),r=ka(a,d,e);c[b]={array:g,buffer:r,len:e,dirty:!1}};
this.alloc=function(e){if(b+e>=d){for(var k=d;k<b+e;)k*=2;d=k;for(name in c){var h=new Float32Array(k*c[name].len),r=c[name].array,f=ka(a,d,c[name].len);g(h,r);c[name].array=h;c[name].buffer=f;c[name].dirty=!0}}k=b;b+=e;return k};this.get=function(a){return c[a].buffer};this.write=function(a,b,d,e){g(c[a].array,b,d*c[a].len,e*c[a].len);c[a].dirty=!0};this.repeat=function(a,b,d,e){for(var f=0;f<e;f++)g(c[a].array,b,(d+f)*c[a].len,c[a].len);c[a].dirty=!0};this.count=function(){return b};this.data=function(a){return c[a].array};
this.update=function(){for(name in c)c[name].dirty&&(c[name].buffer&&c[name].buffer.update(c[name].array,0),c[name].dirty=!1)}}function Ga(a){Y||(Y=C(a.gl,z+"shaders/selbox"));var e=!1,c=!1,d=null,b=null,g=ka(a.gl,6,2),l=G(a.gl,ya(0,0,1,1),2);a.canvas.bind("mousedown",function(h){e&&(show=c=!0,b=d=a.camera.percent(new vect(h.clientX,h.clientY)),g.update(x(d,b),0))});var k=function(){};this.select=function(a){k=a};$(document).bind("mouseup",function(){if(e&&c){var g=a.camera.project(a.camera.pixel(d)),
l=a.camera.project(a.camera.pixel(b));if(g.x>l.x){var f=g.x;g.x=l.x;l.x=f}g.y>l.y&&(f=g.y,g.y=l.y,l.y=f);c=!1;k(new S(g,l))}});$(document).bind("click",function(){e&&(show=!1)});$(document).bind("mousemove",function(h){e&&c&&(b=a.camera.percent(new vect(h.clientX,h.clientY)),g.update(x(d,b),0))});this.enable=function(){e=!0};this.disable=function(){e=!1};this.draw=function(){c&&(gl.useProgram(Y),Y.data("pos",g),Y.data("edge_in",l),gl.drawArrays(gl.TRIANGLES,0,g.numItems))}}function Ha(a,e){for(;a>=
e;)a-=e;for(;0>a;)a+=e;return a}function db(a,e,c,d){this.current=a;this.upper=e;this.lower=c;this.index=d}function Ia(a,e){for(var c=0;c<a.length;c++)if(a[c]==e)return!0;return!1}function ga(a,e,c){if(void 0==e)throw"whoa";return 0==a[e+1].y-a[e].y?Math.min(a[e].x,a[e+1].x):a[e].x+(a[e+1].x-a[e].x)*((c-a[e].y)/(a[e+1].y-a[e].y))}function T(a,e){for(var c=0;c<a.length;c++)if(a[c]==e)return c;return!1}function D(a,e,c){return new vect(ga(e,c,e[a].y),e[a].y)}function J(a,e){if(!e)throw"eek";a.push(e.x);
a.push(e.y)}function U(a,e,c){if(!e||!c||3!=c.length+e.length&&4!=c.length+e.length)throw"ahh";if(3==e.length+c.length){for(var d=0;d<e.length;d++)J(a,e[d]);for(d=0;d<c.length;d++)J(a,c[d])}else e[1].x<e[0].x&&(d=e[0],e[0]=e[1],e[1]=d),c[1].x<c[0].x&&(d=c[0],c[0]=c[1],c[1]=d),J(a,e[0]),J(a,e[1]),J(a,c[1]),J(a,c[0]),J(a,c[1]),J(a,e[0])}function $a(a){for(var e=[],c=0,d=[],b=0;b<a.length;b++){for(var g=0;g<a[b].length-1;g++){var l=Ha(g+1,a[b].length-1),k=Ha(g-1,a[b].length-1);e.push(new db(g+c,l+c,
k+c,b));d.push(a[b][g])}d.push(a[b][0]);c+=a[b].length}e.sort(function(a,b){return d[a.current].y-d[b.current].y});a=[];b=[];new vect(-200,0);new vect(200,0);c=0;c=[];k=[];for(g=0;g<e.length;g++){var h=e[g],l=Ia(a,h.lower),r=Ia(a,h.current),f,n;if(l&&!r)n=f=T(a,h.lower);else if(r&&!l)f=n=T(a,h.current);else if(l&&r)f=T(a,h.lower),n=T(a,h.current);else if(!l&&!r){a:{f=a;n=d;for(var j=d[h.current].x,t=d[h.current].y,u=0;u<f.length;u++){var v=ga(n,f[u],t);if(v>j||0==v-j&&n[f[u]].y>n[index].y){n=u;break a}}n=
f.length}f=n}if(1<Math.abs(f-n)){for(l=0;l<a.length;l++);throw"Bad";}j=vect.left(d[h.lower],d[h.current],d[h.upper]);t=Math.floor(Math.min(f,n)/2);!j&&!l&&!r?(U(k,b[t],[D(h.current,d,a[n-1]),D(h.current,d,a[n])]),b.splice(t,1,[D(h.current,d,a[n-1]),d[h.current]],[d[h.current],D(h.current,d,a[f])])):j&&!l&&!r?b.splice(t,0,[d[h.current]]):l&&!r?(U(k,b[t],[D(h.current,d,a[Math.max(f,n)-1]),d[h.current]]),b[t]=[D(h.current,d,a[Math.min(f,n)-1]),d[h.current]]):!l&&r?(U(k,b[t],[d[h.current],D(h.current,
d,a[Math.min(n,f)+1])]),b[t]=[d[h.current],D(h.current,d,a[Math.max(n,f)+1])]):!j&&l&&r?(U(k,b[t],[D(h.current,d,a[Math.min(f,n)-1]),d[h.current]]),U(k,b[t+1],[D(h.current,d,a[Math.max(f,n)+1]),d[h.current]]),b.splice(t,2,[D(h.current,d,a[Math.min(f,n)-1]),D(h.current,d,a[Math.max(f,n)+1])])):j&&(l&&r)&&(U(k,b[t],[d[h.current]]),b.splice(t,1));l&&!r?a[f]=h.current:r&&!l?a[n]=h.lower:l&&r?(a.splice(T(a,h.lower),1),a.splice(T(a,h.current),1)):!l&&!r&&(j?a.splice(f,0,h.lower,h.current):a.splice(f,0,
h.current,h.lower));for(l=0;l<a.length-1;l++)if(ga(d,a[l],d[h.current].y)>ga(d,a[l+1],d[h.current].y))throw console.log("Misplaced Sweep"),"Misplace!";}if(0<a.length)throw console.log(a),"Bad "+a.length;if(0<c.length)throw console.log(c),"Wrong";return k}function S(a,e){this.min=a.clone();this.max=e.clone();this.contains=function(c){return a.x<=c.x&&e.x>=c.x&&a.y<=c.y&&e.y>=c.y};this.x_in=function(c){return a.x<=c.x&&e.x>=c.x};this.x_left=function(c){return a.x>=c.x};this.x_right=function(a){return e.x<=
a.x};this.y_in=function(c){return a.y<=c.y&&e.y>=c.y};this.y_left=function(c){return a.y>=c.y};this.y_right=function(a){return e.y<=a.y};this.area=function(){return(this.max.x-this.min.x)*(this.max.y-this.min.y)};this.height=function(){return this.max.y-this.min.y};this.width=function(){return this.max.x-this.min.x};this.vertex=function(a){switch(a){case 0:return this.min.clone();case 1:return new vect(this.max.x,this.min.y);case 2:return this.max.clone();case 3:return new vect(this.min.x,this.max.y);
default:throw"Index out of bounds: "+a;}};this.intersects=function(a){for(var d=0;4>d;d++)for(var b=0;4>b;b++)if(vect.intersects(this.vertex(d),this.vertex((d+1)%4),a.vertex(b),a.vertex((b+1)%4)))return!0;return this.contains(a.min)&&this.contains(a.max)&&this.contains(new vect(a.min.x,a.max.y))&&this.contains(new vect(a.max.x,a.min.y))||a.contains(this.min)&&a.contains(this.max)&&a.contains(new vect(this.min.x,this.max.y))&&a.contains(new vect(this.max.x,this.min.y))?!0:!1};this.union=function(a){this.min.x=
Math.min(this.min.x,a.min.x);this.min.y=Math.min(this.min.y,a.min.y);this.max.x=Math.max(this.max.x,a.max.x);this.max.y=Math.max(this.max.y,a.max.y)};this.centroid=function(){return new vect((this.max.x+this.min.x)/2,(this.max.y+this.min.y)/2)};this.clone=function(){return new S(a,e)}}function pa(a,e,c,d){this.data=a[d];this.right=this.left=null;e!=d&&(this.left=new pa(a,e,d-1,parseInt((e+(d-1))/2)));c!=d&&(this.right=new pa(a,d+1,c,parseInt((c+(d+1))/2)));this.subtree=[];for(d=e;d<=c;d++)this.subtree.push(a[d]);
this.subtree.sort(function(a,d){return a.y-d.y});this.yrange=function(a,d,c){return a.y_in(this.subtree[d])&&a.y_in(this.subtree[c])};this.subquery=function(a,d,c,e,h){if(this.yrange(d,c,e))for(d=c;d<=e;d++)a.push(this.subtree[d]);else d.y_in(this.subtree[h])&&a.push(this.subtree[h]),d.y_left(this.subtree[h])?h!=e&&this.subquery(a,d,h+1,e,parseInt((e+(h+1))/2)):(d.x_right(this.subtree[h])||h!=e&&this.subquery(a,d,h+1,e,parseInt((e+(h+1))/2)),h!=c&&this.subquery(a,d,c,h-1,parseInt((c+(h-1))/2)))};
this.search=function(d,g){g.x_in(a[e])&&g.x_in(a[c])?this.subquery(d,g,0,this.subtree.length-1,parseInt((this.subtree.length-1)/2)):(g.contains(this.data)&&d.push(this.data),g.x_left(this.data)?this.right&&this.right.search(d,g):g.x_right(this.data)?this.left&&this.left.search(d,g):(this.left&&this.left.search(d,g),this.right&&this.right.search(d,g)))}}function qa(a){a.sort(function(a,c){return a.x-c.x});0<a.length?this.root=new pa(a,0,a.length-1,parseInt((a.length-1)/2)):null==this.root;this.search=
function(a){if(!this.root)return[];a=a.clone();var c=[];this.root.search(c,a);return c}}function Ja(a){var e={},c={},d=!1,b={},g={},l=!1;if(a.style)for(var k in a.style)b[k]=a.style[k];this.style=function(a,c){if(2>arguments.length)return void 0!==b[a]?b[a]:null;b[a]=c;if(d)for(var g in e)e[g].update(a);return this};this.bounds=null;this.features=function(){var a=[],d;for(d in g)a.push(g[d]);return new w(a)};var h={};this.properties=function(a){var d=[],b;for(b in h)(!a||a&&h[b])&&d.push(b);return d};
this.search=function(a){l&&this.update();var d=new w([]),b;for(b in c)var e=c[b].search(a),d=d.join(e);return d};this.map_contains=function(a,d){l&&this.update();var b=new w([]),e;for(e in c)var g=c[e].map_contains(a,d),b=b.join(g);return b};var f={};this.attr=function(a,b){if(2>arguments.length)return void 0!==f[a]?f[a]:null;f[a]=b;if(d)throw"Not Implemented";};this.append=function(a){var b=new ha[a.type].geometry(a,this);g[b.id]=b;this.bounds?this.bounds.union(b.bounds):this.bounds=b.bounds.clone();
for(var c in a.attr)h[c]=void 0===h[c]?isNaN(a.attr[c])?!1:!0:!isNaN(a.attr[c])&&h[c]?!0:!1;d&&b.initialize(e[b.type]);l=!0};var q=null,n=null;this.mouseover=function(a){q=a};this.mouseout=function(a){n=a};var j={};this.update_move=function(a,d){if(q||n){var b=this.map_contains(a,d),c={};b&&b.each(function(a,d){c[d.id]=d});for(var e in j)!(e in c)&&n&&n(j[e]);for(e in c)!(e in j)&&q&&q(c[e]);j=c}};this.force_out=function(){for(var a in j)n&&n(j[a]);j={}};this.initialize=function(a){for(var b in ha){var c=
a.Renderer[b];c||(c=a.Renderer["*"]);e[b]=new c(a,this)}d=!0;for(var h in g)g[h].initialize(e[g[h].type])};this.update=function(){var a=this.features(),d;for(d in ha)c[d]=new ha[d].collection(a.type(d).items());l=!1};this.draw=function(){l&&this.update();if(!d)throw"Layer has not yet been initialized";for(var a in e)e[a].draw()}}function Ka(a){var e=new vect(Infinity,Infinity),c=new vect(-Infinity,-Infinity);$.each(a,function(a,b){$.each(b,function(a,d){$.each(d,function(a,d){d[0]<e.x&&(e.x=d[0]);
d[0]>c.x&&(c.x=d[0]);d[1]<e.y&&(e.y=d[1]);d[1]>c.y&&(c.y=d[1])})})});return new S(e,c)}function Wa(a,e){for(var c=6*e.length,d=a.alloc(c),b=[new vect(1,1),new vect(1,-1),new vect(-1,-1),new vect(-1,1)],g=0,l=function(){if(e[g]){var a=new vect(e[g][0],e[g][1]);g++;return a}return null},k=l(),h=l(),f=l(),q=function(a,d,b){var c=vect.dir(a,d).rotate(K/2),e=vect.dir(d,b).rotate(K/2);a=vect.add(a,c);c=vect.add(d,c);d=vect.add(d,e);b=vect.add(b,e);return vect.intersect2dpos(a,c,d,b)},j=vect.dir(k,h).rotate(-K/
2),p=vect.dir(k,h).rotate(K/2),t,u,m=function(a,d,b,c,e){a.push(d.x);a.push(d.y);a.push(b.x);a.push(b.y);a.push(c.x);a.push(c.y);a.push(d.x);a.push(d.y);a.push(c.x);a.push(c.y);a.push(e.x);a.push(e.y)},I=[],M=[],N=[];h;)f?(t=vect.sub(q(k,h,f),h),u=vect.sub(q(f,h,k),h)):(t=vect.dir(k,h).rotate(K/2),u=vect.dir(k,h).rotate(-K/2)),m(I,k,k,h,h),m(M,j,p,t,u),m(N,b[0],b[1],b[2],b[3]),j=u,p=t,k=h,h=f,f=l();a.write("vert",I,d,c);a.write("norm",M,d,c);a.write("unit",N,d,c);return d}function Va(a,e){var c=a.alloc(6*
e.length),d=0,b=function(){if(e[d]){var a=new vect(e[d][0],e[d][1]);d++;return a}return null};new vect(1,1);new vect(1,-1);new vect(-1,-1);new vect(-1,1);for(var g=[],l=[],k=[],k=[-1,1,-1,-1,1,-1,-1,1,1,-1,1,1],h=function(a,d,b,c){c?(a[b]=-d.x,a[b+1]=-d.y):(a[b]=d.x,a[b+1]=d.y)},f=function(a,d,b,c){h(a,d,0,!1);h(a,b,2,!1);h(a,d,4,c);h(a,b,6,c);h(a,d,8,!1);h(a,b,10,!1)},q=b(),j=b(),p=b(),t=vect.dir(q,j).rotate(K/2),m,v=c;j;){if(p){m=vect.dir(p,j);var I=vect.dir(j,q);m=vect.sub(m,I).scale(0.5).normalize()}else m=
vect.dir(q,j).rotate(K/2);f(g,q,j,!1);f(l,t,m,!0);a.write("vert",g,v,6);a.write("norm",l,v,6);a.write("unit",k,v,6);v+=6;q=j;j=p;p=b();t=m}return c}function ra(a){E||(E=C(engine.gl,z+"shaders/grid"));a||(a={});a.style||(a.style={});var e=a.lower,c=a.upper,d=a.rows,b=a.cols,g=(c.x-e.x)/b,l=(c.y-e.y)/d,k=new Float32Array(d*b),h=new Uint8Array(4*b*d),f=!1,j=new R(engine.gl,6);j.create("vert",2);j.create("screen",2);j.create("tex",2);var n=new vect(e.x,e.y),m=new vect(c.x,c.y),p=new vect(0,0),u=new vect(1,
1),v=j.alloc(6);j.write("vert",x(n,m),v,6);j.write("screen",x(new vect(-1,-1),new vect(1,1)),v,6);j.write("tex",x(p,u),v,6);var I=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,I);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);this.lower=function(){return e.clone()};
this.upper=function(){return c.clone()};this.rows=function(){return d};this.cols=function(){return b};this.centroid=function(a,d){return new vect(e.x+g*d+g/2,e.y+l*a+l/2)};this.get=function(a,d){return k[b*a+d]};var M=-Infinity,N=Infinity;this.qunatiles=function(a,d){d||(d=function(a,d){return a-d});for(var b=[],c=0;c<k.length;c++)b.push(k[c]);b.sort(d);for(var e=[-Infinity],c=1;c<a;c++){var g=parseInt(inc*c);e.push(b[g])}e.push(Infinity);return e};this.set=function(a,c,e){if(a>=d||c>=b)throw"Index Out of Bounds";
k[b*a+c]=e;f=!0};this.raw_set=function(a,c){if(a>=d*b)throw"Index Out of Bounds: "+a;k[a]=c;f=!0};this.clear=function(a){for(var c=0;c<d*b;c++)k[c]=a};this.initialize=function(){};var X=null;this.draw=function(c){X||(X=c.framebuffer());j.update();if(f){M=-Infinity;N=Infinity;for(var e=0;e<d*b;e++){var g=k[e];g>M&&(M=g);g<N&&(N=g)}for(e=0;e<d*b;e++){var g=e,l=a.map(N,M,k[e]);h[4*g]=parseInt(255*l.r);h[4*g+1]=parseInt(255*l.g);h[4*g+2]=parseInt(255*l.b);h[4*g+3]=parseInt(255*l.a)}gl.bindTexture(gl.TEXTURE_2D,
I);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,b,d,0,gl.RGBA,gl.UNSIGNED_BYTE,h);gl.bindTexture(gl.TEXTURE_2D,null);f=!1}a.style.antialias&&X.activate({blend:!1});gl.useProgram(E);E.data("screen",c.camera.mat3);E.data("pos",j.get("vert"));E.data("tex_in",j.get("tex"));E.data("sampler",I);e=vect.sub(c.camera.screen(m),c.camera.screen(n));E.data("width",e.x);E.data("height",-e.y);E.data("rows",d);E.data("cols",b);E.data("blur",a.blur);gl.drawArrays(gl.TRIANGLES,0,j.count());a.style.antialias&&(X.deactivate(),
c.draw_blur(X.tex))}}function eb(a,e,c){O||(O=C(z+"shaders/raster"));this.image=da(a);var d=G(x(new vect(0,1),new vect(1,0)),2),b=G(x(e,c),2);this.draw=function(a,c,e){e||(gl.useProgram(O),O.data("screen",a.camera.mat3),O.data("pos",b),O.data("tex_in",d),O.data("sampler",this.image),gl.drawArrays(gl.TRIANGLES,0,b.numItems))}}function sa(a){y||(y=C(z+"shaders/hillshade"));var e=$(a).find("LatLonBox"),c=new vect(parseFloat(e.find("west").text()),parseFloat(e.find("south").text())),d=new vect(parseFloat(e.find("east").text()),
parseFloat(e.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var b=!1,g=da(a,function(){b=!0});this.ready=function(){return b};var l=G(x(new vect(0,1),new vect(1,0)),2),k=G(x(c,d),2),h=315;this.draw=function(a){if(b){for(gl.useProgram(altitude_shader);1<=h;)h-=1;altitude_shader.data("azimuth",h);altitude_shader.data("altitude",Math.PI/4/(2*Math.PI));altitude_shader.data("screen",a.camera.mat3);altitude_shader.data("pos",k);altitude_shader.data("tex_in",l);altitude_shader.data("elevation",
g);a=vect.sub(a.camera.screen(d),a.camera.screen(c));altitude_shader.data("pix_w",1/a.x);altitude_shader.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,k.numItems);return h}}}function sa(a){y||(y=C(engine.gl,z+"shaders/hillshade"));var e=$(a).find("LatLonBox"),c=new vect(parseFloat(e.find("west").text()),parseFloat(e.find("south").text())),d=new vect(parseFloat(e.find("east").text()),parseFloat(e.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();var b=!1,g=da(engine.gl,a,function(){b=
!0});this.ready=function(){return b};var l=G(engine.gl,x(new vect(0,1),new vect(1,0)),2),k=G(engine.gl,x(c,d),2),h=315;this.initialize=function(){};this.draw=function(a){if(b){for(gl.useProgram(y);1<=h;)h-=1;y.data("azimuth",h);y.data("altitude",Math.PI/4/(2*Math.PI));y.data("screen",a.camera.mat3);y.data("pos",k);y.data("tex_in",l);y.data("elevation",g);a=vect.sub(a.camera.screen(d),a.camera.screen(c));y.data("pix_w",1/a.x);y.data("pix_h",1/a.y);gl.drawArrays(gl.TRIANGLES,0,k.numItems);return h}}}
function fa(a){for(var e=[],c=[],d=0;d<a.levels;d++){var b=j(a);"file"==b.source&&(b.url+="/"+a.size*Math.pow(2,d+1));b.min=new vect(-180,-90);b.rows=Math.pow(2,d);b.cols=2*b.rows;b.cellsize=180/b.rows;b.z_index=1-ta-d/1E3;b.available=c;b=new fb(b);e.push(b)}ta+=(a.levels+2)/1E3;var g=null;this.initialize=function(a){B||(B=C(a.gl,z+"shaders/tile"));g=new R(a.gl,6*Z);g.create("vert",3);g.create("tex",2);g.create("lookup",1);g.alloc(6*Z);for(var d=0;25>d;d++)c.push(new la(a.gl));for(d=0;d<e.length;d++)e[d].initialize(a);
e[0].fetch_all();e[0].noexpire(!0)};this.draw=function(d,b){gl.useProgram(B);B.data("screen",d.camera.mat3);La=Ma=0;for(var c=Infinity,f=e[0],j,n=0;n<e.length;n++){var m=a.size*e[n].cols/e[n].size(d).x;1>m&&(m=1/m);m<c&&(c=m,f=e[n],j=n)}for(n=j;0<=n;n--)e[n].fetch();if(f.ready())f.draw(d,b,g,0,!0);else{d.enable_z();c=0;for(n=j;0<=n;n--)c=e[n].draw(d,b,g,c,0==n);d.disable_z()}$.each(e,function(a,d){d.cull()})}}function fb(a){a||(a={});a.desaturate||(a.desaturate=0);a.darken||(a.darken=0);a.hue||(a.hue=
0);a.hue_color||(a.hue_color=wa(0,0,0,1));if(!a.available){a.available=[];for(var e=0;8>e;e++)a.available.push(new la(c))}var c=null,d=a.url,b=a.min,g=a.rows,l=a.cols,k=a.cellsize;this.rows=g;this.cols=l;for(var h={},f={},j=function(d,c){var e=new vect(b.x+d*k,b.y+c*k),g=new vect(b.x+(d+1)*k,b.y+(c+1)*k),e={vert:x(e,g,a.z_index),tex:null,i:d,j:c,id:d+l*c,ready:!1,min:e,max:g};f[d][c]=e;h[e.id]=e},e=0;e<l;e++)f[e]={};this.size=function(a){var d=a.camera.screen(b);a=a.camera.screen(vect.add(b,new vect(k*
l,k*g)));d=vect.sub(a,d);d.y=Math.abs(d.y);return d};var n=!1;this.noexpire=function(a){n=a};this.cull=function(){if(!n){var d=(new Date).getTime(),b;for(b in p)if(d-p[b]>gb){var c=h[b];delete h[b];delete f[c.i][c.j];a.available.push(c.tex);c.tex=null;c.ready=!1;delete p[b]}}};var m=function(){var a=engine.camera.project(new vect(engine.canvas.offset().left,engine.canvas.offset().top+engine.canvas.height())),d=engine.camera.project(new vect(engine.canvas.offset().left+engine.canvas.width(),engine.canvas.offset().top)),
c=Math.floor((a.x-b.x)/k),e=Math.ceil((d.x-b.x)/k),a=Math.floor((a.y-b.y)/k),d=Math.ceil((d.y-b.y)/k);return{min_col:c,max_col:e,min_row:a,max_row:d}},p={};this.ready=function(){for(var a=m(),d=Math.max(0,a.min_col);d<Math.min(l,a.max_col);d++)for(var b=Math.max(0,a.min_row);b<Math.min(g,a.max_row);b++)if(!f[d][b]||!f[d][b].ready)return!1;return!0};var u=function(b,e){if(!f[b][e].tex){var g;if("file"==a.source)g=d+"/"+f[b][e].id+".png";else if("wms"==a.source){g={service:"wms",version:"1.1.0",request:"GetMap",
layers:a.layer,bbox:[f[b][e].min.x,f[b][e].min.y,f[b][e].max.x,f[b][e].max.y].join(),width:a.size,height:a.size,srs:"EPSG:4326",format:"image/png",transparent:"true"};var h=[],l;for(l in g)h.push(l+"="+g[l]);g=d+"?"+h.join("&")}f[b][e].tex=a.available.pop();f[b][e].tex||(f[b][e].tex=new la(c));l=g;var k=f[b][e],j=new Image;j.crossOrigin="";j.onload=function(){k.tex&&(k.tex.image(j),k.ready=!0)};j.src=l}};this.fetch_all=function(){for(var a=(new Date).getTime(),d=0;d<l;d++)for(var b=0;b<g;b++)f[d][b]||
j(d,b),f[d][b].tex||u(d,b),p[f[d][b].id]=a};this.fetch=function(){for(var a=m(),d=(new Date).getTime(),b=Math.max(0,a.min_col-1);b<Math.min(l,a.max_col+1);b++)for(var c=Math.max(0,a.min_row-1);c<Math.min(g,a.max_row+1);c++)f[b][c]||j(b,c),f[b][c].tex||u(b,c),p[f[b][c].id]=d};var v=!1;this.initialize=function(a){if(v)throw"Not Implemented: Migrating Tile Layers to New Map";B||(B=C(a.gl,z+"shaders/tile"));c=a.gl;v=!0};this.draw=function(d,b,e,h,k){v||this.initialize(d);d=function(){La++;e.update();
B.data("pos",e.get("vert"));B.data("tex_in",e.get("tex"));B.data("lookup_in",e.get("lookup"));B.data("desaturate",a.desaturate);B.data("darken",a.darken);B.data("hue",a.hue);B.data("hue_color",a.hue_color.array);c.drawArrays(c.TRIANGLES,0,6*h)};b=m();for(var j=(new Date).getTime(),n=Math.max(0,b.min_col);n<Math.min(l,b.max_col);n++)for(var q=Math.max(0,b.min_row);q<Math.min(g,b.max_row);q++)if(f[n][q]&&f[n][q].ready&&f[n][q].tex){e.write("vert",f[n][q].vert,6*h,6);e.write("tex",x(new vect(0,0),new vect(1,
1)),6*h,6);e.repeat("lookup",[h/Z+1/(2*Z)],6*h,6);p[f[n][q].id]=j;B.data("sampler"+h,f[n][q].tex);if(null==f[n][q].tex)throw"badness";h++;Ma++;h>=Z&&(d(),h=0)}k&&d();return h}}var z="",V=jQuery,hb=function(a){if("string"===typeof a.data){var e=a.handler,c=a.data.toLowerCase().split(" ");a.handler=function(a){if(!(this!==a.target&&(/textarea|select/i.test(a.target.nodeName)||"text"===a.target.type))){var b="keypress"!==a.type&&V.hotkeys.specialKeys[a.which],g=String.fromCharCode(a.which).toLowerCase(),
f="",k={};a.altKey&&"alt"!==b&&(f+="alt+");a.ctrlKey&&"ctrl"!==b&&(f+="ctrl+");a.metaKey&&(!a.ctrlKey&&"meta"!==b)&&(f+="meta+");a.shiftKey&&"shift"!==b&&(f+="shift+");b?k[f+b]=!0:(k[f+g]=!0,k[f+V.hotkeys.shiftNums[g]]=!0,"shift+"===f&&(k[V.hotkeys.shiftNums[g]]=!0));b=0;for(g=c.length;b<g;b++)if(k[c[b]])return e.apply(this,arguments)}}}};V.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",
35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"=",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",
"0":")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"}};V.each(["keydown","keyup","keypress"],function(){V.event.special[this]={add:hb}});var L=jQuery,ua=function(a){var e=a||window.event,c=[].slice.call(arguments,1),d=0,b=0,g=0;a=L.event.fix(e);a.type="mousewheel";e.wheelDelta&&(d=e.wheelDelta/120);e.detail&&(d=-e.detail/3);g=d;void 0!==e.axis&&e.axis===e.HORIZONTAL_AXIS&&(g=0,b=-1*d);void 0!==e.wheelDeltaY&&(g=e.wheelDeltaY/120);void 0!==e.wheelDeltaX&&(b=-1*e.wheelDeltaX/
120);c.unshift(a,d,b,g);return(L.event.dispatch||L.event.handle).apply(this,c)},W=["DOMMouseScroll","mousewheel"];if(L.event.fixHooks)for(var P=W.length;P;)L.event.fixHooks[W[--P]]=L.event.mouseHooks;L.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=W.length;a;)this.addEventListener(W[--a],ua,!1);else this.onmousewheel=ua},teardown:function(){if(this.removeEventListener)for(var a=W.length;a;)this.removeEventListener(W[--a],ua,!1);else this.onmousewheel=null}};L.fn.extend({mousewheel:function(a){return a?
this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}});for(var Na=0,P=["ms","moz","webkit","o"],aa=0;aa<P.length&&!window.requestAnimationFrame;++aa)window.requestAnimationFrame=window[P[aa]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[P[aa]+"CancelAnimationFrame"]||window[P[aa]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var e=(new Date).getTime(),c=Math.max(0,16-
(e-Na)),d=window.setTimeout(function(){a(e+c)},c);Na=e+c;return d});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)});var K=3.14159265,ja=!1,Aa=0,Ra={Point:{fill:new s(0.02,0.44,0.69,1),opacity:1,radius:5,stroke:"none","stroke-width":2},Polygon:{fill:new s(0.02,0.44,0.69,1),"fill-opacity":0.5,stroke:new s(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":1},Line:{stroke:new s(0.02,0.44,0.69,1),"stroke-opacity":1,"stroke-width":2}},Ta=1024,Ua=ya(0,0,1,1),Ya=
1024,oa="http://eland.ecohealthalliance.org/wigglemaps",H={x:0,y:0},A=null,Fa=null,Y=null,ha={Point:{geometry:function(a,e){va.call(this,a,e);this.bounds=null;for(var c=0;c<this.geom.length;c++){var d=new vect(this.geom[c][0],this.geom[c][1]),d=new S(d.clone(),d.clone());this.bounds?this.bounds.union(d):this.bounds=d}this.map_contains=function(a,d){for(var c=this.compute("radius"),e=0;e<this.geom.length;e++){var f=a.camera.screen(new vect(this.geom[e][0],this.geom[e][1]));if(vect.dist(f,d)<c)return!0}return!1}},
collection:function(a){var e=[],c=0;$.each(a,function(a,d){var f=d.compute("radius");f>c&&(c=f);$.each(d.geom,function(a,b){e.push({x:b[0],y:b[1],ref:d})})});var d=new qa(e);this.search=function(a){a=d.search(a);var c=[];$.each(a,function(a,d){c.push(d.ref)});return new w(c)};this.map_contains=function(a,e){for(var f=vect.add(e,new vect(-c,c)),k=vect.add(e,new vect(c,-c)),f=new S(a.camera.project(f),a.camera.project(k)),f=d.search(f),k=0;k<f.length;k++){var h=f[k];if(h.ref.map_contains(a,e))return new w([h.ref])}return new w([])}}},
Polygon:{geometry:function(a,e){va.call(this,a,e);this.bounds=Ka(this.geom);this.map_contains=function(a,d){return this.contains(a.camera.project(d))};this.contains=function(a){var d=0;if(this.bounds.contains(a)){d++;for(d=0;d<this.geom.length;d++){var b=0;$.each(this.geom[d],function(d,e){for(var f=0;f<e.length;f++){var h=(f+1)%e.length;if(0>(a.y-e[f][1])/(a.y-e[h][1])){var j=new vect(720,a.y),q=new vect(e[f][0],e[f][1]),h=new vect(e[h][0],e[h][1]);vect.intersects(a,j,q,h)&&b++}}});if(1==b%2)return!0}}return!1}},
collection:function(a){for(var e=[],c=0;c<a.length;c++)$.each(a[c].geom,function(d,b){$.each(b,function(d,b){$.each(b,function(d,b){e.push({ref:a[c],x:b[0],y:b[1]})})})});tree=new qa(e);this.search=function(d){var b=tree.search(d),c={};$.each(b,function(a,d){c[d.ref.id]=d.ref});for(b=0;b<a.length;b++)for(var e=0;4>e;e++)a[b].contains(d.vertex(e))&&(c[a[b].id]=a[b]);d=[];for(var f in c)d.push(c[f]);return new w(d)};this.map_contains=function(a,b){return this.contains(a.camera.project(b))};this.contains=
function(d){for(var b=[],c=0;c<a.length;c++)a[c].contains(d)&&b.push(a[c]);return new w(b)}}},Line:{geometry:function(a,e){va.call(this,a,e);this.bounds=Ka(this.geom);this.map_contains=function(){return!1}},collection:function(){this.search=function(){return new w([])};this.map_contains=function(){return new w([])};this.contains=function(){return new w([])}}}},va=function(a,e){var c={},d=null;this.id=Oa();this.type=a.type;var b=a.attr;this.attr=function(a,d){if(2>arguments.length)return b[a]};this.geom=
a.geom;this.geometry=function(){};this.initialize=function(a){d=a.create(this);d.update_all()};this.compute=function(a){return Ba(this,e,a)};this.style=function(a,b,e){if(2>arguments.length)return void 0!==c[a]?c[a]:null;c[a]=b;d&&d.update(a)}},Oa,Pa=1;Oa=function(){var a=Pa;Pa++;return a};var Ea;Ea=function(a,e){return new vect(a+1E-6*Math.random()-5E-7,e+1E-6*Math.random()-5E-7)};var E=null,w=function(a){var e=null;this.length=a.length;this.count=function(){return a.length};this.items=function(){return a};
this.type=function(d){for(var b=[],c=0;c<a.length;c++)a[c].type==d&&b.push(a[c]);return new w(b)};this.join=function(d){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);for(c=0;c<d.count();c++){var e=d.get(c);this.id(e.id)||b.push(e)}return new w(b)};this.attr=function(){throw"Not Implemented";};this.get=function(d){return a[d]};this.subset=function(d){for(var b=[],c=0;c<d.length;c++)b.push(a[d[c]]);return new w(b)};this.id=function(d){if(!e){e={};for(var b=0;b<a.length;b++)e[a[b].id]=a[b]}return d in
e?e[d]:null};this.each=function(d){for(var b=0;b<a.length;b++)d(b,a[b]);return this};var c={">":function(a,b){return a>b},"<":function(a,b){return a<b},"==":function(a,b){return a==b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b}};this.select=function(d){if(d.match(/^\s*\*\s*$/))return new w(a);var b=d.match(/^\s*([^\s]+)\s*([=<>]+)\s*(([^\s])+)\s*$/);if(!b)throw"Bad Selector";d=b[1];var e=b[2],f=null,k=null;isNaN(b[3])?k=b[3]:f=parseFloat(b[3]);new_elem=[];if(k)for(b=0;b<a.length;b++)c[e](a[b].attr(d),
a[b].attr(k))&&new_elem.push(a[b]);else for(b=0;b<a.length;b++)c[e](a[b].attr(d),f)&&new_elem.push(a[b]);return new w(new_elem)};this.filter=function(d){for(var b=[],c=0;c<a.length;c++)d(a[c])&&b.push(a[c]);return new w(b)};this.quantile=function(d,b,c){a.sort(function(a,b){return a.attr(d)-b.attr(d)});var e=Math.round(b*this.length/c);b=Math.round((b-1)*this.length/c);return new w(a.slice(b,e))};this.range=function(d){for(var b=Infinity,c=-Infinity,e=!1,f=0;f<a.length;f++){var h=a[f].attr(d);isNaN(h)||
(e=!0,b>h&&(b=h),c<h&&(c=h))}return!e?null:{min:b,max:c}};this.style=function(d,b){if(1==arguments.length){var c=[];$.each(a,function(a,b){c.push(b.style(d))});return c}if("function"==typeof b)$.each(a,function(a,c){c.style(d,b(c))});else{var e;a:if(null==b||void 0==b.length)e=!1;else{for(e=0;e<b.length;e++)if(!(e in b)){e=!1;break a}e=!0}e?$.each(a,function(a,c){c.style(d,b[a])}):$.each(a,function(a,c){c.style(d,b)})}return this}},O=null,y=null,Q=null,y=null,gb=1E3,ta=0,Z=8,Ma=0,La=0,B=null,Qa=[];
window.wiggle={Map:function(a,e){this.center=function(a,b){engine.camera.position(new vect(a,b))};this.vcenter=function(a){this.center(a.x,a.y)};this.extents=function(a){engine.camera.extents(a)};this.append=function(a){a.initialize(engine);engine.scene.push(a)};this.remove=function(a){for(var b=0;b<engine.scene.length;b++)if(engine.scene[b]==a)return engine.scene.splice(b,1),!0;return!1};this.shade=function(a){a=new sa(a);engine.shade=a};this.select=function(a){a?(engine.sel.select(a),engine.select(!0)):
engine.select(!1)};this.resize=function(){engine.resize()};this.attr=function(a,b){engine.attr(a,b)};this.png=function(){var a=engine.canvas.get(0).toDataURL();$.ajax({url:"../server/export.png",type:"POST",data:a})};this.width=function(){return engine.canvas.innerWidth()};this.height=function(){return engine.canvas.innerHeight()};var c=null;this.click=function(a){c=a};engine=new bb(a,this,e);engine.canvas.click(function(a){c&&(a=new vect(a.pageX,a.pageY),a=engine.camera.project(a),c(a))})},TimeSeries:function(a,
e){e||(e={});var c=new cb(a,e);this.append=function(a){a.initialize(c);c.scene.push(a)};this.extents=function(a,b){c.camera.extents(a,b)};this.center=function(a,b){c.camera.position(new vect(a,b))};this.vcenter=function(a){this.center(a.x,a.y)}},layer:{Layer:Ja,Grid:ra,Hillshade:sa,Elevation:function(a){Q||(Q=C(z+"shaders/elevation"));var e=$(a).find("LatLonBox"),c=new vect(parseFloat(e.find("west").text()),parseFloat(e.find("south").text())),d=new vect(parseFloat(e.find("east").text()),parseFloat(e.find("north").text()));
a=$(a).find("GroundOverlay Icon href").text();var b=da(a),f=G(x(new vect(0,1),new vect(1,0)),2),l=G(x(c,d),2);this.draw=function(a,e,j){j||(gl.useProgram(Q),Q.data("screen",a.camera.mat3),Q.data("pos",l),Q.data("tex_in",f),Q.data("elevation",b),vect.sub(a.camera.screen(d),a.camera.screen(c)),gl.drawArrays(gl.TRIANGLES,0,l.numItems))}}},io:{Shapefile:function(a){var e=a.path;$.ajax({url:e+".shx",mimeType:"text/plain; charset=x-user-defined",success:function(c){for(var d=[],b=100;b<c.length;)d.push(2*
ia(c,b)),b+=8;$.ajax({url:e+".shp",mimeType:"text/plain; charset=x-user-defined",success:function(b){for(var c=[],e=[],f=0;f<d.length;f++){var j=d[f];ia(b,j);ia(b,j+4);var q=j+8,n=F(b,q);if(0==n)console.log("NULL Shape");else if(1==n)n=ba(b,q+4),q=ba(b,q+12),c.push({attr:{},geom:[[n,q]]});else if(5==n){for(var n=F(b,q+36),q=F(b,q+40),m=j+52,j=j+52+4*n,p=[],u=0;u<n;u++){var v=F(b,m+4*u),s;s=u+1<n?F(b,m+4*(u+1)):q;var w=j,x=[];for(s-=1;s>=v;s--){var z=ba(b,w+16*s),A=ba(b,w+16*s+8);x.push([z,A])}p.push(x)}e.push({attr:{},
geom:[p]})}else throw"Not Implemented: "+n;}if(0<c.length){var y=new PointLayer(c.length);$.each(c,function(a,b){y.append(b)});b=y}else 0<e.length?(y=new PolygonLayer(a),$.each(e,function(a,b){for(var c=0;100>c;)try{y.append(b),c=101}catch(d){c++}100==c&&console.log("rendering polygon failed")}),b=y):b=void 0;a.success(b)}})}})},GeoJSON:function(a,e){void 0===e&&(e={});for(var c=new Ja(e),d=0;d<a.features.length;d++){var b=a.features[d];if("Feature"==b.type){"Point"==b.geometry.type&&c.append({type:"Point",
geom:[b.geometry.coordinates],attr:b.properties});"MultiPoint"==b.geometry.type&&c.append({type:"Point",geom:b.geometry.coordinates,attr:b.properties});if("Polygon"==b.geometry.type){for(var f=b.geometry.coordinates,j=[],k=0;k<=f.length-1;k++){for(var h=[],m=f[k].length-1;0<=m;m--)h.push(f[k][m]);j.push(h)}c.append({type:"Polygon",geom:[j],attr:b.properties})}if("MultiPolygon"==b.geometry.type){var q=[];$.each(b.geometry.coordinates,function(a,b){for(var c=[],d=0;d<=b.length-1;d++){for(var e=[],f=
b[d].length-1;0<=f;f--)e.push(b[d][f]);c.push(e)}q.push(c)});c.append({type:"Polygon",geom:q,attr:b.properties})}"MultiLineString"==b.geometry.type&&$.each(b.geometry.coordinates,function(a,d){c.append({type:"Line",geom:[[d]],attr:b.properties})})}}return c},KML:function(a){var e=$(a).find("LatLonBox"),c=new vect(parseFloat(e.find("west").text()),parseFloat(e.find("south").text())),e=new vect(parseFloat(e.find("east").text()),parseFloat(e.find("north").text()));a=$(a).find("GroundOverlay Icon href").text();
return new eb(z+a,c,e)},SparseGrid:function(a,e){var c=ca(a,0),d=ca(a,4),b=F(a,8),f=F(a,12),j=ca(a,16),k={};for(key in e)k[key]=e[key];k.lower=new vect(c,d);k.upper=new vect(c+j*b,d+j*f);k.rows=f;k.cols=b;c=new ra(k);for(d=20;d<a.length;){for(var j=F(a,d),b=F(a,d+4),f=d+4,k=b,h=0;h<k;h++){var m=ca(a,f+4*h);c.raw_set(j+h,m)}d+=8+4*b}return c},AsciiGrid:function(a,e){var c=a.split("\n"),d=c.splice(0,6),b=parseInt(d[0].slice(14)),f=parseInt(d[1].slice(14)),j=parseFloat(d[2].slice(14)),k=parseFloat(d[3].slice(14)),
h=parseFloat(d[4].slice(14)),d=d[5].slice(14),m={};for(key in e)m[key]=e[key];m.lower=new vect(j,k);m.upper=new vect(j+h*b,k+h*f);m.rows=f;m.cols=b;j=new ra(m);for(k=0;k<f;k++){h=c[k].split(" ");for(m=0;m<b;m++)h[m]==d?j.set(f-1-k,m,NaN):j.set(f-1-k,m,parseFloat(h[m]))}return j},WMS:function(a){a=j(a);for(var e=["url","layer"],c=0;c<e.length;c++){var d=e[c];if(!(d in a))throw"Key "+d+" not found";}f(a,{levels:16,size:256});var e={source:"wms"},b;for(b in e)a[b]=e[b];return new fa(a)}},util:{fcolor:wa,
icolor:function(a,e,c,d){return new s(m(a/255,0,1),m(e/255,0,1),m(c/255,0,1),m(d/255,0,1))},Box:S,RangeTree:qa},widget:{Slider:function(a,e,c){var d=function(a){if(a>=c)throw"Slider index out of bounds";return e.x/(c-1)*a},b=function(b){return b<=a.x?0:b>=a.x+e.x?c-1:Math.round((b-a.x)/e.x*(c-1))};this.dom=$("<div></div>").addClass("slider-container").css("position","relative").css("left",a.x).css("top",a.y).css("width",e.x).css("height",e.y);var f=!1,j=0,k=$("<div></div>").addClass("slider-box").css("position",
"relative").css("left",-10).css("height",e.y).css("width",20).mousedown(function(){f=!0});this.tick=function(){return j};this.count=function(){return c};var h=function(){};this.change=function(a){h=a};var m=function(){};this.release=function(a){m=a};this.dragging=function(){return f};this.dom.append(k);this.set=function(a){a!=j&&h(a);j=a;var b=d(a);k.css("left",b-10);m(a)};$(document).bind("mouseup",function(){if(f){f=!1;var a=b(event.clientX);m(a)}});$(document).bind("mousemove",function(a){f&&(a=
b(a.clientX),a!=j&&h(a),j=a,a=d(a),k.css("left",a-10))})}},ready:function(a){Qa.push(a)}};$(document).ready(function(){$('script[src*="wigglemaps"]').each(function(a,e){var c=/wigglemaps(\.min)?\.js/;$(e).attr("src").match(c)&&(z=$(e).attr("src").replace(c,""))});$.each(Qa,function(a,e){e()})})})();
