<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Map</title>
    <script type="text/javascript" src="../js/jquery-1.7.min.js"></script>
    <script type="text/javascript" src="../js/jquery.hotkeys.js"></script>
    <script type="text/javascript" src="../js/jquery.mousewheel.js"></script>

    <script type="text/javascript" src="../webgl_maps.js"></script>
    <script type="text/javascript" src="../js/geojson.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/screen.css" />
    <style>
    .legend {
	position: absolute;
	z-index: 2;
	bottom: 0px;
	right: 0px;
	text-align: center;
	padding: 20px;
	-moz-user-select: none;
	-webkit-user-select: none;
	cursor: default;
    }
    .legend * {
	margin: 0px;
	padding: 0px;
    }
    .legend h2 {
	text-align: center;	
	margin-bottom: 20px;
	font-size: 14px;
    }
    .range * {
	text-align: left;
	font-size: 12px;
	white-space: nowrap;
    }
    .range .box {
	float: left;
	margin-left: 20px;
	background-color: red;
    }
    </style>
    <script type="text/javascript">
    $ (document).ready (function () {
        map = new Map (null, {
	    base: 'default',
	    center: new vect (0, 0),
	    extents: 360,
	    //background: new Color (150, 150, 150, 255)
	    //background: new Color (10, 10, 51, 255)
	});
       //map.center (-55, -10);

	var red_blue = [
	    new Color (33, 102, 172, 255),
	    new Color (103, 169, 207, 255),
	    new Color (209, 169, 207, 255),
	    new Color (253, 219, 199, 255),
	    new Color (239, 138, 98, 255),
	    new Color (178, 24, 43, 255),
	];

	var cell_height = 25;

	leg = $ ('<div></div>').addClass ('legend');
	leg.append ('<h2>Threats to Water Security</h2>');
	range = $ ('<div></div>').addClass ('range');
	leg.append (range);
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Sixth Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Fifth Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Fourth Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Third Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Second Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">First Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">No Data</div>');
	
	$ ('body').append (leg);
    
	range.children ().filter ('.box').css ('height', cell_height);
	range.children ().filter ('.box').css ('width', cell_height);

	var text_height = range.children ().filter ('.label').first ().height ();
	var top_pad = Math.round ((cell_height - text_height) / 2);
	range.children ().filter ('.label').css ('padding-top', top_pad);
	range.children ().filter ('.label').css ('padding-bottom', cell_height - text_height -top_pad);
	range.children ().filter ('.label').css ('padding-left', cell_height + 40);

	range.children ().filter ('.box').each (function (i) {
	    if (i >= red_blue.length) {
		$ (this).css ('background-color', '#333');
	    }
	    else {
		var c = red_blue[red_blue.length - 1 - i];
		$ (this).css ('background-color', 'rgb(' + parseInt (c.r * 255) + ',' + parseInt (c.g * 255) + ',' + parseInt (c.b * 255) + ')');
	    }
	});

	var scrim = $ ('<div></div>');
	scrim.css ({
	    'background-color': 'white',
	    opacity: .6,
	    padding: 0,
	    margin: 0,
	    width: leg.innerWidth (),
	    height: leg.innerHeight (),
	    position: 'absolute',
	    'z-index': 1,
	    bottom: 0,
	    right: 0
	});

	$ ('body').append (scrim);


	$.ajax ({
	    url: 'data/countries.json',
	    dataType: 'json',
     	    //async: false,			
	    success: function (data) {
		br_pop = GeoJSON (data);

		$.ajax ({
		    url: 'data/bio_threat.csv',
		    //url: 'data/invest_benefits.csv',
                    //url: 'data//a_hws_threat.csv',
		    dataType: 'text',
		    success: function (data) {
			var rows = data.split ('\n');
			var lookup = {};
			for (var i = 1; i < rows.length - 1; i ++) {
			    var vals = rows[i].split (',');
			    var val = vals[1].slice (1, vals[1].length - 1);
			    lookup[val] = parseFloat (vals[2]);
			}
			br_pop.features ().each (function (i, f) {
			    f.attr['range'] = lookup[f.attr['SOVEREIGNT']];
			});
			for (var i = 1; i <= 6; i ++) {
			    var sel = br_pop.features ().quantile ('range', i, 6);
			    sel.each (function (j, f) {
				f.style ('stroke', new Color (10, 10, 10, 255));
				f.style ('fill-opacity', .7);
				f.style ('stroke-opacity', 1);
				if (!isNaN (f.attr['range'])) {
				    f.style ('fill', red_blue[i - 1]);
				}
				else {
				    var c = new Color (10, 10, 10, 255);
				    f.style ('fill', c);
				}
			    });
			}

			//br_pop.features ().style ('fill', function (f) {
			/*br_pop.features ().each (function (i, f) {
			    var key = f.attr['SOVEREIGNT'];
			    var val = lookup[key];
			    if (!isNaN (val)) {
				var index = Math.floor (val * red_blue.length)
				var c = red_blue[index];
				f.style ('fill', c);
				f.style ('stroke', new Color (10, 10, 10, 255));
				f.style ('fill-opacity', .7);
				f.style ('stroke-opacity', 1);
			    }
			    else {
				var c = new Color (10, 10, 10, 255);
				f.style ('fill', c);
				f.style ('stroke', new Color (10, 10, 10, 255));
			    }
			});Ëœ*/
			map.append(br_pop);
		    }
		});
	    }
	});
    });
</script>

  </head>
  <body>
    <p style="color: white; position: absolute; z-index: 2; bottom: 10px; left: 10px;">Data Source: ?</p>
    <!--<div style="padding: 10px; background-color: white;">
    Currently hovering over: <span id="hover">NA</span>
    </div>-->
  </body>
</html>
