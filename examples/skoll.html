<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Map</title>
    <script type="text/javascript" src="../js/jquery-1.7.min.js"></script>
    <script type="text/javascript" src="../js/jquery.hotkeys.js"></script>
    <script type="text/javascript" src="../js/jquery.mousewheel.js"></script>
    <script type="text/javascript" src="../js/utils/jquery.csv.js"></script>

    <script type="text/javascript" src="../webgl_maps.js"></script>
    <script type="text/javascript" src="../js/geojson.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/screen.css" />
    <link rel="stylesheet" type="text/css" href="../css/popup.css" />
    <style>
    .legend {
	position: absolute;
	z-index: 2;
	bottom: 10px;
	right: 10px;
	text-align: center;
	padding: 20px;
	-moz-user-select: none;
	-webkit-user-select: none;
	cursor: default;
        background-color: rgba(51,51,51,.6);
        border: solid 1px rgb(0,0,0);
	font-family: arial, sans-serif;
	color: white;
    }
    .legend * {
	margin: 0px;
	padding: 0px;
    }
    .legend h2 {
	text-align: center;	
	margin-bottom: 20px;
	font-size: 14px;
    }
    .range * {
	text-align: left;
	font-size: 12px;
	white-space: nowrap;
    }
    .range .box {
	float: left;
	margin-left: 20px;
	background-color: red;
    }
    </style>
    <script type="text/javascript">
    $ (document).ready (function () {
        map = new Map (null, {
	    base: 'default',
	    center: new vect (0, 0),
	    extents: 360,
	    //background: new Color (150, 150, 150, 255)
	    //background: new Color (10, 10, 51, 255)
	});
       //map.center (-55, -10);

	var red_blue = [
	    icolor (33, 102, 172, 255),
	    icolor (103, 169, 207, 255),
	    icolor (209, 169, 207, 255),
	    icolor (253, 219, 199, 255),
	    icolor (239, 138, 98, 255),
	    icolor (178, 24, 43, 255),
	];

	var light = .2
	var highlights = [];
	$.each (red_blue, function (index, color) {
	    var c = fcolor (color.r + light, color.g + light, color.b + light, 1.0);
	    highlights.push (c);
	});

	var cell_height = 25;

	leg = $ ('<div></div>').addClass ('legend');
	leg.append ('<h2>Map Scale</h2>');
	range = $ ('<div></div>').addClass ('range');
	leg.append (range);
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Sixth Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Fifth Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Fourth Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Third Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">Second Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">First Quantile</div>');
	range.append ('<div class="box"></div>');
	range.append ('<div class="label">No Data</div>');
	
	$ ('body').append (leg);
    
	range.children ().filter ('.box').css ('height', cell_height);
	range.children ().filter ('.box').css ('width', cell_height);

	var text_height = range.children ().filter ('.label').first ().height ();
	var top_pad = Math.round ((cell_height - text_height) / 2);
	range.children ().filter ('.label').css ('padding-top', top_pad);
	range.children ().filter ('.label').css ('padding-bottom', cell_height - text_height -top_pad);
	range.children ().filter ('.label').css ('padding-left', cell_height + 40);

	range.children ().filter ('.box').each (function (i) {
	    if (i >= red_blue.length) {
		$ (this).css ('background-color', '#333');
	    }
	    else {
		var c = red_blue[red_blue.length - 1 - i];
		$ (this).css ('background-color', 'rgb(' + parseInt (c.r * 255) + ',' + parseInt (c.g * 255) + ',' + parseInt (c.b * 255) + ')');
	    }
	});

	/*var scrim = $ ('<div></div>');
	scrim.css ({
	    'background-color': 'white',
	    opacity: .6,
	    padding: 0,
	    margin: 0,
	    width: leg.innerWidth (),
	    height: leg.innerHeight (),
	    position: 'absolute',
	    'z-index': 1,
	    bottom: 0,
	    right: 0
	});

	$ ('body').append (scrim);*/


	$.ajax ({
	    url: 'data/subunits.json',
	    dataType: 'json',
     	    //async: false,			
	    success: function (data) {
		br_pop = GeoJSON (data);

		$.ajax ({
		    //url: 'data/bio_threat.csv',
		    //url: 'data/invest_benefits.csv',
		    url: 'data/skoll_ISO3V10.csv',
		    dataType: 'text',
		    success: function (data) {
			/*console.log ($.csv (data));
			data = data.replace ('\r', '');
			var rows = data.split ('\n');
			var lookup = {};
			var header = rows[0].split (',');
			for (var i = 0; i < header.length; i ++) {
			    header[i] = header[i].replace ('\r', '');
			}
			for (var i = 1; i < rows.length; i ++) {
			    var vals = rows[i].split (',');
			    //var val = vals[1].slice (1, vals[1].length - 1);
			    var item = {};
			    for (var j = 2; j < header.length; j ++) {
				item[header[j]] = parseFloat (vals[j]);
			    }
			    lookup[vals[1]] = item;
			}*/
			var lookup = $.csv (data, {
			    key: 'ISO3V10',
			    header: true
			});
			br_pop.features ().each (function (i, f) {
			    var country = f.attr['ADM0_A3'];
			    if (lookup[country]) {
				$.each (lookup[country], function (key, value) {
				    f.attr[key] = value;
				});
			    }

			});
			br_pop.features ().style ('stroke', new Color (10, 10, 10, 255));
			function set_colors () {
			    var field = $ ('#sel').val ();
			    var points = br_pop.features ().filter (function (f) {
				f.attr['index'] = undefined;
				return !isNaN (f.attr[field]);
			    });
			    br_pop.features ().style ('fill', new Color (10, 10, 10, 255));
			    for (var i = 1; i <= 6; i ++) {
				var sel = points.quantile (field, i, 6);
				sel.each (function (j, f) {
				    f.attr['index'] = i - 1;
				    f.style ('stroke', new Color (10, 10, 10, 255));
				    f.style ('fill-opacity', .7);
				    f.style ('stroke-opacity', 1);
				    f.style ('fill', red_blue[i - 1]);
				});
			    }
			}
			set_colors ();

			br_pop.mouseover (function (f) {
			    var index = f.attr['index'];
			    if (highlights[index]) {
				f.style ('fill', highlights[index]);
				var field = $ ('#sel').val ();
				var val = Math.round (f.attr[field] * 100) / 100;
				$ ('.popup .head').text (f.get (0).attr['GEOUNIT']);
				//$ ('.popup .value').empty ();
				//$ ('.popup .value').text (val);
				$ ('.popup').css ('display', 'block');
			    }
			});

			br_pop.mouseout (function (f) {
			    var index = f.attr['index'];
			    if (highlights[index]) {
				f.style ('fill', red_blue[index]);
				$ ('.popup').css ('display', 'none');
			    }
			});
			

			$ ('#sel').change (function () {
			    //$ ('.popup .head').text ($ (this).children ('option:selected').text ());
			    set_colors ();
			});

			$(window).mousemove (function (event) {
			    $('.popup').css ({
				top: event.pageY - $ ('.popup').innerHeight () - 15,
				left: event.pageX + 15
			    });
			});

			map.append(br_pop);
		    }
		});
	    }
	});
    });
</script>

  </head>
  <body>
    <p style="color: white; position: absolute; z-index: 2; top: 10px; left: 10px">
      <select id="sel">
        <option value="imr">Infant Mortality Rate</option>
        <option value="urban_land">Urban Land</option>
        <option value="eid_tcv">Temperature Variability</option>
        <option value="eid_pcv">Precipitation Varaibility</option>
        <option value="conflict_intensity">Conflict Intensity</option>
        <option value="conflict_area">Conflict Area</option>
        <option value="EID_risk">EID Risk</option>
      </select>
    </p>
    <p style="color: white; position: absolute; z-index: 2; bottom: 10px; left: 10px;">Data Source: ?</p>
    <!--<div style="padding: 10px; background-color: white;">
    Currently hovering over: <span id="hover">NA</span>
    </div>-->
    <div class="popup" style="position: absolute; z-index: 2; display: none">
      <div class="head">Admin Name</div>
      <div class="value">
	<table cellspacing="0">
	<tr><td class="name">Water Security:</td><td class="val">10.99</td></tr>
	<tr style="background-color: rgba(100,100,100,.75);"><td class="name">Preipitation Variability:</td><td class="val">0.35</td></tr>
	<tr><td class="name">Conflict Intensity:</td><td class="val">30.71</td></tr>
	<tr><td class="name">Pandemic Risk:</td><td class="val">12.43</td></tr>
	</table>
      </div>
    </div>
  </body>
</html>
